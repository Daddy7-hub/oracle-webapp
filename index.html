<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CryptoATM.tech ‚Äî Mini App</title>
  <meta name="color-scheme" content="dark" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- React + ReactDOM (UMD) + Babel (–¥–ª—è JSX –±–µ–∑ —Å–±–æ—Ä–∫–∏) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{--bg:#0a0b0e;--panel:#111319;--card:#141821;--muted:#a5adbb;--txt:#f1f5fb;--gold:#d4af37;--gold-2:#f5d77a;--gold-glow:rgba(212,175,55,.28);--accent:#00e5ff;--green:#22e39e;--danger:#ff6a88;--b1:1px solid rgba(255,255,255,.08);--r:14px;--r-xl:18px;--safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);--bottom-h:96px;--shadow:0 6px 28px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.04) inset}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.08), transparent 60%), var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Inter,Segoe UI,Roboto,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    :focus-visible{outline:2px solid var(--accent); outline-offset:2px; border-radius:8px}
    .wrap{max-width:1160px;margin:0 auto;padding: calc(10px + var(--safe-top)) 14px calc(var(--bottom-h) + 14px)}

    header{position:sticky; top:0; z-index:12; margin:0 -14px 14px; padding: calc(8px + var(--safe-top)) 14px 8px; background:linear-gradient(180deg, rgba(10,11,14,.95), rgba(10,11,14,.6)); backdrop-filter:saturate(120%) blur(6px); border-bottom: var(--b1)}
    .hbar{ display:flex; align-items:center; justify-content:space-between; gap:12px }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0 }
    .logo{ width:44px; height:44px; border-radius:12px; background: radial-gradient(140% 140% at 30% 20%, var(--gold-2), var(--gold) 60%, #6e570f); box-shadow: inset 0 2px 10px rgba(255,255,255,.25), 0 4px 18px var(--gold-glow) }
    .brand h1{margin:0;font-size:18px;letter-spacing:.4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px}
    .userchips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:var(--b1);border-radius:999px;padding:8px 12px;color:var(--txt)}

    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0}
    .tab{appearance:none;border:var(--b1);background:var(--card);color:var(--txt);border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer}
    .tab.active{background:linear-gradient(135deg, rgba(245,215,122,.18), rgba(212,175,55,.14));box-shadow: 0 0 0 1px rgba(212,175,55,.5) inset}
    .page{display:none}.page.active{display:block}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}
    @media(max-width:1020px){.col-8,.col-6,.col-4{grid-column:span 12}}
    .card{background:var(--card);border:var(--b1);border-radius:var(--r-xl);padding:14px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 8px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:rgba(255,255,255,.06);border:var(--b1);border-radius:8px;padding:4px 8px;color:var(--muted);font-size:12px}

    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer;transition:transform .04s ease, box-shadow .2s ease;background:#1a2030;color:var(--txt);border:1px solid rgba(255,255,255,.1)}
    .btn.primary{background:linear-gradient(135deg, #715d1d, #f3d46b 40%, #c9a529);color:#0b0b0c;text-shadow:0 1px 0 rgba(255,255,255,.35);border:1px solid rgba(245,215,122,.65);box-shadow: 0 4px 18px rgba(212,175,55,.28), 0 1px 0 rgba(255,255,255,.25) inset}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.3)}
    .btn:active{transform:translateY(1px)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#11161f;color:var(--txt);outline:none}
    select{padding-right:32px}
    .label{color:var(--muted);font-weight:700}
    .line{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed rgba(255,255,255,.1);padding-top:10px;margin-top:10px}
    .price{font-weight:900}
    .kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}

    .bottom-bar{position:fixed;left:0;right:0;bottom:0;z-index:20;pointer-events:none;background:linear-gradient(180deg, rgba(10,11,14,0), rgba(10,11,14,.96));padding:10px 10px calc(10px + var(--safe-bot))}
    .bb-inner{max-width:1160px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0e1117;border:var(--b1);border-radius:16px;padding:10px 12px;pointer-events:auto}

    .modal-back{position:fixed;inset:0;z-index:30;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);padding:20px 14px}
    .modal{max-width:680px;width:100%;background:#0e1117;border:var(--b1);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .modal h2{margin:0 0 10px}
    .modal .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    .table{width:100%;border-collapse:separate;border-spacing:0;border:var(--b1);border-radius:12px;overflow:hidden}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
    .table th{background:#101421;color:var(--muted);text-align:left}
    .table tr:last-child td{border-bottom:0}

    .visually-hidden{position:absolute;left:-9999px}
    .btn.touching{filter:brightness(1.03)}

    /* splash */
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.12), transparent 60%), var(--bg);z-index:50}
    .s-logo{width:128px;height:128px;border-radius:24px;background: radial-gradient(140% 140% at 30% 20%, var(--gold-2), var(--gold) 60%, #6e570f);box-shadow: inset 0 2px 10px rgba(255,255,255,.25), 0 8px 40px var(--gold-glow)}
    .s-title{font-weight:900;font-size:28px;letter-spacing:.6px;margin-top:16px;text-align:center}
    .s-sub{color:var(--muted);text-align:center;margin-top:4px}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
    .s-logo{animation:float 2.2s ease-in-out infinite}

    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes pop{from{transform:scale(.96);opacity:.6}to{transform:scale(1);opacity:1}}
    .modal-back[style*="display: flex"]{animation:fadeIn .12s ease-out}
    .modal{animation:pop .18s ease-out}
    .btn:hover{filter:brightness(1.08)}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useState } = React;

    /** i18n **/
    const DEFAULT_LANG = localStorage.getItem('CATM_LANG') || (navigator.language||'en').toLowerCase().startsWith('ru') ? 'ru' : 'en';
    const tdict = {
      ru: {
        brandSub: '–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ –ü–∞–∫–µ—Ç—ã ‚Ä¢ –ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã',
        shop: '–ú–∞–≥–∞–∑–∏–Ω', orders: '–ó–∞–∫–∞–∑—ã', ref: '–†–µ—Ñ–µ—Ä–∞–ª—ã', tasks: '–ó–∞–¥–∞–Ω–∏—è', balance: '–ë–∞–ª–∞–Ω—Å', admin: '–ê–¥–º–∏–Ω', faq: 'FAQ',
        subTitle: '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏',
        subHelp: '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ 1/3/6 –º–µ—Å (—Å–∫–∏–¥–∫–∞ ~0/10/20%). ATM –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ 25% (100 ATM = ‚Ç¨1).',
        term: '–°—Ä–æ–∫', term1:'1 –º–µ—Å—è—Ü', term3:'3 –º–µ—Å—è—Ü–∞', term6:'6 –º–µ—Å—è—Ü–µ–≤',
        atmWriteOff: '–°–ø–∏—Å–∞—Ç—å ATM (–º–∞–∫—Å 25%)',
        more: '–ü–æ–¥—Ä–æ–±–Ω–µ–µ', add:'–í –∫–æ—Ä–∑–∏–Ω—É', remove:'–£–±—Ä–∞—Ç—å',
        history: '–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤', number:'‚Ññ', product:'–¢–æ–≤–∞—Ä', termCol:'–°—Ä–æ–∫', method:'–ú–µ—Ç–æ–¥', amount:'–°—É–º–º–∞', status:'–°—Ç–∞—Ç—É—Å', date:'–î–∞—Ç–∞', intent:'Intent',
        referralTitle:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞',
        referralHelp:'–î–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM). –í–∞—à –∫–æ–¥:',
        copy:'–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
        bindForeign:'–ü—Ä–∏–≤—è–∑–∞—Ç—å —á—É–∂–æ–π –∫–æ–¥', bind:'–ü—Ä–∏–≤—è–∑–∞—Ç—å',
        partner:'–ü–∞—Ä—Ç–Ω—ë—Ä', paid:'–û–ø–ª–∞—Ç–∞', reward:'–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ',
        tasksTitle:'–ó–∞–¥–∞–Ω–∏—è –∑–∞ ATM', rewardPlus:'–ù–∞–≥—Ä–∞–¥–∞', proofHint:'URL-–ø—Ä—É—Ñ', submit:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        balanceTitle:'–ë–∞–ª–∞–Ω—Å ATM', balanceHelp:'–ö–æ–∏–Ω—ã –≤—ã–¥–∞—é—Ç—Å—è –∑–∞ –∑–∞–¥–∞–Ω–∏—è –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –ú–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ 25% –∑–∞–∫–∞–∑–∞ (100 ATM = ‚Ç¨1).',
        pinManage:'–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PIN',
        adminTitle:'–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å', adminHelp:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∑–∞–∫–∞–∑—ã, –∑–∞–¥–∞–Ω–∏—è.',
        update:'–û–±–Ω–æ–≤–∏—Ç—å', export:'–≠–∫—Å–ø–æ—Ä—Ç JSON',
        users:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', orders2:'–ó–∞–∫–∞–∑—ã', revenue:'–í—ã—Ä—É—á–∫–∞', atmOnBalances:'ATM –Ω–∞ –±–∞–ª–∞–Ω—Å–∞—Ö',
        usersTbl:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', uid:'ID', username:'Username', atm:'ATM', ordersCount:'–ó–∞–∫–∞–∑—ã', refCode:'–†–µ—Ñ-–∫–æ–¥', from:'–û—Ç –∫–æ–≥–æ',
        ordersTbl:'–ó–∞–∫–∞–∑—ã', userCol:'User', items:'–¢–æ–≤–∞—Ä', euro:'‚Ç¨', actions:'–î–µ–π—Å—Ç–≤–∏—è', markPaid:'–û–ø–ª–∞—á–µ–Ω', cancel:'–û—Ç–º–µ–Ω–∞',
        tasksMod:'–ó–∞–¥–∞–Ω–∏—è (–º–æ–¥–µ—Ä–∞—Ü–∏—è)', task:'–ó–∞–¥–∞–Ω–∏–µ', proof:'–ü—Ä—É—Ñ', approve:'–û–¥–æ–±—Ä–∏—Ç—å', reject:'–û—Ç–∫–ª–æ–Ω–∏—Ç—å',
        faqTitle:'FAQ',
        faq1:'–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –≤ EUR. –û–ø–ª–∞—Ç–∞ ‚Äî –Ω–∞ –±–∏—Ä–∂—É –∞–¥–º–∏–Ω–∞ –∏–ª–∏ —Å—á—ë—Ç –∫–æ–º–ø–∞–Ω–∏–∏.',
        faq2:'ATM –ø–æ–∫—Ä—ã–≤–∞—é—Ç –¥–æ 25% –∑–∞–∫–∞–∑–∞ (100 ATM = ‚Ç¨1).',
        faq3:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞: 10% –æ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM).',
        positions:'–ü–æ–∑–∏—Ü–∏–π', total:'–ò—Ç–æ–≥–æ', totalWithAtm:'–° —É—á—ë—Ç–æ–º ATM', clear:'–û—á–∏—Å—Ç–∏—Ç—å', pay:'–û–ø–ª–∞—Ç–∏—Ç—å',
        authTitle:'–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', authBody:'–û—Ç–∫—Ä–æ–π—Ç–µ Mini App –≤–Ω—É—Ç—Ä–∏ Telegram (—Å initData).', close:'–ó–∞–∫—Ä—ã—Ç—å',
        disclaimer:'Disclaimer', agree:'I agree',
        disclaimerBody:'We strongly recommend conducting your own research before purchasing any services. CryptoATM does not provide financial advice and is not responsible for any losses. By continuing, you confirm you understand the risks and accept full responsibility.',
        cryptoPay:'–û–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π', scanOrCopy:'–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∞–¥—Ä–µ—Å. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)¬ª.',
        recipient:'–ü–æ–ª—É—á–∞—Ç–µ–ª—å', adminExch:'–ë–∏—Ä–∂–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', companyAcc:'–°—á—ë—Ç –∫–æ–º–ø–∞–Ω–∏–∏',
        chain:'–°–µ—Ç—å', address:'–ê–¥—Ä–µ—Å', amountEur:'–°—É–º–º–∞', memo:'–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ', iPaid:'–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)',
        item:'–¢–æ–≤–∞—Ä',
        pin:'PIN', pinSet:'–°–æ–∑–¥–∞—Ç—å –ü–ò–ù-–∫–æ–¥', pinSubSet:'–í–≤–µ–¥–∏—Ç–µ 4 —Ü–∏—Ñ—Ä—ã. –ü–ò–ù —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.', save:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        pinUnlock:'–ü–ò–ù-–∫–æ–¥', pinSubUnlock:'–í–≤–µ–¥–∏—Ç–µ 4 —Ü–∏—Ñ—Ä—ã, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å.', unlock:'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å', pinReset:'–°–±—Ä–æ—Å PIN',
        splashTitle:'CRYPTOATM', splashSub:'Subscriptions ‚Ä¢ Alerts ‚Ä¢ Copy-trading',
        lang:'–Ø–∑—ã–∫',
        accessTitle:'–î–æ—Å—Ç—É–ø', accessBody:'–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –≤—Ö–æ–¥–∞.', accessPlaceholder:'Access code', accessEnter:'–í–æ–π—Ç–∏'
      },
      en: {
        brandSub: 'Subscriptions ‚Ä¢ Bundles ‚Ä¢ Copy-trading ‚Ä¢ Referrals',
        shop: 'Shop', orders: 'Orders', ref: 'Referrals', tasks: 'Tasks', balance: 'Balance', admin:'Admin', faq:'FAQ',
        subTitle: 'Subscription checkout',
        subHelp: 'Choose 1/3/6 months (~0/10/20%). You can redeem up to 25% with ATM (100 ATM = ‚Ç¨1).',
        term:'Term', term1:'1 month', term3:'3 months', term6:'6 months',
        atmWriteOff:'Redeem ATM (max 25%)',
        more:'Details', add:'Add', remove:'Remove',
        history:'Order history', number:'#', product:'Product', termCol:'Term', method:'Method', amount:'Amount', status:'Status', date:'Date', intent:'Intent',
        referralTitle:'Referral program',
        referralHelp:'Share your code and earn 10% of the friend‚Äôs paid subscription (in ATM). Your code:',
        copy:'Copy',
        bindForeign:'Bind a referral code', bind:'Bind',
        partner:'Partner', paid:'Paid', reward:'Reward',
        tasksTitle:'Tasks for ATM', rewardPlus:'Reward', proofHint:'Proof URL', submit:'Submit',
        balanceTitle:'ATM balance', balanceHelp:'Earn ATM from tasks and referrals. Redeem up to 25% (100 ATM = ‚Ç¨1).',
        pinManage:'PIN management',
        adminTitle:'Admin panel', adminHelp:'Stats, orders, tasks.',
        update:'Refresh', export:'Export JSON',
        users:'Users', orders2:'Orders', revenue:'Revenue', atmOnBalances:'ATM on balances',
        usersTbl:'Users', uid:'ID', username:'Username', atm:'ATM', ordersCount:'Orders', refCode:'Ref code', from:'From',
        ordersTbl:'Orders', userCol:'User', items:'Items', euro:'‚Ç¨', actions:'Actions', markPaid:'Mark paid', cancel:'Cancel',
        tasksMod:'Tasks moderation', task:'Task', proof:'Proof', approve:'Approve', reject:'Reject',
        faqTitle:'FAQ',
        faq1:'Fixed prices in EUR. Pay to admin exchange or company wallet.',
        faq2:'ATM can cover up to 25% of order (100 ATM = ‚Ç¨1).',
        faq3:'Referral reward: 10% of the paid subscription (credited in ATM).',
        positions:'Items', total:'Total', totalWithAtm:'With ATM', clear:'Clear', pay:'Pay',
        authTitle:'Authorization required', authBody:'Open this Mini App inside Telegram (with initData).', close:'Close',
        disclaimer:'Disclaimer', agree:'I agree',
        disclaimerBody:'We strongly recommend conducting your own research before purchasing any services. CryptoATM does not provide financial advice and is not responsible for any losses. By continuing, you confirm you understand the risks and accept full responsibility.',
        cryptoPay:'Crypto payment', scanOrCopy:'Scan QR or copy address. After payment press ‚ÄúI paid‚Äù.',
        recipient:'Recipient', adminExch:'Admin exchange', companyAcc:'Company account',
        chain:'Network', address:'Address', amountEur:'Amount', memo:'Memo', iPaid:'I paid',
        item:'Item',
        pin:'PIN', pinSet:'Create PIN', pinSubSet:'Enter 4 digits. PIN is stored locally.', save:'Save',
        pinUnlock:'PIN', pinSubUnlock:'Enter 4 digits to unlock.', unlock:'Unlock', pinReset:'Reset PIN',
        splashTitle:'CRYPTOATM', splashSub:'Subscriptions ‚Ä¢ Alerts ‚Ä¢ Copy-trading',
        lang:'Lang',
        accessTitle:'Access', accessBody:'Enter access code to continue.', accessPlaceholder:'Access code', accessEnter:'Enter'
      }
    };
    function useI18n(){
      const [lang,setLang] = useState(DEFAULT_LANG);
      const t = (k)=> (tdict[lang] && tdict[lang][k]) || (tdict.en && tdict.en[k]) || k;
      const toggle = ()=> { const next = lang==='ru' ? 'en' : 'ru'; setLang(next); localStorage.setItem('CATM_LANG', next); document.documentElement.lang = next; };
      useEffect(()=>{ document.documentElement.lang = lang; },[lang]);
      return {lang, t, toggle};
    }

    /** App **/
    function App(){
      const { lang, t, toggle } = useI18n();
      const [showSplash, setShowSplash] = useState(true);

      useEffect(()=>{
        const tg = window.Telegram && window.Telegram.WebApp;
        try {
          tg && tg.expand && tg.expand();
          tg && tg.setHeaderColor && tg.setHeaderColor('#0a0b0e');
          tg && tg.setBackgroundColor && tg.setBackgroundColor('#0a0b0e');
        } catch(e){}

        // ====== CONFIG ======
        const ADMIN_IDS = [568646738];     // —Ç–≤–æ–π Telegram ID
        const START_BONUS_ATM = 250;
        const REF_BONUS_PERCENT = 0.10;    // 10% –æ—Ç ‚Ç¨ –≤ ATM
        const ATM_RATE = 100;              // 100 ATM = ‚Ç¨1
        const ACCESS_CODE = 'CHANGE_ME';   // <==== –ó–ê–ú–ï–ù–ò –Ω–∞ —Å–≤–æ–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞

        // –ö–∞—Ç–∞–ª–æ–≥
        const CATALOG = [
          {type:'bot',code:'CRYPTO_ATM',name:'Crypto ATM Bot',price:71,desc:'BTC analytics, daily signals & levels.'},
          {type:'bot',code:'ALERTS',name:'Alerts Bot',price:39,desc:'Whales, liquidations, funding, OI & volume alerts.'},
          {type:'bot',code:'NEWS',name:'News Bot',price:29,desc:'CoinMarketCal + RSS + translation + tone analysis.'},
          {type:'pack',code:'PREMIUM',name:'Premium',price:99,desc:'All 3 bots with discount.'},
          {type:'pack',code:'ENTERPRISE',name:'Enterprise',price:199,desc:'Full access + consulting.'},
          {type:'service',code:'COPY',name:'Copy-trading',price:50,desc:'‚Ç¨50/month + profit share. Risk-managed.'},
        ];
        const CATALOG_LONG = {
          CRYPTO_ATM:{bullets:['BTC analytics: levels & zones','Signals with probabilities + comments','Daily OI, funding, volumes']},
          ALERTS:{bullets:['Whale trades (spot/futures), liquidations','Funding/OI, volume spikes, local levels','Direction + trigger explanation']},
          NEWS:{bullets:['CoinMarketCal + RSS + tone','Top-3 digest, translate','Analytics export + keywords']},
          PREMIUM:{bullets:['All 3 bots, one payment','Discount included']},
          ENTERPRISE:{bullets:['Priority support','Consulting & full access']},
          COPY:{bullets:['‚Ç¨50/month + profit share','Transparent reports & risk control']},
        };
        const PERIOD_DISCOUNT = {1:0,3:0.1,6:0.2};

        // –†–µ–∫–≤–∏–∑–∏—Ç—ã
        const PAY_ADDR_ADMIN = {
          BEP20:'0x5af48f9d26edb82e7c30247e105fbf61d2dd1a5c',
          TRC20:'TYcRjK3fFvV2W1k2p7t1B5u8A9XyZqQrTs',
          ERC20:'0x1111222233334444555566667777888899990000'
        };
        const PAY_ADDR_COMPANY = {
          BEP20:'0x5af48f9d26edb82e7c30247e105fbf61d2dd1a5c',
          TRC20:'TYcRjK3fFvV2W1k2p7t1B5u8A9XyZqQrTs',
          ERC20:'0x1111222233334444555566667777888899990000'
        };

        // DOM helpers & DB
        const $ = s=>document.querySelector(s);
        const $$ = s=>Array.from(document.querySelectorAll(s));
        const DBKEY='CATM_DB_HTMLv2';
        function loadDB(){ try{ return JSON.parse(localStorage.getItem(DBKEY)||'null') || {users:{},orders:[],tasks:[],disclaimerAccepted:{},accessOK:{}} }catch(e){ return {users:{},orders:[],tasks:[],disclaimerAccepted:{},accessOK:{}} } }
        const db = loadDB();
        const saveDB = ()=> localStorage.setItem(DBKEY, JSON.stringify(db));

        // Telegram auth
        const rawUser = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
        const CURRENT_USER = rawUser ? {
          id: rawUser.id, username: rawUser.username||'user',
          name: (rawUser.first_name||'') + (rawUser.last_name?(' '+rawUser.last_name):'')
        } : { id:0, username:'guest', name:'Guest' };

        // Create user
        if (!db.users[CURRENT_USER.id]){
          db.users[CURRENT_USER.id] = {
            id: CURRENT_USER.id, username: CURRENT_USER.username, created_at: new Date().toISOString(),
            atm: START_BONUS_ATM, ref_code: 'REF'+(CURRENT_USER.id||Math.floor(Math.random()*1e6)),
            referred_by: null, orders: [], referrals: [], tasks: [], start_bonus_given: true, pin: undefined
          };
          saveDB();
        }
        function user(){ return db.users[CURRENT_USER.id]; }

        // State
        const state = { period:1, atmDiscount:0, cart:[], pay:{chain:'BEP20', dest:'admin', addr: PAY_ADDR_ADMIN.BEP20, amount:0, memo:''} };

        function setHash(tab){ location.hash = '#/'+tab; }
        function currentTab(){ return (location.hash.replace('#/','') || 'shop'); }
        function applyBottomOffset(){ const bar=$('#bottom-bar'); if(!bar) return; document.documentElement.style.setProperty('--bottom-h', Math.ceil(bar.getBoundingClientRect().height)+'px'); }

        // I18n refreshers
        function text(el, s){ if(el) el.textContent = s; }

        function renderHeader(){
          text($('#chip-name'), '@'+(CURRENT_USER.username||'guest'));
          text($('#chip-atm'), String(user().atm));
          text($('#chip-orders'), String(user().orders.length));
          const refCode = $('#ref-code'); if(refCode) refCode.value = user().ref_code;
          // Tabs labels
          $$('.tabs .tab').forEach(btn=>{
            const tab = btn.dataset.tab;
            const map = {shop:'shop',orders:'orders',ref:'ref',tasks:'tasks',balance:'balance',admin:'admin',faq:'faq'};
            if(map[tab]) btn.innerText = (t(map[tab])==='admin' ? 'üõ† '+t(map[tab]) : btn.innerText.replace(/^[^ ]+ /,'') ? `${btn.innerText.split(' ')[0]} ${t(map[tab])}` : t(map[tab]));
          });
        }

        function priceFor(item, months){ const disc=PERIOD_DISCOUNT[months]||0; const perMonth=Math.round(item.price*(1-disc)); return perMonth*months; }

        function updateCartUI(){
          const eur = state.cart.reduce((s,x)=>s+x.amount,0);
          const atmMax = Math.floor(eur*0.25)*ATM_RATE;
          const wantATM = Math.min(state.atmDiscount||0, atmMax, user().atm);
          const eurMinus = Math.floor(wantATM/ATM_RATE);
          const finalEur = Math.max(0, eur-eurMinus);
          text($('#cart-count'), String(state.cart.length));
          text($('#cart-total-eur'), '‚Ç¨'+eur);
          text($('#cart-total-atm'), wantATM+' ATM');
          text($('#cart-total-final'), '‚Ç¨'+finalEur);
          renderHeader(); applyBottomOffset();
        }

        function renderCatalog(){
          const grid = $('#catalog'); if(!grid) return; grid.innerHTML='';
          const months = state.period = parseInt(($('#period') && $('#period').value) || '1',10);
          state.atmDiscount = Math.max(0, parseInt(($('#atm-discount') && $('#atm-discount').value) || '0',10));
          const eur = state.cart.reduce((s,x)=>s+x.amount,0); const atmMax=Math.floor(eur*0.25)*ATM_RATE;
          if(state.atmDiscount>atmMax){ state.atmDiscount=atmMax; if($('#atm-discount')) $('#atm-discount').value = String(atmMax); }
          CATALOG.forEach(it=>{
            const total = priceFor(it, months); const inCart = state.cart.find(x=>x.code===it.code && x.months===months);
            const card = document.createElement('div'); card.className='col-4 card';
            card.innerHTML = `
              <div class="row" style="justify-content:space-between;align-items:start">
                <span class="badge">${it.type.toUpperCase()}</span>
                <span class="price" style="color:var(--gold)">‚Ç¨${total} / ${months}–º</span>
              </div>
              <h3 style="margin-top:6px">${it.name}</h3>
              <p class="muted">${it.desc}</p>
              <div class="line">
                <button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button>
                ${ inCart ? `<button class="btn" data-act="remove" data-code="${it.code}">${t('remove')}</button>` : `<button class="btn primary" data-act="add" data-code="${it.code}">${t('add')}</button>` }
              </div>`;
            grid.appendChild(card);
          });
          updateCartUI();
        }

        function addToCart(code){
          const months=state.period; const it=CATALOG.find(x=>x.code===code); if(!it) return;
          if(state.cart.find(x=>x.code===code && x.months===months)) return;
          state.cart.push({code:it.code,name:it.name,months,amount:priceFor(it,months)});
          updateCartUI(); renderCatalog();
        }
        function removeFromCart(code){
          const months=state.period;
          state.cart = state.cart.filter(x=>!(x.code===code && x.months===months));
          updateCartUI(); renderCatalog();
        }
        function clearCart(){ state.cart=[]; updateCartUI(); renderCatalog(); }

        function renderOrders(){
          const tb = $('#orders-table tbody'); if(!tb) return; tb.innerHTML='';
          const rows = db.orders.filter(o=>o.user===CURRENT_USER.id).slice().reverse();
          rows.forEach(o=>{
            const tr = document.createElement('tr');
            const names = o.items.map(i=>i.name+' √ó'+i.months+'–º').join(', ');
            tr.innerHTML = `<td>${o.id}</td><td>${names}</td><td>${o.items.reduce((s,i)=>s+i.months,0)} –º–µ—Å</td><td>${o.method} (${o.dest||'-'})</td><td>‚Ç¨${o.eur_final} ${o.atm_used?`(+${o.atm_used} ATM)`:''}</td><td>${o.status}</td><td>${new Date(o.created_at).toLocaleString()}</td><td>${o.intent_id||'‚Äî'}</td>`;
            tb.appendChild(tr);
          });
          renderHeader();
        }

        function toast(tmsg){ const tg = window.Telegram && window.Telegram.WebApp; if(tg&&tg.showPopup){ tg.showPopup({title:'',message:String(tmsg),buttons:[{type:'close'}]}); } else { console.log('[toast]', tmsg); } }

        function openItemModal(code){
          const it = CATALOG.find(x=>x.code===code); if(!it) return;
          const long = (CATALOG_LONG[code] && CATALOG_LONG[code].bullets) || [];
          text($('#item-title'), t('item')+': '+it.name);
          $('#item-desc').innerHTML = `
            <div class="muted" style="margin-bottom:8px">${it.desc}</div>
            ${long.length ? `<ul class="muted">${long.map(b=>`<li>${b}</li>`).join('')}</ul>` : ''}
          `;
          $('#modal-item').style.display='flex';
        }
        function closeItem(){ $('#modal-item').style.display='none'; }

        function getActiveAddr(){ const book = state.pay.dest==='company'? PAY_ADDR_COMPANY : PAY_ADDR_ADMIN; return book[state.pay.chain]; }

        function drawQR(text){
          const c = $('#qr'); if(!c) return; const ctx = c.getContext && c.getContext('2d'); if(!ctx) return;
          ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='#000';
          let seed=0; for(let i=0;i<text.length;i++) seed=((seed*33+text.charCodeAt(i))>>>0);
          const n=21,s=Math.floor((c.width-20)/n),off=10;
          for(let y=0;y<n;y++) for(let x=0;x<n;x++){ seed=(seed*1103515245+12345)>>>0; const v=seed&1; if(v) ctx.fillRect(off+x*s, off+y*s, s-1, s-1); }
        }

        function openCryptoModal(eur, chain='BEP20', memo=''){
          state.pay.chain = chain; state.pay.addr = getActiveAddr();
          const chainSel = $('#pay-chain-select'), destSel = $('#pay-dest-select');
          if(chainSel) chainSel.value = chain; if(destSel) destSel.value = state.pay.dest;
          text($('#pay-addr'), state.pay.addr);
          text($('#pay-amount'), `‚Ç¨${eur}`);
          text($('#pay-memo'), memo || 'CRYPTOATM');
          $('#modal-crypto').style.display='flex';
          drawQR(state.pay.addr); applyBottomOffset();
        }
        function closeCrypto(){ $('#modal-crypto').style.display='none'; }

        async function createPaymentIntent(order){
          try{ await new Promise(r=>setTimeout(r,350)); return 'intent_'+Math.random().toString(36).slice(2,9); }
          catch(e){ console.error(e); return null; }
        }

        function createOrder(){
          if(state.cart.length===0) return toast('Cart is empty');
          const eur = state.cart.reduce((s,x)=>s+x.amount,0);
          const atmMax = Math.floor(eur*0.25)*ATM_RATE;
          const wantATM = Math.min(state.atmDiscount||0, atmMax, user().atm);
          const eurMinus = Math.floor(wantATM/ATM_RATE);
          const finalEur = Math.max(0, eur-eurMinus);
          if(wantATM>0) user().atm = Math.max(0, user().atm - wantATM);

          const memo='ORDER-'+(db.orders.length+1);
          const order = { id: db.orders.length+1, user: CURRENT_USER.id, items: state.cart.map(x=>({code:x.code,name:x.name,months:x.months,amount:x.amount})), method:'crypto', dest: state.pay.dest, eur, atm_used: wantATM, eur_final: finalEur, status:'waiting', created_at:new Date().toISOString(), memo, intent_id: null };
          db.orders.push(order); user().orders.push(order.id); saveDB();

          state.cart=[]; state.atmDiscount=0; if($('#atm-discount')) $('#atm-discount').value='0';
          updateCartUI(); renderOrders();

          state.pay.amount=finalEur; state.pay.memo=memo;
          openCryptoModal(finalEur, state.pay.chain, memo);

          createPaymentIntent(order).then(id=>{
            order.intent_id=id; saveDB(); renderOrders(); if(id) text($('#pay-memo'), id);
          });
        }

        function renderRefs(){
          const rc = $('#ref-code'); if(rc) rc.value = user().ref_code;
          const tb = $('#ref-table tbody'); if(tb){ tb.innerHTML=''; for(const r of (user().referrals||[]).slice().reverse()){ const tr=document.createElement('tr'); tr.innerHTML = `<td>@${(db.users[r.uid] && db.users[r.uid].username) || r.uid}</td><td>${new Date(r.at).toLocaleDateString()}</td><td>${r.paid?'–î–∞':'‚Äî'}</td><td>${r.reward||0} ATM</td>`; tb.appendChild(tr); } }
          const hasRef = !!user().referred_by; if($('#ref-bind-input')) $('#ref-bind-input').disabled=hasRef; if($('#ref-bind-btn')) $('#ref-bind-btn').disabled=hasRef;
        }

        const TASK_DEF=[{id:1,title:'TikTok subscribe',reward:100,hint:'URL profile/screenshot'},{id:2,title:'Repost to stories',reward:120,hint:'URL story'},{id:3,title:'Project review',reward:150,hint:'URL post/review'},{id:4,title:'Sticker on car',reward:500,hint:'URL photo'}];
        function renderTasks(){
          const holder = $('#tasks'); if(!holder) return; holder.innerHTML='';
          TASK_DEF.forEach(tk=>{
            const col=document.createElement('div'); col.className='col-6 card';
            col.innerHTML = `<h3>#${tk.id} ${tk.title}</h3><p class="muted">${t('rewardPlus')}: <b>+${tk.reward} ATM</b></p><input id="proof-${tk.id}" type="url" placeholder="${t('proofHint')}"><div class="line"><span class="muted">Moderation</span><button class="btn primary" data-act="submit-task" data-id="${tk.id}">${t('submit')}</button></div>`;
            holder.appendChild(col);
          });
        }

        function renderBalance(){ const el=$('#atm-balance'); if(el) el.textContent = String(user().atm); }

        function renderAdmin(){
          // hide tab for non-admin
          const tabAdminBtn = document.querySelector('#tab-admin-btn'); if(tabAdminBtn) tabAdminBtn.hidden = !ADMIN_IDS.includes(CURRENT_USER.id);

          const users = Object.values(db.users); const o=db.orders; const totalEur=o.reduce((s,x)=>s+x.eur_final,0); const totalAtm=users.reduce((s,u)=>s+u.atm,0);
          const stats = $('#admin-stats'); if(stats) stats.innerHTML = `<div class="row"><div class="chip">${t('users')}: <b>${users.length}</b></div><div class="chip">${t('orders2')}: <b>${o.length}</b></div><div class="chip">${t('revenue')}: <b>‚Ç¨${totalEur}</b></div><div class="chip">${t('atmOnBalances')}: <b>${totalAtm}</b></div></div>`;
          const utb = $('#admin-users tbody'); if(utb){ utb.innerHTML=''; users.slice().sort((a,b)=>b.id-a.id).forEach(u=>{ const refFrom=u.referred_by ? '@'+((db.users[u.referred_by] && db.users[u.referred_by].username)||u.referred_by) : '‚Äî'; const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.id}</td><td>@${u.username}</td><td>${u.atm}</td><td>${u.orders.length}</td><td>${u.ref_code}</td><td>${refFrom}</td><td>${new Date(u.created_at).toLocaleDateString()}</td>`; utb.appendChild(tr); }); }
          const otb = $('#admin-orders tbody'); if(otb){ otb.innerHTML=''; db.orders.slice().reverse().forEach(or=>{ const userName='@'+((db.users[or.user] && db.users[or.user].username)||or.user); const items = or.items.map(i=>i.code+'√ó'+i.months).join(', '); const tr=document.createElement('tr'); tr.innerHTML=`<td>${or.id}</td><td>${userName}</td><td>${items}</td><td>${or.items.reduce((s,i)=>s+i.months,0)} –º–µ—Å</td><td>${or.method} (${or.dest||'-'})</td><td>${or.eur_final}</td><td>${or.atm_used}</td><td>${or.status}</td><td>${new Date(or.created_at).toLocaleString()}</td><td><button class="btn" data-act="mark-paid" data-id="${or.id}">${t('markPaid')}</button> <button class="btn ghost" data-act="mark-cancel" data-id="${or.id}">${t('cancel')}</button></td>`; otb.appendChild(tr); }); }
          const ttb = $('#admin-tasks tbody'); if(ttb){ ttb.innerHTML=''; users.forEach(u=>{ (u.tasks||[]).forEach((tk,idx)=>{ if(tk.status==='pending'){ const def=TASK_DEF.find(d=>d.id===tk.id)||{reward:0,title:'#'+tk.id}; const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.id}</td><td>@${u.username}</td><td>#${tk.id} ${def.title||''}</td><td>${tk.proof||''}</td><td>+${def.reward} ATM</td><td>${tk.status}</td><td><button class="btn" data-act="task-approve" data-uid="${u.id}" data-idx="${idx}">${t('approve')}</button> <button class="btn ghost" data-act="task-reject" data-uid="${u.id}" data-idx="${idx}">${t('reject')}</button></td>`; ttb.appendChild(tr); } }) }); }
        }

        function switchTab(name){
          $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
          $$('.page').forEach(p=>p.classList.toggle('active', p.id==='page-'+name));
          if(name==='shop') renderCatalog();
          if(name==='orders') renderOrders();
          if(name==='ref') renderRefs();
          if(name==='tasks') renderTasks();
          if(name==='balance') renderBalance();
          if(name==='admin') renderAdmin();
          applyBottomOffset();
        }

        // PIN
        function getPinKey(uid){ return `PIN_OK_${uid}` }
        function isPinSet(){ return !!user().pin; }
        function isUnlocked(){ return !isPinSet() || sessionStorage.getItem(getPinKey(CURRENT_USER.id))==='1'; }
        function showPinModal(mode){
          const m=$('#modal-pin'), title=$('#pin-title'), sub=$('#pin-sub'), action=$('#pin-action'), reset=$('#pin-reset'), input=$('#pin-input');
          if(!m||!title||!sub||!action||!reset||!input) return;
          if(mode==='set'){
            text(title, t('pinSet')); text(sub, t('pinSubSet')); text(action, t('save')); $('#pin-reset').style.display='none'; input.value=''; m.style.display='flex'; input.focus();
            action.onclick=()=>{ const v=(input.value||'').replace(/[^0-9]/g,''); if(v.length!==4) return toast('Enter 4 digits'); user().pin=v; saveDB(); toast('PIN saved'); m.style.display='none'; };
          } else {
            text(title, t('pinUnlock')); text(sub, t('pinSubUnlock')); text(action, t('unlock')); $('#pin-reset').style.display = isPinSet()? 'inline-flex':'none'; input.value=''; m.style.display='flex'; input.focus();
            action.onclick=()=>{ const v=(input.value||'').replace(/[^0-9]/g,''); if(v.length!==4) return toast('Enter 4 digits'); if(v===user().pin){ sessionStorage.setItem(getPinKey(CURRENT_USER.id),'1'); toast('Unlocked'); m.style.display='none'; } else toast('Wrong PIN'); };
          }
        }
        function ensureUnlocked(){ if(!isUnlocked()){ showPinModal('unlock'); return false; } return true; }

        // Disclaimer & Access code
        function ensureDisclaimer(){ const ok=db.disclaimerAccepted[CURRENT_USER.id]; $('#modal-disclaimer').style.display = ok ? 'none' : 'flex'; }
        function ensureAccess(){
          // –ê–¥–º–∏–Ω–∞ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–¥
          if(ADMIN_IDS.includes(CURRENT_USER.id)){ db.accessOK[CURRENT_USER.id] = true; saveDB(); return true; }
          const ok = !!db.accessOK[CURRENT_USER.id];
          if(!ok){ $('#modal-access').style.display='flex'; }
          return ok;
        }

        function onHashChange(){ switchTab(currentTab()); }
        window.addEventListener('hashchange', onHashChange);

        function clickHandler(e){
          const btn = e.target && e.target.closest && e.target.closest('button, .btn'); if(!btn) return;
          if(btn.classList.contains('tab')){ const tname=btn.dataset.tab; if(tname){ setHash(tname); switchTab(tname); } return; }
          const act=btn.dataset.act;

          if(act==='add'){ addToCart(btn.dataset.code); return; }
          if(act==='remove'){ removeFromCart(btn.dataset.code); return; }
          if(act==='details'){ openItemModal(btn.dataset.code); return; }

          if(act==='submit-task'){
            const id=+btn.dataset.id; const proofEl=$('#proof-'+id); const proof=(proofEl && proofEl.value && proofEl.value.trim()) || '';
            if(!/^https?:\/\//i.test(proof)) return toast('Add a valid URL proof');
            user().tasks=user().tasks||[]; user().tasks.push({id,proof,at:new Date().toISOString(),status:'pending'}); saveDB(); toast('Sent to moderation'); if(proofEl) proofEl.value=''; return;
          }

          if(btn.id==='lang-toggle'){ toggle(); renderHeader(); renderCatalog(); return; }

          if(btn.id==='cart-clear'){ clearCart(); return; }
          if(btn.id==='checkout-btn'){ if(!ensureUnlocked()) return; if(!db.accessOK[CURRENT_USER.id]){ $('#modal-access').style.display='flex'; return; } createOrder(); return; }

          if(btn.id==='ref-copy'){ navigator.clipboard.writeText(user().ref_code).then(()=>toast('Copied')); return; }
          if(btn.id==='ref-bind-btn'){ const inp=$('#ref-bind-input'); const code=(inp && inp.value && inp.value.trim().toUpperCase()) || ''; if(!code) return toast('Enter code'); const owner=Object.values(db.users).find(u=>u.ref_code===code); if(!owner) return toast('Code not found'); if(owner.id===CURRENT_USER.id) return toast('Cannot bind your own code'); if(user().referred_by) return toast('Already bound'); user().referred_by=owner.id; owner.referrals.push({uid:CURRENT_USER.id, at:new Date().toISOString(), paid:false, reward:0}); saveDB(); renderRefs(); toast('Bound'); return; }

          if(btn.id==='admin-refresh'){ renderAdmin(); return; }
          if(btn.id==='admin-export'){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cryptoatm_export.json'; a.click(); URL.revokeObjectURL(url); return; }

          if(btn.id==='copy-addr'){ navigator.clipboard.writeText(($('#pay-addr')?.textContent)||''); toast('Address copied'); return; }
          if(btn.id==='copy-amount'){ navigator.clipboard.writeText((($('#pay-amount')?.textContent)||'').replace('‚Ç¨','')); toast('Amount copied'); return; }
          if(btn.id==='copy-memo'){ navigator.clipboard.writeText(($('#pay-memo')?.textContent)||''); toast('Memo copied'); return; }
          if(btn.id==='paid-btn'){ toast('Thanks! We will verify the payment.'); closeCrypto(); return; }
          if(btn.id==='close-crypto'){ closeCrypto(); return; }
          if(btn.id==='close-item'){ closeItem(); return; }
          if(btn.id==='auth-close'){ $('#modal-auth').style.display='none'; return; }
          if(btn.id==='accept'){ db.disclaimerAccepted[CURRENT_USER.id]=true; saveDB(); $('#modal-disclaimer').style.display='none'; return; }

          if(btn.id==='pin-manage'){ if(isPinSet()){ showPinModal('unlock'); } else { showPinModal('set'); } return; }
          if(btn.id==='pin-close'){ $('#modal-pin').style.display='none'; return; }
          if(btn.id==='pin-reset'){ if(!isPinSet()) return; user().pin=undefined; saveDB(); sessionStorage.removeItem(getPinKey(CURRENT_USER.id)); toast('PIN removed'); $('#modal-pin').style.display='none'; return; }

          // Access code check
          if(btn.id==='access-enter'){
            const v = ($('#access-input')?.value || '').trim();
            if(!v) return toast('Enter access code');
            if(v === ACCESS_CODE){ db.accessOK[CURRENT_USER.id] = true; saveDB(); $('#modal-access').style.display='none'; toast('Access granted'); }
            else { toast('Wrong code'); }
            return;
          }

          // Admin-only actions
          if(act==='mark-paid'){
            if(!ADMIN_IDS.includes(CURRENT_USER.id)) return toast('No permission');
            const id=+(btn.dataset.id||0); const o=db.orders.find(x=>x.id===id);
            if(o){ o.status='paid';
              const buyer=db.users[o.user]; if(buyer && buyer.referred_by){ const refUser=db.users[buyer.referred_by]; if(refUser){ const rec=(refUser.referrals||[]).find(r=>r.uid===buyer.id); if(rec && !rec.paid){ rec.paid=true; const atmReward=Math.max(0, Math.round((o.eur_final||0) * REF_BONUS_PERCENT * ATM_RATE)); rec.reward=atmReward; refUser.atm=(refUser.atm||0)+atmReward; } } }
              saveDB(); renderOrders(); renderAdmin(); toast('Marked as paid'); }
            return;
          }
          if(act==='mark-cancel'){
            if(!ADMIN_IDS.includes(CURRENT_USER.id)) return toast('No permission');
            const id=+(btn.dataset.id||0); const o=db.orders.find(x=>x.id===id);
            if(o){ o.status='canceled'; saveDB(); renderOrders(); renderAdmin(); toast('Canceled'); }
            return;
          }
          if(act==='task-approve'){
            if(!ADMIN_IDS.includes(CURRENT_USER.id)) return toast('No permission');
            const uid=+(btn.dataset.uid||0); const idx=+(btn.dataset.idx||-1); const u=db.users[uid];
            if(u && u.tasks && u.tasks[idx]){ const tk=u.tasks[idx]; const def=TASK_DEF.find(d=>d.id===tk.id)||{reward:0}; tk.status='approved'; u.atm=(u.atm||0)+(def.reward||0); saveDB(); renderAdmin(); renderBalance(); toast('Approved #'+tk.id+' (+'+def.reward+' ATM)'); }
            return;
          }
          if(act==='task-reject'){
            if(!ADMIN_IDS.includes(CURRENT_USER.id)) return toast('No permission');
            const uid=+(btn.dataset.uid||0); const idx=+(btn.dataset.idx||-1); const u=db.users[uid];
            if(u && u.tasks && u.tasks[idx]){ const tk=u.tasks[idx]; tk.status='rejected'; saveDB(); renderAdmin(); toast('Rejected #'+tk.id); }
            return;
          }
        }

        function changeHandler(e){
          const el=e.target; if(!el) return;
          if(el.id==='period' || el.id==='atm-discount'){ renderCatalog(); }
          if(el.id==='pay-chain-select'){ state.pay.chain = el.value; state.pay.addr=getActiveAddr(); text($('#pay-addr'), state.pay.addr); drawQR(state.pay.addr); }
          if(el.id==='pay-dest-select'){ state.pay.dest = el.value; state.pay.addr=getActiveAddr(); text($('#pay-addr'), state.pay.addr); drawQR(state.pay.addr); }
        }

        function touchStart(e){ const b=e.target && e.target.closest && e.target.closest('.btn'); if(b) b.classList.add('touching'); }
        function touchEnd(){ $$('.btn.touching').forEach(b=>b.classList.remove('touching')); }

        function boot(){
          // Splash end
          setTimeout(()=> setShowSplash(false), 900);

          // Admin tab visibility right away
          const tabAdminBtn = document.querySelector('#tab-admin-btn'); if(tabAdminBtn) tabAdminBtn.hidden = !ADMIN_IDS.includes(CURRENT_USER.id);

          if(CURRENT_USER.id===0){ $('#modal-auth').style.display='flex'; }

          switchTab(currentTab()); renderHeader(); applyBottomOffset(); ensureDisclaimer();

          // Access code
          ensureAccess();

          if(isPinSet()){ sessionStorage.removeItem(getPinKey(CURRENT_USER.id)); showPinModal('unlock'); }
          setInterval(()=>{ const chip=$('#chip-atm'); if(chip) chip.textContent=String(user().atm); }, 1000);
        }

        document.addEventListener('click', clickHandler);
        document.addEventListener('change', changeHandler);
        document.addEventListener('touchstart', touchStart, {passive:true});
        document.addEventListener('touchend', touchEnd);
        window.addEventListener('hashchange', onHashChange);

        // sanity checks
        console.assert(document.getElementById('catalog')!==null,'#catalog should exist');

        boot();
        return ()=>{};
      },[lang]); // re-render catalog texts when language changes

      return (
        <>
          {/* SPLASH */}
          {showSplash && (
            <div className="splash">
              <div style={{textAlign:'center'}}>
                <div className="s-logo" />
                <div className="s-title">{tdict[lang].splashTitle}</div>
                <div className="s-sub">{tdict[lang].splashSub}</div>
              </div>
            </div>
          )}

          <div className="wrap">
            <header>
              <div className="hbar">
                <div className="brand">
                  <div className="logo" aria-hidden="true"></div>
                  <div>
                    <h1 id="brand-title">CRYPTOATM.TECH</h1>
                    <small>{tdict[lang].brandSub}</small>
                  </div>
                </div>
                <div className="userchips">
                  <button className="chip" id="lang-toggle" type="button">üåê {tdict[lang].lang}: <b style={{marginLeft:6}}>{lang.toUpperCase()}</b></button>
                  <div className="chip">üë§ <b id="chip-name">@guest</b></div>
                  <div className="chip">ATM: <b id="chip-atm">0</b></div>
                  <div className="chip">{tdict[lang].orders2}: <b id="chip-orders">0</b></div>
                </div>
              </div>
              <nav className="tabs" id="tabs" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
                <button className="tab active" data-tab="shop" type="button">üõí {tdict[lang].shop}</button>
                <button className="tab" data-tab="orders" type="button">üìÑ {tdict[lang].orders}</button>
                <button className="tab" data-tab="ref" type="button">üë• {tdict[lang].ref}</button>
                <button className="tab" data-tab="tasks" type="button">üß© {tdict[lang].tasks}</button>
                <button className="tab" data-tab="balance" type="button">üí∞ {tdict[lang].balance}</button>
                <button className="tab" data-tab="admin" id="tab-admin-btn" type="button" hidden>üõ† {tdict[lang].admin}</button>
                <button className="tab" data-tab="faq" type="button">‚ùì {tdict[lang].faq}</button>
              </nav>
            </header>

            <main id="pages">
              {/* SHOP */}
              <section id="page-shop" className="page active">
                <div className="grid">
                  <div className="col-12 card">
                    <h3>{tdict[lang].subTitle}</h3>
                    <p className="muted">{tdict[lang].subHelp}</p>
                    <div className="row">
                      <div className="kv" style={{minWidth:240}}>
                        <label className="label" htmlFor="period">{tdict[lang].term}</label>
                        <select id="period"><option value="1">{tdict[lang].term1}</option><option value="3">{tdict[lang].term3}</option><option value="6">{tdict[lang].term6}</option></select>
                      </div>
                      <div className="kv" style={{minWidth:260}}>
                        <label className="label" htmlFor="atm-discount">{tdict[lang].atmWriteOff}</label>
                        <input id="atm-discount" type="number" min="0" step="50" defaultValue="0" placeholder="0" inputMode="numeric" />
                      </div>
                    </div>
                  </div>
                  <div id="catalog" className="col-12 grid"></div>
                </div>
              </section>

              {/* ORDERS */}
              <section id="page-orders" className="page">
                <div className="grid">
                  <div className="col-12 card">
                    <h3>{tdict[lang].history}</h3>
                    <table className="table" id="orders-table">
                      <thead>
                        <tr>
                          <th>{tdict[lang].number}</th><th>{tdict[lang].product}</th><th>{tdict[lang].termCol}</th><th>{tdict[lang].method}</th><th>{tdict[lang].amount}</th><th>{tdict[lang].status}</th><th>{tdict[lang].date}</th><th>{tdict[lang].intent}</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </section>

              {/* REFERRALS */}
              <section id="page-ref" className="page">
                <div className="grid">
                  <div className="col-12 card">
                    <h3>{tdict[lang].referralTitle}</h3>
                    <p className="muted">{tdict[lang].referralHelp}</p>
                    <div className="row"><input id="ref-code" readOnly /><button className="btn primary" id="ref-copy" type="button">{tdict[lang].copy}</button></div>
                    <div className="line">
                      <div className="muted">{tdict[lang].bindForeign}</div>
                      <div className="row"><input id="ref-bind-input" placeholder="REF123456" /><button className="btn" id="ref-bind-btn" type="button">{tdict[lang].bind}</button></div>
                    </div>
                    <div style={{marginTop:10}}>
                      <table className="table" id="ref-table"><thead><tr><th>{tdict[lang].partner}</th><th>{tdict[lang].date}</th><th>{tdict[lang].paid}</th><th>{tdict[lang].reward}</th></tr></thead><tbody></tbody></table>
                    </div>
                  </div>
                </div>
              </section>

              {/* TASKS */}
              <section id="page-tasks" className="page">
                <div className="grid">
                  <div className="col-12 card">
                    <h3>{tdict[lang].tasksTitle}</h3>
                    <div id="tasks" className="grid"></div>
                  </div>
                </div>
              </section>

              {/* BALANCE */}
              <section id="page-balance" className="page">
                <div className="grid">
                  <div className="col-12 card">
                    <h3>{tdict[lang].balanceTitle}</h3>
                    <p className="muted">{tdict[lang].balanceHelp}</p>
                    <div className="row"><div className="chip">Balance: <b id="atm-balance">0</b></div></div>
                    <div className="line"><span className="muted">PIN</span><button className="btn" id="pin-manage" type="button">{tdict[lang].pinManage}</button></div>
                  </div>
                </div>
              </section>

              {/* ADMIN */}
              <section id="page-admin" className="page">
                <div className="grid">
                  <div className="col-12 card">
                    <h3>{tdict[lang].adminTitle}</h3>
                    <p className="muted">{tdict[lang].adminHelp}</p>
                    <div className="row"><button className="btn" id="admin-refresh" type="button">{tdict[lang].update}</button><button className="btn ghost" id="admin-export" type="button">{tdict[lang].export}</button></div>
                    <div className="grid" style={{marginTop:12}}>
                      <div className="col-12 card" id="admin-stats"></div>
                      <div className="col-12 card"><h3>{tdict[lang].usersTbl}</h3><table className="table" id="admin-users"><thead><tr><th>{tdict[lang].uid}</th><th>{tdict[lang].username}</th><th>{tdict[lang].atm}</th><th>{tdict[lang].ordersCount}</th><th>{tdict[lang].refCode}</th><th>{tdict[lang].from}</th><th>{tdict[lang].date}</th></tr></thead><tbody></tbody></table></div>
                      <div className="col-12 card"><h3>{tdict[lang].ordersTbl}</h3><table className="table" id="admin-orders"><thead><tr><th>#</th><th>{tdict[lang].userCol}</th><th>{tdict[lang].items}</th><th>{tdict[lang].termCol}</th><th>{tdict[lang].method}</th><th>{tdict[lang].euro}</th><th>ATM</th><th>{tdict[lang].status}</th><th>{tdict[lang].date}</th><th>{tdict[lang].actions}</th></tr></thead><tbody></tbody></table></div>
                      <div className="col-12 card"><h3>{tdict[lang].tasksMod}</h3><table className="table" id="admin-tasks"><thead><tr><th>{tdict[lang].uid}</th><th>{tdict[lang].userCol}</th><th>{tdict[lang].task}</th><th>{tdict[lang].proof}</th><th>{tdict[lang].reward}</th><th>{tdict[lang].status}</th><th>{tdict[lang].actions}</th></tr></thead><tbody></tbody></table></div>
                    </div>
                  </div>
                </div>
              </section>

              {/* FAQ */}
              <section id="page-faq" className="page">
                <div className="grid">
                  <div className="col-12 card">
                    <h3>{tdict[lang].faqTitle}</h3>
                    <ul className="muted">
                      <li>{tdict[lang].faq1}</li>
                      <li>{tdict[lang].faq2}</li>
                      <li>{tdict[lang].faq3}</li>
                    </ul>
                  </div>
                </div>
              </section>
            </main>
          </div>

          {/* bottom bar */}
          <div className="bottom-bar" id="bottom-bar">
            <div className="bb-inner">
              <div className="row">
                <div className="chip">{tdict[lang].positions}: <b id="cart-count">0</b></div>
                <div className="chip">{tdict[lang].total}: <b id="cart-total-eur">‚Ç¨0</b> / <b id="cart-total-atm">0 ATM</b></div>
                <div className="chip">{tdict[lang].totalWithAtm}: <b id="cart-total-final">‚Ç¨0</b></div>
              </div>
              <div className="row">
                <button className="btn" id="cart-clear" type="button">{tdict[lang].clear}</button>
                <button className="btn primary" id="checkout-btn" type="button">{tdict[lang].pay}</button>
              </div>
            </div>
          </div>

          {/* modals */}
          <div className="modal-back" id="modal-auth" role="dialog" aria-modal="true" aria-labelledby="auth-title">
            <div className="modal">
              <h2 id="auth-title">{tdict[lang].authTitle}</h2>
              <p className="muted">{tdict[lang].authBody}</p>
              <div className="foot"><button className="btn" id="auth-close" type="button">{tdict[lang].close}</button></div>
            </div>
          </div>

          <div className="modal-back" id="modal-disclaimer" role="dialog" aria-modal="true" aria-labelledby="disc-title">
            <div className="modal">
              <h2 id="disc-title">{tdict[lang].disclaimer}</h2>
              <p className="muted">{tdict[lang].disclaimerBody}</p>
              <div className="foot"><button className="btn primary" id="accept" type="button">{tdict[lang].agree}</button></div>
            </div>
          </div>

          <div className="modal-back" id="modal-crypto" role="dialog" aria-modal="true" aria-labelledby="pay-title">
            <div className="modal">
              <h2 id="pay-title">{tdict[lang].cryptoPay}</h2>
              <p className="muted">{tdict[lang].scanOrCopy}</p>
              <div className="row">
                <canvas id="qr" width="180" height="180" style={{background:'#fff',borderRadius:'8px'}}></canvas>
                <div style={{flex:1}}>
                  <div className="kv"><span className="label">{tdict[lang].recipient}</span>
                    <select id="pay-dest-select"><option value="admin">{tdict[lang].adminExch}</option><option value="company">{tdict[lang].companyAcc}</option></select>
                  </div>
                  <div className="kv"><span className="label">{tdict[lang].chain}</span>
                    <select id="pay-chain-select"><option value="BEP20">BEP20</option><option value="TRC20">TRC20</option><option value="ERC20">ERC20</option></select>
                  </div>
                  <div className="kv"><span className="label">{tdict[lang].address}</span><code id="pay-addr" style={{wordBreak:'break-all'}}></code> <button className="btn" id="copy-addr" type="button" style={{marginLeft:'8px'}}>{tdict[lang].copy}</button></div>
                  <div className="kv"><span className="label">{tdict[lang].amountEur}</span><b id="pay-amount">‚Äî</b> <button className="btn" id="copy-amount" type="button" style={{marginLeft:'8px'}}>{tdict[lang].copy}</button></div>
                  <div className="kv"><span className="label">{tdict[lang].memo}</span><b id="pay-memo">CRYPTOATM</b> <button className="btn" id="copy-memo" type="button" style={{marginLeft:'8px'}}>{tdict[lang].copy}</button></div>
                  <div className="row" style={{marginTop:'8px'}}><button className="btn" id="close-crypto" type="button">{tdict[lang].close}</button><button className="btn primary" id="paid-btn" type="button">{tdict[lang].iPaid}</button></div>
                </div>
              </div>
            </div>
          </div>

          <div className="modal-back" id="modal-item" role="dialog" aria-modal="true" aria-labelledby="item-title">
            <div className="modal">
              <h2 id="item-title">{tdict[lang].item}</h2>
              <div id="item-desc" className="muted"></div>
              <div className="foot"><button className="btn" id="close-item" type="button">{tdict[lang].close}</button></div>
            </div>
          </div>

          <div className="modal-back" id="modal-pin" role="dialog" aria-modal="true" aria-labelledby="pin-title">
            <div className="modal">
              <h2 id="pin-title">{tdict[lang].pin}</h2>
              <p id="pin-sub" className="muted"></p>
              <input id="pin-input" inputMode="numeric" maxLength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              <div className="foot">
                <button className="btn ghost" id="pin-reset" type="button">{tdict[lang].pinReset}</button>
                <button className="btn" id="pin-close" type="button">{tdict[lang].close}</button>
                <button className="btn primary" id="pin-action" type="button">OK</button>
              </div>
            </div>
          </div>

          {/* Access code modal */}
          <div className="modal-back" id="modal-access" role="dialog" aria-modal="true" aria-labelledby="access-title">
            <div className="modal">
              <h2 id="access-title">{tdict[lang].accessTitle}</h2>
              <p className="muted">{tdict[lang].accessBody}</p>
              <div className="row"><input id="access-input" placeholder={tdict[lang].accessPlaceholder} /><button className="btn primary" id="access-enter" type="button">{tdict[lang].accessEnter}</button></div>
            </div>
          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
