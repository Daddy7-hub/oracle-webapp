<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CryptoATM.tech ‚Äî Mini App</title>
<meta name="color-scheme" content="dark">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* ===== THEME ===== */
:root{
  --bg:#0a0b0e; --panel:#111319; --card:#141821; --muted:#a5adbb; --txt:#f1f5fb;
  --gold:#d4af37; --gold-2:#f5d77a; --gold-glow: rgba(212,175,55,.28);
  --accent:#00e5ff; --green:#22e39e; --danger:#ff6a88;
  --b1:1px solid rgba(255,255,255,.08); --r:14px; --r-xl:18px;
  --safe-top: env(safe-area-inset-top, 0px); --safe-bot: env(safe-area-inset-bottom, 0px);
  --bottom-h: 96px; --shadow: 0 6px 28px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.04) inset;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.08), transparent 60%), var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Inter,Segoe UI,Roboto,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
:focus-visible{outline:2px solid var(--accent); outline-offset:2px; border-radius:8px}
.wrap{max-width:1160px;margin:0 auto;padding: calc(10px + var(--safe-top)) 14px calc(var(--bottom-h) + 14px)}

/* ===== HEADER ===== */
header{position:sticky; top:0; z-index:12; margin:0 -14px 14px; padding: calc(8px + var(--safe-top)) 14px 8px; background:linear-gradient(180deg, rgba(10,11,14,.95), rgba(10,11,14,.6)); backdrop-filter:saturate(120%) blur(6px); border-bottom: var(--b1)}
.hbar{ display:flex; align-items:center; justify-content:space-between; gap:12px }
.brand{ display:flex; align-items:center; gap:12px; min-width:0 }
.logo{ width:44px; height:44px; border-radius:12px; background: radial-gradient(140% 140% at 30% 20%, var(--gold-2), var(--gold) 60%, #6e570f); box-shadow: inset 0 2px 10px rgba(255,255,255,.25), 0 4px 18px var(--gold-glow) }
.brand h1{margin:0;font-size:18px;letter-spacing:.4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px}
.userchips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:var(--b1);border-radius:999px;padding:8px 12px;color:var(--txt)}

/* ===== NAV / PAGES ===== */
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0}
.tab{appearance:none;border:var(--b1);background:var(--card);color:var(--txt);border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer}
.tab.active{background:linear-gradient(135deg, rgba(245,215,122,.18), rgba(212,175,55,.14));box-shadow: 0 0 0 1px rgba(212,175,55,.5) inset}
.page{display:none}
.page.active{display:block}

/* ===== GRID / CARDS ===== */
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}
@media(max-width:1020px){.col-8,.col-6,.col-4{grid-column:span 12}}
.card{background:var(--card);border:var(--b1);border-radius:var(--r-xl);padding:14px;box-shadow:var(--shadow)}
.card h3{margin:0 0 8px}
.muted{color:var(--muted)}
.badge{display:inline-block;background:rgba(255,255,255,.06);border:var(--b1);border-radius:8px;padding:4px 8px;color:var(--muted);font-size:12px}

/* ===== BUTTONS, INPUTS ===== */
.btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer;transition:transform .04s ease, box-shadow .2s ease;background:#1a2030;color:var(--txt);border:1px solid rgba(255,255,255,.1)}
.btn.primary{background:linear-gradient(135deg, #715d1d, #f3d46b 40%, #c9a529);color:#0b0b0c;text-shadow:0 1px 0 rgba(255,255,255,.35);border:1px solid rgba(245,215,122,.65);box-shadow: 0 4px 18px rgba(212,175,55,.28), 0 1px 0 rgba(255,255,255,.25) inset}
.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.3)}
.btn:active{transform:translateY(1px)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#11161f;color:var(--txt);outline:none}
select{padding-right:32px}
.label{color:var(--muted);font-weight:700}
.line{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed rgba(255,255,255,.1);padding-top:10px;margin-top:10px}
.price{font-weight:900}
.kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}

/* ===== BOTTOM BAR ===== */
.bottom-bar{position:fixed;left:0;right:0;bottom:0;z-index:20;pointer-events:none;background:linear-gradient(180deg, rgba(10,11,14,0), rgba(10,11,14,.96));padding:10px 10px calc(10px + var(--safe-bot))}
.bb-inner{max-width:1160px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0e1117;border:var(--b1);border-radius:16px;padding:10px 12px;pointer-events:auto}

/* ===== MODALS ===== */
.modal-back{position:fixed;inset:0;z-index:30;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);padding:20px 14px}
.modal{max-width:680px;width:100%;background:#0e1117;border:var(--b1);border-radius:18px;box-shadow:var(--shadow);padding:16px}
.modal h2{margin:0 0 10px}
.modal .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* ===== TABLE ===== */
.table{width:100%;border-collapse:separate;border-spacing:0;border:var(--b1);border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
.table th{background:#101421;color:var(--muted);text-align:left}
.table tr:last-child td{border-bottom:0}

/* A11y helpers */
.visually-hidden{position:absolute;left:-9999px}

/* touch */
.btn.touching{filter:brightness(1.03)}
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <header>
    <div class="hbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="brand-title">CRYPTOATM.TECH</h1>
          <small>–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ –ü–∞–∫–µ—Ç—ã ‚Ä¢ –ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã</small>
        </div>
      </div>
      <div class="userchips">
        <div class="chip">üë§ <b id="chip-name">@guest</b></div>
        <div class="chip">ATM: <b id="chip-atm">0</b></div>
        <div class="chip">–ó–∞–∫–∞–∑—ã: <b id="chip-orders">0</b></div>
      </div>
    </div>

    <nav class="tabs" id="tabs" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <button class="tab active" data-tab="shop" type="button">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
      <button class="tab" data-tab="orders" type="button">üìÑ –ó–∞–∫–∞–∑—ã</button>
      <button class="tab" data-tab="ref" type="button">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
      <button class="tab" data-tab="tasks" type="button">üß© –ó–∞–¥–∞–Ω–∏—è</button>
      <button class="tab" data-tab="balance" type="button">üí∞ –ë–∞–ª–∞–Ω—Å</button>
      <button class="tab" data-tab="admin" id="tab-admin-btn" type="button" hidden>üõ† –ê–¥–º–∏–Ω</button>
      <button class="tab" data-tab="faq" type="button">‚ùì FAQ</button>
    </nav>
  </header>

  <!-- PAGES (single visible) -->
  <main id="pages">
    <section id="page-shop" class="page active">
      <div class="grid">
        <div class="col-12 card">
          <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
          <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ 1/3/6 –º–µ—Å (—Å–∫–∏–¥–∫–∞ ~0/10/20%). ATM –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ 25% (100 ATM = ‚Ç¨1).</p>
          <div class="row">
            <div class="kv" style="min-width:240px">
              <label class="label" for="period">–°—Ä–æ–∫</label>
              <select id="period"><option value="1">1 –º–µ—Å—è—Ü</option><option value="3">3 –º–µ—Å—è—Ü–∞</option><option value="6">6 –º–µ—Å—è—Ü–µ–≤</option></select>
            </div>
            <div class="kv" style="min-width:260px">
              <label class="label" for="atm-discount">–°–ø–∏—Å–∞—Ç—å ATM (–º–∞–∫—Å 25%)</label>
              <input id="atm-discount" type="number" min="0" step="50" value="0" placeholder="0" inputmode="numeric">
            </div>
          </div>
        </div>
        <div id="catalog" class="col-12 grid"></div>
      </div>
    </section>

    <section id="page-orders" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
          <table class="table" id="orders-table"><thead><tr><th>‚Ññ</th><th>–¢–æ–≤–∞—Ä</th><th>–°—Ä–æ–∫</th><th>–ú–µ—Ç–æ–¥</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <section id="page-ref" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
          <p class="muted">–î–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º. –ó–∞ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –¥—Ä—É–∑–µ–π ‚Äî –±–æ–Ω—É—Å ATM. –í–∞—à –∫–æ–¥:</p>
          <div class="row"><input id="ref-code" readonly><button class="btn primary" id="ref-copy" type="button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
          <div class="line">
            <div class="muted">–ü—Ä–∏–≤—è–∑–∞—Ç—å —á—É–∂–æ–π –∫–æ–¥</div>
            <div class="row"><input id="ref-bind-input" placeholder="REF123456"><button class="btn" id="ref-bind-btn" type="button">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button></div>
          </div>
          <div style="margin-top:10px">
            <table class="table" id="ref-table"><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–î–∞—Ç–∞</th><th>–û–ø–ª–∞—Ç–∞</th><th>–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <section id="page-tasks" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3>–ó–∞–¥–∞–Ω–∏—è –∑–∞ ATM</h3>
          <div id="tasks" class="grid"></div>
        </div>
      </div>
    </section>

    <section id="page-balance" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3>–ë–∞–ª–∞–Ω—Å ATM</h3>
          <p class="muted">–ö–æ–∏–Ω—ã –≤—ã–¥–∞—é—Ç—Å—è –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π –∏ —á–µ—Ä–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã. –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.</p>
          <div class="row">
            <div class="chip">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <b id="atm-balance">0</b></div>
          </div>
        </div>
      </div>
    </section>

    <section id="page-admin" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
          <p class="muted">–°–≤–æ–¥–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∑–∞–∫–∞–∑–∞–º, —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º.</p>
          <div class="row"><button class="btn" id="admin-refresh" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button><button class="btn ghost" id="admin-export" type="button">–≠–∫—Å–ø–æ—Ä—Ç JSON</button></div>
          <div class="grid" style="margin-top:12px">
            <div class="col-12 card" id="admin-stats"></div>
            <div class="col-12 card"><h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3><table class="table" id="admin-users"><thead><tr><th>ID</th><th>Username</th><th>ATM</th><th>–ó–∞–∫–∞–∑—ã</th><th>–†–µ—Ñ-–∫–æ–¥</th><th>–û—Ç –∫–æ–≥–æ</th><th>–î–∞—Ç–∞</th></tr></thead><tbody></tbody></table></div>
            <div class="col-12 card"><h3>–ó–∞–∫–∞–∑—ã</h3><table class="table" id="admin-orders"><thead><tr><th>#</th><th>User</th><th>–¢–æ–≤–∞—Ä</th><th>–°—Ä–æ–∫</th><th>–ú–µ—Ç–æ–¥</th><th>‚Ç¨</th><th>ATM</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>
    </section>

    <section id="page-faq" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3>FAQ</h3>
          <ul class="muted">
            <li>–ü–æ–¥–ø–∏—Å–∫–∏: –æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ –±–æ—Ç–∞–º –∏–ª–∏ –ø–∞–∫–µ—Ç—ã Premium/Enterprise; –∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ‚Äî ‚Ç¨50/–º–µ—Å + % –æ—Ç –ø—Ä–∏–±—ã–ª–∏.</li>
            <li>–û–ø–ª–∞—Ç–∞: –∫—Ä–∏–ø—Ç–æ–π (QR/–∞–¥—Ä–µ—Å); —Å–∫–∏–¥–∫–∞ ATM –¥–æ 25% (100 ATM = ‚Ç¨1).</li>
            <li>–†–µ—Ñ–µ—Ä–∞–ª—ã: –≤–∞—à –∫–æ–¥ —Ñ–æ—Ä–º–∞—Ç–∞ REF&lt;id&gt;. –ó–∞ –æ–ø–ª–∞—Ç—É –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö ‚Äî –±–æ–Ω—É—Å—ã.</li>
            <li>–ó–∞–¥–∞–Ω–∏—è: –ø—Ä—É—Ñ—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π; –Ω–∞–≥—Ä–∞–¥–∞ –≤ ATM.</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar" id="bottom-bar">
  <div class="bb-inner">
    <div class="row">
      <div class="chip">–ü–æ–∑–∏—Ü–∏–π: <b id="cart-count">0</b></div>
      <div class="chip">–ò—Ç–æ–≥–æ: <b id="cart-total-eur">‚Ç¨0</b> / <b id="cart-total-atm">0 ATM</b></div>
      <div class="chip">–° —É—á—ë—Ç–æ–º ATM: <b id="cart-total-final">‚Ç¨0</b></div>
    </div>
    <div class="row">
      <button class="btn" id="cart-clear" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button class="btn primary" id="checkout-btn" type="button">–û–ø–ª–∞—Ç–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-back" id="modal-auth" role="dialog" aria-modal="true" aria-labelledby="auth-title">
  <div class="modal">
    <h2 id="auth-title">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <p class="muted">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å. –ï—Å–ª–∏ –≤—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ ‚Äî –≤–∫–ª—é—á–∏—Ç–µ Mini App –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ initData.</p>
    <div class="foot"><button class="btn" id="auth-close" type="button">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<div class="modal-back" id="modal-disclaimer" role="dialog" aria-modal="true" aria-labelledby="disc-title">
  <div class="modal">
    <h2 id="disc-title">–î–∏—Å–∫–ª–µ–π–º–µ—Ä</h2>
    <p class="muted">–≠—Ç–æ –Ω–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –†—ã–Ω–æ–∫ –≤–æ–ª–∞—Ç–∏–ª–µ–Ω; –ª—é–±—ã–µ —Å–∏–≥–Ω–∞–ª—ã –º–æ–≥—É—Ç –æ—à–∏–±–∞—Ç—å—Å—è. –ü—Ä–æ–≤–æ–¥–∏—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑.</p>
    <div class="foot"><button class="btn" id="decline" type="button">–ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω</button><button class="btn primary" id="accept" type="button">–Ø –ø–æ–Ω–∏–º–∞—é –∏ –Ω–µ—Å—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</button></div>
  </div>
</div>

<div class="modal-back" id="modal-crypto" role="dialog" aria-modal="true" aria-labelledby="pay-title">
  <div class="modal">
    <h2 id="pay-title">–û–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π</h2>
    <p class="muted">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∞–¥—Ä–µ—Å. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)¬ª ‚Äî –∑–∞–∫–∞–∑ –ø–µ—Ä–µ–π–¥—ë—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É.</p>
    <div class="row">
      <canvas id="qr" width="180" height="180" style="background:#fff;border-radius:8px"></canvas>
      <div style="flex:1">
        <div class="kv"><span class="label">–°–µ—Ç—å</span><b id="pay-chain">TRC20</b></div>
        <div class="kv"><span class="label">–ê–¥—Ä–µ—Å</span><code id="pay-addr" style="word-break:break-all"></code></div>
        <div class="kv"><span class="label">–°—É–º–º–∞</span><b id="pay-amount">‚Äî</b></div>
        <div class="kv"><span class="label">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</span><b id="pay-memo">CRYPTOATM</b></div>
        <div class="row" style="margin-top:8px"><button class="btn" id="copy-addr" type="button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å</button><button class="btn primary" id="paid-btn" type="button">–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)</button></div>
      </div>
    </div>
    <div class="foot"><button class="btn" id="close-crypto" type="button">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<div class="modal-back" id="modal-item" role="dialog" aria-modal="true" aria-labelledby="item-title">
  <div class="modal">
    <h2 id="item-title">–¢–æ–≤–∞—Ä</h2>
    <p id="item-desc" class="muted"></p>
    <div class="foot"><button class="btn" id="close-item" type="button">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<script>
/********************
  CORE / DB / AUTH
********************/ 
const tg = window.Telegram?.WebApp;
if (tg){ try{ tg.expand(); tg.setHeaderColor('#0a0b0e'); tg.setBackgroundColor('#0a0b0e'); }catch(_){} }
const ADMIN_IDS = [568646738];
const START_BONUS_ATM = 250; // —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∫–æ–∏–Ω—ã –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

const CATALOG = [
  {type:'bot', code:'CRYPTO_ATM', name:'Crypto ATM Bot',   price:71, desc:'BTC-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —É—Ä–æ–≤–Ω–∏, —Å–∏–≥–Ω–∞–ª—ã –µ–∂–µ–¥–Ω–µ–≤–Ω–æ.'},
  {type:'bot', code:'ALERTS',     name:'Alerts Bot',       price:39, desc:'–†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã: –∫–∏—Ç—ã, –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏, funding, OI, –æ–±—ä—ë–º—ã, —É—Ä–æ–≤–Ω–∏.'},
  {type:'bot', code:'NEWS',       name:'News & Events Bot',price:29, desc:'CoinMarketCal + RSS, –ø–µ—Ä–µ–≤–æ–¥, —Ñ–∏–ª—å—Ç—Ä—ã, —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –¥–∞–π–¥–∂–µ—Å—Ç.'},
  {type:'pack',code:'PREMIUM',    name:'Premium (–≤—Å–µ 3 –±–æ—Ç–∞)', price:99, desc:'–í—Å–µ –±–æ—Ç—ã —Å–æ —Å–∫–∏–¥–∫–æ–π.'},
  {type:'pack',code:'ENTERPRISE', name:'Enterprise', price:199, desc:'–í—Å–µ –±–æ—Ç—ã + –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç + –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.'},
  {type:'service',code:'COPY',    name:'–ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥', price:50, desc:'‚Ç¨50/–º–µ—Å + % –æ—Ç –ø—Ä–∏–±—ã–ª–∏. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–º, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å.'},
];
const PERIOD_DISCOUNT = {1:0, 3:0.10, 6:0.20};
const PAY_ADDR = { TRC20:'TYcRjK3fFvV2W1k2p7t1B5u8A9XyZqQrTs', BEP20:'0x5af48f9d26edb82e7c30247e105fbf61d2dd1a5c', ERC20:'0x1111222233334444555566667777888899990000' };

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const DBKEY = 'CATM_DB';
const db = loadDB();
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DBKEY)) || {users:{}, orders:[], tasks:[], disclaimerAccepted:{}} } catch(e){ return {users:{}, orders:[], tasks:[], disclaimerAccepted:{}} } }
function saveDB(){ localStorage.setItem(DBKEY, JSON.stringify(db)); }

// Simple auth: require Telegram user
const rawUser = tg?.initDataUnsafe?.user;
if(!rawUser){ // block UI until inside Telegram
  $('#modal-auth').style.display = 'flex';
}
const CURRENT_USER = (rawUser? { id: rawUser.id, username: rawUser.username||'user', name: (rawUser.first_name||'') + (rawUser.last_name?(' '+rawUser.last_name):'') } : { id: 0, username: 'guest', name: 'Guest' });

if(!db.users[CURRENT_USER.id]){
  db.users[CURRENT_USER.id] = { id: CURRENT_USER.id, username: CURRENT_USER.username, created_at: new Date().toISOString(), atm: START_BONUS_ATM, // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å
    ref_code: 'REF'+(CURRENT_USER.id||Math.floor(Math.random()*1e6)), referred_by: null, orders: [], referrals: [], start_bonus_given: true };
  saveDB();
}
function user(){ return db.users[CURRENT_USER.id]; }

if(ADMIN_IDS.includes(CURRENT_USER.id)) $('#tab-admin-btn').hidden = false;

/********************
  LAYOUT / ROUTER
********************/
const state = { period:1, atmDiscount:0, cart:[], pay:{chain:'TRC20', addr:PAY_ADDR.TRC20, amount:0} };

function setHash(tab){ location.hash = '#/'+tab; }
function currentTab(){ return (location.hash.replace('#/','') || 'shop'); }
function switchTab(name){
  $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
  $$('.page').forEach(p=>p.classList.toggle('active', p.id==='page-'+name));
  if(name==='shop') renderCatalog();
  if(name==='orders') renderOrders();
  if(name==='ref') renderRefs();
  if(name==='tasks') renderTasks();
  if(name==='balance') renderBalance();
  if(name==='admin') renderAdmin();
  applyBottomOffset();
}
window.addEventListener('hashchange', ()=> switchTab(currentTab()) );

/********************
  RENDER HELPERS
********************/
function renderHeader(){ $('#chip-name').textContent='@'+(CURRENT_USER.username||'guest'); $('#chip-atm').textContent=user().atm; $('#chip-orders').textContent=user().orders.length; $('#ref-code').value=user().ref_code; }
function applyBottomOffset(){ const bar=$('#bottom-bar'); if(!bar) return; document.documentElement.style.setProperty('--bottom-h', Math.ceil(bar.getBoundingClientRect().height)+'px'); }

/********************
  SHOP / CART
********************/
function priceFor(item, months){ const disc = PERIOD_DISCOUNT[months]||0; const perMonth = Math.round(item.price*(1-disc)); return perMonth*months; }
function renderCatalog(){
  const grid = $('#catalog'); grid.innerHTML='';
  const months = state.period = parseInt($('#period').value||'1',10);
  state.atmDiscount = Math.max(0, parseInt($('#atm-discount').value||'0',10));
  const eur = state.cart.reduce((s,x)=>s+x.amount,0); const atmMax = Math.floor(eur*0.25)*100; if(state.atmDiscount>atmMax){ state.atmDiscount=atmMax; $('#atm-discount').value=atmMax; }
  CATALOG.forEach(it=>{
    const total = priceFor(it, months); const inCart = state.cart.find(x=>x.code===it.code && x.months===months);
    const card = document.createElement('div'); card.className='col-4 card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:start">
        <span class="badge">${it.type.toUpperCase()}</span>
        <span class="price" style="color:var(--gold)">‚Ç¨${total} / ${months}–º</span>
      </div>
      <h3 style="margin-top:6px">${it.name}</h3>
      <p class="muted">${it.desc}</p>
      <div class="line">
        <button class="btn" data-act="details" data-code="${it.code}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        ${ inCart ? `<button class="btn" data-act="remove" data-code="${it.code}">–£–±—Ä–∞—Ç—å</button>` : `<button class="btn primary" data-act="add" data-code="${it.code}">–í –∫–æ—Ä–∑–∏–Ω—É</button>` }
      </div>`;
    grid.appendChild(card);
  });
  updateCartUI();
}
function addToCart(code){ const months=state.period; const it=CATALOG.find(x=>x.code===code); if(!it) return; if(state.cart.find(x=>x.code===code && x.months===months)) return; state.cart.push({code:it.code,name:it.name,months,amount:priceFor(it,months)}); updateCartUI(); renderCatalog(); }
function removeFromCart(code){ const months=state.period; state.cart = state.cart.filter(x=>!(x.code===code && x.months===months)); updateCartUI(); renderCatalog(); }
function clearCart(){ state.cart=[]; updateCartUI(); renderCatalog(); }
function updateCartUI(){ const eur=state.cart.reduce((s,x)=>s+x.amount,0); const atmMax=Math.floor(eur*0.25)*100; const wantATM=Math.min(state.atmDiscount||0, atmMax, user().atm); const eurMinus=Math.floor(wantATM/100); const finalEur=Math.max(0, eur-eurMinus); $('#cart-count').textContent=state.cart.length; $('#cart-total-eur').textContent='‚Ç¨'+eur; $('#cart-total-atm').textContent=wantATM+' ATM'; $('#cart-total-final').textContent='‚Ç¨'+finalEur; renderHeader(); applyBottomOffset(); }

/********************
  ORDERS / PAY
********************/
function createOrder(){ if(state.cart.length===0) return toast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); const eur=state.cart.reduce((s,x)=>s+x.amount,0); const atmMax=Math.floor(eur*0.25)*100; const wantATM=Math.min(state.atmDiscount||0, atmMax, user().atm); const eurMinus=Math.floor(wantATM/100); const finalEur=Math.max(0, eur-eurMinus); if(wantATM>0){ user().atm -= wantATM; }
  const order={ id: db.orders.length+1, user: CURRENT_USER.id, items: state.cart.map(x=>({code:x.code,name:x.name,months:x.months,amount:x.amount})), method:'crypto', eur, atm_used: wantATM, eur_final: finalEur, status:'waiting', created_at:new Date().toISOString() };
  db.orders.push(order); user().orders.push(order.id); saveDB(); state.cart=[]; state.atmDiscount=0; $('#atm-discount').value=0; updateCartUI(); renderOrders(); openCryptoModal(finalEur); }
function renderOrders(){ const tb=$('#orders-table tbody'); tb.innerHTML=''; const rows=db.orders.filter(o=>o.user===CURRENT_USER.id).slice().reverse(); for(const o of rows){ const tr=document.createElement('tr'); const names=o.items.map(i=>i.name+' √ó'+i.months+'–º').join(', '); tr.innerHTML=`<td>${o.id}</td><td>${names}</td><td>${o.items.reduce((s,i)=>s+i.months,0)} –º–µ—Å</td><td>${o.method}</td><td>‚Ç¨${o.eur_final} ${o.atm_used?`(+${o.atm_used} ATM)`:''}</td><td>${o.status}</td><td>${new Date(o.created_at).toLocaleString()}</td>`; tb.appendChild(tr); } renderHeader(); }

/********************
  REFERRALS
********************/
function renderRefs(){ $('#ref-code').value=user().ref_code; const tb=$('#ref-table tbody'); tb.innerHTML=''; for(const r of user().referrals.slice().reverse()){ const tr=document.createElement('tr'); tr.innerHTML=`<td>@${db.users[r.uid]?.username||r.uid}</td><td>${new Date(r.at).toLocaleDateString()}</td><td>${r.paid?'–î–∞':'‚Äî'}</td><td>${r.reward||0} ATM</td>`; tb.appendChild(tr);} const hasRef=!!user().referred_by; $('#ref-bind-input').disabled=hasRef; $('#ref-bind-btn').disabled=hasRef; }

/********************
  TASKS (rewards only)
********************/
const TASK_DEF=[
  {id:1, title:'–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ TikTok', reward:100, type:'link', hint:'–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å/—Å–∫—Ä–∏–Ω'},
  {id:2, title:'–†–µ–ø–æ—Å—Ç –≤ —Å—Ç–æ—Ä–∏—Å', reward:120, type:'link', hint:'–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–∏—Å'},
  {id:3, title:'–û—Ç–∑—ã–≤ –æ –ø—Ä–æ–µ–∫—Ç–µ', reward:150, type:'text', hint:'–¢–µ–∫—Å—Ç/—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç–∑—ã–≤'},
  {id:4, title:'–ù–∞–∫–ª–µ–π–∫–∞ –Ω–∞ –∞–≤—Ç–æ', reward:500, type:'image', hint:'–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ'}
];
function renderTasks(){ const holder=$('#tasks'); holder.innerHTML=''; TASK_DEF.forEach(t=>{ const col=document.createElement('div'); col.className='col-6 card'; col.innerHTML=`<h3>#${t.id} ${t.title}</h3><p class="muted">–ù–∞–≥—Ä–∞–¥–∞: <b>+${t.reward} ATM</b></p><input id="proof-${t.id}" placeholder="${t.hint}"><div class="line"><span class="muted">–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º</span><button class="btn primary" data-act="submit-task" data-id="${t.id}">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>`; holder.appendChild(col); }); }

/********************
  BALANCE
********************/
function renderBalance(){ $('#atm-balance').textContent=user().atm; }

/********************
  MODALS / QR
********************/
function openCryptoModal(eur, chain='TRC20'){ const addr=PAY_ADDR[chain]; state.pay.chain=chain; state.pay.addr=addr; $('#pay-chain').textContent=chain; $('#pay-addr').textContent=addr; $('#pay-amount').textContent=`‚Ç¨${eur}`; $('#modal-crypto').style.display='flex'; drawQR(addr); applyBottomOffset(); }
function closeCrypto(){ $('#modal-crypto').style.display='none'; }
function drawQR(text){ const c=$('#qr'), ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='#000'; let seed=0; for(let i=0;i<text.length;i++) seed=(seed*33+text.charCodeAt(i))>>>0; const n=21, s=Math.floor((c.width-20)/n), off=10; for(let y=0;y<n;y++) for(let x=0;x<n;x++){ const v=(seed=(seed*1103515245+12345)>>>0)&1; if(v) ctx.fillRect(off+x*s, off+y*s, s-1, s-1);} }
function openItemModal(code){ const it=CATALOG.find(x=>x.code===code); if(!it) return; $('#item-title').textContent=it.name; $('#item-desc').textContent=it.desc; $('#modal-item').style.display='flex'; }
function closeItem(){ $('#modal-item').style.display='none'; }

/********************
  HELPERS
********************/
function toast(t){ if(tg?.showPopup){ tg.showPopup({title:'', message:String(t), buttons:[{type:'close'}]}); } else { console.log('[toast]', t); } }

/********************
  EVENTS
********************/
document.addEventListener('click', (e)=>{
  const btn=e.target.closest('button, .btn'); if(!btn) return;
  if(btn.classList.contains('tab')){ setHash(btn.dataset.tab); switchTab(btn.dataset.tab); return; }
  const act=btn.dataset.act;
  if(act==='add'){ addToCart(btn.dataset.code); return; }
  if(act==='remove'){ removeFromCart(btn.dataset.code); return; }
  if(act==='details'){ openItemModal(btn.dataset.code); return; }
  if(act==='submit-task'){ const id=+btn.dataset.id; const val=$(`#proof-${id}`)?.value.trim(); if(!val) return toast('–î–æ–±–∞–≤—å—Ç–µ –ø—Ä—É—Ñ'); user().tasks=user().tasks||[]; user().tasks.push({id, proof:val, at:new Date().toISOString(), status:'pending'}); saveDB(); toast('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É'); $(`#proof-${id}`).value=''; return; }
  if(btn.id==='cart-clear'){ clearCart(); return; }
  if(btn.id==='checkout-btn'){ createOrder(); return; }
  if(btn.id==='ref-copy'){ navigator.clipboard.writeText(user().ref_code).then(()=>toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')); return; }
  if(btn.id==='ref-bind-btn'){ const code=$('#ref-bind-input').value.trim().toUpperCase(); if(!code) return toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥'); const owner=Object.values(db.users).find(u=>u.ref_code===code); if(!owner) return toast('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω'); if(owner.id===CURRENT_USER.id) return toast('–ù–µ–ª—å–∑—è –ø—Ä–∏–≤—è–∑–∞—Ç—å —Å–≤–æ–π –∫–æ–¥'); if(user().referred_by) return toast('–ö–æ–¥ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω'); user().referred_by=owner.id; owner.referrals.push({uid:CURRENT_USER.id, at:new Date().toISOString(), paid:false, reward:0}); saveDB(); renderRefs(); toast('–ö–æ–¥ –ø—Ä–∏–≤—è–∑–∞–Ω'); return; }
  if(btn.id==='admin-refresh'){ renderAdmin(); return; }
  if(btn.id==='admin-export'){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cryptoatm_export.json'; a.click(); URL.revokeObjectURL(url); return; }
  if(btn.id==='copy-addr'){ navigator.clipboard.writeText($('#pay-addr').textContent||''); toast('–ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); return; }
  if(btn.id==='paid-btn'){ toast('–°–ø–∞—Å–∏–±–æ! –ú—ã –æ—Ç–º–µ—Ç–∏–º –∑–∞–∫–∞–∑ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.'); closeCrypto(); return; }
  if(btn.id==='close-crypto'){ closeCrypto(); return; }
  if(btn.id==='close-item'){ closeItem(); return; }
  if(btn.id==='auth-close'){ $('#modal-auth').style.display='none'; return; }
  if(btn.id==='accept'){ db.disclaimerAccepted[CURRENT_USER.id]=true; saveDB(); $('#modal-disclaimer').style.display='none'; return; }
  if(btn.id==='decline'){ if(tg?.close) tg.close(); else window.location.href='about:blank'; return; }
});

document.addEventListener('change', (e)=>{ const el=e.target; if(el.id==='period' || el.id==='atm-discount'){ renderCatalog(); } });

document.addEventListener('touchstart', (e)=>{ const b=e.target.closest('.btn'); if(b) b.classList.add('touching'); },{passive:true});
document.addEventListener('touchend', ()=> $$('.btn.touching').forEach(b=>b.classList.remove('touching')) );

/********************
  ADMIN
********************/
function renderAdmin(){ const users=Object.values(db.users); const o=db.orders; const totalEur=o.reduce((s,x)=>s+x.eur_final,0); const totalAtm=users.reduce((s,u)=>s+u.atm,0); $('#admin-stats').innerHTML=`<div class="row"><div class="chip">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: <b>${users.length}</b></div><div class="chip">–ó–∞–∫–∞–∑—ã: <b>${o.length}</b></div><div class="chip">–í—ã—Ä—É—á–∫–∞: <b>‚Ç¨${totalEur}</b></div><div class="chip">ATM –Ω–∞ –±–∞–ª–∞–Ω—Å–∞—Ö: <b>${totalAtm}</b></div></div>`; const utb=$('#admin-users tbody'); utb.innerHTML=''; for(const u of users.slice().sort((a,b)=>b.id-a.id)){ const refFrom=u.referred_by ? '@'+(db.users[u.referred_by]?.username||u.referred_by) : '‚Äî'; const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.id}</td><td>@${u.username}</td><td>${u.atm}</td><td>${u.orders.length}</td><td>${u.ref_code}</td><td>${refFrom}</td><td>${new Date(u.created_at).toLocaleDateString()}</td>`; utb.appendChild(tr);} const otb=$('#admin-orders tbody'); otb.innerHTML=''; for(const or of db.orders.slice().reverse()){ const userName='@'+(db.users[or.user]?.username||or.user); const items=or.items.map(i=>i.code+'√ó'+i.months).join(', '); const tr=document.createElement('tr'); tr.innerHTML=`<td>${or.id}</td><td>${userName}</td><td>${items}</td><td>${or.items.reduce((s,i)=>s+i.months,0)} –º–µ—Å</td><td>${or.method}</td><td>${or.eur_final}</td><td>${or.atm_used}</td><td>${or.status}</td><td>${new Date(or.created_at).toLocaleString()}</td>`; otb.appendChild(tr);} }

/********************
  BOOT
********************/
function boot(){ if(CURRENT_USER.id===0){ $('#modal-auth').style.display='flex'; } const want = currentTab(); switchTab(want); renderHeader(); applyBottomOffset(); ensureDisclaimer(); setInterval(()=>($('#chip-atm').textContent=user().atm), 1000); }
function ensureDisclaimer(){ const ok=db.disclaimerAccepted[CURRENT_USER.id]; if(ok){ $('#modal-disclaimer').style.display='none'; return;} $('#modal-disclaimer').style.display='flex'; }

boot();
</script>
</body>
</html>
