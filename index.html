<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>–û—Ä–∞–∫–ª ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1221; --bg-soft:#121634; --card:#151a33; --elev:rgba(255,255,255,.03);
      --text:#e9ecff; --muted:#aab1ff; --line:#2a305f;
      --acc:#7a8cff; --acc2:#6de0ff; --ok:#35d49a; --warn:#ffd166; --err:#ff6b6b;
      --shadow: 0 10px 35px rgba(0,0,0,.45);
      --radius:18px; --gap:16px; --blur:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 80% -10%, #1b2040 0%, #0f1221 60%, #0a0d18 100%) fixed,
        linear-gradient(180deg,#0f1221,#0a0d18);
    }
    .app{max-width:980px;margin:0 auto;padding:24px}
    .hero{
      display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:14px
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
      background:conic-gradient(from 210deg at 50% 50%, #6de0ff, #7a8cff 40%, #6de0ff 100%);
      color:#081020;font-weight:900;box-shadow:0 10px 30px rgba(109,224,255,.25);
    }
    .title{font-weight:800;font-size:22px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--elev);background:#0d1230;color:var(--muted);font-size:12px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .card{
      grid-column:span 12; border-radius:var(--radius);
      background:linear-gradient(135deg,var(--bg-soft),#101531);
      box-shadow: var(--shadow), inset 0 0 0 1px var(--elev); padding:18px; backdrop-filter: blur(var(--blur));
    }
    @media (min-width:820px){
      .card--half{grid-column:span 6}
      .card--third{grid-column:span 4}
      .card--wide{grid-column:span 12}
    }
    .card h3{margin:0 0 8px;font-size:16px}
    .sep{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:14px 0}

    label{display:block;margin:8px 0 8px 2px;font-size:12px;color:var(--muted)}
    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--elev);
      background:#0f142d;color:var(--text);outline:none; transition: box-shadow .15s, border-color .15s;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.01);
    }
    input:focus,select:focus,textarea:focus{border-color:#3953ff; box-shadow:0 0 0 3px rgba(57,83,255,.15)}
    textarea{resize:vertical;min-height:96px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row .col{flex:1;min-width:220px}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:12px 16px;border-radius:14px;border:1px solid var(--elev); cursor:pointer; user-select:none;
      background:linear-gradient(135deg,#20264d,#1a1f40); color:var(--text);
      transition:transform .06s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{box-shadow:0 10px 30px rgba(122,140,255,.18)}
    .btn:active{transform:translateY(1px)}
    .btn--mini{background:linear-gradient(135deg,#294a73,#1a2f47); border-color:rgba(109,224,255,.35)}
    .btn--deep{background:linear-gradient(135deg,#1f6b56,#1b4d40); border-color:rgba(53,212,154,.45)}
    .btn--pay{background:linear-gradient(135deg,#2a3a88,#1d275d); border-color:rgba(122,140,255,.35)}
    .btn--ghost{background:#0d1230}
    .btn.full{width:100%}
    .kudos{display:flex;gap:8px;flex-wrap:wrap}
    .kudos .chip{background:#0c1025;border-color:var(--elev)}

    .notice{
      padding:14px;border:1px dashed var(--line);border-radius:14px;background:#0f142b;color:var(--muted);
      font-size:14px
    }
    .preview{white-space:pre-wrap;background:#0f142b;border:1px dashed var(--line);padding:12px;border-radius:12px;margin-top:10px}
    .hidden{display:none}

    /* Light theme via Telegram themeParams */
    .light body{
      background:linear-gradient(180deg,#f3f5ff,#eef1ff)
    }
    .light .card{
      background:linear-gradient(135deg,#ffffff,#f7f8ff);
      box-shadow:0 12px 30px rgba(20,25,60,.08), inset 0 0 0 1px #eef0ff;
    }
    .light input,.light select,.light textarea{background:#fff;border:1px solid #e6e9ff;color:#12152d}
    .light .btn{background:linear-gradient(135deg,#eef1ff,#e6e9ff);border-color:#e6e9ff;color:#161a33}
    .light .btn--mini{background:linear-gradient(135deg,#e0f3ff,#d6eefe)}
    .light .btn--deep{background:linear-gradient(135deg,#dff5ec,#c7eddc)}
    .light .btn--pay{background:linear-gradient(135deg,#e5e9ff,#d8ddff)}
    .light .notice{background:#fff;border-color:#e6e9ff}
    .light .preview{background:#fff;border-color:#e6e9ff;color:#263069}
    .light .chip{background:#fff;border-color:#e6e9ff;color:#3a408e}
  </style>
</head>
<body>
  <div class="app">
    <div class="hero">
      <div class="brand">
        <div class="logo">üîÆ</div>
        <div>
          <div class="title">–û—Ä–∞–∫–ª ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
          <div class="subtitle">–ö–æ—Ä–æ—Ç–∫–æ–µ/–≥–ª—É–±–æ–∫–æ–µ —á—Ç–µ–Ω–∏–µ –Ω–∞ 7 –¥–Ω–µ–π ‚Ä¢ –û–ø–ª–∞—Ç–∞ ‚≠ê</div>
        </div>
      </div>
      <div class="chip" id="envChip">WebApp</div>
    </div>

    <div class="grid">
      <div class="card card--wide">
        <h3>1) –¢–µ–º–∞</h3>
        <select id="topic">
          <option value="career">–ö–∞—Ä—å–µ—Ä–∞</option>
          <option value="love">–õ—é–±–æ–≤—å</option>
          <option value="finance">–§–∏–Ω–∞–Ω—Å—ã</option>
          <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
          <option value="overall" selected>–û–±—â–µ–µ</option>
        </select>
        <div class="hint">–ú–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.</div>
      </div>

      <div class="card card--half">
        <h3>2) –ê–Ω–∫–µ—Ç–∞</h3>
        <div class="row">
          <div class="col">
            <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
            <input id="dob" type="date" placeholder="yyyy-mm-dd"/>
            <div class="hint">–§–æ—Ä–º–∞—Ç: –ì–ì–ì–ì-–ú–ú-–î–î</div>
          </div>
          <div class="col">
            <label>–ü–æ–ª</label>
            <select id="gender">
              <option value="">‚Äî –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å ‚Äî</option>
              <option value="male">–º—É–∂—Å–∫–æ–π</option>
              <option value="female">–∂–µ–Ω—Å–∫–∏–π</option>
              <option value="other">–¥—Ä—É–≥–æ–π</option>
            </select>
          </div>
        </div>
        <label style="margin-top:10px">–ö–æ–Ω—Ç–µ–∫—Å—Ç / –≤–æ–ø—Ä–æ—Å (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)</label>
        <textarea id="context" rows="5" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏ —Å–∏—Ç—É–∞—Ü–∏—é –∏–ª–∏ —Ü–µ–ª—å‚Ä¶"></textarea>
        <div class="hint">–ú–∞–∫—Å–∏–º—É–º 500 —Å–∏–º–≤–æ–ª–æ–≤. –ù–∏–∫–∞–∫–∏—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤/—é—Ä–∏—Å/—Ñ–∏–Ω—Å–æ–≤–µ—Ç–æ–≤ ‚Äî —ç—Ç–æ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å.</div>
      </div>

      <div class="card card--half">
        <h3>3) –î–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="row" style="margin-top:6px">
          <button class="btn btn--mini full" id="btnMini">ü™Ñ –ú–∏–Ω–∏-—á—Ç–µ–Ω–∏–µ</button>
          <button class="btn btn--deep full" id="btnDeep">‚ú® –ì–ª—É–±–æ–∫–æ–µ —á—Ç–µ–Ω–∏–µ</button>
          <button class="btn btn--pay  full" id="btnPay">‚≠ê –ö—É–ø–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã</button>
        </div>
        <div class="sep"></div>
        <div class="kudos">
          <span class="chip">–ë–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</span>
          <span class="chip">–†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</span>
          <span class="chip">–ó–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤</span>
        </div>
      </div>

      <div class="card card--wide" id="browserBlock" style="display:none">
        <h3>–û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –∏–∑ Telegram</h3>
        <div class="notice">
          –≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ª—É—á—à–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å <b>–∏–∑ Telegram</b> (—á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ).<br>
          –°–µ–π—á–∞—Å –≤–∫–ª—é—á—ë–Ω —Ä–µ–∂–∏–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: –Ω–∞–∂–∞—Ç–∏—è –ø–æ–∫–∞–∂—É—Ç JSON, –∫–æ—Ç–æ—Ä—ã–π —É—Ö–æ–¥–∏—Ç –±–æ—Ç—É.
        </div>
        <div id="preview" class="preview hidden"></div>
        <div class="row" style="margin-top:10px">
          <a class="btn btn--ghost" href="#" id="copyUrl">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</a>
          <a class="btn btn--ghost" href="https://t.me" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å Telegram</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============ Shortcuts ============
    const qs = s => document.querySelector(s);
    const topicEl  = qs('#topic');
    const dobEl    = qs('#dob');
    const genderEl = qs('#gender');
    const ctxEl    = qs('#context');
    const previewEl= qs('#preview');
    const browserBlock = qs('#browserBlock');
    const envChip  = qs('#envChip');

    const tg = window.Telegram?.WebApp;

    // ============ Theme from Telegram ============
    function applyThemeFromTG(){
      if(!tg) return;
      const t = tg.themeParams || {};
      const css = (k, def) => t[k] ? t[k] : def;
      // map a few important colors if provided by Telegram
      document.documentElement.style.setProperty('--bg', css('bg_color', '#0f1221'));
      document.documentElement.style.setProperty('--text', css('text_color', '#e9ecff'));
      document.documentElement.style.setProperty('--muted', css('hint_color', '#aab1ff'));
      document.documentElement.style.setProperty('--line', css('secondary_bg_color', '#2a305f'));
      // light/dark hint
      const lightLikely = t.bg_color && luminance(t.bg_color) > 0.8;
      if (lightLikely || tg.colorScheme === 'light') {
        document.documentElement.classList.add('light');
        envChip.textContent = 'WebApp ‚Ä¢ light';
      } else {
        envChip.textContent = 'WebApp ‚Ä¢ dark';
      }
    }
    function luminance(hex){
      const c = hex.replace('#','');
      if(c.length<6) return 0;
      const r=parseInt(c.slice(0,2),16)/255, g=parseInt(c.slice(2,4),16)/255, b=parseInt(c.slice(4,6),16)/255;
      const a=[r,g,b].map(v=>v<=0.03928? v/12.92: Math.pow((v+0.055)/1.055,2.4));
      return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2];
    }

    // ============ Telegram init ============
    const inTelegram = !!(tg && tg.initDataUnsafe);
    if (inTelegram) {
      tg.ready?.();
      tg.expand?.();
      applyThemeFromTG();
      // MainButton
      tg.MainButton.setParams({text:"‚ú® –ì–ª—É–±–æ–∫–æ–µ —á—Ç–µ–Ω–∏–µ",is_active:true,is_visible:true});
      tg.onEvent('mainButtonClicked', ()=> {
        send('gen','deep');
      });
      // BackButton
      tg.BackButton.show();
      tg.onEvent('backButtonClicked', ()=> window.scrollTo({top:0,behavior:'smooth'}));
    } else {
      // Browser mode
      envChip.textContent = 'Browser preview';
      browserBlock.style.display = 'block';
    }

    // ============ Form helpers ============
    const KEY='oracle_webapp_cache_v2';
    function save(){
      localStorage.setItem(KEY, JSON.stringify({
        t: topicEl.value, d: dobEl.value, g: genderEl.value, c: ctxEl.value
      }));
    }
    function load(){
      try{
        const v = JSON.parse(localStorage.getItem(KEY)||'null');
        if(v){ topicEl.value=v.t||'overall'; dobEl.value=v.d||''; genderEl.value=v.g||''; ctxEl.value=v.c||''; }
      }catch(e){}
    }
    [topicEl,dobEl,genderEl,ctxEl].forEach(el=>el.addEventListener('change', save));
    load();

    // ============ Validation ============
    function validate(mode){
      const ctx = (ctxEl.value||'').trim();
      if (ctx.length > 500) return fail("–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–º–∞–∫—Å. 500 —Å–∏–º–≤.)");
      // deep: —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ
      if (mode === 'deep'){
        if (!ctx) return fail("–î–æ–±–∞–≤—å 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Äî —Ç–∞–∫ —á—Ç–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ç–æ—á–Ω–µ–µ.");
      }
      // dob format auto-checked by input[type=date]
      return true;
    }
    function fail(msg){
      toast(msg, 'error');
      haptic('error');
      return false;
    }

    // ============ Payload / Send ============
    function buildPayload(action, mode){
      return {
        action,             // 'gen' | 'pay'
        mode,               // 'mini' | 'deep' | null
        topic: (topicEl.value||'overall').trim(),
        dob: (dobEl.value||'').trim(),           // YYYY-MM-DD
        gender: (genderEl.value||'').trim(),     // male|female|other
        context: (ctxEl.value||'').trim()
      };
    }

    function send(action, mode){
      if (!validate(mode)) return;
      const data = buildPayload(action, mode);
      if (!inTelegram || !tg.sendData){
        // Browser preview
        previewEl.classList.remove('hidden');
        previewEl.textContent = "PREVIEW ‚Äî JSON, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –±–æ—Ç—É:\n\n" + JSON.stringify(data,null,2);
        return;
      }
      tg.MainButton.showProgress?.();
      try {
        tg.sendData(JSON.stringify(data));
        toast(action==='pay' ? "–û—Ç–∫—Ä—ã–ª –º–µ–Ω—é –ø–æ–∫—É–ø–∫–∏ –≤ –±–æ—Ç–µ." : "–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –æ—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.");
        haptic('impact');
      } finally {
        setTimeout(()=>tg.MainButton.hideProgress?.(), 400);
      }
    }

    // ============ UX: haptics & popups ============
    function haptic(type){
      try{
        if (!tg?.HapticFeedback) return;
        if (type==='impact') tg.HapticFeedback.impactOccurred('medium');
        if (type==='error')  tg.HapticFeedback.notificationOccurred('error');
        if (type==='success')tg.HapticFeedback.notificationOccurred('success');
      }catch(e){}
    }
    function toast(message, kind='info'){
      if (!inTelegram || !tg.showPopup) {
        console.log(`[${kind}] ${message}`);
        return;
      }
      const title = kind==='error'?'–û—à–∏–±–∫–∞': (kind==='success'?'–ì–æ—Ç–æ–≤–æ':'–û—Ä–∞–∫–ª');
      tg.showPopup({title, message, buttons:[{id:"ok", type:"ok", text:"–û–ö"}]});
    }

    // ============ Bind buttons ============
    qs('#btnMini').addEventListener('click', ()=> send('gen','mini'));
    qs('#btnDeep').addEventListener('click', ()=> send('gen','deep'));
    qs('#btnPay'). addEventListener('click', ()=> send('pay',null));

    // ============ Utility ============
    qs('#copyUrl').addEventListener('click', (e)=>{
      e.preventDefault();
      navigator.clipboard.writeText(location.href).then(()=> toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞.",'success'));
    });
  </script>
</body>
</html>
