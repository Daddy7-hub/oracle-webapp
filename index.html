<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Oracle Quest ‚Äî –º–∏–Ω–∏-–∞–ø–ø</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#0b0f1c; --panel:#0f1530; --card:#121a3a; --line:rgba(255,255,255,.06);
    --text:#eef1ff; --muted:#a9b6ff; --acc:#7aa2ff; --acc2:#74f1d1; --warn:#ffd166; --err:#ff6b6b; --ok:#38d39f;
    --glow:0 10px 30px rgba(122,162,255,.25);
    --r:18px; --g:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 900px at 120% -20%, #1a2250 0,#0b0f1c 60%) fixed,
      radial-gradient(900px 700px at -30% 120%, #0f1330 0,#0b0f1c 55%) fixed,
      linear-gradient(180deg,#0c1022,#0b0f1c);
    color:var(--text);
    font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  }
  .app{max-width:980px;margin:0 auto;padding:18px}
  .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{
    width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
    background:conic-gradient(from 190deg,#74f1d1,#7aa2ff 45%,#74f1d1 100%); color:#0b0f1c;font-weight:900;
    box-shadow:0 10px 35px rgba(116,241,209,.25);
  }
  .title{font-weight:800;letter-spacing:.2px}
  .chip{border:1px solid var(--line);background:#0e1330;padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}

  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--g)}
  .card{
    grid-column:span 12;background:linear-gradient(135deg,var(--card),#0f1530);
    border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--glow); padding:14px;
  }
  @media(min-width:860px){ .half{grid-column:span 6} .third{grid-column:span 4} .wide{grid-column:span 12} }

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .stat{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:#0d1330;border:1px solid var(--line)}
  .stat b{font-size:18px}
  .bar{height:10px;border-radius:999px;background:#0c122a;border:1px solid var(--line);position:relative;overflow:hidden}
  .bar>i{position:absolute;inset:0 0 0 0;width:0%;background:linear-gradient(90deg,#7aa2ff,#74f1d1);border-radius:999px;transition:width .3s ease}

  .tap{
    display:grid;place-items:center;aspect-ratio:1/1;border-radius:20px;border:1px solid var(--line);
    background:
      radial-gradient(600px 300px at 50% 0%, rgba(122,162,255,.15), transparent 70%),
      linear-gradient(135deg,#131c40,#0f1530);
    box-shadow: var(--glow), inset 0 0 0 1px rgba(255,255,255,.02);
    user-select:none; cursor:pointer; position:relative; overflow:hidden;
  }
  .tap .score{font-size:42px;font-weight:900;letter-spacing:.5px}
  .tap .lbl{color:var(--muted);font-size:12px}
  .pulse{position:absolute;border-radius:50%;pointer-events:none;border:2px solid rgba(116,241,209,.5);transform:scale(0);opacity:.9;animation:pulse .6s ease-out forwards}
  @keyframes pulse{to{transform:scale(8);opacity:0}}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 12px;border-radius:14px;
    border:1px solid var(--line);background:linear-gradient(135deg,#1a2350,#121a3a);color:var(--text);cursor:pointer;user-select:none}
  .btn:active{transform:translateY(1px)}
  .btn.ok{background:linear-gradient(135deg,#1a4f3a,#153b2c);border-color:rgba(56,211,159,.35)}
  .btn.pay{background:linear-gradient(135deg,#24307a,#1a2350);border-color:rgba(122,162,255,.35)}
  .btn.ghost{background:#0d1330}
  .btn.full{width:100%}

  .shop{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .pack{padding:12px;border-radius:14px;background:#0d1330;border:1px solid var(--line);text-align:center}
  .pack b{font-size:18px}
  .pack .stars{color:#ffe27a}

  .task{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0e1330}
  .task.done{opacity:.6}
  .task .t{font-weight:600}
  .task .r{color:var(--muted);font-size:12px}
  .badge{padding:4px 8px;border-radius:999px;background:#0b1229;border:1px solid var(--line);color:var(--muted);font-size:12px}

  .notice{padding:12px;border:1px dashed var(--line);border-radius:14px;background:#0e1330;color:var(--muted)}
  .hint{color:var(--muted);font-size:12px}

  .preview{white-space:pre-wrap;background:#0d1330;border:1px dashed var(--line);border-radius:12px;padding:12px;margin-top:8px}
  .hidden{display:none}

  /* Light mode via TG theme */
  .light .card{background:linear-gradient(135deg,#ffffff,#f5f7ff);border-color:#e7ebff}
  .light body{background:linear-gradient(180deg,#eff2ff,#e9edff)}
  .light .tap{background:linear-gradient(135deg,#f1f3ff,#e9edff)}
  .light .btn{background:linear-gradient(135deg,#eef1ff,#e7ebff);color:#141936}
  .light .btn.pay{background:linear-gradient(135deg,#e5ebff,#dde4ff)}
  .light .btn.ok{background:linear-gradient(135deg,#e6fbf3,#d7f6ea)}
  .light .stat,.light .pack,.light .task,.light .notice,.light .preview{background:#fff;border-color:#e7ebff}
  .light .chip{background:#fff;border-color:#e7ebff;color:#3a408e}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="brand">
      <div class="logo">üîÆ</div>
      <div>
        <div class="title">Oracle Quest</div>
        <div class="hint">–¢–∞–ø–∞–π –∫—Ä–∏—Å—Ç–∞–ª–ª, —É–ª—É—á—à–∞–π—Å—è, –ø–æ–ª—É—á–∞–π —á—Ç–µ–Ω–∏—è. –ö–∞–∫ —É ¬´—Ö–æ–º—è–∫–∞¬ª, –Ω–æ –ø—Ä–æ –û—Ä–∞–∫—É–ª üòé</div>
      </div>
    </div>
    <div class="chip" id="envChip">WebApp</div>
  </div>

  <div class="grid">
    <!-- STATS -->
    <div class="card wide">
      <div class="row">
        <div class="stat"><span>üíé</span><div><div class="r">–ö—Ä–µ–¥–∏—Ç—ã</div><b id="credits">0</b></div></div>
        <div class="stat"><span>‚ö°</span><div><div class="r">–≠–Ω–µ—Ä–≥–∏—è</div><div class="bar" style="width:180px"><i id="energyBar"></i></div></div><b id="energy" style="margin-left:8px">0</b></div>
        <div class="stat"><span>‚¨ÜÔ∏è</span><div><div class="r">–ú–Ω–æ–∂–∏—Ç–µ–ª—å</div><b id="mult">x1</b></div></div>
        <div class="stat"><span>üéØ</span><div><div class="r">–£—Ä–æ–≤–µ–Ω—å</div><b id="lvl">1</b></div></div>
      </div>
    </div>

    <!-- TAP -->
    <div class="card half">
      <div id="tap" class="tap">
        <div>
          <div class="lbl" style="text-align:center;margin-bottom:6px">—Ç–∞–ø–∞–π —á—Ç–æ–±—ã –¥–æ–±—ã—Ç—å ¬´–∏–Ω—Å–∞–π—Ç—ã¬ª</div>
          <div class="score" id="score">0</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="btnClaim">üéÅ –ü–æ–ª—É—á–∏—Ç—å –º–∏–Ω–∏-—á—Ç–µ–Ω–∏–µ</button>
        <button class="btn ghost" id="btnDeep">‚ú® –ì–ª—É–±–æ–∫–æ–µ —á—Ç–µ–Ω–∏–µ</button>
      </div>
      <div class="hint" style="margin-top:6px">–ú–∏–Ω–∏-—á—Ç–µ–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ (–ø–æ –ª–∏–º–∏—Ç—É). –ì–ª—É–±–æ–∫–æ–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç 1 –∫—Ä–µ–¥–∏—Ç (–∏–ª–∏ –¥–µ–º–æ —Ä–∞–∑ –≤ 7 –¥–Ω–µ–π).</div>
    </div>

    <!-- UPGRADES / SHOP -->
    <div class="card half">
      <div class="row">
        <div class="badge">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="hint">–ü–æ–∫—É–ø–∫–∞ –≤ ‚≠ê —á–µ—Ä–µ–∑ –±–æ—Ç–∞</div>
      </div>
      <div class="shop" style="margin-top:10px">
        <div class="pack">
          <div class="r">–ü–∞–∫–µ—Ç</div>
          <b>1 –∫—Ä–µ–¥–∏—Ç</b>
          <div class="stars" style="margin:6px 0">50 ‚≠ê</div>
          <button class="btn pay full" data-pack="1">–ö—É–ø–∏—Ç—å</button>
        </div>
        <div class="pack">
          <div class="r">–ü–∞–∫–µ—Ç</div>
          <b>5 –∫—Ä–µ–¥–∏—Ç–æ–≤</b>
          <div class="stars" style="margin:6px 0">240 ‚≠ê</div>
          <button class="btn pay full" data-pack="5">–ö—É–ø–∏—Ç—å</button>
        </div>
        <div class="pack">
          <div class="r">–ü–∞–∫–µ—Ç</div>
          <b>10 –∫—Ä–µ–¥–∏—Ç–æ–≤</b>
          <div class="stars" style="margin:6px 0">450 ‚≠ê</div>
          <button class="btn pay full" data-pack="10">–ö—É–ø–∏—Ç—å</button>
        </div>
      </div>
      <div class="sep" style="margin:12px 0"></div>
      <div class="row">
        <button class="btn full" id="btnBoost">‚ö° –≠–Ω–µ—Ä–≥–∏—è +50</button>
        <button class="btn full" id="btnMult">‚¨ÜÔ∏è –ú–Ω–æ–∂–∏—Ç–µ–ª—å +0.1</button>
      </div>
      <div class="hint" style="margin-top:8px">–ë—É—Å—Ç—ã –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ (–¥–ª—è —Ñ–∞–Ω–∞), —Ä–µ–∞–ª—å–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã ‚Äî —á–µ—Ä–µ–∑ ‚≠ê.</div>
    </div>

    <!-- TASKS -->
    <div class="card wide">
      <div class="row">
        <div class="badge">–ö–≤–µ—Å—Ç—ã</div>
        <div class="hint">–î–µ–ª–∞–π –∑–∞–¥–∞–Ω–∏—è ‚Äî –∑–∞–±–∏—Ä–∞–π –∫—Ä–µ–¥–∏—Ç—ã</div>
      </div>
      <div id="tasks" style="margin-top:10px"></div>
    </div>

    <!-- PROFILE -->
    <div class="card wide">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="badge">–ê–Ω–∫–µ—Ç–∞</div>
          <div class="hint">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –±–æ—Ç–∞ –≤–º–µ—Å—Ç–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º</div>
        </div>
        <div class="chip" id="previewMode" style="display:none">Browser preview</div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:220px">
          <div class="hint">–¢–µ–º–∞</div>
          <select id="topic" style="width:100%">
            <option value="career">–ö–∞—Ä—å–µ—Ä–∞</option>
            <option value="love">–õ—é–±–æ–≤—å</option>
            <option value="finance">–§–∏–Ω–∞–Ω—Å—ã</option>
            <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
            <option value="overall" selected>–û–±—â–µ–µ</option>
          </select>
        </div>
        <div>
          <div class="hint">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</div>
          <input id="dob" type="date">
        </div>
        <div>
          <div class="hint">–ü–æ–ª</div>
          <select id="gender">
            <option value="">‚Äî</option>
            <option value="male">–º</option>
            <option value="female">–∂</option>
            <option value="other">–¥—Ä—É–≥–æ–π</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="hint">–ö–æ–Ω—Ç–µ–∫—Å—Ç (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)</div>
        <textarea id="context" rows="4" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏ —Å–∏—Ç—É–∞—Ü–∏—é / –≤–æ–ø—Ä–æ—Å‚Ä¶ (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
      </div>
      <div class="preview hidden" id="debugPreview"></div>
    </div>

    <!-- DISCLAIMER -->
    <div class="card wide">
      <div class="notice">‚ö†Ô∏è –î–∏—Å–∫–ª–µ–π–º–µ—Ä: —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.</div>
    </div>
  </div>
</div>

<script>
  // ===== Telegram SDK =====
  const tg = window.Telegram?.WebApp;
  const inTG = !!(tg && tg.initDataUnsafe);
  const envChip = document.getElementById('envChip');
  const prevChip = document.getElementById('previewMode');

  function applyTheme(){
    if(!inTG) { envChip.textContent = 'Browser'; return; }
    tg.ready?.(); tg.expand?.();
    const tp = tg.themeParams||{};
    const isLight = (tg.colorScheme==='light') || (tp.bg_color && luminance(tp.bg_color)>0.8);
    if (isLight) document.documentElement.classList.add('light');
    envChip.textContent = `WebApp ‚Ä¢ ${isLight?'light':'dark'}`;
  }
  function luminance(hex){
    const c=(hex||'').replace('#',''); if(c.length<6) return .1;
    const [r,g,b]=[0,2,4].map(i=>parseInt(c.slice(i,i+2),16)/255);
    const L=[r,g,b].map(v=>v<=.03928?v/12.92:Math.pow((v+.055)/1.055,2.4));
    return 0.2126*L[0]+0.7152*L[1]+0.0722*L[2];
  }
  applyTheme();

  // ===== State =====
  const els = {
    credits: $('#credits'), energy: $('#energy'), energyBar: $('#energyBar'),
    mult: $('#mult'), lvl: $('#lvl'), score: $('#score'),
    tap: $('#tap'), btnClaim: $('#btnClaim'), btnDeep: $('#btnDeep'),
    btnBoost: $('#btnBoost'), btnMult: $('#btnMult'),
    topic: $('#topic'), dob: $('#dob'), gender: $('#gender'), ctx: $('#context'),
    tasks: $('#tasks'), debug: $('#debugPreview')
  };
  const KEY='oracleq_v1';
  const state = load() || {
    credits: 0, score: 0, lvl: 1, mult: 1.0,
    energy: 100, energyMax: 100, regen: 6,   // +6/—Å–µ–∫ –¥–æ energyMax
    lastTick: Date.now(),
    tasks: [
      {id:'daily',   t:'–ó–∞–±–µ—Ä–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å',   r:'+1 –∫—Ä–µ–¥–∏—Ç',      done:false},
      {id:'profile', t:'–ó–∞–ø–æ–ª–Ω–∏ –∞–Ω–∫–µ—Ç—É',            r:'+1 –∫—Ä–µ–¥–∏—Ç',      done:false},
      {id:'follow',  t:'–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª',        r:'+1 –∫—Ä–µ–¥–∏—Ç',      done:false},
      {id:'invite',  t:'–í–≤–µ–¥–∏ —Ä–µ—Ñ.–∫–æ–¥ –¥—Ä—É–≥–∞',       r:'+1 –∫—Ä–µ–¥–∏—Ç',      done:false},
    ]
  };
  save();

  // ===== UI sync =====
  function fmt(n){return Math.floor(n).toLocaleString('ru-RU')}
  function sync(){
    els.credits.textContent = fmt(state.credits);
    els.score.textContent   = fmt(state.score);
    els.lvl.textContent     = fmt(state.lvl);
    els.mult.textContent    = 'x'+state.mult.toFixed(1);
    els.energy.textContent  = fmt(state.energy);
    const p = Math.max(0, Math.min(100, 100*state.energy/state.energyMax));
    els.energyBar.style.width = p+'%';
    renderTasks();
  }
  function renderTasks(){
    els.tasks.innerHTML='';
    state.tasks.forEach(task=>{
      const wrap = div('task'+(task.done?' done':''),`
        <div>
          <div class="t">${task.t}</div>
          <div class="r">${task.r}</div>
        </div>
        <div>
          <button class="btn ${task.done?'ghost':''}" data-task="${task.id}" ${task.done?'disabled':''}>${task.done?'‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ':'–ó–∞–±—Ä–∞—Ç—å'}</button>
        </div>
      `);
      els.tasks.appendChild(wrap);
    });
  }

  // ===== Engine (energy regen) =====
  function tick(){
    const now=Date.now(), dt=(now-state.lastTick)/1000; state.lastTick=now;
    state.energy = Math.min(state.energyMax, state.energy + state.regen*dt);
    sync(); save();
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // ===== Tap logic =====
  els.tap.addEventListener('click', (e)=>{
    if(state.energy<1){ toast('–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏'); haptic('error'); return; }
    const gain = 1*state.mult;
    state.score += gain;
    state.energy = Math.max(0, state.energy-1);
    pulse(e);
    levelUpIfNeeded();
    sync(); save();
  });
  function levelUpIfNeeded(){
    const need = state.lvl*100;
    if(state.score>=need){ state.lvl++; state.mult = +(state.mult+0.1).toFixed(1); confetti(); haptic('success'); }
  }
  function pulse(e){
    const p = document.createElement('span'); p.className='pulse';
    const r = e.currentTarget.getBoundingClientRect();
    p.style.left=(e.clientX-r.left)+'px'; p.style.top=(e.clientY-r.top)+'px';
    e.currentTarget.appendChild(p); setTimeout(()=>p.remove(),600);
  }
  function confetti(){
    if(!inTG || !tg.HapticFeedback) return;
    tg.HapticFeedback.impactOccurred('rigid');
  }

  // ===== Tasks click =====
  els.tasks.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-task]'); if(!b) return;
    const id = b.dataset.task; const task = state.tasks.find(t=>t.id===id);
    if(!task || task.done) return;
    if(id==='daily'){ state.credits+=1; task.done=true; }
    if(id==='profile'){ if(!els.dob.value || !els.gender.value){ return toast('–ó–∞–ø–æ–ª–Ω–∏ –î–† –∏ –ø–æ–ª'); } state.credits+=1; task.done=true; }
    if(id==='follow'){ toast('–û—Ç–∫—Ä–æ–π –∫–∞–Ω–∞–ª –∏–∑ –±–æ—Ç–∞ ‚Äî —Ç–∞–º –∫–Ω–æ–ø–∫–∞ ¬´–ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è¬ª'); state.credits+=1; task.done=true; }
    if(id==='invite'){
      const code = prompt('–í–≤–µ–¥–∏ —Ä–µ—Ñ.–∫–æ–¥'); if(!code) return;
      // –ü—Ä–æ—Å—Ç–æ –æ—Ç–º–µ—á–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ª–æ–∫–∞–ª—å–Ω–æ; —Ä–µ–∞–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å–¥–µ–ª–∞–µ—Ç –±–æ—Ç –ø–æ—Å–ª–µ sendData (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
      state.credits+=1; task.done=true;
    }
    sync(); save(); haptic('success');
  });

  // ===== Boosts (demo only) =====
  els.btnBoost.addEventListener('click', ()=>{ state.energy=Math.min(state.energyMax, state.energy+50); sync(); save(); haptic('impact'); });
  els.btnMult .addEventListener('click', ()=>{ state.mult=+(state.mult+0.1).toFixed(1); sync(); save(); haptic('impact'); });

  // ===== Reading buttons =====
  els.btnClaim.addEventListener('click', ()=> {
    sendToBot({action:'gen', mode:'mini', ...profilePayload()});
  });
  els.btnDeep.addEventListener('click', ()=> {
    // –ú—è–≥–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ—Å–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è deep
    if(!(els.ctx.value||'').trim()) return toast('–î–æ–±–∞–≤—å 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Äî —Ç–∞–∫ —Ç–æ—á–Ω–µ–µ üôå','warn');
    sendToBot({action:'gen', mode:'deep', ...profilePayload()});
  });

  // ===== Shop buttons (Stars) =====
  document.querySelectorAll('button.pay[data-pack]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const qty = +b.dataset.pack;
      sendToBot({action:'pay', pack:qty});
    });
  });

  // ===== Telegram helpers =====
  function sendToBot(obj){
    const payload = JSON.stringify(obj);
    if (!inTG || !tg.sendData){
      // preview mode
      prevChip.style.display='inline-flex';
      els.debug.classList.remove('hidden');
      els.debug.textContent = 'PREVIEW ‚Äî JSON, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –±–æ—Ç—É:\n\n' + payload;
      console.log('[preview send]', obj);
      return;
    }
    tg.MainButton.setParams({text:'–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶',is_visible:true}); tg.MainButton.showProgress?.();
    try{
      tg.sendData(payload);
      toast('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.','ok');
      haptic('impact');
    } finally {
      setTimeout(()=>{ tg.MainButton.hideProgress?.(); tg.MainButton.setParams({text:'‚ú® –ì–ª—É–±–æ–∫–æ–µ —á—Ç–µ–Ω–∏–µ'}); }, 500);
    }
  }

  function profilePayload(){
    return {
      topic: (els.topic.value||'overall').trim(),
      dob: (els.dob.value||'').trim(),          // YYYY-MM-DD
      gender: (els.gender.value||'').trim(),
      context: (els.ctx.value||'').trim().slice(0,500)
    };
  }

  function toast(message, kind='info'){
    if(!inTG || !tg.showPopup){ console.log(`[${kind}]`, message); return; }
    const title = kind==='ok'?'–ì–æ—Ç–æ–≤–æ': kind==='warn'?'–ü–æ–¥—Å–∫–∞–∑–∫–∞': kind==='error'?'–û—à–∏–±–∫–∞':'–û—Ä–∞–∫–ª';
    tg.showPopup({title, message, buttons:[{id:'ok',type:'ok',text:'–û–ö'}]});
  }
  function haptic(type){
    try{
      if(!tg?.HapticFeedback) return;
      if(type==='impact') tg.HapticFeedback.impactOccurred('medium');
      if(type==='success') tg.HapticFeedback.notificationOccurred('success');
      if(type==='error') tg.HapticFeedback.notificationOccurred('error');
    }catch(e){}
  }

  // ===== Persistence =====
  function save(){
    localStorage.setItem(KEY, JSON.stringify({
      credits:state.credits, score:state.score, lvl:state.lvl, mult:state.mult,
      energy:state.energy, energyMax:state.energyMax, regen:state.regen,
      lastTick:state.lastTick, tasks:state.tasks,
      topic:els.topic.value, dob:els.dob.value, gender:els.gender.value, context:els.ctx.value
    }));
  }
  function load(){
    try{
      const v = JSON.parse(localStorage.getItem(KEY)||'null');
      if(v){
        els.topic.value  = v.topic||'overall';
        els.dob.value    = v.dob||'';
        els.gender.value = v.gender||'';
        els.ctx.value    = v.context||'';
        return {
          credits:v.credits||0, score:v.score||0, lvl:v.lvl||1, mult:v.mult||1,
          energy:v.energy??100, energyMax:v.energyMax||100, regen:v.regen||6, lastTick:v.lastTick||Date.now(),
          tasks:v.tasks||[]
        };
      }
    }catch(e){}
    return null;
  }
  ['change','input'].forEach(ev=>{
    [els.topic,els.dob,els.gender,els.ctx].forEach(x=>x.addEventListener(ev, save));
  });

  sync();

  // ===== small helpers =====
  function $(s){return document.querySelector(s)}
  function div(cls,html){const d=document.createElement('div');d.className=cls;d.innerHTML=html;return d}
</script>
</body>
</html>
