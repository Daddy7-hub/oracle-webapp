<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CryptoATM.tech ‚Äî Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#0b0d12; --panel:#0f1320; --card:#151a2a; --muted:#9aa3b2; --txt:#e8edf4;
    --brand:#7c4dff; --acc:#00e5ff; --green:#27e1a7; --danger:#ff6a88; --gold:#ffd76a;
    --b1:1px solid rgba(255,255,255,.08); --r:14px; --rx:18px;
    --glow:0 0 0 1px rgba(124,77,255,.25), 0 10px 24px rgba(124,77,255,.18), 0 6px 16px rgba(0,229,255,.12);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 700px at 80% -10%, rgba(124,77,255,.15), transparent 60%),
      radial-gradient(900px 600px at -10% 20%, rgba(0,229,255,.12), transparent 60%), var(--bg);
    color:var(--txt); font:14px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;background:rgba(255,255,255,.03);border:var(--b1);border-radius:var(--rx);backdrop-filter:blur(6px)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 210deg,var(--brand),var(--acc),var(--green),var(--brand))}
  .brand h1{margin:0;font-size:18px}
  .brand p{margin:0;color:var(--muted);font-size:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;gap:6px;align-items:center;background:rgba(255,255,255,.05);border:var(--b1);border-radius:999px;padding:6px 10px}
  .pill{padding:6px 10px;background:rgba(124,77,255,.18);border:1px solid rgba(124,77,255,.38);border-radius:999px;font-weight:700;color:#d9ccff}

  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0 16px}
  .tab{border:var(--b1);border-radius:12px;background:#141927;color:var(--txt);padding:8px 12px;font-weight:700;cursor:pointer;user-select:none}
  .tab.active{background:linear-gradient(135deg,rgba(124,77,255,.2),rgba(0,229,255,.15));box-shadow:var(--glow)}

  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
  @media(max-width:980px){.col-8,.col-6,.col-4,.col-3{grid-column:span 12}}

  .card{background:var(--card);border:var(--b1);border-radius:var(--rx);padding:14px}
  .h{margin:0 0 8px}.subtle{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .price{font-weight:900}
  .tag{font-size:11px;opacity:.85;border:1px dashed rgba(255,255,255,.25);padding:2px 6px;border-radius:999px}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi .box{background:rgba(255,255,255,.03);border:var(--b1);border-radius:14px;padding:10px;text-align:center}
  .kpi b{font-size:18px}
  .list{display:flex;flex-direction:column;gap:8px}

  .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;transition:transform .05s ease, box-shadow .2s ease}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(135deg,var(--acc),var(--green));color:#0b0d12;box-shadow:var(--glow)}
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.35);color:var(--txt)}
  .btn.warn{background:linear-gradient(135deg,rgba(255,106,136,.9),#ff9bb1);color:#1a0f12}
  .btn.small{padding:7px 10px;border-radius:10px;font-weight:700}
  .btn.icon{display:inline-flex;align-items:center;gap:6px}

  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#121726;color:var(--txt)}
  textarea{min-height:86px;resize:vertical}
  .line{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed rgba(255,255,255,.1);padding-top:10px;margin-top:10px}
  .note{background:rgba(255,106,136,.12);border:1px solid rgba(255,106,136,.35);border-radius:12px;padding:10px;color:#ffdbe4}
  .ok{background:rgba(39,225,167,.12);border:1px solid rgba(39,225,167,.35);border-radius:12px;padding:10px;color:#d9ffef}

  /* modal / sheet */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;z-index:40}
  .modal.show{display:flex}
  .sheet{background:var(--panel);width:min(100%,900px);border-radius:18px 18px 0 0;border:var(--b1);padding:14px}
  .sheet h3{margin:4px 0 10px}
  .sheet .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}

  .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);margin:8px 0}

  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th{color:var(--muted);font-weight:600;text-align:left;font-size:12px;padding:0 6px}
  .table td{background:rgba(255,255,255,.03);border:var(--b1);padding:10px;border-radius:10px}

  .switch{position:relative;display:inline-block;width:48px;height:28px}
  .switch input{display:none}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#243147;border-radius:999px}
  .slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;top:3px;background:#fff;border-radius:50%;transition:.2s}
  .switch input:checked + .slider{background:linear-gradient(135deg,var(--acc),var(--green))}
  .switch input:checked + .slider:before{transform:translateX(20px)}
</style>
</head>
<body>
<div class="wrap">
  <!-- HEADER -->
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 style="display:flex;gap:8px;align-items:center">CryptoATM.tech <span class="tag">mini-app</span></h1>
        <p>–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ ATM-–º–æ–Ω–µ—Ç—ã ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã ‚Ä¢ –ó–∞–¥–∞–Ω–∏—è ‚Ä¢ –†–æ–∑—ã–≥—Ä—ã—à–∏</p>
      </div>
    </div>
    <div class="chips">
      <div class="chip">üë§ <b id="u-name">@guest</b></div>
      <div class="chip">ATM: <b id="u-atm">0</b></div>
      <div class="chip">üß∫ <b id="u-cart">0</b></div>
    </div>
  </header>

  <!-- NAV -->
  <nav class="tabs" id="tabs">
    <button class="tab active" data-tab="shop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="tab" data-tab="wallet">üí∞ –ö–æ—à–µ–ª—ë–∫</button>
    <button class="tab" data-tab="tasks">üß© –ó–∞–¥–∞–Ω–∏—è</button>
    <button class="tab" data-tab="ref">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
    <button class="tab" data-tab="raffle">üèÜ –†–æ–∑—ã–≥—Ä—ã—à</button>
    <button class="tab" data-tab="profile">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="tab" data-tab="faq">‚ùì FAQ</button>
    <button class="tab" id="admin-tab" data-tab="admin" hidden>üõ† Admin</button>
  </nav>

  <!-- SHOP -->
  <section id="tab-shop" class="grid">
    <div class="col-12 card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h3 class="h">–¢–∞—Ä–∏—Ñ—ã –∏ –±–æ—Ç—ã</h3>
          <p class="subtle">–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞(–æ–≤) –∏–ª–∏ –ø–∞–∫–µ—Ç, —Å—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –∫—É–ø–æ–Ω. –ö–æ—Ä–∑–∏–Ω–∞ –≤–Ω–∏–∑—É.</p>
        </div>
        <div class="row">
          <span class="pill">–°–∫–∏–¥–∫–∏ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 3–º/6–º</span>
        </div>
      </div>
    </div>

    <!-- —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="col-12 card">
      <div class="row" style="justify-content:space-between;gap:10px">
        <div class="row">
          <select id="duration">
            <option value="1">1 –º–µ—Å—è—Ü</option>
            <option value="3">3 –º–µ—Å—è—Ü–∞ (‚àí10%)</option>
            <option value="6">6 –º–µ—Å—è—Ü–µ–≤ (‚àí20%)</option>
          </select>
          <input id="coupon" placeholder="–ö—É–ø–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, WELCOME10)" />
          <button class="btn ghost small" data-action="shop.applyCoupon">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="row">
          <label class="row" style="gap:8px;align-items:center">
            –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–∞–∫–µ—Ç—ã
            <span class="switch"><input id="only-packs" type="checkbox"><span class="slider"></span></span>
          </label>
        </div>
      </div>
    </div>

    <div id="tariffs" class="col-12 grid"></div>

    <div class="col-12 card">
      <h3 class="h">–ö–æ—Ä–∑–∏–Ω–∞</h3>
      <div id="cart-list" class="subtle">–ü—É—Å—Ç–æ</div>
      <div class="divider"></div>
      <div class="row" style="justify-content:space-between">
        <div>
          <div>–ò—Ç–æ–≥–æ: <span class="price">‚Ç¨<span id="cart-total">0</span></span>
            <span class="subtle">–∏–ª–∏</span> <span class="price"><span id="cart-total-atm">0</span> ATM</span></div>
          <div class="subtle" id="cart-discounts">–ë–µ–∑ —Å–∫–∏–¥–æ–∫</div>
        </div>
        <div class="row">
          <button class="btn ghost" data-action="cart.clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button class="btn primary" data-action="checkout.open">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
        </div>
      </div>
      <div class="note" style="margin-top:10px">ATM-–æ–ø–ª–∞—Ç–∞ ‚âà –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è ‚Äî –º–æ–Ω–µ—Ç—ã —Ü–µ–Ω–Ω—ã –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π, –∞ –µ–≤—Ä–æ ‚Äî –±—ã—Å—Ç—Ä–µ–µ.</div>
    </div>
  </section>

  <!-- WALLET -->
  <section id="tab-wallet" class="grid" hidden>
    <div class="col-12 card">
      <h3 class="h">–ö–æ—à–µ–ª—ë–∫ ATM</h3>
      <div class="kpi" style="margin:8px 0 12px">
        <div class="box">–ë–∞–ª–∞–Ω—Å<br><b id="atm-balance">0</b></div>
        <div class="box">–ö–ª–∏–∫–∏ —Å–µ–≥–æ–¥–Ω—è<br><b id="atm-tap-left">100</b></div>
        <div class="box">Daily –±–æ–Ω—É—Å<br><b id="atm-daily">–Ω–µ –ø–æ–ª—É—á–µ–Ω</b></div>
        <div class="box">–ó–∞—á–∏—Å–ª–µ–Ω–∏—è (30–¥)<br><b id="atm-earn-30d">0</b></div>
      </div>
      <div class="row">
        <button class="btn primary small" data-action="wallet.daily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π +1</button>
        <button class="btn ghost small" data-action="wallet.tap">–ö–ª–∏–∫ +1 (–ª–∏–º–∏—Ç)</button>
      </div>

      <div class="line">
        <div class="row" style="flex:1">
          <input id="buy-usdt" type="number" value="50" min="5" step="1" placeholder="–°—É–º–º–∞ USDT">
          <select id="buy-chain">
            <option value="TRC20">TRC20</option>
            <option value="BEP20">BEP20</option>
            <option value="ERC20">ERC20</option>
          </select>
        </div>
        <div class="row">
          <button class="btn primary" data-action="wallet.buy">–ö—É–ø–∏—Ç—å ATM</button>
        </div>
      </div>

      <div class="divider"></div>
      <h4 class="h" style="margin-top:0">–ò—Å—Ç–æ—Ä–∏—è</h4>
      <table class="table" id="tx-table">
        <thead><tr>
          <th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        </tr></thead>
        <tbody id="tx-body"><tr><td colspan="4" class="subtle" style="padding:8px">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- TASKS -->
  <section id="tab-tasks" class="grid" hidden>
    <div class="col-12 card">
      <h3 class="h">–ó–∞–¥–∞–Ω–∏—è</h3>
      <p class="subtle">–ü—Ä—É—Ñ ‚Üí –º–æ–¥–µ—Ä–∞—Ü–∏—è ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ ATM. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ.</p>
      <div id="tasks" class="grid"></div>
    </div>
  </section>

  <!-- REFERRALS -->
  <section id="tab-ref" class="grid" hidden>
    <div class="col-12 card">
      <h3 class="h">–†–µ—Ñ–µ—Ä–∞–ª—ã</h3>
      <div class="row" style="justify-content:space-between">
        <div class="list" style="min-width:280px">
          <div>–í–∞—à –∫–æ–¥: <b id="ref-my">REF0</b></div>
          <input id="ref-code" placeholder="–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ–¥: REF123456" />
          <div class="row">
            <button class="btn primary small" data-action="ref.bind">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button>
            <button class="btn ghost small" data-action="ref.copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–æ–¥</button>
          </div>
          <div class="subtle">–ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ ‚Äî –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ ATM. –î–ª—è Premium/Enterprise ‚Äî –ø–æ–≤—ã—à–µ–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã.</div>
        </div>
        <div class="list" style="flex:1">
          <div class="kpi">
            <div class="box">–ü–µ—Ä–µ—Ö–æ–¥—ã<br><b id="ref-clicks">0</b></div>
            <div class="box">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏<br><b id="ref-signed">0</b></div>
            <div class="box">–û–ø–ª–∞—Ç—ã<br><b id="ref-paid">0</b></div>
            <div class="box">ATM –æ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤<br><b id="ref-atm">0</b></div>
          </div>
          <div class="divider"></div>
          <h4 class="h" style="margin:0">–¢–æ–ø –Ω–µ–¥–µ–ª–∏</h4>
          <div id="ref-top" class="list"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- RAFFLE -->
  <section id="tab-raffle" class="grid" hidden>
    <div class="col-12 card">
      <h3 class="h">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à</h3>
      <div class="row">
        <button class="btn primary" data-action="raffle.optin">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</button>
        <button class="btn ghost" data-action="raffle.rules">–ü—Ä–∞–≤–∏–ª–∞</button>
      </div>
      <div class="divider"></div>
      <div class="grid">
        <div class="col-6 card">
          <h4 class="h">–í–∞—à —à–∞–Ω—Å</h4>
          <p class="subtle">–í–µ—Å —Ä–∞–≤–µ–Ω –±–∞–ª–∞–Ω—Å—É ATM. –ß–µ–º –±–æ–ª—å—à–µ ‚Äî —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å.</p>
          <div class="kpi">
            <div class="box">–í–∞—à ATM<br><b id="raffle-atm">0</b></div>
            <div class="box">ATM –ø—É–ª–∞<br><b id="raffle-pool">0</b></div>
            <div class="box">–í–∞—à —à–∞–Ω—Å<br><b id="raffle-chance">0%</b></div>
            <div class="box">–°—Ç–∞—Ç—É—Å<br><b id="raffle-status">–Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ</b></div>
          </div>
        </div>
        <div class="col-6 card">
          <h4 class="h">–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –ø—Ä–æ—à–ª–æ–≥–æ –º–µ—Å—è—Ü–∞</h4>
          <div id="raffle-winners" class="list"><div class="subtle">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="tab-profile" class="grid" hidden>
    <div class="col-12 card">
      <h3 class="h">–ü—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div class="grid">
        <div class="col-6">
          <div class="list">
            <label>–ò–º—è/—é–∑–µ—Ä–Ω–µ–π–º
              <input id="prof-name" placeholder="@username" />
            </label>
            <label>Email (–¥–ª—è —á–µ–∫–æ–≤)
              <input id="prof-email" type="email" placeholder="you@example.com" />
            </label>
            <label>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
              <select id="prof-notify">
                <option value="all">–í—Å–µ</option>
                <option value="important">–¢–æ–ª—å–∫–æ –≤–∞–∂–Ω–æ–µ</option>
                <option value="none">–í—ã–∫–ª—é—á–µ–Ω—ã</option>
              </select>
            </label>
            <div class="row">
              <button class="btn primary small" data-action="profile.save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn ghost small" data-action="profile.export">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="list">
            <div class="kpi">
              <div class="box">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏<br><b id="prof-subs">0</b></div>
              <div class="box">–ò—Å—Ç–µ–∫–∞—é—Ç –≤ 30–¥<br><b id="prof-expiring">0</b></div>
              <div class="box">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ ‚Ç¨<br><b id="prof-spent">0</b></div>
              <div class="box">–ü–æ–ª—É—á–µ–Ω–æ ATM<br><b id="prof-earn">0</b></div>
            </div>
            <div class="divider"></div>
            <h4 class="h" style="margin:0">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h4>
            <div class="row">
              <button class="btn ghost small" data-action="support.chat">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
              <button class="btn ghost small" data-action="support.mail">–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞ email</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ADMIN (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN_ID) -->
  <section id="tab-admin" class="grid" hidden>
    <div class="col-12 card">
      <h3 class="h">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
      <p class="subtle">–í–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º. –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –æ–±–∑–æ—Ä.</p>
      <div class="grid">
        <div class="col-6 card">
          <h4 class="h">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
          <div class="list">
            <div class="row">
              <input id="adm-user" placeholder="Telegram ID / @user" />
              <input id="adm-atm" type="number" placeholder="+ATM" />
              <button class="btn primary small" data-action="admin.grant.atm">–ó–∞—á–∏—Å–ª–∏—Ç—å ATM</button>
            </div>
            <div class="row">
              <input id="adm-coupon" placeholder="COUPON10" />
              <input id="adm-discount" type="number" placeholder="% –∏–ª–∏ ‚Ç¨" />
              <button class="btn primary small" data-action="admin.coupon">–°–æ–∑–¥–∞—Ç—å –∫—É–ø–æ–Ω</button>
            </div>
            <div class="row">
              <input id="adm-task" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è" />
              <input id="adm-reward" type="number" placeholder="–ù–∞–≥—Ä–∞–¥–∞ ATM" />
              <button class="btn primary small" data-action="admin.task">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
            </div>
          </div>
        </div>
        <div class="col-6 card">
          <h4 class="h">–°—Ç–∞—Ç—É—Å</h4>
          <div class="kpi">
            <div class="box">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏<br><b id="adm-users">0</b></div>
            <div class="box">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏<br><b id="adm-subs">0</b></div>
            <div class="box">–ó–∞—è–≤–∫–∏ –Ω–∞ ATM<br><b id="adm-buys">0</b></div>
            <div class="box">–ü—Ä—É—Ñ—ã –≤ –æ—á–µ—Ä–µ–¥–∏<br><b id="adm-queue">0</b></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- CHECKOUT SHEET -->
<div class="modal" id="checkout-modal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
      <button class="btn ghost small" data-action="checkout.close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="co-items" class="list" style="margin:8px 0"></div>
    <div class="divider"></div>
    <div class="row" style="justify-content:space-between">
      <div>
        <div>–ò—Ç–æ–≥–æ: ‚Ç¨<b id="co-total-eur">0</b> / <b id="co-total-atm">0</b> ATM</div>
        <div class="subtle" id="co-discounts">–ë–µ–∑ —Å–∫–∏–¥–æ–∫</div>
      </div>
      <div class="row">
        <button class="btn primary" data-action="co.pay.eur">–û–ø–ª–∞—Ç–∏—Ç—å ‚Ç¨</button>
        <button class="btn primary" data-action="co.pay.atm">–û–ø–ª–∞—Ç–∏—Ç—å ATM</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== Telegram bridge
  const tg = window.Telegram?.WebApp;
  if (tg) { try { tg.expand(); tg.enableClosingConfirmation(); } catch(e){} }

  // ===== Constants / Catalog (—Ü–µ–Ω—ã –∫–∞–∫ –Ω–∞ —Å–∞–π—Ç–µ)
  const ADMIN_ID = 568646738; // –ø–æ–∫–∞–∂–µ—Ç Admin —Ç–∞–±, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å user.id

  const CATALOG = [
    {type:'bot', code:'CRYPTO_ATM_BOT', name:'Crypto ATM Bot', price_eur:71,  price_atm:2800, desc:'BTC-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —É—Ä–æ–≤–Ω–∏, SL/TP, –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏'},
    {type:'bot', code:'ALERTS_BOT',     name:'Alerts Bot',     price_eur:71,  price_atm:2800, desc:'–ö–∏—Ç—ã, –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏, funding, OI'},
    {type:'bot', code:'NEWS_BOT',       name:'News Bot',       price_eur:71,  price_atm:2800, desc:'–ù–æ–≤–æ—Å—Ç–∏, –¥–∞–π–¥–∂–µ—Å—Ç—ã, —Ñ–∏–ª—å—Ç—Ä—ã'},
    {type:'pack',code:'STANDARD',   name:'Standard (3 –±–æ—Ç–∞)', price_eur:150, price_atm:6000,  desc:'3 –ª—é–±—ã—Ö –±–æ—Ç–∞ ‚Ä¢ —á–∞—Ç ‚Ä¢ —Ä–µ—Ñ. –±–∞–∑–æ–≤–∞—è'},
    {type:'pack',code:'PREMIUM',    name:'Premium (4 –±–æ—Ç–∞)',  price_eur:191, price_atm:7600,  desc:'4 –±–æ—Ç–∞ ‚Ä¢ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ä–µ—Ñ. ‚Ä¢ lounge'},
    {type:'pack',code:'ENTERPRISE', name:'Enterprise (–≤—Å–µ)',   price_eur:249, price_atm:9900,  desc:'–í—Å–µ –±–æ—Ç—ã ‚Ä¢ VIP –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Ä¢ –±–æ–Ω—É—Å—ã'}
  ];

  // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
  let TASKS = [
    {id:1, title:'–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Instagram', reward:10, type:'link', hint:'–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å', once:true, status:'new'},
    {id:2, title:'–†–µ–ø–æ—Å—Ç —Å—Ç–æ—Ä–∏—Å',         reward:15, type:'link', hint:'–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–∏—Å',  once:true, status:'new'},
    {id:3, title:'–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞',      reward:25, type:'text', hint:'@username –¥—Ä—É–≥–∞',   once:false,status:'new'}
  ];

  // –ö—É–ø–æ–Ω—ã (–¥–µ–º–æ –≤–Ω—É—Ç—Ä–∏ —Ñ—Ä–æ–Ω—Ç–∞; –≤ –ø—Ä–æ–¥–µ –æ—Ç–¥–∞—ë—Ç –±—ç–∫)
  const COUPONS = {
    'WELCOME10': { kind:'percent', value:10,  note:'–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è -10%' },
    'SUMMER15':  { kind:'percent', value:15,  note:'–õ–µ—Ç–Ω—è—è -15%' },
    'VIP20':     { kind:'percent', value:20,  note:'VIP -20%' },
    'FIX10':     { kind:'fixed',   value:10,  note:'-‚Ç¨10' }
  };

  // ===== State (offline demo)
  const state = {
    user: {
      id: tg?.initDataUnsafe?.user?.id || 0,
      name: tg?.initDataUnsafe?.user?.username || 'guest',
      email: '',
      notify: 'all'
    },
    atm: 0,
    cart: [],
    cartMonth: 1,
    coupon: null,
    taps_left: 100,
    daily_claimed: false,
    tx: [],
    raffle: { pool: 0, opted: false, winners: [] },
    ref:   { clicks: 0, signed: 0, paid: 0, atm: 0, top: [] },
    profile: { subs: 0, expiring: 0, spent: 0, earn: 0 }
  };

  // ===== Helpers
  const $  = (s)=> document.querySelector(s);
  const $$ = (s)=> Array.from(document.querySelectorAll(s));
  function toast(t){
    if (tg?.showPopup) tg.showPopup({title:'', message:String(t)});
    else alert(t);
  }
  function sendData(obj){
    const payload = JSON.stringify(obj);
    if (tg?.sendData) tg.sendData(payload);
    else console.log('[offline send]', payload);
  }
  function addTx(type, amount, comment){
    state.tx.unshift({ ts:new Date().toISOString(), type, amount, comment });
    renderTx();
  }

  // ===== Pricing
  function calcCartTotals(){
    const months = state.cartMonth;
    const baseE = state.cart.reduce((s,x)=>s + x.price_eur, 0);
    const baseA = state.cart.reduce((s,x)=>s + x.price_atm, 0);
    let mul = months; // –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤
    let discRate = 0;
    if (months === 3) discRate = 0.10; else if (months === 6) discRate = 0.20;
    let totalE = Math.round((baseE * mul) * (1 - discRate));
    let totalA = Math.round((baseA * mul) * (1 - discRate));
    let discounts = [];
    if (discRate>0) discounts.push(`–∑–∞ ${months}–º: ‚àí${discRate*100|0}%`);
    if (state.coupon){
      const c = COUPONS[state.coupon] || {kind:'none'};
      if (c.kind==='percent'){
        const dE = Math.round(totalE * (c.value/100));
        totalE -= dE; discounts.push(`–∫—É–ø–æ–Ω ${state.coupon}: ‚àí${c.value}%`);
      }else if(c.kind==='fixed'){
        totalE = Math.max(0, totalE - c.value);
        discounts.push(`–∫—É–ø–æ–Ω ${state.coupon}: ‚àí‚Ç¨${c.value}`);
      }
    }
    return { totalE, totalA, discounts };
  }

  // ===== Render: Catalog
  function renderCatalog(){
    const holder = $('#tariffs'); holder.innerHTML='';
    const onlyPacks = $('#only-packs').checked;
    (onlyPacks ? CATALOG.filter(x=>x.type==='pack') : CATALOG).forEach(it=>{
      const el = document.createElement('div');
      el.className = 'col-4 card';
      el.innerHTML = `
        <h3 class="h">${it.name}</h3>
        <p class="subtle">${it.desc || ''}</p>
        <div class="row" style="margin:6px 0 8px">
          <span class="chip">‚Ç¨ <b>${it.price_eur}</b> / –º–µ—Å</span>
          <span class="chip"><b>${it.price_atm}</b> ATM</span>
          ${it.type==='pack' ? '<span class="tag">–ø–∞–∫–µ—Ç</span>' : '<span class="tag">–±–æ—Ç</span>'}
        </div>
        <div class="line">
          <span class="subtle">${it.type==='pack'?'–ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä':'–æ—Ç–¥–µ–ª—å–Ω—ã–π –±–æ—Ç'}</span>
          <div class="row">
            <button class="btn ghost small" data-action="item.info" data-code="${it.code}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
            <button class="btn primary small" data-action="cart.add" data-code="${it.code}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>`;
      holder.appendChild(el);
    });
  }

  // ===== Cart
  function updateCartUI(){
    $('#u-cart').textContent = String(state.cart.length);
    const list = $('#cart-list');
    if (state.cart.length===0) { list.textContent = '–ü—É—Å—Ç–æ'; }
    else {
      list.innerHTML = state.cart.map(x=>`
        <div class="line">
          <div>${x.name}</div>
          <div class="row">
            <span class="subtle">‚Ç¨${x.price_eur} / ${x.price_atm} ATM</span>
            <button class="btn ghost small" data-action="cart.remove" data-code="${x.code}">—É–±—Ä–∞—Ç—å</button>
          </div>
        </div>`).join('');
    }
    const { totalE, totalA, discounts } = calcCartTotals();
    $('#cart-total').textContent = totalE;
    $('#cart-total-atm').textContent = totalA;
    $('#cart-discounts').textContent = discounts.length? ('–°–∫–∏–¥–∫–∏: ' + discounts.join(', ')) : '–ë–µ–∑ —Å–∫–∏–¥–æ–∫';
  }

  // ===== Wallet
  function updateATMUI(){
    $('#u-atm').textContent       = String(state.atm);
    $('#atm-balance').textContent = String(state.atm);
    $('#atm-tap-left').textContent= String(state.taps_left);
    $('#atm-daily').textContent   = state.daily_claimed ? '–ø–æ–ª—É—á–µ–Ω' : '–Ω–µ –ø–æ–ª—É—á–µ–Ω';
    $('#raffle-atm').textContent  = String(state.atm);
    const pool = Math.max(state.raffle.pool, state.atm + 100); // –¥–µ–º–æ
    $('#raffle-pool').textContent = String(pool);
    const chance = pool ? Math.min(100, (state.atm / pool * 100)) : 0;
    $('#raffle-chance').textContent = (chance.toFixed(2)) + '%';
  }
  function renderTx(){
    const tbody = $('#tx-body'); tbody.innerHTML='';
    if (state.tx.length===0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="4" class="subtle" style="padding:8px">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td>`;
      tbody.appendChild(tr);
      return;
    }
    state.tx.forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(t.ts).toLocaleString()}</td>
        <td>${t.type}</td>
        <td>${t.amount}</td>
        <td class="subtle">${t.comment || ''}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ===== Tasks
  function renderTasks(){
    const holder = $('#tasks'); holder.innerHTML='';
    TASKS.forEach(t=>{
      const el = document.createElement('div');
      el.className='col-6 card';
      let statusTag = '';
      if (t.status==='sent')    statusTag = '<span class="tag">–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>';
      if (t.status==='done')    statusTag = '<span class="tag">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>';
      if (t.status==='rejected')statusTag = '<span class="tag" style="border-color:#ff6a88;color:#ff6a88">–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>';
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <h3 class="h">#${t.id} ${t.title}</h3>
          ${statusTag}
        </div>
        <p class="subtle">–ù–∞–≥—Ä–∞–¥–∞: <b>+${t.reward} ATM</b>${t.once? ' ‚Ä¢ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ':''}</p>
        <input data-task-proof="${t.id}" placeholder="${t.hint}" ${t.status==='done'?'disabled':''}>
        <div class="line">
          <span class="subtle">–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º</span>
          <button class="btn primary small" data-action="task.submit" data-id="${t.id}" ${t.status==='done'?'disabled':''}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>`;
      holder.appendChild(el);
    });
  }

  // ===== Referrals
  function renderRef(){
    $('#ref-my').textContent = 'REF'+(state.user.id||0);
    $('#ref-clicks').textContent  = state.ref.clicks;
    $('#ref-signed').textContent  = state.ref.signed;
    $('#ref-paid').textContent    = state.ref.paid;
    $('#ref-atm').textContent     = state.ref.atm;
    const top = $('#ref-top'); top.innerHTML='';
    const items = (state.ref.top.length ? state.ref.top : [
      {name:'@alpha', paid:3}, {name:'@beta', paid:2}, {name:'@gamma', paid:1}
    ]);
    items.forEach((u,i)=>{
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `<span class="chip">#${i+1}</span> <b>${u.name}</b> <span class="subtle">–æ–ø–ª–∞—Ç: ${u.paid}</span>`;
      top.appendChild(row);
    });
  }

  // ===== Profile
  function renderProfile(){
    $('#prof-name').value  = '@'+state.user.name;
    $('#prof-email').value = state.user.email || '';
    $('#prof-notify').value= state.user.notify || 'all';
    $('#prof-subs').textContent    = state.profile.subs;
    $('#prof-expiring').textContent= state.profile.expiring;
    $('#prof-spent').textContent   = state.profile.spent;
    $('#prof-earn').textContent    = state.profile.earn;
  }

  // ===== Admin
  function renderAdminTab(){
    const show = (state.user.id === ADMIN_ID);
    $('#admin-tab').hidden = !show;
  }

  // ===== Checkout modal
  function openCheckout(){
    const co = $('#checkout-modal');
    // –∑–∞–ø–æ–ª–Ω–∏—Ç—å
    const coList = $('#co-items'); coList.innerHTML='';
    state.cart.forEach(x=>{
      const d = document.createElement('div');
      d.className='line';
      d.innerHTML = `<div>${x.name}</div><div class="subtle">‚Ç¨${x.price_eur} / ${x.price_atm} ATM</div>`;
      coList.appendChild(d);
    });
    const { totalE, totalA, discounts } = calcCartTotals();
    $('#co-total-eur').textContent = totalE;
    $('#co-total-atm').textContent = totalA;
    $('#co-discounts').textContent = discounts.length? ('–°–∫–∏–¥–∫–∏: ' + discounts.join(', ')) : '–ë–µ–∑ —Å–∫–∏–¥–æ–∫';
    co.classList.add('show');
  }
  function closeCheckout(){ $('#checkout-modal').classList.remove('show'); }

  // ===== Navigation
  $('#tabs').addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab'); if(!btn) return;
    $$('.tab').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
    const name = btn.dataset.tab;
    $$('section[id^="tab-"]').forEach(s=> s.hidden = (s.id !== 'tab-'+name) );
    if(name==='shop'){ renderCatalog(); updateCartUI(); }
    if(name==='wallet'){ updateATMUI(); renderTx(); }
    if(name==='tasks'){ renderTasks(); }
    if(name==='ref'){ renderRef(); }
    if(name==='profile'){ renderProfile(); }
    if(name==='admin'){ /* dynamic stats could be pulled from backend */ }
  });

  // ===== Actions (delegation)
  document.body.addEventListener('click', (e)=>{
    const a = e.target.closest('[data-action]'); if(!a) return;
    const act = a.dataset.action;

    // shop
    if(act==='item.info'){
      const it = CATALOG.find(x=>x.code===a.dataset.code); if(!it) return;
      toast(`${it.name}\n\n${it.desc}\n\n‚Ç¨${it.price_eur}/–º–µ—Å –∏–ª–∏ ${it.price_atm} ATM`);
      return;
    }
    if(act==='cart.add'){
      const it = CATALOG.find(x=>x.code===a.dataset.code); if(!it) return;
      if (state.cart.some(x=>x.code===it.code)) return toast('–£–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ');
      state.cart.push({...it}); updateCartUI(); sendData({action:'cart_add', code:it.code});
      return;
    }
    if(act==='cart.remove'){
      const code = a.dataset.code; state.cart = state.cart.filter(x=>x.code!==code);
      updateCartUI(); sendData({action:'cart_remove', code}); return;
    }
    if(act==='cart.clear'){ state.cart=[]; updateCartUI(); sendData({action:'cart_clear'}); return; }
    if(act==='checkout.open'){ if(state.cart.length===0) return toast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); openCheckout(); return; }
    if(act==='checkout.close'){ closeCheckout(); return; }

    if(act==='co.pay.eur'){
      const { totalE } = calcCartTotals();
      const items = state.cart.map(x=>x.code);
      sendData({action:'checkout', method:'eur', months: state.cartMonth, coupon: state.coupon, items, total_eur: totalE});
      toast('–°—á—ë—Ç –≤ ‚Ç¨ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç'); addTx('Invoice EUR', '‚Ç¨'+totalE, '–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏');
      state.cart=[]; updateCartUI(); closeCheckout(); return;
    }
    if(act==='co.pay.atm'){
      const { totalA } = calcCartTotals();
      const items = state.cart.map(x=>x.code);
      sendData({action:'checkout', method:'atm', months: state.cartMonth, coupon: state.coupon, items, total_atm: totalA});
      // –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–µ–º–æ
      if(!tg){
        if(state.atm<totalA) return toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ATM (–¥–µ–º–æ)');
        state.atm -= totalA; updateATMUI(); addTx('Pay ATM', '-'+totalA, '–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–µ–º–æ)');
        state.profile.subs += 1; state.profile.spent += 0; // –µ–≤—Ä–æ –Ω–µ —Å–ø–∏—Å–∞–ª–∏
      }
      state.cart=[]; updateCartUI(); closeCheckout(); return;
    }

    // wallet
    if(act==='wallet.daily'){
      if(state.daily_claimed) return toast('–°–µ–≥–æ–¥–Ω—è —É–∂–µ –ø–æ–ª—É—á–µ–Ω–æ');
      state.daily_claimed = true; state.atm += 1; updateATMUI();
      sendData({action:'daily_claim'}); addTx('Daily', '+1', '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞'); return;
    }
    if(act==='wallet.tap'){
      if(state.taps_left<=0) return toast('–õ–∏–º–∏—Ç –∫–ª–∏–∫–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω');
      state.taps_left--; state.atm++; updateATMUI(); sendData({action:'tap'}); return;
    }
    if(act==='wallet.buy'){
      const usdt = parseInt($('#buy-usdt').value||'0',10), chain=$('#buy-chain').value;
      if(!usdt || usdt<5) return toast('–ú–∏–Ω–∏–º—É–º 5 USDT');
      sendData({action:'buy_atm', usdt, chain});
      toast(`–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É ${usdt} USDT (${chain}) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞`);
      addTx('Buy req', usdt+' USDT', chain); return;
    }

    // tasks
    if(act==='task.submit'){
      const id = Number(a.dataset.id);
      const proof = (document.querySelector(`[data-task-proof="${id}"]`)?.value || '').trim();
      if(!proof) return toast('–î–æ–±–∞–≤—å—Ç–µ –ø—Ä—É—Ñ');
      const t = TASKS.find(x=>x.id===id); if(!t) return;
      t.status = 'sent'; renderTasks();
      sendData({action:'task_submit', task_id:id, proof});
      toast('–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ.'); return;
    }

    // ref
    if(act==='ref.bind'){
      const code = ($('#ref-code').value||'').trim(); if(!code) return toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
      sendData({action:'ref_bind', code}); toast('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'); return;
    }
    if(act==='ref.copy'){
      const my = 'REF'+(state.user.id||0);
      navigator.clipboard?.writeText(my); toast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); return;
    }

    // raffle
    if(act==='raffle.optin'){
      state.raffle.opted = true; $('#raffle-status').textContent='—É—á–∞—Å—Ç–≤—É–µ—Ç–µ';
      sendData({action:'raffle_optin'}); toast('–í—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ'); return;
    }
    if(act==='raffle.rules'){
      toast('–ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü —Ä–æ–∑—ã–≥—Ä—ã—à. –í–µ—Å = –±–∞–ª–∞–Ω—Å ATM –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ä–µ–∑–∞. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Å–ª—É—á–∞–π–Ω—ã–π, –Ω–æ —Å –≤–µ—Å–æ–º.'); return;
    }

    // profile
    if(act==='profile.save'){
      state.user.name = ($('#prof-name').value||'').replace(/^@/,'') || state.user.name;
      state.user.email= $('#prof-email').value||'';
      state.user.notify=$('#prof-notify').value||'all';
      sendData({action:'profile_save', user:state.user}); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); return;
    }
    if(act==='profile.export'){
      sendData({action:'profile_export'}); toast('–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç'); return;
    }

    // admin
    if(act==='admin.grant.atm'){
      const who = $('#adm-user').value.trim(); const amt = parseInt($('#adm-atm').value||'0',10);
      if(!who||!amt) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
      sendData({action:'admin_grant_atm', user:who, amount:amt}); toast('–ó–∞—è–≤–∫–∞ –Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'); return;
    }
    if(act==='admin.coupon'){
      const c = $('#adm-coupon').value.trim(); const d = parseInt($('#adm-discount').value||'0',10);
      if(!c||!d) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫—É–ø–æ–Ω –∏ —Å–∫–∏–¥–∫—É');
      sendData({action:'admin_coupon', code:c, discount:d}); toast('–ö—É–ø–æ–Ω —Å–æ–∑–¥–∞–Ω (–µ—Å–ª–∏ –æ–¥–æ–±—Ä–µ–Ω–æ)'); return;
    }
    if(act==='admin.task'){
      const title = $('#adm-task').value.trim(); const reward = parseInt($('#adm-reward').value||'0',10);
      if(!title||!reward) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏ –Ω–∞–≥—Ä–∞–¥—É');
      sendData({action:'admin_task', title, reward}); toast('–ó–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ (–µ—Å–ª–∏ –æ–¥–æ–±—Ä–µ–Ω–æ)'); return;
    }

    // shop extras
    if(act==='shop.applyCoupon'){
      const c = ($('#coupon').value||'').toUpperCase();
      if(!c) { state.coupon=null; updateCartUI(); return toast('–ö—É–ø–æ–Ω –æ—á–∏—â–µ–Ω'); }
      if(!COUPONS[c]) return toast('–ö—É–ø–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
      state.coupon = c; updateCartUI(); toast('–ö—É–ø–æ–Ω –ø—Ä–∏–º–µ–Ω—ë–Ω'); return;
    }
  });

  // duration change, only-packs toggle
  $('#duration').addEventListener('change', (e)=>{
    state.cartMonth = parseInt(e.target.value,10) || 1;
    updateCartUI();
  });
  $('#only-packs').addEventListener('change', renderCatalog);

  // ===== boot
  (function boot(){
    $('#u-name').textContent = '@'+state.user.name;
    $('#ref-my').textContent = 'REF'+(state.user.id||0);
    renderAdminTab();
    renderCatalog(); updateCartUI();
    updateATMUI(); renderTx(); renderTasks(); renderRef(); renderProfile();
  })();
</script>
</body>
</html>
