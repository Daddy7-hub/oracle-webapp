<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CryptoATM.tech ‚Äî Mini App</title>
<meta name="theme-color" content="#0a0a0c">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#0a0a0c; --panel:#0e0f12; --card:#121319; --muted:#a7adb8; --txt:#f3f4f8;
    --gold:#e4c76a; --gold-2:#b18d43; --gold-3:#6a5522;
    --accent:#1f2937; --ok:#2bd182; --warn:#ffb84d; --danger:#ff6a88;
    --b1:1px solid rgba(255,255,255,.08);
    --r:18px; --r2:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:
    radial-gradient(900px 600px at 90% -20%, rgba(228,199,106,.10), transparent),
    radial-gradient(700px 500px at -10% 10%, rgba(177,141,67,.08), transparent),
    var(--bg);
    color:var(--txt);
    font:14px/1.6 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{max-width:1120px;margin:0 auto;padding:16px 14px 28px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border:var(--b1);border-radius:22px;background:linear-gradient(180deg,rgba(228,199,106,.08),rgba(255,255,255,.02));box-shadow:var(--shadow)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:12px;background:
     conic-gradient(from 210deg,#2b2210,#e4c76a,#b18d43,#2b2210);
     box-shadow:inset 0 0 0 1px rgba(255,255,255,.15);
  }
  .title h1{margin:0;font-size:18px;letter-spacing:.3px}
  .title p{margin:0;color:var(--muted);font-size:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:var(--b1);border-radius:999px;background:#0f1014}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;transition:transform .05s ease}
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn.primary{background:linear-gradient(135deg,var(--gold),var(--gold-2));color:#0a0a0c}
  .btn.ghost{background:transparent;border:1px dashed rgba(228,199,106,.55);color:var(--txt)}
  .btn.small{padding:7px 10px;border-radius:10px}
  .tabs{display:flex;gap:8px;margin:14px 0 16px;flex-wrap:wrap}
  .tab{border:var(--b1);border-radius:12px;background:#0f1014;color:var(--txt);padding:8px 12px;font-weight:800;cursor:pointer}
  .tab.active{background:linear-gradient(135deg,rgba(228,199,106,.25),rgba(255,255,255,.06))}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
  @media(max-width:1080px){.col-8,.col-6,.col-4,.col-3{grid-column:span 12}}
  .card{background:var(--card);border:var(--b1);border-radius:22px;padding:14px;box-shadow:var(--shadow)}
  .h{margin:0 0 8px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .line{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed rgba(255,255,255,.12);padding-top:10px;margin-top:10px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1014;color:var(--txt);outline:none}
  textarea{min-height:96px;resize:vertical}
  .price{font-weight:900;color:#f1d58a}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .chip{background:linear-gradient(180deg,rgba(228,199,106,.10),rgba(255,255,255,.03))}
  .note{background:rgba(228,199,106,.12);border:1px solid rgba(228,199,106,.35);border-radius:12px;padding:10px;color:#f7eac5}
  .danger{background:rgba(255,106,136,.12);border:1px solid rgba(255,106,136,.35);border-radius:12px;padding:10px;color:#ffdbe4}
  .ok{background:rgba(43,209,130,.12);border:1px solid rgba(43,209,130,.35);border-radius:12px;padding:10px;color:#d8ffe9}
  .product{display:flex;flex-direction:column;gap:8px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:var(--b1);font-size:12px}
  .u-divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:6px 0}
  /* modal bottom-sheet */
  .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:saturate(70%) blur(3px);z-index:50}
  .modal.show{display:flex}
  .sheet{background:#0d0e12;border:var(--b1);border-radius:20px 20px 0 0;max-width:980px;width:100%;padding:14px}
  /* toast */
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0e0f13;border:1px solid rgba(255,255,255,.12);color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:60}
  .toast.show{display:block;animation:fade 2.3s ease}
  @keyframes fade{0%{opacity:0;transform:translateX(-50%) translateY(6px)}10%{opacity:1;transform:translateX(-50%) translateY(0)}85%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>CryptoATM.tech</h1>
        <p>–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ –ü–∞–∫–µ—Ç—ã ‚Ä¢ Copy-Trading ‚Ä¢ ATM-—Å–∫–∏–¥–∫–∏ ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã</p>
      </div>
    </div>
    <div class="chips">
      <div class="chip">üë§ <b id="u-name">@guest</b></div>
      <div class="chip">ATM: <b id="u-atm">‚Äî</b></div>
      <button class="btn ghost small" id="btn-balance">–ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å</button>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="shop">üõç –ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="tab" data-tab="ref">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
    <button class="tab" data-tab="tasks">üß© –ó–∞–¥–∞–Ω–∏—è</button>
    <button class="tab" data-tab="faq">‚ùì FAQ</button>
  </div>

  <!-- SHOP -->
  <section id="tab-shop" class="grid">
    <div class="col-12 card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h3 class="h">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
          <p class="muted">–î–æ–±–∞–≤–ª—è–π—Ç–µ –±–æ—Ç–æ–≤/–ø–∞–∫–µ—Ç—ã. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 3/6 –º–µ—Å —Å–æ —Å–∫–∏–¥–∫–æ–π. ATM-–±–∞–ª–ª–∞–º–∏ –º–æ–∂–Ω–æ –ø–æ–≥–∞—Å–∏—Ç—å –¥–æ 25% (100 ATM = ‚Ç¨1).</p>
        </div>
        <div class="row">
          <label class="chip">–°—Ä–æ–∫:
            <select id="duration" style="margin-left:8px">
              <option value="1">1 –º–µ—Å—è—Ü</option>
              <option value="3">3 –º–µ—Å—è—Ü–∞ (‚àí10%)</option>
              <option value="6">6 –º–µ—Å—è—Ü–µ–≤ (‚àí20%)</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div id="catalog" class="col-12 grid"></div>

    <div class="col-12 card">
      <div class="row" style="justify-content:space-between">
        <h3 class="h">–ö–æ—Ä–∑–∏–Ω–∞</h3>
        <div class="row">
          <button class="btn ghost small" id="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button class="btn primary small" id="btn-checkout">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
        </div>
      </div>
      <div id="cart-list" class="muted">–ü—É—Å—Ç–æ</div>
      <div class="line">
        <div class="kpi">
          <div class="chip">–°—É–º–º–∞: <span class="price">‚Ç¨<b id="sum-eur">0</b></span></div>
          <div class="chip">–°–ø–∏—Å–∞—Ç—å ATM:
            <input id="use-atm" type="number" min="0" step="100" value="0" style="width:120px;margin-left:8px">
          </div>
          <div class="chip">–õ–∏–º–∏—Ç: <b>–¥–æ 25%</b></div>
        </div>
        <div class="row">
          <span class="muted">Copy-Trading: ‚Ç¨50/–º–µ—Å + % –æ—Ç –ø—Ä–∏–±—ã–ª–∏.</span>
          <button class="btn ghost small" id="btn-copy-info">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        </div>
      </div>
    </div>
  </section>

  <!-- REF -->
  <section id="tab-ref" class="grid" hidden>
    <div class="col-12 card">
      <h3 class="h">–†–µ—Ñ–µ—Ä–∞–ª—ã</h3>
      <div class="row">
        <div class="chip">–í–∞—à –∫–æ–¥: <b id="my-ref">REF0</b></div>
        <button class="btn ghost small" id="btn-copy-ref">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="ref-code" placeholder="REF123456">
        <button class="btn primary" id="btn-bind-ref">–ü—Ä–∏–≤—è–∑–∞—Ç—å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è</button>
      </div>
      <p class="muted" style="margin-top:10px">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–º ‚Äî –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –±–æ–Ω—É—Å ATM. –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç ¬´–∫—Ç–æ –æ—Ç –∫–æ–≥–æ¬ª.</p>
    </div>
  </section>

  <!-- TASKS -->
  <section id="tab-tasks" class="grid" hidden>
    <div class="col-12 card">
      <h3 class="h">–ó–∞–¥–∞–Ω–∏—è –∑–∞ ATM-–±–∞–ª–ª—ã</h3>
      <div id="tasks" class="grid"></div>
      <div class="note" style="margin-top:10px">ATM-–±–∞–ª–ª–∞–º–∏ –º–æ–∂–Ω–æ –ø–æ–∫—Ä—ã—Ç—å –¥–æ 25% –æ—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞ (100 ATM = ‚Ç¨1).</div>
    </div>
  </section>

  <!-- FAQ -->
  <section id="tab-faq" class="grid" hidden>
    <div class="col-12 card">
      <h3 class="h">FAQ</h3>
      <ul class="muted">
        <li>–ü–æ–¥–ø–∏—Å–∫–∏: –æ—Ç–¥–µ–ª—å–Ω—ã–µ –±–æ—Ç—ã –∏–ª–∏ –ø–∞–∫–µ—Ç—ã (Standard / Premium / Enterprise).</li>
        <li>Copy-Trading: ‚Ç¨50/–º–µ—Å + % –æ—Ç –ø—Ä–∏–±—ã–ª–∏. –£—Ç–æ—á–Ω—è–µ—Ç—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.</li>
        <li>ATM-–±–∞–ª–ª—ã: –∑–∞ –∑–∞–¥–∞–Ω–∏—è –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∫—É. 100 ATM = ‚Ç¨1. –°–∫–∏–¥–∫–∞ –Ω–µ –±–æ–ª–µ–µ 25%.</li>
        <li>–û–ø–ª–∞—Ç–∞ –≤ –µ–≤—Ä–æ: –∏–Ω–≤–æ–π—Å –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—é/–∫—Ä–∏–ø—Ç–æ; –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —á–∞—Ç–µ.</li>
      </ul>
    </div>
  </section>
</div>

<!-- Checkout -->
<div class="modal" id="modal-checkout">
  <div class="sheet">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>–ß–µ–∫-–∞—É—Ç</h3>
      <button class="btn ghost small" data-close="#modal-checkout">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="co-items" class="muted" style="margin:6px 0">‚Äî</div>
    <div class="u-divider"></div>
    <div class="line">
      <div>
        –ö –æ–ø–ª–∞—Ç–µ: <span class="price">‚Ç¨<b id="co-sum">0</b></span>
        <div class="muted" id="co-note">–°—É–º–º–∞ ‚Ç¨0 ‚Äî ATM –∑–∞–ø—Ä–æ—Å: 0 (–æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–∏–º–∏—Ç 25% –ø—Ä–æ–≤–µ—Ä–∏—Ç –±—ç–∫–µ–Ω–¥)</div>
      </div>
      <div class="row">
        <button class="btn primary" id="btn-send-order">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- Copy-Trading -->
<div class="modal" id="modal-copy">
  <div class="sheet">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>Copy-Trading</h3>
      <button class="btn ghost small" data-close="#modal-copy">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="note" style="margin:8px 0">
      ‚Ç¨50/–º–µ—Å + % –æ—Ç –ø—Ä–∏–±—ã–ª–∏. –ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ Telegram, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—Å–ª–æ–≤–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.
    </div>
    <div class="line">
      <div class="muted">–ì–æ—Ç–æ–≤—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è?</div>
      <button class="btn primary" id="btn-add-copy">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É (‚Ç¨50/–º–µ—Å)</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ========= Telegram bridge & helpers ========= */
const tg = window.Telegram?.WebApp || null;
if(tg){ tg.expand(); }

function sendData(obj){
  const payload = JSON.stringify(obj);
  if(tg && typeof tg.sendData === 'function'){
    tg.sendData(payload);
  }else{
    console.log('[offline send]', payload);
    // emulate response toast for offline demo
    if(obj.action==='checkout') toast('–î–µ–º–æ: –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤ —á–∞—Ç.');
    if(obj.action==='task_submit') toast('–î–µ–º–æ: –∑–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é.');
    if(obj.action==='ref_bind') toast('–î–µ–º–æ: –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∞–Ω (–ª–æ–∫–∞–ª—å–Ω–æ).');
    if(obj.action==='balance') toast('–î–µ–º–æ: –∑–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
  }
}

function toast(msg){
  const el = document.getElementById('toast');
  el.textContent = String(msg);
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 2300);
}

/* ========= Catalog (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –±—ç–∫–æ–º) ========= */
const CATALOG = [
  {type:'bot',  code:'CRYPTO_ATM_BOT', name:'Crypto ATM Bot', eur:71, desc:'BTC-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —É—Ä–æ–≤–Ω–∏ –∏ —Å–∏–≥–Ω–∞–ª—ã ‚ü∂ –¥–ª—è —Ç—Ä–µ–π–¥–∏–Ω–≥–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ.'},
  {type:'bot',  code:'ALERTS_BOT',     name:'Alerts Bot',     eur:71, desc:'–ö–∏—Ç—ã, –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏, funding, OI, –æ–±—ä—ë–º—ã, —É—Ä–æ–≤–Ω–∏. –†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã.'},
  {type:'bot',  code:'NEWS_BOT',       name:'News Bot',       eur:71, desc:'–î–∞–π–¥–∂–µ—Å—Ç—ã, —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, —Ñ–∏–ª—å—Ç—Ä—ã, —Ç–æ–ø-3 –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–≤–æ–¥–∫–∏.'},
  {type:'pack', code:'STANDARD',       name:'Standard (3)',   eur:150,desc:'–¢—Ä–∏ –±–æ—Ç–∞ –ø–æ —Å–ø–µ—Ü-—Ü–µ–Ω–µ. –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–∏–Ω–≥–∞.'},
  {type:'pack', code:'PREMIUM',        name:'Premium (4)',    eur:191,desc:'–í—Å–µ –±–æ—Ç—ã, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.'},
  {type:'pack', code:'ENTERPRISE',     name:'Enterprise',     eur:249,desc:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–∞–∫–µ—Ç –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞.'},
  {type:'svc',  code:'COPY_TRADE',     name:'Copy-Trading',   eur:50, desc:'‚Ç¨50/–º–µ—Å + % –æ—Ç –ø—Ä–∏–±—ã–ª–∏. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.'},
];

const TASK_LIST = [
  {id:1, title:'–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ TikTok', reward:150, hint:'–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å'},
  {id:2, title:'–†–µ–ø–æ—Å—Ç –≤ —Å—Ç–æ—Ä–∏—Å',    reward:120, hint:'–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–∏—Å'},
  {id:3, title:'–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞',   reward:300, hint:'@username –¥—Ä—É–≥–∞'},
  {id:4, title:'–ù–∞–∫–ª–µ–π–∫–∞ –Ω–∞ –∞–≤—Ç–æ',   reward:800, hint:'–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –ø—Ä—É—Ñ–∞'},
  {id:5, title:'–û—Ç–∑—ã–≤',              reward:200, hint:'–°—Å—ã–ª–∫–∞ –∏–ª–∏ —Å–∫—Ä–∏–Ω –æ—Ç–∑—ã–≤–∞'},
];

const DUR_DISCOUNT = {1:0, 3:0.10, 6:0.20};

/* ========= State ========= */
const state = {
  user: {
    id: tg?.initDataUnsafe?.user?.id || 0,
    name: tg?.initDataUnsafe?.user?.username || 'guest',
  },
  cart: [],
  months: 1
};

/* ========= DOM refs ========= */
const $ = s => document.querySelector(s);
const elName = $('#u-name');
const elATM  = $('#u-atm');
const elMyRef= $('#my-ref');
const elCatalog = $('#catalog');
const elCartList= $('#cart-list');
const elSumEur = $('#sum-eur');
const elDur = $('#duration');
const elUseATM = $('#use-atm');

/* ========= Renderers ========= */
function renderCatalog(){
  elCatalog.innerHTML = '';
  CATALOG.forEach(it=>{
    const col = document.createElement('div');
    col.className = 'col-4';
    col.innerHTML = `
      <div class="card product" data-code="${it.code}">
        <div class="row" style="justify-content:space-between">
          <div class="pill">${it.type==='bot'?'–ë–û–¢':it.type==='pack'?'–ü–ê–ö–ï–¢':'–°–ï–†–í–ò–°'}</div>
          <div class="price">‚Ç¨${it.eur}/–º–µ—Å</div>
        </div>
        <h3 class="h">${it.name}</h3>
        <p class="muted">${it.desc||''}</p>
        <div class="line">
          <button class="btn ghost small" data-info="${it.code}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
          <button class="btn primary small" data-add="${it.code}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
      </div>`;
    elCatalog.appendChild(col);
  });
}
function renderTasks(){
  const holder = $('#tasks');
  holder.innerHTML = '';
  TASK_LIST.forEach(t=>{
    const col = document.createElement('div');
    col.className = 'col-6';
    col.innerHTML = `
      <div class="card">
        <h3 class="h">#${t.id} ${t.title}</h3>
        <p class="muted">–ù–∞–≥—Ä–∞–¥–∞: +${t.reward} ATM</p>
        <input id="proof-${t.id}" placeholder="${t.hint}">
        <div class="line">
          <span class="muted">–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º</span>
          <button class="btn primary small" data-task="${t.id}">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>`;
    holder.appendChild(col);
  });
}
function renderCart(){
  if(state.cart.length===0){
    elCartList.textContent = '–ü—É—Å—Ç–æ';
  }else{
    elCartList.innerHTML = state.cart.map(x=>`
      <div class="line">
        <div>${x.name}</div>
        <div class="row">
          <span class="muted">‚Ç¨${x.eur}/–º–µ—Å</span>
          <button class="btn ghost small" data-remove="${x.code}">—É–±—Ä–∞—Ç—å</button>
        </div>
      </div>`).join('');
  }
  elSumEur.textContent = String(subtotal());
}

/* ========= Calculations ========= */
function subtotal(){
  const base = state.cart.reduce((s,x)=>s + x.eur, 0);
  const months = parseInt(elDur.value || '1', 10);
  state.months = months;
  const disc = DUR_DISCOUNT[months] || 0;
  return Math.round(base * months * (1-disc));
}

/* ========= Actions ========= */
function addToCart(code){
  const it = CATALOG.find(x=>x.code===code);
  if(!it) return;
  if(state.cart.some(x=>x.code===code)) return toast('–£–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ');
  state.cart.push({code:it.code, name:it.name, eur:it.eur});
  sendData({action:'cart_add', code});
  renderCart();
}
function removeFromCart(code){
  state.cart = state.cart.filter(x=>x.code!==code);
  sendData({action:'cart_remove', code});
  renderCart();
}
function clearCart(){
  state.cart = [];
  elUseATM.value = 0;
  sendData({action:'cart_clear'});
  renderCart();
}
function openCheckout(){
  if(!state.cart.length) return toast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
  const list = state.cart.map(x=>`‚Ä¢ ${x.name}`).join('<br>') + `<br>–°—Ä–æ–∫: ${state.months}–º`;
  $('#co-items').innerHTML = list;
  $('#co-sum').textContent = String(subtotal());
  const wantATM = parseInt(elUseATM.value||'0',10)||0;
  $('#co-note').textContent = `–ó–∞–ø—Ä–æ—à–µ–Ω–æ —Å–ø–∏—Å–∞—Ç—å ATM: ${wantATM} (–±—ç–∫–µ–Ω–¥ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç –º–∞–∫—Å–∏–º—É–º 25% –∏ –ø–æ –≤–∞—à–µ–º—É –±–∞–ª–∞–Ω—Å—É)`;
  openModal('#modal-checkout');
}
function sendOrder(){
  const items = state.cart.map(x=>x.code);
  const wantATM = parseInt(elUseATM.value||'0',10)||0;
  sendData({action:'checkout', items, months:state.months, use_atm:wantATM});
  closeModal('#modal-checkout');
  clearCart();
}

/* ========= Modals ========= */
function openModal(sel){ document.querySelector(sel).classList.add('show'); }
function closeModal(sel){ document.querySelector(sel).classList.remove('show'); }

/* ========= Events ========= */
document.addEventListener('click', (e)=>{
  const info = e.target.closest('[data-info]');
  if(info){
    const code = info.getAttribute('data-info');
    const it = CATALOG.find(x=>x.code===code);
    if(it) toast(`${it.name}\n\n${it.desc||''}\n‚Ç¨${it.eur}/–º–µ—Å`);
  }
  const add = e.target.closest('[data-add]');
  if(add){
    addToCart(add.getAttribute('data-add'));
  }
  const rmv = e.target.closest('[data-remove]');
  if(rmv){
    removeFromCart(rmv.getAttribute('data-remove'));
  }
  const taskBtn = e.target.closest('[data-task]');
  if(taskBtn){
    const id = parseInt(taskBtn.getAttribute('data-task'),10);
    const proof = (document.getElementById('proof-'+id).value||'').trim();
    if(!proof) return toast('–î–æ–±–∞–≤—å—Ç–µ –ø—Ä—É—Ñ');
    sendData({action:'task_submit', task_id:id, proof});
    document.getElementById('proof-'+id).value='';
    toast('–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é');
  }
  const closeBtn = e.target.closest('[data-close]');
  if(closeBtn){
    closeModal(closeBtn.getAttribute('data-close'));
  }
});

$('#btn-clear').addEventListener('click', clearCart);
$('#btn-checkout').addEventListener('click', openCheckout);
$('#btn-send-order').addEventListener('click', sendOrder);
$('#btn-copy-ref').addEventListener('click', ()=>{
  const code = 'REF'+(state.user.id||0);
  navigator.clipboard?.writeText(code);
  toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: '+code);
});
$('#btn-bind-ref').addEventListener('click', ()=>{
  const code = ($('#ref-code').value||'').trim();
  if(!code) return toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
  sendData({action:'ref_bind', code});
});
$('#btn-balance').addEventListener('click', ()=> sendData({action:'balance'}));
$('#btn-copy-info').addEventListener('click', ()=> openModal('#modal-copy'));
$('#btn-add-copy').addEventListener('click', ()=>{
  addToCart('COPY_TRADE');
  closeModal('#modal-copy');
});
elDur.addEventListener('change', renderCart);

/* ========= Tabs ========= */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    const name = btn.dataset.tab;
    document.querySelectorAll('section[id^="tab-"]').forEach(s=> s.hidden = (s.id !== 'tab-'+name));
    if(name==='tasks') renderTasks();
    if(name==='ref') elMyRef.textContent = 'REF'+(state.user.id||0);
  });
});

/* ========= Boot ========= */
function boot(){
  elName.textContent = '@'+state.user.name;
  elMyRef.textContent = 'REF'+(state.user.id||0);
  renderCatalog();
  renderCart();
  renderTasks(); // pre-render for faster first open
  // ATM –±–∞–ª–∞–Ω—Å –ø–æ–¥—Ç—è–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å¬ª, –±—ç–∫ –æ—Ç–≤–µ—Ç–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤ —á–∞—Ç.
}
boot();
</script>
</body>
</html>
