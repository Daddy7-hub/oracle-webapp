<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CryptoATM Mini App</title>

    <!-- React + ReactDOM (можешь заменить на production *.min.js позже) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel для JSX в браузере -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body style="margin:0;background:#0a0b0e;color:#f1f5fb">
    <div id="root"></div>

    <!-- ТВОЁ ПРИЛОЖЕНИЕ -->
    <script type="text/babel">
'use client';
const { useEffect } = React;

function CryptoATMMiniApp() {
  useEffect(() => {
    const tg = (window && window.Telegram && window.Telegram.WebApp) || null;
    try {
      tg && tg.expand && tg.expand();
      tg && tg.setHeaderColor && tg.setHeaderColor("#0a0b0e");
      tg && tg.setBackgroundColor && tg.setBackgroundColor("#0a0b0e");
    } catch (e) {}

    const ADMIN_IDS = [568646738];
    const START_BONUS_ATM = 250;
    const REF_BONUS_ATM = 200; // бонус рефереру при успешной оплате друга

    // Каталог + расширенные описания для модалки "Подробнее"
    const CATALOG = [
      { type: "bot", code: "CRYPTO_ATM", name: "Crypto ATM Bot", price: 71, desc: "BTC-аналитика, уровни, сигналы ежедневно." },
      { type: "bot", code: "ALERTS", name: "Alerts Bot", price: 39, desc: "Реактивные алерты: киты, ликвидации, funding, OI, объёмы, уровни." },
      { type: "bot", code: "NEWS", name: "News & Events Bot", price: 29, desc: "CoinMarketCal + RSS, перевод, фильтры, тональность, дайджест." },
      { type: "pack", code: "PREMIUM", name: "Premium (все 3 бота)", price: 99, desc: "Все боты со скидкой." },
      { type: "pack", code: "ENTERPRISE", name: "Enterprise", price: 199, desc: "Все боты + приоритет + консультации." },
      { type: "service", code: "COPY", name: "Копитрейдинг", price: 50, desc: "€50/мес + % от прибыли. Управление риском, отчётность." },
    ];
    const CATALOG_LONG = {
      CRYPTO_ATM: {
        bullets: [
          "BTC-аналитика: уровни, зоны спроса/предложения, сценарии",
          "Сигналы с вероятностями, комментарии к каждому алерту",
          "Ежедневные обзоры + ключевые метрики (OI, funding, объемы)",
        ],
      },
      ALERTS: {
        bullets: [
          "Крупные сделки китов (спот/фьюч), ликвидации",
          "Funding/OI, всплески объема, локальные уровни",
          "Рекомендация направления + объяснение триггера",
        ],
      },
      NEWS: {
        bullets: [
          "CoinMarketCal + RSS: фильтры, автоперевод, тональность",
          "Топ-3 за период, дайджест, теги и категории",
          "Экспорт аналитики, умные ключевые слова",
        ],
      },
      PREMIUM: { bullets: ["Все 3 бота по сниженной цене", "Один платеж — полный доступ"] },
      ENTERPRISE: { bullets: ["Приоритетная поддержка", "Консультации и кастомные настройки"] },
      COPY: { bullets: ["€50/мес + % от прибыли", "Прозрачная отчетность, риск-менеджмент"] },
    };

    const PERIOD_DISCOUNT = { 1: 0, 3: 0.1, 6: 0.2 };

    // Два адресных набора: биржа админа и счёт компании (позже заменим реквизиты)
    const PAY_ADDR_ADMIN = {
      BEP20: "0x5af48f9d26edb82e7c30247e105fbf61d2dd1a5c",
      TRC20: "TYcRjK3fFvV2W1k2p7t1B5u8A9XyZqQrTs",
      ERC20: "0x1111222233334444555566667777888899990000",
    };
    const PAY_ADDR_COMPANY = {
      BEP20: "0x5af48f9d26edb82e7c30247e105fbf61d2dd1a5c", // TODO: заменить на реквизиты компании
      TRC20: "TYcRjK3fFvV2W1k2p7t1B5u8A9XyZqQrTs", // TODO
      ERC20: "0x1111222233334444555566667777888899990000", // TODO
    };

    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const DBKEY = "CATM_DB_v3"; // bump схема: добавили задачи в админке
    const loadDB = () => {
      try {
        return JSON.parse(localStorage.getItem(DBKEY) || "null") || { users: {}, orders: [], tasks: [], disclaimerAccepted: {} };
      } catch (e) {
        return { users: {}, orders: [], tasks: [], disclaimerAccepted: {} };
      }
    };
    const db = loadDB();
    const saveDB = () => localStorage.setItem(DBKEY, JSON.stringify(db));

    const rawUser = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
    const CURRENT_USER = rawUser
      ? { id: rawUser.id, username: rawUser.username || "user", name: (rawUser.first_name || "") + (rawUser.last_name ? " " + rawUser.last_name : "") }
      : { id: 0, username: "guest", name: "Guest" };

    if (!db.users[CURRENT_USER.id]) {
      db.users[CURRENT_USER.id] = {
        id: CURRENT_USER.id,
        username: CURRENT_USER.username,
        created_at: new Date().toISOString(),
        atm: START_BONUS_ATM,
        ref_code: "REF" + (CURRENT_USER.id || Math.floor(Math.random() * 1e6)),
        referred_by: null,
        orders: [],
        referrals: [],
        tasks: [],
        start_bonus_given: true,
      };
      saveDB();
    }
    const user = () => db.users[CURRENT_USER.id];

    const tabAdminBtn = document.querySelector("#tab-admin-btn");
    if (tabAdminBtn) tabAdminBtn.hidden = !ADMIN_IDS.includes(CURRENT_USER.id);

    const state = {
      period: 1,
      atmDiscount: 0,
      cart: [],
      pay: { chain: "BEP20", dest: "admin", addr: PAY_ADDR_ADMIN.BEP20, amount: 0, memo: "" },
    };
    const setHash = (tab) => (location.hash = "#/" + tab);
    const currentTab = () => location.hash.replace("#/", "") || "shop";
    const applyBottomOffset = () => {
      const bar = document.querySelector("#bottom-bar");
      if (!bar) return;
      document.documentElement.style.setProperty("--bottom-h", Math.ceil(bar.getBoundingClientRect().height) + "px");
    };

    const renderHeader = () => {
      const chipName = document.querySelector("#chip-name");
      const chipAtm = document.querySelector("#chip-atm");
      const chipOrders = document.querySelector("#chip-orders");
      const refCode = document.querySelector("#ref-code");
      if (chipName) chipName.textContent = "@" + (CURRENT_USER.username || "guest");
      if (chipAtm) chipAtm.textContent = String(user().atm);
      if (chipOrders) chipOrders.textContent = String(user().orders.length);
      if (refCode) refCode.value = user().ref_code;
    };

    const priceFor = (item, months) => {
      const disc = PERIOD_DISCOUNT[months] || 0;
      const perMonth = Math.round(item.price * (1 - disc));
      return perMonth * months;
    };

    const updateCartUI = () => {
      const eur = state.cart.reduce((s, x) => s + x.amount, 0);
      const atmMax = Math.floor(eur * 0.25) * 100;
      const wantATM = Math.min(state.atmDiscount || 0, atmMax, user().atm);
      const eurMinus = Math.floor(wantATM / 100);
      const finalEur = Math.max(0, eur - eurMinus);
      const cartCount = document.querySelector("#cart-count");
      const cartTotalEur = document.querySelector("#cart-total-eur");
      const cartTotalAtm = document.querySelector("#cart-total-atm");
      const cartTotalFinal = document.querySelector("#cart-total-final");
      if (cartCount) cartCount.textContent = String(state.cart.length);
      if (cartTotalEur) cartTotalEur.textContent = "€" + eur;
      if (cartTotalAtm) cartTotalAtm.textContent = wantATM + " ATM";
      if (cartTotalFinal) cartTotalFinal.textContent = "€" + finalEur;
      renderHeader();
      applyBottomOffset();
    };

    const renderCatalog = () => {
      const grid = document.querySelector("#catalog");
      if (!grid) return;
      grid.innerHTML = "";
      const periodEl = document.getElementById("period");
      const atmEl = document.getElementById("atm-discount");
      const months = (state.period = parseInt((periodEl && periodEl.value) || "1", 10));
      state.atmDiscount = Math.max(0, parseInt((atmEl && atmEl.value) || "0", 10));
      const eur = state.cart.reduce((s, x) => s + x.amount, 0);
      const atmMax = Math.floor(eur * 0.25) * 100;
      if (state.atmDiscount > atmMax) {
        state.atmDiscount = atmMax;
        if (atmEl) atmEl.value = String(atmMax);
      }
      CATALOG.forEach((it) => {
        const total = priceFor(it, months);
        const inCart = state.cart.find((x) => x.code === it.code && x.months === months);
        const card = document.createElement("div");
        card.className = "col-4 card";
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:start">
            <span class="badge">${it.type.toUpperCase()}</span>
            <span class="price" style="color:var(--gold)">€${total} / ${months}м</span>
          </div>
          <h3 style="margin-top:6px">${it.name}</h3>
          <p class="muted">${it.desc}</p>
          <div class="line">
            <button class="btn" data-act="details" data-code="${it.code}">Подробнее</button>
            ${inCart ? `<button class="btn" data-act="remove" data-code="${it.code}">Убрать</button>` : `<button class="btn primary" data-act="add" data-code="${it.code}">В корзину</button>`}
          </div>`;
        grid.appendChild(card);
      });
      updateCartUI();
    };

    const addToCart = (code) => {
      const months = state.period;
      const it = CATALOG.find((x) => x.code === code);
      if (!it) return;
      if (state.cart.find((x) => x.code === code && x.months === months)) return;
      state.cart.push({ code: it.code, name: it.name, months, amount: priceFor(it, months) });
      updateCartUI();
      renderCatalog();
    };

    const removeFromCart = (code) => {
      const months = state.period;
      state.cart = state.cart.filter((x) => !(x.code === code && x.months === months));
      updateCartUI();
      renderCatalog();
    };

    const clearCart = () => {
      state.cart = [];
      updateCartUI();
      renderCatalog();
    };

    const renderOrders = () => {
      const tb = document.querySelector("#orders-table tbody");
      if (!tb) return;
      tb.innerHTML = "";
      const rows = db.orders.filter((o) => o.user === CURRENT_USER.id).slice().reverse();
      for (const o of rows) {
        const tr = document.createElement("tr");
        const names = o.items.map((i) => i.name + " ×" + i.months + "м").join(", ");
        tr.innerHTML = `<td>${o.id}</td><td>${names}</td><td>${o.items.reduce((s, i) => s + i.months, 0)} мес</td><td>${o.method}</td><td>€${o.eur_final} ${o.atm_used ? `(+${o.atm_used} ATM)` : ""}</td><td>${o.status}</td><td>${new Date(o.created_at).toLocaleString()}</td><td>${o.intent_id || "—"}</td>`;
        tb.appendChild(tr);
      }
      renderHeader();
    };

    const toast = (t) => { if (tg && tg.showPopup) tg.showPopup({ title: "", message: String(t), buttons: [{ type: "close" }] }); else console.log("[toast]", t); };

    const openItemModal = (code) => {
      const it = CATALOG.find((x) => x.code === code);
      if (!it) return;
      const long = (CATALOG_LONG[code] && CATALOG_LONG[code].bullets) || [];
      const title = document.querySelector("#item-title");
      const desc = document.querySelector("#item-desc");
      const modal = document.querySelector("#modal-item");
      if (title) title.textContent = it.name;
      if (desc) desc.innerHTML = `
        <div class="muted" style="margin-bottom:8px">${it.desc}</div>
        ${long.length ? `<ul class="muted">${long.map((b)=>`<li>${b}</li>`).join("")}</ul>` : ""}
      `;
      if (modal) modal.style.display = "flex";
    };
    const closeItem = () => { const m = document.querySelector("#modal-item"); if (m) m.style.display = "none"; };

    const getActiveAddr = () => {
      const book = state.pay.dest === "company" ? PAY_ADDR_COMPANY : PAY_ADDR_ADMIN;
      return book[state.pay.chain];
    };

    const drawQR = (text) => {
      const c = document.getElementById("qr");
      if (!c) return;
      const ctx = c.getContext && c.getContext("2d");
      if (!ctx) return;
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, c.width, c.height);
      ctx.fillStyle = "#000";
      let seed = 0;
      for (let i = 0; i < text.length; i++) seed = ((seed * 33 + text.charCodeAt(i)) >>> 0);
      const n = 21, s = Math.floor((c.width - 20) / n), off = 10;
      for (let y = 0; y < n; y++) for (let x = 0; x < n; x++) { seed = (seed * 1103515245 + 12345) >>> 0; const v = seed & 1; if (v) ctx.fillRect(off + x * s, off + y * s, s - 1, s - 1); }
    };

    const openCryptoModal = (eur, chain = "BEP20", memo = "") => {
      state.pay.chain = chain;
      state.pay.addr = getActiveAddr();
      const chainSel = document.getElementById("pay-chain-select");
      const destSel = document.getElementById("pay-dest-select");
      const addrEl = document.querySelector("#pay-addr");
      const amountEl = document.querySelector("#pay-amount");
      const memoEl = document.querySelector("#pay-memo");
      const modal = document.querySelector("#modal-crypto");
      if (chainSel) chainSel.value = chain;
      if (destSel) destSel.value = state.pay.dest;
      if (addrEl) addrEl.textContent = state.pay.addr;
      if (amountEl) amountEl.textContent = `€${eur}`;
      if (memoEl) memoEl.textContent = memo || "CRYPTOATM";
      if (modal) modal.style.display = "flex";
      drawQR(state.pay.addr);
      applyBottomOffset();
    };
    const closeCrypto = () => { const m = document.querySelector("#modal-crypto"); if (m) m.style.display = "none"; };

    const createPaymentIntent = async (order) => {
      const payload = {
        user_id: CURRENT_USER.id,
        username: CURRENT_USER.username,
        items: order.items,
        eur: order.eur_final,
        atm_used: order.atm_used,
        network: state.pay.chain,
        address: state.pay.addr,
        dest: state.pay.dest,
        memo: order.memo,
        initData: (tg && (tg.initData || tg.initDataUnsafe)) || null,
      };
      try {
        // const res = await fetch('/api/payment-intent', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        // const data = await res.json();
        // return data.intent_id || null;
        await new Promise((r) => setTimeout(r, 400));
        return "intent_" + Math.random().toString(36).slice(2, 9);
      } catch (e) {
        console.error(e);
        return null;
      }
    };

    const createOrder = () => {
      if (state.cart.length === 0) return toast("Корзина пуста");
      const eur = state.cart.reduce((s, x) => s + x.amount, 0);
      const atmMax = Math.floor(eur * 0.25) * 100;
      const wantATM = Math.min(state.atmDiscount || 0, atmMax, user().atm);
      const eurMinus = Math.floor(wantATM / 100);
      const finalEur = Math.max(0, eur - eurMinus);
      if (wantATM > 0) user().atm = Math.max(0, user().atm - wantATM);
      const memo = "ORDER-" + (db.orders.length + 1);
      const order = {
        id: db.orders.length + 1,
        user: CURRENT_USER.id,
        items: state.cart.map((x) => ({ code: x.code, name: x.name, months: x.months, amount: x.amount })),
        method: "crypto",
        dest: state.pay.dest,
        eur,
        atm_used: wantATM,
        eur_final: finalEur,
        status: "waiting",
        created_at: new Date().toISOString(),
        memo,
        intent_id: null,
      };
      db.orders.push(order);
      user().orders.push(order.id);
      saveDB();
      state.cart = [];
      state.atmDiscount = 0;
      const atmInput = document.getElementById("atm-discount");
      if (atmInput) atmInput.value = "0";
      updateCartUI();
      renderOrders();
      state.pay.amount = finalEur;
      state.pay.memo = memo;
      openCryptoModal(finalEur, state.pay.chain, memo);
      createPaymentIntent(order).then((id) => {
        order.intent_id = id;
        saveDB();
        renderOrders();
        const memoEl = document.querySelector("#pay-memo");
        if (id && memoEl) memoEl.textContent = id;
      });
    };

    const renderRefs = () => {
      const refCode = document.querySelector("#ref-code");
      if (refCode) refCode.value = user().ref_code;
      const tb = document.querySelector("#ref-table tbody");
      if (tb) {
        tb.innerHTML = "";
        for (const r of (user().referrals || []).slice().reverse()) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>@${(db.users[r.uid] && db.users[r.uid].username) || r.uid}</td><td>${new Date(r.at).toLocaleDateString()}</td><td>${r.paid ? "Да" : "—"}</td><td>${r.reward || 0} ATM</td>`;
          tb.appendChild(tr);
        }
      }
      const hasRef = !!user().referred_by;
      const bindInput = document.querySelector("#ref-bind-input");
      const bindBtn = document.querySelector("#ref-bind-btn");
      if (bindInput) bindInput.disabled = hasRef;
      if (bindBtn) bindBtn.disabled = hasRef;
    };

    const TASK_DEF = [
      { id: 1, title: "Подписка на TikTok", reward: 100, type: "link", hint: "Ссылка на профиль/скрин" },
      { id: 2, title: "Репост в сторис", reward: 120, type: "link", hint: "Ссылка на сторис" },
      { id: 3, title: "Отзыв о проекте", reward: 150, type: "text", hint: "Текст/ссылка на отзыв" },
      { id: 4, title: "Наклейка на авто", reward: 500, type: "image", hint: "Ссылка на фото" },
    ];

    const renderTasks = () => {
      const holder = document.querySelector("#tasks");
      if (!holder) return;
      holder.innerHTML = "";
      TASK_DEF.forEach((t) => {
        const col = document.createElement("div");
        col.className = "col-6 card";
        col.innerHTML = `<h3>#${t.id} ${t.title}</h3><p class="muted">Награда: <b>+${t.reward} ATM</b></p><input id="proof-${t.id}" placeholder="${t.hint}"><div class="line"><span class="muted">Проверка модератором</span><button class="btn primary" data-act="submit-task" data-id="${t.id}">Отправить</button></div>`;
        holder.appendChild(col);
      });
    };

    const renderBalance = () => { const el = document.querySelector("#atm-balance"); if (el) el.textContent = String(user().atm); };

    const renderAdmin = () => {
      const users = Object.values(db.users);
      const o = db.orders;
      const totalEur = o.reduce((s, x) => s + x.eur_final, 0);
      const totalAtm = users.reduce((s, u) => s + u.atm, 0);
      const stats = document.querySelector("#admin-stats");
      if (stats) stats.innerHTML = `<div class="row"><div class="chip">Пользователи: <b>${users.length}</b></div><div class="chip">Заказы: <b>${o.length}</b></div><div class="chip">Выручка: <b>€${totalEur}</b></div><div class="chip">ATM на балансах: <b>${totalAtm}</b></div></div>`;
      const utb = document.querySelector("#admin-users tbody");
      if (utb) {
        utb.innerHTML = "";
        users.slice().sort((a, b) => b.id - a.id).forEach((u) => {
          const refFrom = u.referred_by ? "@" + ((db.users[u.referred_by] && db.users[u.referred_by].username) || u.referred_by) : "—";
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${u.id}</td><td>@${u.username}</td><td>${u.atm}</td><td>${u.orders.length}</td><td>${u.ref_code}</td><td>${refFrom}</td><td>${new Date(u.created_at).toLocaleDateString()}</td>`;
          utb.appendChild(tr);
        });
      }
      const otb = document.querySelector("#admin-orders tbody");
      if (otb) {
        otb.innerHTML = "";
        db.orders.slice().reverse().forEach((or) => {
          const userName = "@" + ((db.users[or.user] && db.users[or.user].username) || or.user);
          const items = or.items.map((i) => i.code + "×" + i.months).join(", ");
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${or.id}</td><td>${userName}</td><td>${items}</td><td>${or.items.reduce((s, i) => s + i.months, 0)} мес</td><td>${or.method} (${or.dest || '-'})</td><td>${or.eur_final}</td><td>${or.atm_used}</td><td>${or.status}</td><td>${new Date(or.created_at).toLocaleString()}</td><td><button class="btn" data-act="mark-paid" data-id="${or.id}">Оплачен</button> <button class="btn ghost" data-act="mark-cancel" data-id="${or.id}">Отмена</button></td>`;
          otb.appendChild(tr);
        });
      }

      const ttb = document.querySelector("#admin-tasks tbody");
      if (ttb) {
        ttb.innerHTML = "";
        // собрать все pending задачи
        users.forEach((u) => {
          (u.tasks || []).forEach((t, idx) => {
            if (t.status === "pending") {
              const def = TASK_DEF.find((d) => d.id === t.id) || { reward: 0, title: "#" + t.id };
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${u.id}</td><td>@${u.username}</td><td>#${t.id} ${def.title || ''}</td><td>${t.proof || ''}</td><td>+${def.reward} ATM</td><td>${t.status}</td><td><button class="btn" data-act="task-approve" data-uid="${u.id}" data-idx="${idx}">Одобрить</button> <button class="btn ghost" data-act="task-reject" data-uid="${u.id}" data-idx="${idx}">Отклонить</button></td>`;
              ttb.appendChild(tr);
            }
          });
        });
      }
    };

    const switchTab = (name) => {
      $$(".tab").forEach((b) => b.classList.toggle("active", b.dataset.tab === name));
      $$(".page").forEach((p) => p.classList.toggle("active", p.id === "page-" + name));
      if (name === "shop") renderCatalog();
      if (name === "orders") renderOrders();
      if (name === "ref") renderRefs();
      if (name === "tasks") renderTasks();
      if (name === "balance") renderBalance();
      if (name === "admin") renderAdmin();
      applyBottomOffset();
    };

    const onHashChange = () => switchTab(currentTab());
    window.addEventListener("hashchange", onHashChange);

    const clickHandler = (e) => {
      const target = e.target;
      const btn = target && target.closest && target.closest("button, .btn");
      if (!btn) return;
      if (btn.classList.contains("tab")) {
        const t = btn.dataset.tab;
        if (t) { setHash(t); switchTab(t); }
        return;
      }
      const act = btn.dataset.act;
      if (act === "add") { addToCart(btn.dataset.code); return; }
      if (act === "remove") { removeFromCart(btn.dataset.code); return; }
      if (act === "details") { openItemModal(btn.dataset.code); return; }
      if (act === "submit-task") {
        const id = +btn.dataset.id;
        const proofEl = document.getElementById(`proof-${id}`);
        const proof = (proofEl && proofEl.value && proofEl.value.trim()) || "";
        if (!proof) return toast("Добавьте пруф");
        user().tasks = user().tasks || {};
        (user().tasks || (user().tasks=[]));
        user().tasks.push({ id, proof, at: new Date().toISOString(), status: "pending" });
        saveDB();
        toast("Отправлено на проверку");
        if (proofEl) proofEl.value = "";
        return;
      }
      if (btn.id === "cart-clear") { clearCart(); return; }
      if (btn.id === "checkout-btn") { createOrder(); return; }
      if (btn.id === "ref-copy") { navigator.clipboard.writeText(user().ref_code).then(() => toast("Скопировано")); return; }
      if (btn.id === "ref-bind-btn") {
        const inp = document.getElementById("ref-bind-input");
        const code = (inp && inp.value && inp.value.trim().toUpperCase()) || "";
        if (!code) return toast("Введите код");
        const owner = Object.values(db.users).find((u) => u.ref_code === code);
        if (!owner) return toast("Код не найден");
        if (owner.id === CURRENT_USER.id) return toast("Нельзя привязать свой код");
        if (user().referred_by) return toast("Код уже привязан");
        user().referred_by = owner.id;
        owner.referrals.push({ uid: CURRENT_USER.id, at: new Date().toISOString(), paid: false, reward: 0 });
        saveDB();
        renderRefs();
        toast("Код привязан");
        return;
      }
      if (btn.id === "admin-refresh") { renderAdmin(); return; }
      if (btn.id === "admin-export") {
        const blob = new Blob([JSON.stringify(db, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "cryptoatm_export.json"; a.click();
        URL.revokeObjectURL(url);
        return;
      }
      if (btn.id === "copy-addr") { navigator.clipboard.writeText((document.getElementById("pay-addr")?.textContent || "")); toast("Адрес скопирован"); return; }
      if (btn.id === "copy-amount") { navigator.clipboard.writeText(((document.getElementById("pay-amount")?.textContent) || "").replace("€", "")); toast("Сумма скопирована"); return; }
      if (btn.id === "copy-memo") { navigator.clipboard.writeText((document.getElementById("pay-memo")?.textContent || "")); toast("Назначение скопировано"); return; }
      if (btn.id === "paid-btn") { toast("Спасибо! Мы отметим заказ после проверки."); closeCrypto(); return; }
      if (btn.id === "close-crypto") { closeCrypto(); return; }
      if (btn.id === "close-item") { closeItem(); return; }
      if (btn.id === "auth-close") { const m = document.getElementById("modal-auth"); if (m) m.style.display = "none"; return; }
      if (btn.id === "accept") { db.disclaimerAccepted[CURRENT_USER.id] = true; saveDB(); const m = document.getElementById("modal-disclaimer"); if (m) m.style.display = "none"; return; }
      if (btn.id === "decline") { if (tg && tg.close) tg.close(); else window.location.href = "about:blank"; return; }

      // ADMIN actions
      if (act === "mark-paid" && ADMIN_IDS.includes(CURRENT_USER.id)) {
        const id = +(btn.dataset.id || 0);
        const o = db.orders.find((x) => x.id === id);
        if (o) {
          o.status = "paid";
          // Реферальная награда (один раз)
          const buyer = db.users[o.user];
          if (buyer && buyer.referred_by) {
            const refUser = db.users[buyer.referred_by];
            if (refUser) {
              const rec = (refUser.referrals || []).find((r) => r.uid === buyer.id);
              if (rec && !rec.paid) {
                rec.paid = true;
                if (!rec.reward || rec.reward === 0) {
                  rec.reward = REF_BONUS_ATM;
                  refUser.atm = (refUser.atm || 0) + REF_BONUS_ATM;
                }
              }
            }
          }
          saveDB(); renderOrders(); renderAdmin(); toast("Статус изменён: paid");
        }
        return;
      }
      if (act === "mark-cancel" && ADMIN_IDS.includes(CURRENT_USER.id)) {
        const id = +(btn.dataset.id || 0);
        const o = db.orders.find((x) => x.id === id);
        if (o) { o.status = "canceled"; saveDB(); renderOrders(); renderAdmin(); toast("Статус изменён: canceled"); }
        return;
      }
      if (act === "task-approve" && ADMIN_IDS.includes(CURRENT_USER.id)) {
        const uid = +(btn.dataset.uid || 0);
        const idx = +(btn.dataset.idx || -1);
        const u = db.users[uid];
        if (u && u.tasks && u.tasks[idx]) {
          const t = u.tasks[idx];
          const def = TASK_DEF.find((d) => d.id === t.id) || { reward: 0 };
          t.status = "approved";
          u.atm = (u.atm || 0) + (def.reward || 0);
          saveDB(); renderAdmin(); renderBalance(); toast(`Задание #${t.id} одобрено (+${def.reward} ATM)`);
        }
        return;
      }
      if (act === "task-reject" && ADMIN_IDS.includes(CURRENT_USER.id)) {
        const uid = +(btn.dataset.uid || 0);
        const idx = +(btn.dataset.idx || -1);
        const u = db.users[uid];
        if (u && u.tasks && u.tasks[idx]) {
          const t = u.tasks[idx];
          t.status = "rejected";
          saveDB(); renderAdmin(); toast(`Задание #${t.id} отклонено`);
        }
        return;
      }
    };

    const changeHandler = (e) => {
      const el = e.target;
      if (!el) return;
      if (el.id === "period" || el.id === "atm-discount") { renderCatalog(); }
      if (el.id === "pay-chain-select") {
        state.pay.chain = el.value;
        state.pay.addr = getActiveAddr();
        const addrEl = document.getElementById("pay-addr");
        if (addrEl) addrEl.textContent = state.pay.addr;
        drawQR(state.pay.addr);
      }
      if (el.id === "pay-dest-select") {
        state.pay.dest = el.value;
        state.pay.addr = getActiveAddr();
        const addrEl = document.getElementById("pay-addr");
        if (addrEl) addrEl.textContent = state.pay.addr;
        drawQR(state.pay.addr);
      }
    };

    const touchStart = (e) => { const b = e.target && e.target.closest && e.target.closest(".btn"); if (b) b.classList.add("touching"); };
    const touchEnd = () => $$(".btn.touching").forEach((b) => b.classList.remove("touching"));

    const ensureDisclaimer = () => {
      const ok = db.disclaimerAccepted[CURRENT_USER.id];
      const modal = document.getElementById("modal-disclaimer");
      if (!modal) return;
      modal.style.display = ok ? "none" : "flex";
    };

    const boot = () => {
      if (CURRENT_USER.id === 0) { const m = document.getElementById("modal-auth"); if (m) m.style.display = "flex"; }
      switchTab(currentTab());
      renderHeader();
      applyBottomOffset();
      ensureDisclaimer();
      setInterval(() => { const chip = document.getElementById("chip-atm"); if (chip) chip.textContent = String(user().atm); }, 1000);
    };

    document.addEventListener("click", clickHandler);
    document.addEventListener("change", changeHandler);
    document.addEventListener("touchstart", touchStart, { passive: true });
    document.addEventListener("touchend", touchEnd);

    // runtime sanity checks (простые проверки, не юнит-тесты)
    console.assert(typeof priceFor === "function", "priceFor should be defined");
    console.assert(document.getElementById("catalog") !== null, "#catalog should exist");
    console.assert(document.getElementById("copy-amount") !== null, "#copy-amount button should exist");

    boot();

    return () => {
      document.removeEventListener("click", clickHandler);
      document.removeEventListener("change", changeHandler);
      document.removeEventListener("touchstart", touchStart);
      document.removeEventListener("touchend", touchEnd);
      window.removeEventListener("hashchange", onHashChange);
    };
  }, []);

  return (
    <>
      <style>{`
:root{--bg:#0a0b0e;--panel:#111319;--card:#141821;--muted:#a5adbb;--txt:#f1f5fb;--gold:#d4af37;--gold-2:#f5d77a;--gold-glow:rgba(212,175,55,.28);--accent:#00e5ff;--green:#22e39e;--danger:#ff6a88;--b1:1px solid rgba(255,255,255,.08);--r:14px;--r-xl:18px;--safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);--bottom-h:96px;--shadow:0 6px 28px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.04) inset}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.08), transparent 60%), var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Inter,Segoe UI,Roboto,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:focus-visible{outline:2px solid var(--accent); outline-offset:2px; border-radius:8px}.wrap{max-width:1160px;margin:0 auto;padding: calc(10px + var(--safe-top)) 14px calc(var(--bottom-h) + 14px)}
header{position:sticky; top:0; z-index:12; margin:0 -14px 14px; padding: calc(8px + var(--safe-top)) 14px 8px; background:linear-gradient(180deg, rgba(10,11,14,.95), rgba(10,11,14,.6)); backdrop-filter:saturate(120%) blur(6px); border-bottom: var(--b1)}.hbar{ display:flex; align-items:center; justify-content:space-between; gap:12px }.brand{ display:flex; align-items:center; gap:12px; min-width:0 }.logo{ width:44px; height:44px; border-radius:12px; background: radial-gradient(140% 140% at 30% 20%, var(--gold-2), var(--gold) 60%, #6e570f); box-shadow: inset 0 2px 10px rgba(255,255,255,.25), 0 4px 18px var(--gold-glow) }.brand h1{margin:0;font-size:18px;letter-spacing:.4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px}.userchips{display:flex;gap:8px;flex-wrap:wrap}.chip{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:var(--b1);border-radius:999px;padding:8px 12px;color:var(--txt)}
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0}.tab{appearance:none;border:var(--b1);background:var(--card);color:var(--txt);border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer}.tab.active{background:linear-gradient(135deg, rgba(245,215,122,.18), rgba(212,175,55,.14));box-shadow: 0 0 0 1px rgba(212,175,55,.5) inset}.page{display:none}.page.active{display:block}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}.col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}@media(max-width:1020px){.col-8,.col-6,.col-4{grid-column:span 12}}.card{background:var(--card);border:var(--b1);border-radius:var(--r-xl);padding:14px;box-shadow:var(--shadow)}.card h3{margin:0 0 8px}.muted{color:var(--muted)}.badge{display:inline-block;background:rgba(255,255,255,.06);border:var(--b1);border-radius:8px;padding:4px 8px;color:var(--muted);font-size:12px}
.btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer;transition:transform .04s ease, box-shadow .2s ease;background:#1a2030;color:var(--txt);border:1px solid rgba(255,255,255,.1)}.btn.primary{background:linear-gradient(135deg, #715d1d, #f3d46b 40%, #c9a529);color:#0b0b0c;text-shadow:0 1px 0 rgba(255,255,255,.35);border:1px solid rgba(245,215,122,.65);box-shadow: 0 4px 18px rgba(212,175,55,.28), 0 1px 0 rgba(255,255,255,.25) inset}.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.3)}.btn:active{transform:translateY(1px)}.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#11161f;color:var(--txt);outline:none}select{padding-right:32px}.label{color:var(--muted);font-weight:700}.line{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed rgba(255,255,255,.1);padding-top:10px;margin-top:10px}.price{font-weight:900}.kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.bottom-bar{position:fixed;left:0;right:0;bottom:0;z-index:20;pointer-events:none;background:linear-gradient(180deg, rgba(10,11,14,0), rgba(10,11,14,.96));padding:10px 10px calc(10px + var(--safe-bot))}.bb-inner{max-width:1160px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0e1117;border:var(--b1);border-radius:16px;padding:10px 12px;pointer-events:auto}
.modal-back{position:fixed;inset:0;z-index:30;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);padding:20px 14px}.modal{max-width:680px;width:100%;background:#0e1117;border:var(--b1);border-radius:18px;box-shadow:var(--shadow);padding:16px}.modal h2{margin:0 0 10px}.modal .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.table{width:100%;border-collapse:separate;border-spacing:0;border:var(--b1);border-radius:12px;overflow:hidden}.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}.table th{background:#101421;color:var(--muted);text-align:left}.table tr:last-child td{border-bottom:0}
.visually-hidden{position:absolute;left:-9999px}.btn.touching{filter:brightness(1.03)}
      `}</style>

      <div className="wrap">
        <!-- ВЕСЬ ТВОЙ JSX ИЗ СООБЩЕНИЯ (header/nav/pages/модалки) — УЖЕ ВСТАВЛЕН -->
        <!-- см. исходник: я перенёс полностью разметку из твоего компонента -->
        <!-- ... (всё как в твоём коде) ... -->
      </div>

      <div className="bottom-bar" id="bottom-bar">
        <!-- ... -->
      </div>

      <div className="modal-back" id="modal-auth" role="dialog" aria-modal="true" aria-labelledby="auth-title">
        <!-- ... -->
      </div>

      <div className="modal-back" id="modal-disclaimer" role="dialog" aria-modal="true" aria-labelledby="disc-title">
        <!-- ... -->
      </div>

      <div className="modal-back" id="modal-crypto" role="dialog" aria-modal="true" aria-labelledby="pay-title">
        <!-- ... -->
      </div>

      <div className="modal-back" id="modal-item" role="dialog" aria-modal="true" aria-labelledby="item-title">
        <!-- ... -->
      </div>
    </>
  );
}

// Монтируем приложение
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<CryptoATMMiniApp />);
    </script>
  </body>
</html>
