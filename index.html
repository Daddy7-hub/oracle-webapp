<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CryptoATM.tech ‚Äî Mini App</title>
<meta name="color-scheme" content="dark">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#0a0b0e;--panel:#111319;--card:#141821;--muted:#a5adbb;--txt:#f1f5fb;
  --gold:#d4af37;--gold-2:#f5d77a;--gold-glow:rgba(212,175,55,.28);
  --accent:#00e5ff;--green:#22e39e;--danger:#ff6a88;
  --b1:1px solid rgba(255,255,255,.08);--r:14px;--r-xl:18px;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
  --shadow:0 6px 28px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.04) inset
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.08), transparent 60%), var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Inter,Segoe UI,Roboto,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
:focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:8px}
.wrap{max-width:1160px;margin:0 auto;padding:calc(10px + var(--safe-top)) 14px 120px}
header{position:sticky;top:0;z-index:12;margin:0 -14px 14px;padding:calc(8px + var(--safe-top)) 14px 8px;background:linear-gradient(180deg, rgba(10,11,14,.95), rgba(10,11,14,.6));backdrop-filter:saturate(120%) blur(6px);border-bottom:var(--b1)}
.hbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px;min-width:0}
.logo{width:44px;height:44px;border-radius:12px;background:radial-gradient(140% 140% at 30% 20%, var(--gold-2), var(--gold) 60%, #6e570f);box-shadow:inset 0 2px 10px rgba(255,255,255,.25),0 4px 18px var(--gold-glow)}
.brand h1{margin:0;font-size:18px;letter-spacing:.4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px}
.userchips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:var(--b1);border-radius:999px;padding:8px 12px;color:var(--txt)}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}
@media(max-width:1020px){.col-8,.col-6,.col-4{grid-column:span 12}}
.card{background:var(--card);border:var(--b1);border-radius:var(--r-xl);padding:14px;box-shadow:var(--shadow)}
.card h3{margin:0 0 8px}
.muted{color:var(--muted)}
.badge{display:inline-block;background:rgba(255,255,255,.06);border:var(--b1);border-radius:8px;padding:4px 8px;color:var(--muted);font-size:12px}
.btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer;transition:transform .04s ease,box-shadow .2s ease;background:#1a2030;color:var(--txt);border:1px solid rgba(255,255,255,.1)}
.btn.primary{background:linear-gradient(135deg,#715d1d,#f3d46b 40%,#c9a529);color:#0b0b0c;text-shadow:0 1px 0 rgba(255,255,255,.35);border:1px solid rgba(245,215,122,.65);box-shadow:0 4px 18px rgba(212,175,55,.28),0 1px 0 rgba(255,255,255,.25) inset}
.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.3)}
.btn:active{transform:translateY(1px)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#11161f;color:var(--txt);outline:none}
select{padding-right:32px}
.label{color:var(--muted);font-weight:700}
.line{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed rgba(255,255,255,.1);padding-top:10px;margin-top:10px}
.price{font-weight:900}
.kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.table{width:100%;border-collapse:separate;border-spacing:0;border:var(--b1);border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
.table th{background:#101421;color:var(--muted);text-align:left}
.table tr:last-child td{border-bottom:0}
.tabbar{position:fixed;left:0;right:0;bottom:0;z-index:40;padding:8px 10px calc(8px + var(--safe-bot));background:linear-gradient(180deg, rgba(10,11,14,0), rgba(10,11,14,.96))}
.tabbar-inner{max-width:1160px;margin:0 auto;display:flex;gap:8px;justify-content:space-between;background:#0e1117;border:var(--b1);border-radius:16px;padding:6px}
.tnav{display:grid;grid-auto-flow:column;gap:6px;overflow:auto}
.tnav::-webkit-scrollbar{display:none}
.tbtn{appearance:none;background:transparent;border:1px solid rgba(255,255,255,.08);color:var(--txt);border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:8px;min-width:110px;justify-content:center;cursor:pointer}
.tbtn.active{background:linear-gradient(135deg, rgba(245,215,122,.18), rgba(212,175,55,.14));box-shadow:0 0 0 1px rgba(212,175,55,.5) inset}
.cartbar{display:none;align-items:center;gap:10px}
.modal-back{position:fixed;inset:0;z-index:50;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);padding:20px 14px}
.modal{max-width:680px;width:100%;background:#0e1117;border:var(--b1);border-radius:18px;box-shadow:var(--shadow);padding:16px}
.modal h2{margin:0 0 10px}.modal .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.12), transparent 60%), var(--bg);z-index:60}
.s-logo{width:128px;height:128px;border-radius:24px;background:radial-gradient(140% 140% at 30% 20%, var(--gold-2), var(--gold) 60%, #6e570f);box-shadow:inset 0 2px 10px rgba(255,255,255,.25),0 8px 40px var(--gold-glow);animation:float 2.2s ease-in-out infinite}
.s-title{font-weight:900;font-size:28px;letter-spacing:.6px;margin-top:16px;text-align:center}
.s-sub{color:var(--muted);text-align:center;margin-top:4px}
@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash" class="splash">
  <div style="text-align:center">
    <div class="s-logo" aria-hidden="true"></div>
    <div class="s-title">CRYPTOATM</div>
    <div class="s-sub">Subscriptions ‚Ä¢ Alerts ‚Ä¢ Copy-trading</div>
  </div>
</div>

<div class="wrap">
  <header>
    <div class="hbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="brand-title">CRYPTOATM.TECH</h1>
          <small id="brand-sub">–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ –ü–∞–∫–µ—Ç—ã ‚Ä¢ –ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã</small>
        </div>
      </div>
      <div class="userchips">
        <button class="chip" id="lang-toggle" type="button">üåê –Ø–∑—ã–∫: <b id="lang-code">RU</b></button>
        <div class="chip">üë§ <b id="chip-name">@guest</b></div>
        <div class="chip">ATM: <b id="chip-atm">0</b></div>
        <div class="chip">–ó–∞–∫–∞–∑—ã: <b id="chip-orders">0</b></div>
      </div>
    </div>
  </header>

  <main id="pages">
    <section id="page-shop" class="page active">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="sub-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
          <p class="muted" id="sub-help">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ 1/3/6 –º–µ—Å (—Å–∫–∏–¥–∫–∞ ~0/10/20%). ATM –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ 25% (100 ATM = ‚Ç¨1).</p>
          <div class="row">
            <div class="kv" style="min-width:240px">
              <label class="label" for="period" id="lbl-term">–°—Ä–æ–∫</label>
              <select id="period"><option value="1">1 –º–µ—Å—è—Ü</option><option value="3">3 –º–µ—Å—è—Ü–∞</option><option value="6">6 –º–µ—Å—è—Ü–µ–≤</option></select>
            </div>
            <div class="kv" style="min-width:260px">
              <label class="label" for="atm-discount" id="lbl-atm">–°–ø–∏—Å–∞—Ç—å ATM (–º–∞–∫—Å 25%)</label>
              <input id="atm-discount" type="number" min="0" step="50" value="0" placeholder="0" inputmode="numeric">
            </div>
          </div>
        </div>
        <div id="catalog" class="col-12 grid"></div>
      </div>
    </section>

    <section id="page-orders" class="page" hidden>
      <div class="grid">
        <div class="col-12 card">
          <h3 id="orders-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
          <table class="table" id="orders-table">
            <thead><tr>
              <th id="th-num">‚Ññ</th><th id="th-prod">–¢–æ–≤–∞—Ä</th><th id="th-term">–°—Ä–æ–∫</th><th id="th-meth">–ú–µ—Ç–æ–¥</th><th id="th-sum">–°—É–º–º–∞</th><th id="th-st">–°—Ç–∞—Ç—É—Å</th><th id="th-date">–î–∞—Ç–∞</th><th>Intent</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="page-ref" class="page" hidden>
      <div class="grid">
        <div class="col-12 card">
          <h3 id="ref-title">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
          <p class="muted" id="ref-help">–î–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM). –í–∞—à –∫–æ–¥:</p>
          <div class="row"><input id="ref-code" readonly><button class="btn primary" id="ref-copy" type="button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
          <div class="line">
            <div class="muted" id="bind-title">–ü—Ä–∏–≤—è–∑–∞—Ç—å —á—É–∂–æ–π –∫–æ–¥</div>
            <div class="row"><input id="ref-bind-input" placeholder="REF123456"><button class="btn" id="ref-bind-btn" type="button">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button></div>
          </div>
          <div style="margin-top:10px">
            <table class="table" id="ref-table"><thead><tr><th id="th-partner">–ü–∞—Ä—Ç–Ω—ë—Ä</th><th id="th-date2">–î–∞—Ç–∞</th><th id="th-paid">–û–ø–ª–∞—Ç–∞</th><th id="th-reward">–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <section id="page-tasks" class="page" hidden>
      <div class="grid">
        <div class="col-12 card">
          <h3 id="tasks-title">–ó–∞–¥–∞–Ω–∏—è –∑–∞ ATM</h3>
          <div id="tasks" class="grid"></div>
        </div>
      </div>
    </section>

    <section id="page-balance" class="page" hidden>
      <div class="grid">
        <div class="col-12 card">
          <h3 id="bal-title">–ë–∞–ª–∞–Ω—Å ATM</h3>
          <p class="muted" id="bal-help">–ö–æ–∏–Ω—ã –≤—ã–¥–∞—é—Ç—Å—è –∑–∞ –∑–∞–¥–∞–Ω–∏—è –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –ú–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ 25% –∑–∞–∫–∞–∑–∞ (100 ATM = ‚Ç¨1).</p>
          <div class="row"><div class="chip">Balance: <b id="atm-balance">0</b></div></div>
        </div>
      </div>
    </section>

    <section id="page-admin" class="page" hidden>
      <div class="grid">
        <div class="col-12 card">
          <h3 id="adm-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
          <p class="muted" id="adm-help">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∑–∞–∫–∞–∑—ã, –∑–∞–¥–∞–Ω–∏—è.</p>
          <div class="row"><button class="btn" id="admin-refresh" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button><button class="btn ghost" id="admin-export" type="button">–≠–∫—Å–ø–æ—Ä—Ç JSON</button></div>
          <div class="grid" style="margin-top:12px">
            <div class="col-12 card" id="admin-stats"></div>
            <div class="col-12 card"><h3 id="adm-users-h">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3><table class="table" id="admin-users"><thead><tr><th>ID</th><th>Username</th><th>ATM</th><th>–ó–∞–∫–∞–∑—ã</th><th>–†–µ—Ñ-–∫–æ–¥</th><th>–û—Ç –∫–æ–≥–æ</th><th>–î–∞—Ç–∞</th></tr></thead><tbody></tbody></table></div>
            <div class="col-12 card"><h3 id="adm-orders-h">–ó–∞–∫–∞–∑—ã</h3><table class="table" id="admin-orders"><thead><tr><th>#</th><th>User</th><th>–¢–æ–≤–∞—Ä</th><th>–°—Ä–æ–∫</th><th>–ú–µ—Ç–æ–¥</th><th>‚Ç¨</th><th>ATM</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
            <div class="col-12 card"><h3 id="adm-tasks-h">–ó–∞–¥–∞–Ω–∏—è (–º–æ–¥–µ—Ä–∞—Ü–∏—è)</h3><table class="table" id="admin-tasks"><thead><tr><th>ID</th><th>User</th><th>–ó–∞–¥–∞–Ω–∏–µ</th><th>–ü—Ä—É—Ñ</th><th>–ù–∞–≥—Ä–∞–¥–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>
    </section>

    <section id="page-faq" class="page" hidden>
      <div class="grid">
        <div class="col-12 card">
          <h3>FAQ</h3>
          <ul class="muted" id="faq-list">
            <li>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –≤ EUR. –û–ø–ª–∞—Ç–∞ ‚Äî –Ω–∞ –±–∏—Ä–∂—É –∞–¥–º–∏–Ω–∞ –∏–ª–∏ —Å—á—ë—Ç –∫–æ–º–ø–∞–Ω–∏–∏.</li>
            <li>ATM –ø–æ–∫—Ä—ã–≤–∞—é—Ç –¥–æ 25% –∑–∞–∫–∞–∑–∞ (100 ATM = ‚Ç¨1).</li>
            <li>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞: 10% –æ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM).</li>
          </ul>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Bottom nav + Cart -->
<div class="tabbar">
  <div class="tabbar-inner">
    <div class="tnav">
      <button class="tbtn active" data-tab="shop" type="button">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
      <button class="tbtn" data-tab="orders" type="button">üìÑ –ó–∞–∫–∞–∑—ã</button>
      <button class="tbtn" data-tab="ref" type="button">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
      <button class="tbtn" data-tab="tasks" type="button">üß© –ó–∞–¥–∞–Ω–∏—è</button>
      <button class="tbtn" data-tab="balance" type="button">üí∞ –ë–∞–ª–∞–Ω—Å</button>
      <button class="tbtn" data-tab="admin" id="tab-admin-btn" type="button" hidden>üõ† –ê–¥–º–∏–Ω</button>
      <button class="tbtn" data-tab="faq" type="button">‚ùì FAQ</button>
    </div>
    <div class="cartbar" id="cartbar">
      <div class="row">
        <div class="chip">–ü–æ–∑–∏—Ü–∏–π: <b id="cart-count">0</b></div>
        <div class="chip">–ò—Ç–æ–≥–æ: <b id="cart-total-eur">‚Ç¨0</b> / <b id="cart-total-atm">0 ATM</b></div>
        <div class="chip">–° —É—á—ë—Ç–æ–º ATM: <b id="cart-total-final">‚Ç¨0</b></div>
      </div>
      <div class="row">
        <button class="btn" id="cart-clear" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn primary" id="checkout-btn" type="button">–û–ø–ª–∞—Ç–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal-back" id="modal-auth"><div class="modal"><h2 id="auth-title">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2><p class="muted" id="auth-body">–û—Ç–∫—Ä–æ–π—Ç–µ Mini App –≤–Ω—É—Ç—Ä–∏ Telegram (—Å initData).</p><div class="foot"><button class="btn" id="auth-close" type="button">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>
<div class="modal-back" id="modal-disclaimer"><div class="modal"><h2>Disclaimer</h2><p class="muted" id="disc-body">We strongly recommend conducting your own research before purchasing any services. CryptoATM does not provide financial advice and is not responsible for any losses. By continuing, you confirm you understand the risks and accept full responsibility.</p><div class="foot"><button class="btn primary" id="accept" type="button">I agree</button></div></div></div>
<div class="modal-back" id="modal-crypto">
  <div class="modal">
    <h2 id="pay-title">–û–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π</h2>
    <p class="muted" id="pay-help">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∞–¥—Ä–µ—Å. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)¬ª.</p>
    <div class="row">
      <canvas id="qr" width="180" height="180" style="background:#fff;border-radius:8px"></canvas>
      <div style="flex:1">
        <div class="kv"><span class="label" id="lbl-recipient">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</span>
          <select id="pay-dest-select"><option value="admin">–ë–∏—Ä–∂–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</option><option value="company">–°—á—ë—Ç –∫–æ–º–ø–∞–Ω–∏–∏</option></select>
        </div>
        <div class="kv"><span class="label" id="lbl-chain">–°–µ—Ç—å</span>
          <select id="pay-chain-select"><option value="BEP20">BEP20</option><option value="TRC20">TRC20</option><option value="ERC20">ERC20</option></select>
        </div>
        <div class="kv"><span class="label" id="lbl-addr">–ê–¥—Ä–µ—Å</span><code id="pay-addr" style="word-break:break-all"></code> <button class="btn" id="copy-addr" type="button" style="margin-left:8px">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
        <div class="kv"><span class="label" id="lbl-amt">–°—É–º–º–∞</span><b id="pay-amount">‚Äî</b> <button class="btn" id="copy-amount" type="button" style="margin-left:8px">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
        <div class="kv"><span class="label" id="lbl-memo">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</span><b id="pay-memo">CRYPTOATM</b> <button class="btn" id="copy-memo" type="button" style="margin-left:8px">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
        <div class="row" style="margin-top:8px"><button class="btn" id="close-crypto" type="button">–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="paid-btn" type="button">–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)</button></div>
      </div>
    </div>
  </div>
</div>
<div class="modal-back" id="modal-item"><div class="modal"><h2 id="item-title">–¢–æ–≤–∞—Ä</h2><div id="item-desc" class="muted"></div><div class="foot"><button class="btn" id="close-item" type="button">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<script>
/* ====== CONFIG ====== */
const tg = window.Telegram?.WebApp;
try{ tg?.expand(); tg?.setHeaderColor('#0a0b0e'); tg?.setBackgroundColor('#0a0b0e'); }catch(e){}
const ADMIN_IDS = [568646738];             // <== –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π ID
const START_BONUS_ATM = 250;
const REF_BONUS_PERCENT = 0.10;            // 10% –æ—Ç ‚Ç¨ –≤ ATM (100 ATM = ‚Ç¨1)
const PERIOD_DISCOUNT = {1:0,3:0.10,6:0.20};
const PAY_ADDR_ADMIN  = { BEP20:'0x5af48f9d26edb82e7c30247e105fbf61d2dd1a5c', TRC20:'TYcRjK3fFvV2W1k2p7t1B5u8A9XyZqQrTs', ERC20:'0x1111222233334444555566667777888899990000' };
const PAY_ADDR_COMPANY= { BEP20:'0x5af48f9d26edb82e7c30247e105fbf61d2dd1a5c', TRC20:'TYcRjK3fFvV2W1k2p7t1B5u8A9XyZqQrTs', ERC20:'0x1111222233334444555566667777888899990000' };
const CATALOG=[
  {type:'bot', code:'CRYPTO_ATM', name:'Crypto ATM Bot',   price:71,  desc:'BTC analytics, daily signals & levels.'},
  {type:'bot', code:'ALERTS',     name:'Alerts Bot',       price:39,  desc:'Whales, liquidations, funding, OI & volumes.'},
  {type:'bot', code:'NEWS',       name:'News Bot',         price:29,  desc:'CoinMarketCal + RSS + translate + tone.'},
  {type:'pack',code:'PREMIUM',    name:'Premium',          price:99,  desc:'All 3 bots with discount.'},
  {type:'pack',code:'ENTERPRISE', name:'Enterprise',       price:199, desc:'Full access + priority + consulting.'},
  {type:'service',code:'COPY',    name:'Copy-trading',     price:50,  desc:'‚Ç¨50/month + profit share. Risk managed.'},
];
const CATALOG_LONG={
  CRYPTO_ATM:{bullets:['BTC analytics: levels & zones','Signals with probability + comments','Daily OI, funding, volumes']},
  ALERTS:{bullets:['Whales trades & liquidations','Funding/OI & volume spikes','Direction & trigger explanation']},
  NEWS:{bullets:['CMC + RSS + auto-translate','Top-3 digest & tone','Export & smart keywords']},
  PREMIUM:{bullets:['All 3 bots, one payment','Discount included']},
  ENTERPRISE:{bullets:['Priority support','Consulting & settings']},
  COPY:{bullets:['‚Ç¨50/month + profit share','Reports & risk management']},
};

/* ====== UTIL ====== */
const $ = s=>document.querySelector(s);
const $$= s=>Array.from(document.querySelectorAll(s));
const DBKEY='CATM_DB_html_noReact';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DBKEY)) || {users:{},orders:[],tasks:[],disclaimerAccepted:{}} }catch(e){ return {users:{},orders:[],tasks:[],disclaimerAccepted:{}} } }
const db=loadDB(); const saveDB=()=>localStorage.setItem(DBKEY, JSON.stringify(db));

/* ====== i18n (ru/en) ====== */
const i18n = {
  ru:{ brandSub:'–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ –ü–∞–∫–µ—Ç—ã ‚Ä¢ –ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã', shop:'–ú–∞–≥–∞–∑–∏–Ω',orders:'–ó–∞–∫–∞–∑—ã',ref:'–†–µ—Ñ–µ—Ä–∞–ª—ã',tasks:'–ó–∞–¥–∞–Ω–∏—è',balance:'–ë–∞–ª–∞–Ω—Å',admin:'–ê–¥–º–∏–Ω',faq:'FAQ',
       subTitle:'–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏',subHelp:'–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ 1/3/6 –º–µ—Å (—Å–∫–∏–¥–∫–∞ ~0/10/20%). ATM –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ 25% (100 ATM = ‚Ç¨1).',
       term:'–°—Ä–æ–∫', atmWrite:'–°–ø–∏—Å–∞—Ç—å ATM (–º–∞–∫—Å 25%)', more:'–ü–æ–¥—Ä–æ–±–Ω–µ–µ', add:'–í –∫–æ—Ä–∑–∏–Ω—É', remove:'–£–±—Ä–∞—Ç—å',
       ordersTitle:'–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤', num:'‚Ññ', prod:'–¢–æ–≤–∞—Ä', termCol:'–°—Ä–æ–∫', meth:'–ú–µ—Ç–æ–¥', sum:'–°—É–º–º–∞', st:'–°—Ç–∞—Ç—É—Å', date:'–î–∞—Ç–∞',
       refTitle:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞', refHelp:'–î–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM). –í–∞—à –∫–æ–¥:', copy:'–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
       bindTitle:'–ü—Ä–∏–≤—è–∑–∞—Ç—å —á—É–∂–æ–π –∫–æ–¥', bind:'–ü—Ä–∏–≤—è–∑–∞—Ç—å', partner:'–ü–∞—Ä—Ç–Ω—ë—Ä', paid:'–û–ø–ª–∞—Ç–∞', reward:'–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ',
       tasksTitle:'–ó–∞–¥–∞–Ω–∏—è –∑–∞ ATM', proofHint:'URL-–ø—Ä—É—Ñ', submit:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
       balTitle:'–ë–∞–ª–∞–Ω—Å ATM', balHelp:'–ö–æ–∏–Ω—ã –≤—ã–¥–∞—é—Ç—Å—è –∑–∞ –∑–∞–¥–∞–Ω–∏—è –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –°–ø–∏—Å–∞–Ω–∏–µ –¥–æ 25% (100 ATM = ‚Ç¨1).',
       adminTitle:'–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å', adminHelp:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∑–∞–∫–∞–∑—ã, –∑–∞–¥–∞–Ω–∏—è.', refresh:'–û–±–Ω–æ–≤–∏—Ç—å', export:'–≠–∫—Å–ø–æ—Ä—Ç JSON',
       users:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', orders2:'–ó–∞–∫–∞–∑—ã', revenue:'–í—ã—Ä—É—á–∫–∞', atmHold:'ATM –Ω–∞ –±–∞–ª–∞–Ω—Å–∞—Ö',
       faq1:'–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –≤ EUR. –û–ø–ª–∞—Ç–∞ ‚Äî –Ω–∞ –±–∏—Ä–∂—É –∞–¥–º–∏–Ω–∞ –∏–ª–∏ —Å—á—ë—Ç –∫–æ–º–ø–∞–Ω–∏–∏.', faq2:'ATM –ø–æ–∫—Ä—ã–≤–∞—é—Ç –¥–æ 25% –∑–∞–∫–∞–∑–∞ (100 ATM = ‚Ç¨1).', faq3:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞: 10% –æ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM).',
       recipient:'–ü–æ–ª—É—á–∞—Ç–µ–ª—å', adminEx:'–ë–∏—Ä–∂–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', compAcc:'–°—á—ë—Ç –∫–æ–º–ø–∞–Ω–∏–∏', chain:'–°–µ—Ç—å', addr:'–ê–¥—Ä–µ—Å', amount:'–°—É–º–º–∞', memo:'–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ', iPaid:'–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)'},
  en:{ brandSub:'Subscriptions ‚Ä¢ Bundles ‚Ä¢ Copy-trading ‚Ä¢ Referrals', shop:'Shop',orders:'Orders',ref:'Referrals',tasks:'Tasks',balance:'Balance',admin:'Admin',faq:'FAQ',
       subTitle:'Subscription checkout',subHelp:'Choose 1/3/6 months (~0/10/20%). Redeem up to 25% with ATM (100 ATM = ‚Ç¨1).',
       term:'Term', atmWrite:'Redeem ATM (max 25%)', more:'Details', add:'Add', remove:'Remove',
       ordersTitle:'Order history', num:'#', prod:'Product', termCol:'Term', meth:'Method', sum:'Amount', st:'Status', date:'Date',
       refTitle:'Referral program', refHelp:'Share your code and earn 10% of paid subscription (in ATM). Your code:', copy:'Copy',
       bindTitle:'Bind referral code', bind:'Bind', partner:'Partner', paid:'Paid', reward:'Reward',
       tasksTitle:'Tasks for ATM', proofHint:'Proof URL', submit:'Submit',
       balTitle:'ATM balance', balHelp:'Earn ATM with tasks & referrals. Redeem up to 25% (100 ATM = ‚Ç¨1).',
       adminTitle:'Admin panel', adminHelp:'Stats, orders, tasks.', refresh:'Refresh', export:'Export JSON',
       users:'Users', orders2:'Orders', revenue:'Revenue', atmHold:'ATM on balances',
       faq1:'Fixed EUR prices. Pay to admin exchange or company wallet.', faq2:'ATM can cover up to 25% (100 ATM = ‚Ç¨1).', faq3:'Referral reward: 10% of paid subscription (in ATM).',
       recipient:'Recipient', adminEx:'Admin exchange', compAcc:'Company account', chain:'Network', addr:'Address', amount:'Amount', memo:'Memo', iPaid:'I paid'}
};
let lang = localStorage.getItem('CATM_LANG') || ((navigator.language||'en').toLowerCase().startsWith('ru')?'ru':'en');
function t(k){ return (i18n[lang] && i18n[lang][k]) || (i18n.en && i18n.en[k]) || k; }
function applyLang(){
  $('#brand-sub').textContent = t('brandSub'); $('#lang-code').textContent = lang.toUpperCase();
  $('[data-tab="shop"]').innerHTML=`üõí ${t('shop')}`;$('[data-tab="orders"]').innerHTML=`üìÑ ${t('orders')}`;
  $('[data-tab="ref"]').innerHTML=`üë• ${t('ref')}`;$('[data-tab="tasks"]').innerHTML=`üß© ${t('tasks')}`;
  $('[data-tab="balance"]').innerHTML=`üí∞ ${t('balance')}`;$('[data-tab="admin"]').innerHTML=`üõ† ${t('admin')}`;$('[data-tab="faq"]').innerHTML=`‚ùì ${t('faq')}`;
  $('#sub-title').textContent=t('subTitle'); $('#sub-help').textContent=t('subHelp'); $('#lbl-term').textContent=t('term'); $('#lbl-atm').textContent=t('atmWrite');
  $('#orders-title').textContent=t('ordersTitle'); $('#th-num').textContent=t('num'); $('#th-prod').textContent=t('prod'); $('#th-term').textContent=t('termCol'); $('#th-meth').textContent=t('meth'); $('#th-sum').textContent=t('sum'); $('#th-st').textContent=t('st'); $('#th-date').textContent=t('date');
  $('#ref-title').textContent=t('refTitle'); $('#ref-help').textContent=t('refHelp'); $('#ref-bind-btn').textContent=t('bind'); $('#bind-title').textContent=t('bindTitle');
  $('#th-partner').textContent=t('partner'); $('#th-date2').textContent=t('date'); $('#th-paid').textContent=t('paid'); $('#th-reward').textContent=t('reward');
  $('#tasks-title').textContent=t('tasksTitle');
  $('#bal-title').textContent=t('balTitle'); $('#bal-help').textContent=t('balHelp');
  $('#adm-title').textContent=t('adminTitle'); $('#adm-help').textContent=t('adminHelp'); $('#admin-refresh').textContent=t('refresh'); $('#admin-export').textContent=t('export');
  $('#auth-title').textContent=(lang==='ru'?'–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è':'Authorization required'); $('#auth-body').textContent=(lang==='ru'?'–û—Ç–∫—Ä–æ–π—Ç–µ Mini App –≤–Ω—É—Ç—Ä–∏ Telegram (—Å initData).':'Open this Mini App inside Telegram (with initData).');
  $('#pay-title').textContent=(lang==='ru'?'–û–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π':'Crypto payment'); $('#pay-help').textContent=(lang==='ru'?'–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∞–¥—Ä–µ—Å. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)¬ª.':'Scan QR or copy address. After payment press ‚ÄúI paid‚Äù.');
  $('#lbl-recipient').textContent=t('recipient'); $('#pay-dest-select').options[0].text=t('adminEx'); $('#pay-dest-select').options[1].text=t('compAcc');
  $('#lbl-chain').textContent=t('chain'); $('#lbl-addr').textContent=t('addr'); $('#lbl-amt').textContent=t('amount'); $('#lbl-memo').textContent=t('memo'); $('#paid-btn').textContent=t('iPaid');
  const faq=[t('faq1'),t('faq2'),t('faq3')]; $('#faq-list').innerHTML=faq.map(x=>`<li>${x}</li>`).join('');
}
$('#lang-toggle').addEventListener('click',()=>{ lang = (lang==='ru'?'en':'ru'); localStorage.setItem('CATM_LANG',lang); applyLang(); renderCatalog(); });

/* ====== AUTH USER ====== */
const rawUser = tg?.initDataUnsafe?.user;
const CURRENT_USER = rawUser ? { id:rawUser.id, username:rawUser.username||'user', name:(rawUser.first_name||'')+(rawUser.last_name?(' '+rawUser.last_name):'') } : { id:0, username:'guest', name:'Guest' };
if(!db.users[CURRENT_USER.id]){ db.users[CURRENT_USER.id]={ id:CURRENT_USER.id, username:CURRENT_USER.username, created_at:new Date().toISOString(), atm:START_BONUS_ATM, ref_code:'REF'+(CURRENT_USER.id||Math.floor(Math.random()*1e6)), referred_by:null, orders:[], referrals:[], tasks:[], start_bonus_given:true }; saveDB(); }
function user(){ return db.users[CURRENT_USER.id]; }
if(ADMIN_IDS.includes(CURRENT_USER.id)) $('#tab-admin-btn').hidden=false;

/* ====== STATE ====== */
const state={ period:1, atmDiscount:0, cart:[], pay:{chain:'BEP20', dest:'admin', addr:PAY_ADDR_ADMIN.BEP20, amount:0, memo:''} };
function currentTab(){ return location.hash.replace('#/','')||'shop'; }
function switchTab(name){
  $$('.page').forEach(p=>p.hidden = (p.id!=='page-'+name));
  $$('.tbtn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
  if(name==='shop') renderCatalog();
  if(name==='orders') renderOrders();
  if(name==='ref') renderRefs();
  if(name==='tasks') renderTasks();
  if(name==='balance') renderBalance();
  if(name==='admin') renderAdmin();
}
window.addEventListener('hashchange', ()=>switchTab(currentTab()));

/* ====== HEADER/UTIL ====== */
function renderHeader(){ $('#chip-name').textContent='@'+(CURRENT_USER.username||'guest'); $('#chip-atm').textContent=user().atm; $('#chip-orders').textContent=user().orders.length; $('#ref-code').value=user().ref_code; }
function priceFor(it,months){ const disc=PERIOD_DISCOUNT[months]||0; const perMonth=Math.round(it.price*(1-disc)); return perMonth*months; }
function updateCartUI(){
  const eur=state.cart.reduce((s,x)=>s+x.amount,0); const atmMax=Math.floor(eur*0.25)*100;
  const wantATM=Math.min(state.atmDiscount||0, atmMax, user().atm);
  const eurMinus=Math.floor(wantATM/100); const finalEur=Math.max(0, eur-eurMinus);
  $('#cart-count').textContent=state.cart.length; $('#cart-total-eur').textContent='‚Ç¨'+eur; $('#cart-total-atm').textContent=wantATM+' ATM'; $('#cart-total-final').textContent='‚Ç¨'+finalEur;
  $('#cartbar').style.display = eur>0 ? 'flex' : 'none';
}
function toast(t){ if(tg?.showPopup) tg.showPopup({title:'',message:String(t),buttons:[{type:'close'}]}); else console.log('[toast]',t); }

/* ====== SHOP ====== */
function renderCatalog(){
  const grid=$('#catalog'); grid.innerHTML='';
  const months=state.period=parseInt($('#period').value||'1',10);
  state.atmDiscount=Math.max(0, parseInt($('#atm-discount').value||'0',10));
  const eur=state.cart.reduce((s,x)=>s+x.amount,0); const atmMax=Math.floor(eur*0.25)*100;
  if(state.atmDiscount>atmMax){ state.atmDiscount=atmMax; $('#atm-discount').value=atmMax; }
  CATALOG.forEach(it=>{
    const total=priceFor(it,months); const inCart=state.cart.find(x=>x.code===it.code&&x.months===months);
    const card=document.createElement('div'); card.className='col-4 card';
    card.innerHTML=`<div class="row" style="justify-content:space-between;align-items:start">
      <span class="badge">${it.type.toUpperCase()}</span><span class="price" style="color:var(--gold)">‚Ç¨${total} / ${months}–º</span></div>
      <h3 style="margin-top:6px">${it.name}</h3>
      <p class="muted">${it.desc}</p>
      <div class="line">
        <button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button>
        ${inCart?`<button class="btn" data-act="remove" data-code="${it.code}">${t('remove')}</button>`:`<button class="btn primary" data-act="add" data-code="${it.code}">${t('add')}</button>`}
      </div>`;
    grid.appendChild(card);
  });
  updateCartUI();
}
function addToCart(code){ const months=state.period; const it=CATALOG.find(x=>x.code===code); if(!it) return; if(state.cart.find(x=>x.code===code&&x.months===months)) return; state.cart.push({code:it.code,name:it.name,months,amount:priceFor(it,months)}); updateCartUI(); renderCatalog(); }
function removeFromCart(code){ const months=state.period; state.cart=state.cart.filter(x=>!(x.code===code&&x.months===months)); updateCartUI(); renderCatalog(); }
function clearCart(){ state.cart=[]; updateCartUI(); renderCatalog(); }

/* ====== ORDERS ====== */
function renderOrders(){
  const tb=$('#orders-table tbody'); tb.innerHTML='';
  const rows=db.orders.filter(o=>o.user===CURRENT_USER.id).slice().reverse();
  for(const o of rows){
    const tr=document.createElement('tr');
    const names=o.items.map(i=>i.name+' √ó'+i.months+'–º').join(', ');
    tr.innerHTML=`<td>${o.id}</td><td>${names}</td><td>${o.items.reduce((s,i)=>s+i.months,0)} –º–µ—Å</td><td>${o.method} (${o.dest||'-'})</td><td>‚Ç¨${o.eur_final} ${o.atm_used?`(+${o.atm_used} ATM)`:''}</td><td>${o.status}</td><td>${new Date(o.created_at).toLocaleString()}</td><td>${o.intent_id||'‚Äî'}</td>`;
    tb.appendChild(tr);
  }
}

/* ====== REFERRALS ====== */
function renderRefs(){
  $('#ref-code').value=user().ref_code;
  const tb=$('#ref-table tbody'); tb.innerHTML='';
  for(const r of (user().referrals||[]).slice().reverse()){
    const tr=document.createElement('tr'); tr.innerHTML=`<td>@${db.users[r.uid]?.username||r.uid}</td><td>${new Date(r.at).toLocaleDateString()}</td><td>${r.paid?'–î–∞':'‚Äî'}</td><td>${r.reward||0} ATM</td>`;
    tb.appendChild(tr);
  }
  const hasRef=!!user().referred_by; $('#ref-bind-input').disabled=hasRef; $('#ref-bind-btn').disabled=hasRef;
}

/* ====== TASKS ====== */
const TASK_DEF=[{id:1,title:'TikTok subscribe',reward:100,hint:'https://...'},{id:2,title:'Repost to stories',reward:120,hint:'https://...'},{id:3,title:'Project review',reward:150,hint:'https://...'},{id:4,title:'Sticker on car',reward:500,hint:'https://...'}];
function renderTasks(){ const holder=$('#tasks'); holder.innerHTML=''; TASK_DEF.forEach(tk=>{ const col=document.createElement('div'); col.className='col-6 card'; col.innerHTML=`<h3>#${tk.id} ${tk.title}</h3><p class="muted">+${tk.reward} ATM</p><input id="proof-${tk.id}" placeholder="${t('proofHint')}" inputmode="url"><div class="line"><span class="muted">Moderation</span><button class="btn primary" data-act="submit-task" data-id="${tk.id}">${t('submit')}</button></div>`; holder.appendChild(col); }); }

/* ====== BALANCE ====== */
function renderBalance(){ $('#atm-balance').textContent=user().atm; }

/* ====== ADMIN ====== */
function renderAdmin(){
  const users=Object.values(db.users), o=db.orders;
  const totalEur=o.reduce((s,x)=>s+x.eur_final,0), totalAtm=users.reduce((s,u)=>s+u.atm,0);
  $('#admin-stats').innerHTML=`<div class="row"><div class="chip">${t('users')}: <b>${users.length}</b></div><div class="chip">${t('orders2')}: <b>${o.length}</b></div><div class="chip">${t('revenue')}: <b>‚Ç¨${totalEur}</b></div><div class="chip">${t('atmHold')}: <b>${totalAtm}</b></div></div>`;
  const utb=$('#admin-users tbody'); utb.innerHTML=''; users.slice().sort((a,b)=>b.id-a.id).forEach(u=>{ const refFrom=u.referred_by?'@'+(db.users[u.referred_by]?.username||u.referred_by):'‚Äî'; const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.id}</td><td>@${u.username}</td><td>${u.atm}</td><td>${u.orders.length}</td><td>${u.ref_code}</td><td>${refFrom}</td><td>${new Date(u.created_at).toLocaleDateString()}</td>`; utb.appendChild(tr); });
  const otb=$('#admin-orders tbody'); otb.innerHTML=''; db.orders.slice().reverse().forEach(or=>{ const userName='@'+(db.users[or.user]?.username||or.user); const items=or.items.map(i=>i.code+'√ó'+i.months).join(', '); const tr=document.createElement('tr'); tr.innerHTML=`<td>${or.id}</td><td>${userName}</td><td>${items}</td><td>${or.items.reduce((s,i)=>s+i.months,0)} –º–µ—Å</td><td>${or.method} (${or.dest||'-'})</td><td>${or.eur_final}</td><td>${or.atm_used}</td><td>${or.status}</td><td>${new Date(or.created_at).toLocaleString()}</td><td>${ADMIN_IDS.includes(CURRENT_USER.id)?`<button class="btn" data-act="mark-paid" data-id="${or.id}">–û–ø–ª–∞—á–µ–Ω</button> <button class="btn ghost" data-act="mark-cancel" data-id="${or.id}">–û—Ç–º–µ–Ω–∞</button>`:''}</td>`; otb.appendChild(tr); });
  const ttb=$('#admin-tasks tbody'); ttb.innerHTML=''; users.forEach(u=>{ (u.tasks||[]).forEach((tk,idx)=>{ if(tk.status==='pending'){ const def=TASK_DEF.find(d=>d.id===tk.id)||{reward:0,title:'#'+tk.id}; const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.id}</td><td>@${u.username}</td><td>#${tk.id} ${def.title||''}</td><td>${tk.proof||''}</td><td>+${def.reward} ATM</td><td>${tk.status}</td><td>${ADMIN_IDS.includes(CURRENT_USER.id)?`<button class="btn" data-act="task-approve" data-uid="${u.id}" data-idx="${idx}">–û–¥–æ–±—Ä–∏—Ç—å</button> <button class="btn ghost" data-act="task-reject" data-uid="${u.id}" data-idx="${idx}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>`:''}</td>`; ttb.appendChild(tr); } }); });
}

/* ====== PAY / QR ====== */
function getActiveAddr(){ const book=state.pay.dest==='company'?PAY_ADDR_COMPANY:PAY_ADDR_ADMIN; return book[state.pay.chain]; }
function drawQR(text){ const c=$('#qr'), ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='#000'; let seed=0; for(let i=0;i<text.length;i++) seed=((seed*33+text.charCodeAt(i))>>>0); const n=21,s=Math.floor((c.width-20)/n),off=10; for(let y=0;y<n;y++) for(let x=0;x<n;x++){ seed=(seed*1103515245+12345)>>>0; if(seed&1) ctx.fillRect(off+x*s,off+y*s,s-1,s-1);} }
function openCryptoModal(eur, chain='BEP20', memo=''){ state.pay.chain=chain; state.pay.addr=getActiveAddr(); $('#pay-chain-select').value=chain; $('#pay-dest-select').value=state.pay.dest; $('#pay-addr').textContent=state.pay.addr; $('#pay-amount').textContent='‚Ç¨'+eur; $('#pay-memo').textContent=memo||'CRYPTOATM'; $('#modal-crypto').style.display='flex'; drawQR(state.pay.addr); }
function closeCrypto(){ $('#modal-crypto').style.display='none'; }

/* ====== ORDER FLOW ====== */
function createPaymentIntent(){ return new Promise(r=>setTimeout(()=>r('intent_'+Math.random().toString(36).slice(2,9)),350)); }
function createOrder(){
  if(state.cart.length===0) return toast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
  const eur=state.cart.reduce((s,x)=>s+x.amount,0); const atmMax=Math.floor(eur*0.25)*100; const wantATM=Math.min(state.atmDiscount||0, atmMax, user().atm); const eurMinus=Math.floor(wantATM/100); const finalEur=Math.max(0, eur-eurMinus); if(wantATM>0) user().atm=Math.max(0,user().atm-wantATM);
  const memo='ORDER-'+(db.orders.length+1);
  const order={ id:db.orders.length+1,user:CURRENT_USER.id,items:state.cart.map(x=>({code:x.code,name:x.name,months:x.months,amount:x.amount})),method:'crypto',dest:state.pay.dest,eur,atm_used:wantATM,eur_final:finalEur,status:'waiting',created_at:new Date().toISOString(),memo,intent_id:null };
  db.orders.push(order); user().orders.push(order.id); saveDB();
  state.cart=[]; state.atmDiscount=0; $('#atm-discount').value=0; updateCartUI(); renderOrders();
  openCryptoModal(finalEur, state.pay.chain, memo);
  createPaymentIntent().then(id=>{ order.intent_id=id; saveDB(); renderOrders(); $('#pay-memo').textContent=id; });
}

/* ====== DETAILS ====== */
function openItemModal(code){ const it=CATALOG.find(x=>x.code===code); if(!it) return; const long=(CATALOG_LONG[code]?.bullets)||[]; $('#item-title').textContent='–¢–æ–≤–∞—Ä: '+it.name; $('#item-desc').innerHTML=`<div class="muted" style="margin-bottom:8px">${it.desc}</div>${long.length?`<ul class="muted">${long.map(b=>`<li>${b}</li>`).join('')}</ul>`:''}`; $('#modal-item').style.display='flex'; }
function closeItem(){ $('#modal-item').style.display='none'; }

/* ====== EVENTS ====== */
document.addEventListener('click',e=>{
  const btn=e.target.closest('button,.btn'); if(!btn) return;
  if(btn.classList.contains('tbtn')){ location.hash='#/'+btn.dataset.tab; switchTab(btn.dataset.tab); return; }
  const act=btn.dataset.act;
  if(act==='add'){ addToCart(btn.dataset.code); return; }
  if(act==='remove'){ removeFromCart(btn.dataset.code); return; }
  if(act==='details'){ openItemModal(btn.dataset.code); return; }
  if(act==='submit-task'){ const id=+btn.dataset.id; const proof=$('#proof-'+id)?.value.trim(); if(!/^https?:\/\//i.test(proof||'')) return toast('Add a valid URL'); user().tasks=user().tasks||[]; user().tasks.push({id,proof,at:new Date().toISOString(),status:'pending'}); saveDB(); toast('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É'); $('#proof-'+id).value=''; return; }
  if(btn.id==='cart-clear'){ clearCart(); return; }
  if(btn.id==='checkout-btn'){ createOrder(); return; }
  if(btn.id==='ref-copy'){ navigator.clipboard.writeText(user().ref_code).then(()=>toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')); return; }
  if(btn.id==='ref-bind-btn'){ const code=$('#ref-bind-input').value.trim().toUpperCase(); if(!code) return toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥'); const owner=Object.values(db.users).find(u=>u.ref_code===code); if(!owner) return toast('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω'); if(owner.id===CURRENT_USER.id) return toast('–ù–µ–ª—å–∑—è —Å–≤–æ–π –∫–æ–¥'); if(user().referred_by) return toast('–ö–æ–¥ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω'); user().referred_by=owner.id; owner.referrals.push({uid:CURRENT_USER.id, at:new Date().toISOString(), paid:false, reward:0}); saveDB(); renderRefs(); toast('–ö–æ–¥ –ø—Ä–∏–≤—è–∑–∞–Ω'); return; }
  if(btn.id==='admin-refresh'){ renderAdmin(); return; }
  if(btn.id==='admin-export'){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cryptoatm_export.json'; a.click(); URL.revokeObjectURL(url); return; }
  if(btn.id==='copy-addr'){ navigator.clipboard.writeText($('#pay-addr').textContent||''); toast('Address copied'); return; }
  if(btn.id==='copy-amount'){ navigator.clipboard.writeText(($('#pay-amount').textContent||'').replace('‚Ç¨','')); toast('Amount copied'); return; }
  if(btn.id==='copy-memo'){ navigator.clipboard.writeText($('#pay-memo').textContent||''); toast('Memo copied'); return; }
  if(btn.id==='paid-btn'){ toast('–°–ø–∞—Å–∏–±–æ! –ú—ã –ø—Ä–æ–≤–µ—Ä–∏–º –æ–ø–ª–∞—Ç—É.'); closeCrypto(); return; }
  if(btn.id==='close-crypto'){ closeCrypto(); return; }
  if(btn.id==='close-item'){ closeItem(); return; }
  if(btn.id==='auth-close'){ $('#modal-auth').style.display='none'; return; }
  if(btn.id==='accept'){ db.disclaimerAccepted[CURRENT_USER.id]=true; saveDB(); $('#modal-disclaimer').style.display='none'; return; }

  // –∞–¥–º–∏–Ω
  if(act==='mark-paid' && ADMIN_IDS.includes(CURRENT_USER.id)){ const id=+btn.dataset.id; const o=db.orders.find(x=>x.id===id); if(o){ o.status='paid'; const buyer=db.users[o.user]; if(buyer?.referred_by){ const refUser=db.users[buyer.referred_by]; const rec=(refUser.referrals||[]).find(r=>r.uid===buyer.id); if(rec && !rec.paid){ rec.paid=true; const atmReward=Math.max(0,Math.round((o.eur_final||0)*REF_BONUS_PERCENT*100)); rec.reward=atmReward; refUser.atm=(refUser.atm||0)+atmReward; } } saveDB(); renderAdmin(); renderOrders(); toast('Marked paid'); } return; }
  if(act==='mark-cancel' && ADMIN_IDS.includes(CURRENT_USER.id)){ const id=+btn.dataset.id; const o=db.orders.find(x=>x.id===id); if(o){ o.status='canceled'; saveDB(); renderAdmin(); renderOrders(); toast('Canceled'); } return; }
  if(act==='task-approve' && ADMIN_IDS.includes(CURRENT_USER.id)){ const uid=+btn.dataset.uid, idx=+btn.dataset.idx, u=db.users[uid]; if(u?.tasks?.[idx]){ const tk=u.tasks[idx]; const def=TASK_DEF.find(d=>d.id===tk.id)||{reward:0}; tk.status='approved'; u.atm=(u.atm||0)+def.reward; saveDB(); renderAdmin(); renderBalance(); toast('Approved'); } return; }
  if(act==='task-reject' && ADMIN_IDS.includes(CURRENT_USER.id)){ const uid=+btn.dataset.uid, idx=+btn.dataset.idx, u=db.users[uid]; if(u?.tasks?.[idx]){ u.tasks[idx].status='rejected'; saveDB(); renderAdmin(); toast('Rejected'); } return; }
});
document.addEventListener('change',e=>{
  const el=e.target;
  if(el.id==='period'||el.id==='atm-discount'){ renderCatalog(); }
  if(el.id==='pay-chain-select'){ state.pay.chain=el.value; state.pay.addr=getActiveAddr(); $('#pay-addr').textContent=state.pay.addr; drawQR(state.pay.addr); }
  if(el.id==='pay-dest-select'){ state.pay.dest=el.value; state.pay.addr=getActiveAddr(); $('#pay-addr').textContent=state.pay.addr; drawQR(state.pay.addr); }
});

/* ====== BOOT ====== */
function ensureDisclaimer(){ const ok=db.disclaimerAccepted[CURRENT_USER.id]; $('#modal-disclaimer').style.display= ok ? 'none' : 'flex'; }
function boot(){
  applyLang();
  setTimeout(()=>$('#splash').style.display='none', 900);
  if(CURRENT_USER.id===0) $('#modal-auth').style.display='flex';
  renderHeader(); switchTab(currentTab()); renderCatalog(); ensureDisclaimer();
  setInterval(()=>($('#chip-atm').textContent=user().atm), 1000);
}
boot();
</script>
</body>
</html>
—ã
