<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>CryptoATM.tech — Welcome Hub</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { color-scheme: light dark; }
    .card { @apply rounded-2xl p-4 shadow-lg bg-white/70 dark:bg-zinc-900/70 backdrop-blur border border-white/20 dark:border-zinc-800; }
    .btn  { @apply px-4 py-2 rounded-xl font-medium shadow; }
    .btn-primary { @apply btn bg-indigo-600 text-white hover:bg-indigo-500; }
    .btn-ghost   { @apply btn bg-transparent border border-indigo-400/30 text-indigo-600 dark:text-indigo-300; }
    .tag { @apply inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-200; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-rose-50 dark:from-zinc-950 dark:via-zinc-900 dark:to-black text-zinc-900 dark:text-zinc-100 min-h-screen">
  <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 space-y-6">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">CryptoATM.tech</h1>
        <p class="text-sm opacity-70">Welcome Hub • тарифы, подключение, рефералка и кликер</p>
      </div>
      <button id="btnOpenInTG" class="btn-ghost hidden sm:inline-flex">Открыть в Telegram</button>
    </header>

    <!-- Nav -->
    <nav class="grid grid-cols-2 sm:grid-cols-4 gap-3">
      <button data-tab="catalog" class="tab btn-primary">Каталог</button>
      <button data-tab="plans" class="tab btn-ghost">Тарифы</button>
      <button data-tab="ref" class="tab btn-ghost">Рефералка</button>
      <button data-tab="quests" class="tab btn-ghost">Кликер</button>
    </nav>

    <!-- Catalog -->
    <section id="catalog" class="card space-y-4">
      <h2 class="text-xl font-semibold">Каталог ботов</h2>
      <div id="bots" class="grid sm:grid-cols-2 gap-4"></div>
    </section>

    <!-- Plans -->
    <section id="plans" class="card space-y-4 hidden">
      <h2 class="text-xl font-semibold">Тарифы</h2>
      <div id="plansWrap" class="grid sm:grid-cols-2 gap-4"></div>
    </section>

    <!-- Referral -->
    <section id="ref" class="card space-y-4 hidden">
      <h2 class="text-xl font-semibold">Реферальная программа</h2>
      <div>
        <p class="opacity-80 mb-2">Приглашай друзей — получай CATM. Чем больше активных друзей, тем выше шансы в розыгрышах.</p>
        <div class="flex items-center gap-2">
          <input id="refLink" class="flex-1 rounded-xl px-3 py-2 bg-white/70 dark:bg-zinc-800/70 border border-white/20 dark:border-zinc-700" placeholder="Ваша ссылка" readonly>
          <button id="copyRef" class="btn-primary">Скопировать</button>
        </div>
      </div>
    </section>

    <!-- Quests -->
    <section id="quests" class="card space-y-4 hidden">
      <h2 class="text-xl font-semibold">Кликер-квесты</h2>
      <p class="opacity-80">Выполняй задания и получай <b>CATM</b>. В конце месяца — розыгрыш призов среди активных.</p>
      <div id="tasks" class="space-y-3"></div>
      <div class="flex items-center justify-between border-t border-white/20 dark:border-zinc-800 pt-3">
        <div>Баланс: <b id="balance">0</b> CATM</div>
        <button id="btnBalance" class="btn-ghost">Обновить баланс</button>
      </div>
    </section>

    <!-- Footer -->
    <footer class="text-xs opacity-60 text-center py-6">
      © CryptoATM.tech • Это не финсовет • <a class="underline" href="#" id="openPay">Оплатить тариф</a>
    </footer>
  </div>

<script>
const tg = window.Telegram?.WebApp;
const IS_TG = !!tg;
const WEBAPP_URL = location.href.split('#')[0];

// Данные (должны совпадать с бэком)
const BOTS = [
  {id:"atm_pro", title:"CryptoATM Pro", short:"Автопродажи, платёжные шлюзы, рефералка, аналитика",
    bullets:["Платежи: крипта / банковские / Stars","Витрины и цифровые товары","Реферальная программа и скидки","Аналитика и роли команды"], badge:"Топ"},
  {id:"atm_starter", title:"CryptoATM Starter", short:"Быстрый запуск продаж и выдача товаров",
    bullets:["Простая витрина","Автовыдача","Лёгкая настройка"], badge:"Хит"},
  {id:"atm_support", title:"CryptoATM Support", short:"Саппорт-бот и тикеты в Telegram",
    bullets:["Тикеты","Теги/статусы","Хэндовер оператору"], badge:""}
];
const PLANS = [
  {id:"pro_month",bot_id:"atm_pro",name:"Pro — Месяц",period:"month",price_usd:79,crypto:"USDT/BTC/ETH",features:["Все модули","1 workspace","Поддержка"]},
  {id:"pro_year",bot_id:"atm_pro",name:"Pro — Год",period:"year",price_usd:790,crypto:"USDT/BTC/ETH",features:["Все модули","1 workspace","Приоритет","2 мес. в подарок"]},
  {id:"starter_month",bot_id:"atm_starter",name:"Starter — Месяц",period:"month",price_usd:19,crypto:"USDT",features:["Быстрый старт","Простая витрина","E-mail поддержка"]},
  {id:"support_month",bot_id:"atm_support",name:"Support — Месяц",period:"month",price_usd:29,crypto:"USDT",features:["Тикеты","Команда","Базовая аналитика"]},
];

// UI helpers
function $id(id){return document.getElementById(id)}
function showTab(name){
  ["catalog","plans","ref","quests"].forEach(t=>{
    $id(t).classList.toggle("hidden", t!==name);
    document.querySelector(`[data-tab="${t}"]`)?.classList.toggle("btn-primary", t===name);
    document.querySelector(`[data-tab="${t}"]`)?.classList.toggle("btn-ghost", t!==name);
  });
}

// Render Catalog
function renderBots(){
  const wrap = $id("bots"); wrap.innerHTML="";
  BOTS.forEach(b=>{
    const li = document.createElement("div"); li.className="card space-y-2";
    li.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-lg font-semibold">${b.title}</div>
        ${b.badge ? `<span class="tag">${b.badge}</span>` : ""}
      </div>
      <div class="opacity-80">${b.short}</div>
      <ul class="list-disc pl-5 text-sm opacity-80">${b.bullets.map(x=>`<li>${x}</li>`).join("")}</ul>
      <div class="flex gap-2 pt-2">
        <button class="btn-primary" data-bid="${b.id}">Смотреть планы</button>
        <button class="btn-ghost" data-open="pay">Оплатить</button>
      </div>
    `;
    wrap.appendChild(li);
    li.querySelector(`[data-bid="${b.id}"]`).onclick = ()=> {
      showTab("plans");
      renderPlans(b.id);
    };
  });
}

// Render Plans
function renderPlans(filterBotId=null){
  const wrap = $id("plansWrap"); wrap.innerHTML="";
  (filterBotId ? PLANS.filter(p=>p.bot_id===filterBotId) : PLANS).forEach(p=>{
    const li = document.createElement("div"); li.className="card space-y-2";
    li.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-lg font-semibold">${p.name}</div>
        <div class="tag">$${p.price_usd} / ${p.period}</div>
      </div>
      <ul class="list-disc pl-5 text-sm opacity-80">${p.features.map(x=>`<li>${x}</li>`).join("")}</ul>
      <div class="flex gap-2 pt-2">
        <button class="btn-primary" data-buy="${p.id}">Купить</button>
        <button class="btn-ghost" data-bot="${p.bot_id}">О боте</button>
      </div>
    `;
    wrap.appendChild(li);
    li.querySelector(`[data-buy="${p.id}"]`).onclick = ()=> buyPlan(p.id);
    li.querySelector(`[data-bot="${p.bot_id}"]`).onclick = ()=> {
      showTab("catalog");
      document.querySelector(`#bots [data-bid="${p.bot_id}"]`)?.scrollIntoView({behavior:"smooth", block:"center"});
    };
  });
}

// WebApp bridge
function sendData(obj){
  if (IS_TG){
    tg.sendData(JSON.stringify(obj));
  } else {
    alert("Откройте в Telegram для взаимодействия с ботом.");
  }
}

function buyPlan(plan_id){
  sendData({action:"buy_plan", plan_id});
  tg?.HapticFeedback?.impactOccurred("medium");
}

// Referral
function setRefLink(){
  // генерируем локально — бот пришлёт точную по нажатию в /start
  const pseudo = "ref_" + Math.random().toString(36).slice(2,10).toUpperCase();
  const link = `https://t.me/${tg?.initDataUnsafe?.user?.username ? "" : "your_bot"}?start=${pseudo}`;
  $id("refLink").value = link;
}
$id("copyRef").onclick = ()=>{
  navigator.clipboard.writeText($id("refLink").value);
  tg?.HapticFeedback?.notificationOccurred("success");
};

// Tasks (кликер)
const TASKS = [
  {id:"daily_tap", title:"Ежедневный тап", desc:"нажми и получи 1 CATM", reward:1, type:"click"},
  {id:"join_insta", title:"Подписка на Instagram", desc:"Подпишись и подтвердись", reward:20, type:"external", url:"https://instagram.com"},
  {id:"invite_friend", title:"Пригласи друга", desc:"Друг перешёл по твоей ссылке и открыл мини-апп", reward:50, type:"ref"},
];
function renderTasks(){
  const wrap = $id("tasks"); wrap.innerHTML="";
  TASKS.forEach(t=>{
    const el=document.createElement("div"); el.className="card";
    el.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold">${t.title}</div>
          <div class="text-sm opacity-70">${t.desc}</div>
        </div>
        <div class="tag">+${t.reward} CATM</div>
      </div>
      <div class="pt-2">
        <button class="btn-primary" data-task="${t.id}">${t.type==="click" ? "Тап" : "Выполнить"}</button>
        ${t.url ? `<a class="btn-ghost inline-block ml-2" target="_blank" href="${t.url}">Открыть</a>` : ""}
      </div>
    `;
    wrap.appendChild(el);
    el.querySelector(`[data-task="${t.id}"]`).onclick = ()=>{
      // примитивная проверка; реальную валидацию делаем на бэке/админке
      sendData({action:"task_done", task_id:t.id, reward:t.reward});
      tg?.HapticFeedback?.impactOccurred("light");
    };
  });
}

// Balance
$id("btnBalance").onclick = ()=>{
  sendData({action:"get_balance"});
};

// Tabs
document.querySelectorAll(".tab").forEach(b=>{
  b.onclick = ()=> showTab(b.dataset.tab);
});

// Pay link
$id("openPay").onclick = (e)=>{e.preventDefault(); showTab("plans");};

// Open in TG button (for web preview)
if (!IS_TG) {
  document.getElementById("btnOpenInTG").classList.remove("hidden");
  document.getElementById("btnOpenInTG").onclick = ()=>{
    alert("Откройте эту страницу из Telegram мини-аппа (кнопка /app у бота).");
  };
} else {
  tg.expand(); // растянуть
  tg.setHeaderColor("secondary_bg_color");
  tg.setBackgroundColor(tg.themeParams.bg_color || "#0b0b0b");
}

// Init
renderBots();
renderPlans();
renderTasks();
setRefLink();
showTab("catalog");
</script>
</body>
</html>
