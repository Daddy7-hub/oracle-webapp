<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"
  />
  <title>Oracle Quest ‚Äî WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0f1c; --card:#0f1530; --card2:#121a3a; --line:rgba(255,255,255,.08);
      --text:#eef1ff; --muted:#a9b6ff; --ok:#38d39f; --danger:#ff6b6b;
      --r:18px; --pad:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(1200px 900px at 120% -20%, #1a2250 0,#0b0f1c 60%) fixed,
        radial-gradient(900px 700px at -30% 120%, #0f1330 0,#0b0f1c 55%) fixed,
        linear-gradient(180deg,#0c1022,#0b0f1c);
      color:var(--text);
      font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    }
    .app{max-width:980px;margin:0 auto;padding:12px 12px 84px}
    .app__header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 12px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand__logo{
      width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
      background:conic-gradient(from 190deg,#74f1d1,#7aa2ff 45%,#74f1d1 100%); color:#0b0f1c;font-weight:900;
      box-shadow:0 10px 35px rgba(116,241,209,.25);
    }
    .brand__title{margin:0;font-size:18px;font-weight:800;letter-spacing:.2px}
    .brand__desc{margin:0;font-size:12px;color:var(--muted)}
    .chip{border:1px solid var(--line);background:#0e1330;padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .router{display:block}
    .page{display:block}
    .card{
      background:linear-gradient(135deg,var(--card2),var(--card));
      border:1px solid var(--line); border-radius:var(--r); padding:var(--pad); margin-bottom:12px;
      box-shadow:0 10px 30px rgba(122,162,255,.12);
    }
    .grid{display:grid;gap:12px}
    .grid--2{grid-template-columns:repeat(2,1fr)}
    .grid--3{grid-template-columns:repeat(3,1fr)}
    @media(max-width:780px){.grid--2,.grid--3{grid-template-columns:1fr}}
    .label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block}
    input,select,textarea{
      width:100%;background:#0d1330;border:1px solid var(--line);color:var(--text);
      border-radius:12px;padding:10px 12px;outline:none
    }
    textarea{resize:vertical}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:14px;
      border:1px solid var(--line);background:linear-gradient(135deg,#1a2350,#121a3a);color:var(--text);
      cursor:pointer;user-select:none;transition:transform .05s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn--ok{background:linear-gradient(135deg,#1a4f3a,#153b2c);border-color:rgba(56,211,159,.35)}
    .btn--pay{background:linear-gradient(135deg,#24307a,#1a2350);border-color:rgba(122,162,255,.35)}
    .btn--danger{background:linear-gradient(135deg,#4b1a1a,#3b1313);border-color:rgba(255,107,107,.35)}
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .stat{display:flex;gap:8px;align-items:center;padding:10px;border-radius:14px;background:#0d1330;border:1px solid var(--line)}
    .stat b{font-size:18px}
    .energy .bar{height:10px;border-radius:999px;background:#0c122a;border:1px solid var(--line);overflow:hidden;min-width:200px}
    .energy .bar i{display:block;height:100%;width:0;background:linear-gradient(90deg,#7aa2ff,#74f1d1);transition:width .3s ease}
    .tap{
      margin:12px 0; display:grid;place-items:center;aspect-ratio:1/1;border-radius:20px;border:1px solid var(--line);
      background: radial-gradient(600px 300px at 50% 0%, rgba(122,162,255,.15), transparent 70%),
                  linear-gradient(135deg,#131c40,#0f1530);
      box-shadow: 0 10px 30px rgba(122,162,255,.18), inset 0 0 0 1px rgba(255,255,255,.02);
      user-select:none; cursor:pointer; position:relative; overflow:hidden;
    }
    .tap__label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .tap__score{font-size:42px;font-weight:900;letter-spacing:.5px}
    .pulse{position:absolute;border-radius:50%;pointer-events:none;border:2px solid rgba(116,241,209,.5);transform:scale(0);opacity:.9;animation:pulse .6s ease-out forwards}
    @keyframes pulse{to{transform:scale(8);opacity:0}}
    .shop{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .pack{padding:12px;border-radius:14px;background:#0d1330;border:1px solid var(--line);text-align:center}
    .pack b{font-size:18px}
    .stars{color:#ffe27a;margin:4px 0}
    .note{padding:12px;border:1px dashed var(--line);border-radius:14px;background:#0e1330;color:var(--muted)}
    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none}
    .tasks{display:grid;gap:10px}
    .task{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0e1330}
    .task.done{opacity:.6}
    .task .t{font-weight:600}
    .task .r{color:var(--muted);font-size:12px}
    .tabs{
      position:fixed;left:0;right:0;bottom:0;z-index:40;
      display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:8px;
      background:linear-gradient(180deg,rgba(11,15,28,.2),rgba(11,15,28,.8) 30%,rgba(11,15,28,.95));
      backdrop-filter: blur(8px); border-top:1px solid var(--line);
    }
    .tab{
      appearance:none;border:1px solid var(--line);background:#0e1330;border-radius:14px;padding:8px 4px;
      color:var(--text);display:flex;flex-direction:column;align-items:center;gap:4px;font-size:12px;cursor:pointer
    }
    .tab.active{outline:2px solid rgba(122,162,255,.5)}
    .light body{background:#f2f4ff}
    .light .card,.light .task,.light .pack,.light .note{background:#fff;border-color:#e6ebff;color:#111}
    .light .chip{background:#fff;color:#334}
    .light .tab{background:#fff}
    .light .tap{background:linear-gradient(135deg,#f1f3ff,#e9edff)}
  </style>
</head>
<body>
  <div id="app" class="app">
    <header class="app__header">
      <div class="brand">
        <div class="brand__logo">üîÆ</div>
        <div class="brand__meta">
          <h1 class="brand__title">Oracle Quest</h1>
          <p class="brand__desc">–∫–ª–∏–∫–µ—Ä + —á—Ç–µ–Ω–∏—è + –º–∞–≥–∞–∑–∏–Ω ‚≠ê</p>
        </div>
      </div>
      <div class="chip" id="envChip">‚Ä¶</div>
    </header>

    <main id="router" class="router"></main>

    <nav class="tabs">
      <button class="tab" data-route="home"><span>üè†</span><b>–ì–ª–∞–≤–Ω–∞—è</b></button>
      <button class="tab" data-route="readings"><span>üìú</span><b>–ß—Ç–µ–Ω–∏—è</b></button>
      <button class="tab" data-route="shop"><span>‚≠ê</span><b>–ú–∞–≥–∞–∑–∏–Ω</b></button>
      <button class="tab" data-route="quests"><span>üéØ</span><b>–ö–≤–µ—Å—Ç—ã</b></button>
      <button class="tab" data-route="profile"><span>üë§</span><b>–ê–Ω–∫–µ—Ç–∞</b></button>
    </nav>
  </div>

  <!-- TEMPLATES -->
  <template id="tpl-home">
    <section class="page">
      <div class="stats">
        <div class="stat"><span>üíé</span><div><div>–ö—Ä–µ–¥–∏—Ç—ã</div><b data-bind="credits">0</b></div></div>
        <div class="stat energy">
          <span>‚ö°</span>
          <div>
            <div>–≠–Ω–µ—Ä–≥–∏—è</div>
            <div class="bar"><i data-bind="energyBar" style="width:0%"></i></div>
          </div>
          <b data-bind="energy">0</b>
        </div>
        <div class="stat"><span>‚¨ÜÔ∏è</span><div><div>–ú–Ω–æ–∂–∏—Ç–µ–ª—å</div><b data-bind="mult">x1.0</b></div></div>
        <div class="stat"><span>üéöÔ∏è</span><div><div>–£—Ä–æ–≤–µ–Ω—å</div><b data-bind="lvl">1</b></div></div>
      </div>

      <div class="tap" data-action="tap">
        <div class="tap__label">–¢–∞–ø–∞–π, —á—Ç–æ–±—ã –¥–æ–±—ã—Ç—å ¬´–∏–Ω—Å–∞–π—Ç—ã¬ª</div>
        <div class="tap__score" data-bind="score">0</div>
      </div>

      <div class="grid grid--2">
        <button class="btn btn--ok" data-action="toReadingsMini">üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –º–∏–Ω–∏-—á—Ç–µ–Ω–∏–µ</button>
        <button class="btn" data-action="toReadingsDeep">‚ú® –ì–ª—É–±–æ–∫–æ–µ —á—Ç–µ–Ω–∏–µ</button>
      </div>

      <p class="muted">–ú–∏–Ω–∏-—á—Ç–µ–Ω–∏–µ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ (–∏–ª–∏ –ø–æ –ª–∏–º–∏—Ç—É). –ì–ª—É–±–æ–∫–æ–µ ‚Äî 1 –∫—Ä–µ–¥–∏—Ç –∏–ª–∏ –¥–µ–º–æ —Ä–∞–∑ –≤ 7 –¥–Ω–µ–π.</p>
    </section>
  </template>

  <template id="tpl-readings">
    <section class="page">
      <h2>–ß—Ç–µ–Ω–∏—è</h2>
      <div class="card">
        <div class="grid grid--3">
          <div>
            <label class="label">–¢–µ–º–∞</label>
            <select data-model="topic">
              <option value="career">–ö–∞—Ä—å–µ—Ä–∞</option>
              <option value="love">–õ—é–±–æ–≤—å</option>
              <option value="finance">–§–∏–Ω–∞–Ω—Å—ã</option>
              <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
              <option value="overall" selected>–û–±—â–µ–µ</option>
            </select>
          </div>
          <div>
            <label class="label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
            <input type="date" data-model="dob" />
          </div>
          <div>
            <label class="label">–ü–æ–ª</label>
            <select data-model="gender">
              <option value="">‚Äî</option>
              <option value="male">–º</option>
              <option value="female">–∂</option>
              <option value="other">–¥—Ä—É–≥–æ–π</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label class="label">–ö–æ–Ω—Ç–µ–∫—Å—Ç (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)</label>
          <textarea rows="4" data-model="context" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏ —Å–∏—Ç—É–∞—Ü–∏—é‚Ä¶"></textarea>
        </div>

        <div class="grid grid--2" style="margin-top:12px">
          <button class="btn btn--ok" data-action="mini">üîÆ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏-—á—Ç–µ–Ω–∏–µ</button>
          <button class="btn" data-action="deep">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≥–ª—É–±–æ–∫–æ–µ</button>
        </div>
      </div>

      <div class="card hidden" id="preview">
        <div class="label">PREVIEW (–±—Ä–∞—É–∑–µ—Ä): JSON, –∫–æ—Ç–æ—Ä—ã–π —É–π–¥—ë—Ç –±–æ—Ç—É</div>
        <pre id="previewJson"></pre>
      </div>

      <div class="note">‚ö†Ô∏è –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –º–µ–¥/—Ñ–∏–Ω/—é—Ä –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.</div>
    </section>
  </template>

  <template id="tpl-shop">
    <section class="page">
      <h2>–ú–∞–≥–∞–∑–∏–Ω ‚≠ê</h2>
      <div class="shop">
        <div class="pack">
          <b>1 –∫—Ä–µ–¥–∏—Ç</b>
          <div class="stars">50 ‚≠ê</div>
          <button class="btn btn--pay" data-pack="1">–ö—É–ø–∏—Ç—å</button>
        </div>
        <div class="pack">
          <b>5 –∫—Ä–µ–¥–∏—Ç–æ–≤</b>
          <div class="stars">240 ‚≠ê</div>
          <button class="btn btn--pay" data-pack="5">–ö—É–ø–∏—Ç—å</button>
        </div>
        <div class="pack">
          <b>10 –∫—Ä–µ–¥–∏—Ç–æ–≤</b>
          <div class="stars">450 ‚≠ê</div>
          <button class="btn btn--pay" data-pack="10">–ö—É–ø–∏—Ç—å</button>
        </div>
      </div>

      <div class="grid grid--2" style="margin-top:12px">
        <button class="btn" data-action="boostEnergy">‚ö° –≠–Ω–µ—Ä–≥–∏—è +50</button>
        <button class="btn" data-action="boostMult">‚¨ÜÔ∏è –ú–Ω–æ–∂–∏—Ç–µ–ª—å +0.1</button>
      </div>

      <p class="muted">–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ ‚≠ê. –ù–∞–∂–º–∏ ¬´–ö—É–ø–∏—Ç—å¬ª ‚Äî –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º —Å–∏–≥–Ω–∞–ª –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.</p>
    </section>
  </template>

  <template id="tpl-quests">
    <section class="page">
      <h2>–ö–≤–µ—Å—Ç—ã</h2>
      <div id="tasks" class="tasks"></div>
    </section>
  </template>

  <template id="tpl-profile">
    <section class="page">
      <h2>–ê–Ω–∫–µ—Ç–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</h2>
      <div class="card">
        <div class="grid grid--3">
          <div>
            <label class="label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
            <input type="date" data-model="dob" />
          </div>
          <div>
            <label class="label">–ü–æ–ª</label>
            <select data-model="gender">
              <option value="">‚Äî</option>
              <option value="male">–º</option>
              <option value="female">–∂</option>
              <option value="other">–¥—Ä—É–≥–æ–π</option>
            </select>
          </div>
          <div>
            <label class="label">–¢–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
            <select data-model="topic">
              <option value="career">–ö–∞—Ä—å–µ—Ä–∞</option>
              <option value="love">–õ—é–±–æ–≤—å</option>
              <option value="finance">–§–∏–Ω–∞–Ω—Å—ã</option>
              <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
              <option value="overall">–û–±—â–µ–µ</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label class="label">–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
          <textarea rows="3" data-model="context" placeholder="–°–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ"></textarea>
        </div>

        <div class="grid grid--2" style="margin-top:12px">
          <button class="btn btn--ok" data-action="saveProfile">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn btn--danger" data-action="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        </div>
      </div>

      <div class="note">
        WebApp –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç payload —á–µ—Ä–µ–∑ <code>WebApp.sendData</code> ‚Äî
        —Ç–≤–æ–π –±–æ—Ç –ø–æ–π–º–∞–µ—Ç –µ–≥–æ –≤ <code>@dp.message(F.web_app_data)</code>.
      </div>
    </section>
  </template>

  <script type="module">
    // ---------- TG helpers ----------
    const tg = window.Telegram?.WebApp || null;
    const inTG = !!(tg && tg.initDataUnsafe);
    const envChipEl = document.getElementById('envChip');

    function initTheme() {
      if (!inTG) {
        envChipEl.textContent = 'Browser preview';
        document.documentElement.classList.remove('light');
        return;
      }
      tg.ready?.(); tg.expand?.();
      const tp = tg.themeParams || {};
      const isLight = (tg.colorScheme === 'light') || (tp.bg_color && luminance(tp.bg_color) > 0.8);
      if (isLight) document.documentElement.classList.add('light');
      envChipEl.textContent = `WebApp ‚Ä¢ ${isLight ? 'light' : 'dark'}`;
    }
    function luminance(hex) {
      const c = (hex || '').replace('#', '');
      if (c.length < 6) return .1;
      const [r, g, b] = [0, 2, 4].map(i => parseInt(c.slice(i, i + 2), 16) / 255);
      const L = [r, g, b].map(v => v <= .03928 ? v / 12.92 : Math.pow((v + .055) / 1.055, 2.4));
      return 0.2126 * L[0] + 0.7152 * L[1] + 0.0722 * L[2];
    }
    function popup(message, kind='info', title) {
      if (!inTG || !tg.showPopup) { console.log(`[${kind}]`, message); return; }
      tg.showPopup({ title: title || '–û—Ä–∞–∫—É–ª', message, buttons:[{id:'ok', type:'ok', text:'–û–ö'}] });
    }
    function haptic(type) {
      try{
        if (!tg?.HapticFeedback) return;
        if (type==='impact') tg.HapticFeedback.impactOccurred('medium');
        if (type==='success') tg.HapticFeedback.notificationOccurred('success');
        if (type==='error') tg.HapticFeedback.notificationOccurred('error');
      }catch(e){}
    }
    function sendPayload(obj) {
      const payload = JSON.stringify(obj);
      const prev = document.getElementById('preview');
      const pre = document.getElementById('previewJson');
      if (!inTG || !tg.sendData) {
        if (prev && pre) { prev.classList.remove('hidden'); pre.textContent = payload; }
        console.log('[preview send]', obj);
        return;
      }
      tg.MainButton.setParams({ text:'–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶', is_visible:true }); tg.MainButton.showProgress?.();
      try{
        tg.sendData(payload);
        popup('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.','ok');
        haptic('impact');
      } finally {
        setTimeout(()=>{ tg.MainButton.hideProgress?.(); tg.MainButton.setParams({text:'–ì–æ—Ç–æ–≤–æ',is_visible:false}); }, 600);
      }
    }

    // ---------- State ----------
    const KEY = 'oracleq_v2';
    const defaults = {
      credits: 0, score: 0, lvl: 1, mult: 1.0,
      energy: 100, energyMax: 100, regen: 6, lastTick: Date.now(),
      profile: { topic:'overall', dob:'', gender:'', context:'' },
      tasks: [
        { id:'daily', t:'–ó–∞–±–µ—Ä–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å', r:'+1 –∫—Ä–µ–¥–∏—Ç', done:false },
        { id:'readMini', t:'–°–¥–µ–ª–∞–π –º–∏–Ω–∏-—á—Ç–µ–Ω–∏–µ', r:'+50 –æ—á–∫–æ–≤', done:false },
        { id:'tap100', t:'–ù–∞–∫–ª–∏–∫–∞–π 100 –æ—á–∫–æ–≤', r:'–≠–Ω–µ—Ä–≥–∏—è +50', done:false },
      ]
    };
    let S = load();
    function load(){ try{ return {...structuredClone(defaults), ...JSON.parse(localStorage.getItem(KEY)||'{}')} }catch(e){ return structuredClone(defaults) } }
    function save(){ localStorage.setItem(KEY, JSON.stringify(S)); }
    function addCredits(n){ S.credits=Math.max(0,(S.credits||0)+n); save(); bindStats(); }
    function addScore(n){ S.score=(S.score||0)+n; if(S.score>= (S.lvl*200)){ S.lvl++; S.mult=+(S.mult+0.1).toFixed(1);} save(); bindStats(); }
    function setProfile(p){ S.profile={...S.profile,...p}; save(); }
    function regenEnergy(){
      const now=Date.now(); const dt=Math.max(0, Math.floor((now-S.lastTick)/1000)); if(!dt) return;
      S.lastTick=now; S.energy=Math.min(S.energyMax, S.energy + dt*S.regen); save(); bindStats();
    }
    setInterval(regenEnergy, 1000);

    // ---------- Router & Screens ----------
    const $router = document.getElementById('router');
    const T = id => document.getElementById(id).content.cloneNode(true);

    function route(name){ window.location.hash = '#'+name; render(name); }
    function render(name){
      $router.innerHTML = '';
      const tabs=[...document.querySelectorAll('.tab')];
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.route===name));

      if(name==='home'){ renderHome(); return;}
      if(name==='readings'){ renderReadings(); return;}
      if(name==='shop'){ renderShop(); return;}
      if(name==='quests'){ renderQuests(); return;}
      if(name==='profile'){ renderProfile(); return;}
      renderHome();
    }

    // --- Home
    function renderHome(){
      const node=T('tpl-home'); $router.appendChild(node);
      bindStats();
      const tap = $router.querySelector('[data-action="tap"]');
      tap.addEventListener('click', ev=>{
        if (S.energy < 1) { popup('–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏. –ü–æ–ø—Ä–æ–±—É–π –±—É—Å—Ç—ã –≤ –ú–∞–≥–∞–∑–∏–Ω–µ ‚≠ê','warn'); return; }
        S.energy = Math.max(0, S.energy-1); const gain = Math.round(1 * S.mult);
        addScore(gain); pulse(tap, ev);
        save(); bindStats(); haptic('impact');
        // quest
        if (S.score>=100 && !isDone('tap100')) { markDone('tap100'); S.energy=Math.min(S.energyMax,S.energy+50); popup('–ö–≤–µ—Å—Ç ¬´–ù–∞–∫–ª–∏–∫–∞–π 100 –æ—á–∫–æ–≤¬ª –≤—ã–ø–æ–ª–Ω–µ–Ω! –≠–Ω–µ—Ä–≥–∏—è +50','ok'); save(); }
      });
      $router.querySelector('[data-action="toReadingsMini"]').onclick=()=>{ route('readings'); setTimeout(()=>trigger('mini'),50); };
      $router.querySelector('[data-action="toReadingsDeep"]').onclick=()=>{ route('readings'); setTimeout(()=>trigger('deep'),50); };
    }
    function pulse(el, ev){
      const p=document.createElement('i'); p.className='pulse';
      const r= Math.max(el.clientWidth, el.clientHeight); const x=(ev.offsetX||el.clientWidth/2), y=(ev.offsetY||el.clientHeight/2);
      p.style.left=(x-8)+'px'; p.style.top=(y-8)+'px'; p.style.width='16px'; p.style.height='16px';
      el.appendChild(p); setTimeout(()=>p.remove(),650);
    }
    function bindStats(){
      const q=sel=>$router.querySelector(`[data-bind="${sel}"]`);
      if(!q('credits')) return;
      q('credits').textContent = S.credits;
      q('score').textContent = S.score.toLocaleString('ru-RU');
      q('lvl').textContent = S.lvl;
      q('mult').textContent = 'x'+S.mult.toFixed(1);
      q('energy').textContent = Math.floor(S.energy);
      const w = Math.round(100 * (S.energy / S.energyMax));
      q('energyBar').style.width = w+'%';
    }

    // --- Readings
    function renderReadings(){
      const node=T('tpl-readings'); $router.appendChild(node);
      // init models from state
      setValue('[data-model="topic"]', S.profile.topic || 'overall');
      setValue('[data-model="dob"]', S.profile.dob || '');
      setValue('[data-model="gender"]', S.profile.gender || '');
      setValue('[data-model="context"]', S.profile.context || '');

      $router.querySelector('[data-action="mini"]').onclick = ()=> trigger('mini');
      $router.querySelector('[data-action="deep"]').onclick = ()=> trigger('deep');
    }
    function getModel(){
      const topic = getValue('[data-model="topic"]');
      const dob = getValue('[data-model="dob"]');
      const gender = getValue('[data-model="gender"]');
      const context = getValue('[data-model="context"]').slice(0,500);
      setProfile({topic,dob,gender,context});
      return { topic, dob, gender, context };
    }
    function trigger(mode){
      const m = getModel();
      if (mode==='mini') { addScore(50); if(!isDone('readMini')) { markDone('readMini'); popup('–ö–≤–µ—Å—Ç ¬´–°–¥–µ–ª–∞–π –º–∏–Ω–∏-—á—Ç–µ–Ω–∏–µ¬ª –≤—ã–ø–æ–ª–Ω–µ–Ω! +50 –æ—á–∫–æ–≤','ok'); } }
      const payload = { action:'gen', mode, ...m };
      sendPayload(payload);
    }

    // --- Shop
    function renderShop(){
      const node=T('tpl-shop'); $router.appendChild(node);
      $router.querySelectorAll('[data-pack]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pack = parseInt(btn.dataset.pack,10);
          // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –±–æ—Ç—É –æ—Ç–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–∏ Stars
          sendPayload({ action:'pay', pack });
        });
      });
      $router.querySelector('[data-action="boostEnergy"]').onclick=()=>{
        S.energy = Math.min(S.energyMax, S.energy + 50); save(); bindStats(); haptic('success');
      };
      $router.querySelector('[data-action="boostMult"]').onclick=()=>{
        S.mult = +(S.mult + 0.1).toFixed(1); save(); bindStats(); haptic('success');
      };
      bindStats();
    }

    // --- Quests
    function renderQuests(){
      const node=T('tpl-quests'); $router.appendChild(node);
      const $tasks = $router.querySelector('#tasks'); $tasks.innerHTML='';
      S.tasks.forEach(t=>{
        const row = document.createElement('div'); row.className='task'+(t.done?' done':'');
        const left = document.createElement('div'); left.innerHTML = `<div class="t">${t.t}</div><div class="r">${t.r}</div>`;
        const right = document.createElement('div');
        const b = document.createElement('button'); b.className='btn'; b.textContent = t.done?'–ì–æ—Ç–æ–≤–æ':'–ó–∞–±—Ä–∞—Ç—å';
        b.disabled = t.done;
        b.onclick=()=>claim(t.id);
        right.appendChild(b);
        row.appendChild(left); row.appendChild(right);
        $tasks.appendChild(row);
      });
    }
    function isDone(id){ return !!S.tasks.find(x=>x.id===id)?.done; }
    function markDone(id){ const t=S.tasks.find(x=>x.id===id); if(t) t.done=true; save(); render('quests'); }
    function claim(id){
      const t = S.tasks.find(x=>x.id===id); if(!t || t.done) return;
      if (id==='daily'){ addCredits(1); popup('–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: +1 –∫—Ä–µ–¥–∏—Ç','ok'); }
      if (id==='readMini'){ addScore(50); }
      if (id==='tap100'){ S.energy=Math.min(S.energyMax,S.energy+50); }
      t.done=true; save(); render('quests');
    }

    // --- Profile
    function renderProfile(){
      const node=T('tpl-profile'); $router.appendChild(node);
      setValue('[data-model="topic"]', S.profile.topic || 'overall');
      setValue('[data-model="dob"]', S.profile.dob || '');
      setValue('[data-model="gender"]', S.profile.gender || '');
      setValue('[data-model="context"]', S.profile.context || '');
      $router.querySelector('[data-action="saveProfile"]').onclick=()=>{
        const m=getModel(); setProfile(m); popup('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','ok'); haptic('success');
      };
      $router.querySelector('[data-action="reset"]').onclick=()=>{
        if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å?')) { localStorage.removeItem(KEY); S=load(); render('home'); }
      };
    }

    // helpers for models
    function getValue(sel){ const el=$router.querySelector(sel); return (el?.value||'').trim(); }
    function setValue(sel, val){ const el=$router.querySelector(sel); if(el) el.value=val||''; }

    // tabs
    document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=>route(b.dataset.route)));
    window.addEventListener('hashchange', ()=> render((location.hash||'#home').slice(1)));

    // boot
    initTheme();
    render((location.hash||'#home').slice(1) || 'home');
  </script>
</body>
</html>
