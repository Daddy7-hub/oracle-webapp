<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>CryptoATM.tech ‚Äî Mini App</title>

  <!-- Telegram WebApp API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0a0b0e;--panel:#111319;--card:#141821;--muted:#a5adbb;--txt:#f1f5fb;
      --gold:#d4af37;--gold-2:#f5d77a;--gold-glow:rgba(212,175,55,.28);
      --accent:#00e5ff;--green:#22e39e;--danger:#ff6a88;
      --b1:1px solid rgba(255,255,255,.08);--r:14px;--r-xl:18px;
      --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
      --shadow:0 6px 28px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.04) inset
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.08), transparent 60%), var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Inter,Segoe UI,Roboto,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    :focus-visible{outline:2px solid var(--accent); outline-offset:2px; border-radius:8px}
    .wrap{max-width:1160px;margin:0 auto;padding: calc(10px + var(--safe-top)) 14px 120px}
    header{position:sticky; top:0; z-index:12; margin:0 -14px 14px; padding: calc(8px + var(--safe-top)) 14px 8px; background:linear-gradient(180deg, rgba(10,11,14,.95), rgba(10,11,14,.6)); backdrop-filter:saturate(120%) blur(6px); border-bottom: var(--b1)}
    .hbar{ display:flex; align-items:center; justify-content:space-between; gap:12px }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0 }
    .logo{ width:44px; height:44px; border-radius:12px; background: radial-gradient(140% 140% at 30% 20%, var(--gold-2), var(--gold) 60%, #6e570f); box-shadow: inset 0 2px 10px rgba(255,255,255,.25), 0 4px 18px var(--gold-glow) }
    .brand h1{margin:0;font-size:18px;letter-spacing:.6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px}
    .userchips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:var(--b1);border-radius:999px;padding:8px 12px;color:var(--txt)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}
    @media(max-width:1020px){.col-8,.col-6,.col-4{grid-column:span 12}}

    .card{background:var(--card);border:var(--b1);border-radius:var(--r-xl);padding:14px;box-shadow:var(--shadow);animation:fadein .3s ease}
    .card h3{margin:0 0 8px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:rgba(255,255,255,.06);border:var(--b1);border-radius:8px;padding:4px 8px;color:var(--muted);font-size:12px}

    /* Buttons / inputs */
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer;transition:transform .04s ease, box-shadow .2s ease;background:#1a2030;color:var(--txt);border:1px solid rgba(255,255,255,.1)}
    .btn.primary{background:linear-gradient(135deg, #715d1d, #f3d46b 40%, #c9a529);color:#0b0b0c;text-shadow:0 1px 0 rgba(255,255,255,.35);border:1px solid rgba(245,215,122,.65);box-shadow: 0 4px 18px rgba(212,175,55,.28), 0 1px 0 rgba(255,255,255,.25) inset}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.3)}
    .btn:active{transform:translateY(1px)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#11161f;color:var(--txt);outline:none}
    select{padding-right:32px}
    .label{color:var(--muted);font-weight:700}
    .line{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed rgba(255,255,255,.1);padding-top:10px;margin-top:10px}
    .price{font-weight:900}
    .kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}

    /* PRODUCT CARD LAYOUT (equal height) */
    .p-card{display:flex;flex-direction:column;min-height:260px}
    .p-head{display:flex;align-items:flex-start;justify-content:space-between}
    .p-body{margin-top:6px;flex:1 1 auto}
    .p-actions{border-top:1px dashed rgba(255,255,255,.1);padding-top:10px;margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:space-between}

    /* Bottom swipeable nav (with arrows) */
    .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:40;padding:8px 10px calc(8px + var(--safe-bot));background:linear-gradient(180deg, rgba(10,11,14,0), rgba(10,11,14,.96))}
    .tabbar-inner{max-width:1160px;margin:0 auto;display:flex;gap:8px;justify-content:space-between;background:#0e1117;border:var(--b1);border-radius:16px;padding:6px}
    .tnav-wrap{display:flex;align-items:center;gap:6px;flex:1}
    .tnav{flex:1;display:grid;grid-auto-flow:column;gap:6px;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
    .tnav::-webkit-scrollbar{display:none}
    .tbtn{appearance:none;background:transparent;border:1px solid rgba(255,255,255,.08);color:var(--txt);border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:8px;min-width:130px;justify-content:center;cursor:pointer;scroll-snap-align:center;font-weight:800}
    .tbtn.active{background:linear-gradient(135deg, rgba(245,215,122,.18), rgba(212,175,55,.14));box-shadow:0 0 0 1px rgba(212,175,55,.5) inset}
    .tscroll{appearance:none;border:1px solid rgba(255,255,255,.1);background:#171b26;color:var(--txt);border-radius:12px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer}

    /* Cart icon */
    .carticon{appearance:none;background:linear-gradient(135deg, #272c3a, #171b26);border:1px solid rgba(255,255,255,.1);color:var(--txt);border-radius:12px;min-width:64px;padding:0 10px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer}
    .carticon b{background:#d4af37;color:#0a0b0e;border-radius:999px;padding:2px 8px;font-weight:900}

    /* Modal basics */
    .modal-back{position:fixed;inset:0;z-index:50;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);padding:20px 14px}
    .modal{max-width:720px;width:100%;background:#0e1117;border:var(--b1);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .modal h2{margin:0 0 10px}
    .modal .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Splash */
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.12), transparent 60%), var(--bg);z-index:60}
    .s-title{font-weight:900;font-size:28px;letter-spacing:.6px}
    .s-sub{color:var(--muted);text-align:center;margin-top:4px}

    /* Coins animation */
    .coin{position:fixed;left:50%;top:-20px;font-size:22px;animation:fall 900ms ease-in forwards;pointer-events:none;filter:drop-shadow(0 2px 6px rgba(0,0,0,.6))}
    @keyframes fall{0%{transform:translate(-50%, -40px) rotate(0);opacity:.9} 70%{opacity:1} 100%{transform:translate(-50%, 70vh) rotate(360deg);opacity:0}}

    .page{display:none}.page.active{display:block}
    .touching{filter:brightness(1.03)}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

<!-- Splash (–¥–∏—Å–∫–ª–µ–π–º–µ—Ä EN –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π) -->
<div id="splash" class="splash">
  <div style="text-align:center;max-width:640px;padding:0 16px">
    <div class="s-title">CryptoATM.tech</div>
    <p class="s-sub" style="margin-top:10px">
      By accessing this Mini App, you confirm you understand CryptoATM.tech does not provide financial or investment advice. Information is educational/analytical only. Markets are volatile; do your own research. By continuing, you agree to our Terms.
    </p>
    <div style="margin-top:18px">
      <button class="btn primary" id="agree-btn" type="button">I Agree</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- HEADER -->
  <header>
    <div class="hbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>CryptoATM.tech</h1>
          <small id="brand-sub">–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ –ü–∞–∫–µ—Ç—ã ‚Ä¢ –ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã</small>
        </div>
      </div>
      <div class="userchips">
        <button class="chip" id="lang-toggle" type="button">üåê <b id="lang-code">RU</b></button>
        <div class="chip">üë§ <b id="chip-name">@guest</b></div>
        <div class="chip">ATM: <b id="chip-atm">0</b></div>
        <div class="chip">–ó–∞–∫–∞–∑—ã: <b id="chip-orders">0</b></div>
        <button class="chip" id="dev-login" type="button" style="display:none">‚öôÔ∏è –¢–µ—Å—Ç-–≤—Ö–æ–¥</button>
      </div>
    </div>
  </header>

  <!-- PAGES -->
  <main id="pages">
    <!-- SHOP -->
    <section id="page-shop" class="page active">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="sub-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
          <p class="muted" id="sub-help">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ 1/3/6/12 –º–µ—Å (—Å–∫–∏–¥–∫–∞ 0/10/20/30%). ATM ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –Ω–∞–≥—Ä–∞–¥–∞, —Å–µ–π—á–∞—Å –Ω–µ —Ä–∞—Å—Ö–æ–¥—É—é—Ç—Å—è.</p>
          <div class="row">
            <div class="kv" style="min-width:200px">
              <label class="label" for="period" id="lbl-term">–°—Ä–æ–∫</label>
              <select id="period"><option value="1">1</option><option value="3">3</option><option value="6">6</option><option value="12">12</option></select>
            </div>
          </div>
        </div>

        <div id="catalog" class="col-12 grid"></div>
      </div>
    </section>

    <!-- ORDERS -->
    <section id="page-orders" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="orders-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
          <table class="table" id="orders-table">
            <thead><tr>
              <th id="th-num">‚Ññ</th><th id="th-prod">–¢–æ–≤–∞—Ä</th><th id="th-term">–°—Ä–æ–∫</th><th id="th-meth">–ú–µ—Ç–æ–¥</th><th id="th-sum">–°—É–º–º–∞</th><th id="th-st">–°—Ç–∞—Ç—É—Å</th><th id="th-date">–î–∞—Ç–∞</th><th>Memo</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REFERRALS -->
    <section id="page-ref" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="ref-title">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
          <p class="muted" id="ref-help">–î–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM). –í–∞—à –∫–æ–¥:</p>
          <div class="row"><input id="ref-code" readonly><button class="btn primary" id="ref-copy" type="button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
          <div class="line">
            <div class="muted" id="bind-title">–ü—Ä–∏–≤—è–∑–∞—Ç—å —á—É–∂–æ–π –∫–æ–¥</div>
            <div class="row"><input id="ref-bind-input" placeholder="REF123456"><button class="btn" id="ref-bind-btn" type="button">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button></div>
          </div>
          <div style="margin-top:10px">
            <table class="table" id="ref-table"><thead><tr><th id="th-partner">–ü–∞—Ä—Ç–Ω—ë—Ä</th><th id="th-date2">–î–∞—Ç–∞</th><th id="th-paid">–û–ø–ª–∞—Ç–∞</th><th id="th-reward">–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <!-- BALANCE -->
    <section id="page-balance" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="bal-title">–ë–∞–ª–∞–Ω—Å ATM</h3>
          <p class="muted" id="bal-help">ATM –∫–æ–ø—è—Ç—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –ù–µ –∏–º–µ—é—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–∞ –≤ —Ñ–∏–∞—Ç–Ω–æ–π –≤–∞–ª—é—Ç–µ.</p>
          <div class="row"><div class="chip">Balance: <b id="atm-balance">0</b></div></div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="page-admin" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="adm-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
          <p class="muted" id="adm-help">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∑–∞–∫–∞–∑—ã. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º.</p>
          <div class="row"><button class="btn" id="admin-refresh">–û–±–Ω–æ–≤–∏—Ç—å</button><button class="btn ghost" id="admin-export">–≠–∫—Å–ø–æ—Ä—Ç JSON</button></div>
          <div class="grid" style="margin-top:12px">
            <div class="col-12 card" id="admin-stats"></div>
            <div class="col-12 card"><h3 id="adm-users-h">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3><table class="table" id="admin-users"><thead><tr><th>ID</th><th>Username</th><th>ATM</th><th>–ó–∞–∫–∞–∑—ã</th><th>–†–µ—Ñ-–∫–æ–¥</th><th>–û—Ç –∫–æ–≥–æ</th><th>–î–∞—Ç–∞</th></tr></thead><tbody></tbody></table></div>
            <div class="col-12 card"><h3 id="adm-orders-h">–ó–∞–∫–∞–∑—ã</h3><table class="table" id="admin-orders"><thead><tr><th>#</th><th>User</th><th>–¢–æ–≤–∞—Ä—ã</th><th>–°—Ä–æ–∫</th><th>–ú–µ—Ç–æ–¥</th><th>‚Ç¨</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section id="page-faq" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3>FAQ</h3>
          <div id="faq-qa"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Bottom swipeable nav -->
<div class="tabbar">
  <div class="tabbar-inner">
    <div class="tnav-wrap">
      <button class="tscroll" id="tnav-left" type="button" aria-label="Left">‚Äπ</button>
      <div class="tnav" id="tnav">
        <button class="tbtn active" data-tab="shop" type="button">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
        <button class="tbtn" data-tab="orders" type="button">üìÑ –ó–∞–∫–∞–∑—ã</button>
        <button class="tbtn" data-tab="ref" type="button">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
        <button class="tbtn" data-tab="balance" type="button">üí∞ –ë–∞–ª–∞–Ω—Å</button>
        <button class="tbtn" data-tab="admin" id="tab-admin-btn" type="button" hidden>üõ† –ê–¥–º–∏–Ω</button>
        <button class="tbtn" data-tab="faq" type="button">‚ùì FAQ</button>
      </div>
      <button class="tscroll" id="tnav-right" type="button" aria-label="Right">‚Ä∫</button>
    </div>

    <!-- Cart button -->
    <button class="carticon" id="cart-open" type="button" aria-label="Cart">
      üß∫ <b id="cart-count">0</b>
    </button>
  </div>
</div>

<!-- ITEM DETAILS -->
<div class="modal-back" id="modal-item"><div class="modal"><h2 id="item-title">–¢–æ–≤–∞—Ä</h2><div id="item-desc" class="muted"></div><div class="foot"><button class="btn" id="close-item">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<!-- AUTH REQUIRED -->
<div class="modal-back" id="modal-auth"><div class="modal"><h2 id="auth-title">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2><p class="muted" id="auth-body">–û—Ç–∫—Ä–æ–π—Ç–µ Mini App –≤–Ω—É—Ç—Ä–∏ Telegram (—Å initData).</p><div class="foot"><button class="btn" id="auth-close">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<!-- CART SHEET -->
<div class="modal-back" id="modal-cart">
  <div class="modal">
    <h2 id="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</h2>
    <div id="cart-list" class="grid"></div>
    <div class="line"><div><b id="cart-total-label">–ò—Ç–æ–≥–æ:</b> <b id="cart-total">‚Ç¨0</b></div>
      <div class="row"><button class="btn" id="cart-close" type="button">–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="cart-checkout" type="button">–û—Ñ–æ—Ä–º–∏—Ç—å</button></div>
    </div>
  </div>
</div>

<!-- PAYMENT SHEET (single destination) -->
<div class="modal-back" id="modal-pay">
  <div class="modal">
    <h2 id="pay-title">–û–ø–ª–∞—Ç–∞</h2>
    <div class="grid">
      <div class="col-12 card">
        <div class="row">
          <div class="kv" style="min-width:420px">
            <span class="label" id="lbl-addr">–ê–¥—Ä–µ—Å</span>
            <code id="pay-addr" style="word-break:break-all"></code>
            <button class="btn" id="copy-addr" type="button" style="margin-left:8px">Copy</button>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="kv"><span class="label" id="lbl-amt">–°—É–º–º–∞</span><b id="pay-amount">‚Ç¨0</b><button class="btn" id="copy-amount" type="button" style="margin-left:8px">Copy</button></div>
          <div class="kv"><span class="label" id="lbl-memo">Memo</span><b id="pay-memo">‚Äî</b><button class="btn" id="copy-memo" type="button" style="margin-left:8px">Copy</button></div>
        </div>
        <p class="muted" style="margin-top:10px">
          –û–ø–ª–∞—á–∏–≤–∞—è –ø–æ–¥–ø–∏—Å–∫—É, –≤—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ CryptoATM.tech.
          <a id="terms-link" href="#" target="_blank" rel="noopener">–°—Å—ã–ª–∫–∞ –Ω–∞ —É—Å–ª–æ–≤–∏—è (–ø–æ–∑–∂–µ)</a>
        </p>
      </div>
      <div class="col-12">
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="pay-close" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="btn primary" id="paid-btn" type="button">–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =============================
   CORE / CONFIG / CONSTANTS
============================= */
const tg = window.Telegram?.WebApp;
try{ tg?.expand(); tg?.setHeaderColor('#0a0b0e'); tg?.setBackgroundColor('#0a0b0e'); }catch(e){}
const H = (type) => { try{ tg?.HapticFeedback?.impactOccurred?.(type||'light'); }catch(e){} };

// –ê–¥–º–∏–Ω—ã (–ø–æ–∫–∞ –≤ –∫–æ–¥–µ; –ø–æ–∑–∂–µ —Å –±—ç–∫–∞). –ó–ê–ú–ï–ù–ò –Ω–∞ —Å–≤–æ–π ID
const ADMIN_IDS = [568646738];

const START_BONUS_ATM = 250;
const REF_BONUS_PERCENT = 0.10; // 10% –≤ ATM –æ—Ç —Å—É–º–º—ã –ø–æ–¥–ø–∏—Å–∫–∏ ‚Äî –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ –º–æ–Ω–µ—Ç, –±–µ–∑ –∫—É—Ä—Å–∞
const PERIOD_DISCOUNT = {1:0, 3:0.10, 6:0.20, 12:0.30};
const ATM_REWARD_PER_ORDER = 100; // ‚Üê —Ñ–∏–∫—Å –Ω–∞–≥—Ä–∞–¥–∞ ATM –∑–∞ –ª—é–±–æ–π –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑

// –µ–¥–∏–Ω—ã–π –∞–¥—Ä–µ—Å –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
const PAY_ADDR = "0x5af48f9d26edb82e7c30247e105fbf61d2dd1a5c"; // TODO: –∑–∞–º–µ–Ω–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

// –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç
const BOT_LIST = [
  {code:'CRYPTO_ATM', name:'Crypto ATM Bot'},
  {code:'ALERTS', name:'Alerts Bot'},
  {code:'NEWS', name:'News Bot'}
];
const CATALOG = [
  {type:'onebot', code:'ONE_BOT', name:'One Bot', price:79, desc:'–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É. –ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–π.', chooseFrom: BOT_LIST},
  {type:'plan', code:'STANDARD', name:'Standard', price:150, desc:'–ë–∞–∑–æ–≤—ã–π –ø–∞–∫–µ—Ç –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.'},
  {type:'plan', code:'PREMIUM', name:'Premium', price:191, desc:'–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.', badge:'popular'},
  {type:'plan', code:'ENTERPRISE', name:'Enterprise', price:249, desc:'–¢–æ–ø–æ–≤—ã–π –ø–ª–∞–Ω —Å –º–∞–∫—Å–∏–º—É–º–æ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.', badge:'top'},
  {type:'plan', code:'COPY', name:'Copy-trading', price:50, desc:'‚Ç¨50/–º–µ—Å + 10% –æ—Ç –ø—Ä–∏–±—ã–ª–∏.'},
  {type:'consult', code:'CONSULT', name:'Consulting', price:79, desc:'–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º. ‚Ç¨79/—á–∞—Å. –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤.'},
  {type:'training', code:'TRAINING', name:'Training: First steps in crypto', price:890, desc:'–ü–æ–ª–Ω—ã–π –∫—É—Ä—Å ¬´–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ –≤ —Å—Ñ–µ—Ä–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç¬ª. –†–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂.'},
  {type:'trial', code:'TRIAL', name:'Trial 3 days', price:0, desc:'–ü—Ä–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –±–æ—Ç—É –Ω–∞ 3 –¥–Ω—è.', chooseFrom: BOT_LIST}
];

/* =============================
   I18N
============================= */
const i18n = {
  ru:{ brandSub:'–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ –ü–∞–∫–µ—Ç—ã ‚Ä¢ –ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã',
       shop:'–ú–∞–≥–∞–∑–∏–Ω',orders:'–ó–∞–∫–∞–∑—ã',ref:'–†–µ—Ñ–µ—Ä–∞–ª—ã',balance:'–ë–∞–ª–∞–Ω—Å',admin:'–ê–¥–º–∏–Ω',faq:'FAQ',
       subTitle:'–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏',
       subHelp:'–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ 1/3/6/12 –º–µ—Å (—Å–∫–∏–¥–∫–∞ 0/10/20/30%). ATM ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –Ω–∞–≥—Ä–∞–¥–∞, —Å–µ–π—á–∞—Å –Ω–µ —Ä–∞—Å—Ö–æ–¥—É—é—Ç—Å—è.',
       term:'–°—Ä–æ–∫', more:'–ü–æ–¥—Ä–æ–±–Ω–µ–µ', add:'–í –∫–æ—Ä–∑–∏–Ω—É', remove:'–£–±—Ä–∞—Ç—å',
       popular:'–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π', top:'–¢–æ–ø', months:'–º–µ—Å',
       ordersTitle:'–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤', num:'‚Ññ', prod:'–¢–æ–≤–∞—Ä', termCol:'–°—Ä–æ–∫', meth:'–ú–µ—Ç–æ–¥', sum:'–°—É–º–º–∞', st:'–°—Ç–∞—Ç—É—Å', date:'–î–∞—Ç–∞',
       refTitle:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞', refHelp:'–î–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM). –í–∞—à –∫–æ–¥:', copy:'–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
       bindTitle:'–ü—Ä–∏–≤—è–∑–∞—Ç—å —á—É–∂–æ–π –∫–æ–¥', bind:'–ü—Ä–∏–≤—è–∑–∞—Ç—å', partner:'–ü–∞—Ä—Ç–Ω—ë—Ä', paid:'–û–ø–ª–∞—Ç–∞', reward:'–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ',
       balTitle:'–ë–∞–ª–∞–Ω—Å ATM', balHelp:'ATM –∫–æ–ø—è—Ç—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –ù–µ –∏–º–µ—é—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–∞ –≤ —Ñ–∏–∞—Ç–Ω–æ–π –≤–∞–ª—é—Ç–µ.',
       adminTitle:'–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å', adminHelp:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∑–∞–∫–∞–∑—ã.', refresh:'–û–±–Ω–æ–≤–∏—Ç—å', export:'–≠–∫—Å–ø–æ—Ä—Ç JSON',
       users:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', orders2:'–ó–∞–∫–∞–∑—ã', revenue:'–í—ã—Ä—É—á–∫–∞', addr:'–ê–¥—Ä–µ—Å', amount:'–°—É–º–º–∞', memo:'Memo',
       iPaid:'–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)',
       cart:'–ö–æ—Ä–∑–∏–Ω–∞', total:'–ò—Ç–æ–≥–æ', close:'–ó–∞–∫—Ä—ã—Ç—å', checkout:'–û—Ñ–æ—Ä–º–∏—Ç—å',
  },
  en:{ brandSub:'Subscriptions ‚Ä¢ Bundles ‚Ä¢ Copy-trading ‚Ä¢ Referrals',
       shop:'Shop',orders:'Orders',ref:'Referrals',balance:'Balance',admin:'Admin',faq:'FAQ',
       subTitle:'Subscription checkout',
       subHelp:'Choose 1/3/6/12 months (discount 0/10/20/30%). ATM are internal rewards, not spendable yet.',
       term:'Term', more:'Details', add:'Add', remove:'Remove',
       popular:'Most popular', top:'Top', months:'mo',
       ordersTitle:'Order history', num:'#', prod:'Product', termCol:'Term', meth:'Method', sum:'Amount', st:'Status', date:'Date',
       refTitle:'Referral program', refHelp:'Share your code and earn 10% (in ATM). Your code:', copy:'Copy',
       bindTitle:'Bind referral code', bind:'Bind', partner:'Partner', paid:'Paid', reward:'Reward',
       balTitle:'ATM balance', balHelp:'ATM accrue from purchases and referrals. They are not pegged to fiat.',
       adminTitle:'Admin panel', adminHelp:'Stats & orders.', refresh:'Refresh', export:'Export JSON',
       users:'Users', orders2:'Orders', revenue:'Revenue', addr:'Address', amount:'Amount', memo:'Memo',
       iPaid:'I paid',
       cart:'Cart', total:'Total', close:'Close', checkout:'Checkout',
  }
};
let lang = localStorage.getItem('CATM_LANG') || ((navigator.language||'en').toLowerCase().startsWith('ru')?'ru':'en');
const t = (k)=> (i18n[lang] && i18n[lang][k]) || (i18n.en && i18n.en[k]) || k;

const TAB_EMOJI = { shop:'üõí', orders:'üìÑ', ref:'üë•', balance:'üí∞', admin:'üõ†', faq:'‚ùì' };

/* =============================
   STORAGE / USER / STATE
============================= */
const DBKEY = 'CATM_DB_HTML_V4';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DBKEY)) || {users:{},orders:[],disclaimerAccepted:false} }catch(e){ return {users:{},orders:[],disclaimerAccepted:false} } }
const db = loadDB();
const saveDB = () => localStorage.setItem(DBKEY, JSON.stringify(db));

const rawUser = tg?.initDataUnsafe?.user;
let CURRENT_USER = rawUser ? { id:rawUser.id, username:rawUser.username||'user', name:(rawUser.first_name||'')+(rawUser.last_name?(' '+rawUser.last_name):'') } : { id:0, username:'guest', name:'Guest' };

if(!db.users[CURRENT_USER.id]){
  db.users[CURRENT_USER.id]={ id:CURRENT_USER.id, username:CURRENT_USER.username, created_at:new Date().toISOString(), atm:START_BONUS_ATM, ref_code:'REF'+(CURRENT_USER.id||Math.floor(Math.random()*1e6)), referred_by:null, orders:[], referrals:[], start_bonus_given:true };
  saveDB();
}
function user(){ return db.users[CURRENT_USER.id]; }

const state={ period:1, cart:[], pay:{ addr:PAY_ADDR, amount:0, memo:'' } };

/* =============================
   HELPERS / UI
============================= */
function applyLang(){
  document.getElementById('brand-sub').textContent = t('brandSub');
  document.getElementById('lang-code').textContent = lang.toUpperCase();
  Object.keys(TAB_EMOJI).forEach(key=>{
    const btn = document.querySelector(`.tbtn[data-tab="${key}"]`);
    if (btn) btn.textContent = `${TAB_EMOJI[key]} ${t(key)}`;
  });

  // headings & labels
  document.getElementById('sub-title').textContent = t('subTitle');
  document.getElementById('sub-help').textContent = t('subHelp');
  document.getElementById('lbl-term').textContent = t('term');
  document.getElementById('orders-title').textContent=t('ordersTitle');

  // order table headers
  document.getElementById('th-num').textContent=t('num');
  document.getElementById('th-prod').textContent=t('prod');
  document.getElementById('th-term').textContent=t('termCol');
  document.getElementById('th-meth').textContent=t('meth');
  document.getElementById('th-sum').textContent=t('sum');
  document.getElementById('th-st').textContent=t('st');
  document.getElementById('th-date').textContent=t('date');

  // ref
  document.getElementById('ref-title').textContent=t('refTitle');
  document.getElementById('ref-help').textContent=t('refHelp');
  document.getElementById('bind-title').textContent=t('bindTitle');
  document.getElementById('ref-bind-btn').textContent=t('bind');
  document.getElementById('th-partner').textContent=t('partner');
  document.getElementById('th-date2').textContent=t('date');
  document.getElementById('th-paid').textContent=t('paid');
  document.getElementById('th-reward').textContent=t('reward');

  // balance/admin
  document.getElementById('bal-title').textContent=t('balTitle');
  document.getElementById('bal-help').textContent=t('balHelp');
  document.getElementById('adm-title').textContent=t('adminTitle');
  document.getElementById('adm-help').textContent=t('adminHelp');
  document.getElementById('admin-refresh').textContent=t('refresh');
  document.getElementById('admin-export').textContent=t('export');

  // pay sheet
  document.getElementById('lbl-addr').textContent=t('addr');
  document.getElementById('lbl-amt').textContent=t('amount');
  document.getElementById('lbl-memo').textContent=t('memo');
  document.getElementById('paid-btn').textContent=t('iPaid');

  // cart sheet
  document.getElementById('cart-title').textContent=t('cart');
  document.getElementById('cart-total-label').textContent = t('total') + ':';
  document.getElementById('cart-close').textContent = t('close');
  document.getElementById('cart-checkout').textContent = t('checkout');

  renderFAQ();
}

function setHash(tab){ location.hash = '#/'+tab; }
function currentTab(){ return (location.hash.replace('#/','') || 'shop'); }
function switchTab(name){
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
  document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active', p.id==='page-'+name));
  if(name==='shop') renderCatalog();
  if(name==='orders') renderOrders();
  if(name==='ref') renderRefs();
  if(name==='balance') renderBalance();
  if(name==='admin') renderAdmin();
}

/* =============================
   PRICING
============================= */
function priceFor(item,months,opts={}){
  if(item.type==='plan' || item.type==='onebot'){
    const disc = PERIOD_DISCOUNT[months]||0; const perMonth = Math.round(item.price*(1-disc)); return perMonth*months;
  }
  if(item.type==='consult'){ const hours = Math.max(1, parseInt(opts.hours||1,10)); return item.price * hours; }
  if(item.type==='training'){ return item.price; }
  if(item.type==='trial'){ return 0; }
  const disc = PERIOD_DISCOUNT[months]||0; const perMonth = Math.round(item.price*(1-disc)); return perMonth*months;
}

/* =============================
   HEADER / COUNTERS
============================= */
function renderHeader(){
  document.getElementById('chip-name').textContent='@'+(CURRENT_USER.username||'guest');
  document.getElementById('chip-atm').textContent=user().atm;
  document.getElementById('chip-orders').textContent=user().orders.length;
  document.getElementById('ref-code').value=user().ref_code;
  if(ADMIN_IDS.includes(CURRENT_USER.id)) document.getElementById('tab-admin-btn').hidden=false;
}
function updateCartIcon(){
  document.getElementById('cart-count').textContent = state.cart.length;
  document.getElementById('atm-balance').textContent = user().atm;
  renderHeader();
}

/* =============================
   CATALOG
============================= */
function renderCatalog(){
  const grid = document.getElementById('catalog'); grid.innerHTML='';
  const months = state.period = parseInt(document.getElementById('period').value||'1',10);

  CATALOG.forEach(it=>{
    const previewAmount = priceFor(it, months, {hours:1});
    const card = document.createElement('div'); card.className='col-4 card p-card';

    let badges = `<span class="badge">${(it.type==='plan'?'PLAN':it.type.toUpperCase())}</span>`;
    if(it.badge==='popular') badges += ` <span class="badge">${t('popular')}</span>`;
    if(it.badge==='top') badges += ` <span class="badge">${t('top')}</span>`;

    let body = '';
    let actions = '';

    if(it.type==='onebot' || it.type==='trial'){
      const options = (it.chooseFrom||[]).map(b=>`<option value="${b.code}">${b.name}</option>`).join('');
      body = `
        <p class="muted">${it.desc}</p>
        <div class="row"><select data-select="${it.code}" class="onebot-select">${options}</select></div>
      `;
      actions = `
        <div class="p-actions">
          <button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button>
          <button class="btn primary" data-act="${it.type==='trial'?'add-trial':'add-one'}" data-code="${it.code}">${t('add')}</button>
        </div>
      `;
    } else if (it.type==='consult'){
      body = `
        <p class="muted">${it.desc}</p>
        <div class="row">
          <label class="label" for="hours-${it.code}" style="min-width:100px">Hours</label>
          <input id="hours-${it.code}" type="number" min="1" step="1" value="1" style="max-width:120px">
        </div>
      `;
      actions = `
        <div class="p-actions">
          <button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button>
          <button class="btn primary" data-act="add-consult" data-code="${it.code}">${t('add')}</button>
        </div>
      `;
    } else if (it.type==='training'){
      const inCart = state.cart.find(x=>x.code===it.code);
      body = `<p class="muted">${it.desc}</p>`;
      actions = `
        <div class="p-actions">
          <button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button>
          ${inCart?`<button class="btn" disabled>${t('add')}</button>`:`<button class="btn primary" data-act="add" data-code="${it.code}">${t('add')}</button>`}
        </div>
      `;
    } else {
      const inCart = state.cart.find(x=>x.code===it.code && x.months===months);
      body = `<p class="muted">${it.desc}</p>`;
      actions = `
        <div class="p-actions">
          <button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button>
          ${inCart?`<button class="btn" data-act="remove" data-code="${it.code}">${t('remove')}</button>`:`<button class="btn primary" data-act="add" data-code="${it.code}">${t('add')}</button>`}
        </div>
      `;
    }

    card.innerHTML = `
      <div class="p-head">
        <div>${badges}</div>
        <span class="price" style="color:var(--gold)">
          ${it.type==='trial' ? 'Free' : `‚Ç¨${previewAmount}`} ${it.type==='trial'?'': (it.type==='consult'||it.type==='training' ? '' : `/ ${months}${t('months')}`)}
        </span>
      </div>
      <div class="p-body">
        <h3>${it.name}</h3>
        ${body}
      </div>
      ${actions}
    `;
    grid.appendChild(card);
  });

  updateCartIcon();
}

/* =============================
   CART
============================= */
function openCart(){
  const list = document.getElementById('cart-list'); list.innerHTML='';
  if(state.cart.length===0){
    list.innerHTML = `<div class="col-12 card"><p class="muted">${lang==='ru'?'–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞':'Cart is empty'}</p></div>`;
  }else{
    state.cart.forEach((item, idx)=>{
      const row = document.createElement('div'); row.className='col-12 card';
      row.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:center">
          <div>
            <b>${item.name}</b> <span class="muted">‚Ä¢ ${item.months} ${(lang==='ru'?'–º–µ—Å':'mo')}</span>
          </div>
          <div class="row" style="align-items:center">
            <b style="margin-right:8px">‚Ç¨${item.amount}</b>
            <button class="btn ghost" data-act="cart-remove" data-idx="${idx}" type="button">${t('remove')}</button>
          </div>
        </div>
      `;
      list.appendChild(row);
    });
  }
  const total = state.cart.reduce((s,x)=>s+x.amount,0);
  document.getElementById('cart-total').textContent = '‚Ç¨'+total;
  document.getElementById('modal-cart').style.display='flex';
}
function closeCart(){ document.getElementById('modal-cart').style.display='none'; }

function addToCart(code, extraText, opts={}){
  const months = state.period;
  const it = CATALOG.find(x=>x.code===code);
  if(!it) return;

  if(it.type==='training'){
    if(state.cart.find(x=>x.code===it.code)) return;
  } else if (it.type==='plan'){
    if(state.cart.find(x=>x.code===it.code && x.months===months)) return;
  }

  const amount = priceFor(it, months, opts);
  const nameBase = it.name + (extraText ? `: ${extraText}` : '');
  const monthsCol = (it.type==='plan' || it.type==='onebot') ? months : 1;

  state.cart.push({ code: it.code, name: nameBase, months: monthsCol, amount });
  H('light');
  renderCatalog();
}
function removeFromCart(code){
  const months = state.period;
  state.cart = state.cart.filter(x=>!(x.code===code && (x.months===months || x.months===1)));
  H('light');
  renderCatalog();
  openCart(); // –æ–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–∞–ª–∫—É –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞
}

/* =============================
   ORDERS / REF / BALANCE
============================= */
function renderOrders(){
  const tb = document.querySelector('#orders-table tbody'); tb.innerHTML='';
  const rows = db.orders.filter(o=>o.user===CURRENT_USER.id).slice().reverse();
  for(const o of rows){
    const tr=document.createElement('tr');
    const names=o.items.map(i=>i.name+' √ó'+i.months+(i.months>1? (lang==='ru'?'–º':' mo') : '')).join(', ');
    tr.innerHTML=`<td>${o.id}</td><td>${names}</td><td>${o.items.reduce((s,i)=>s+i.months,0)} ${lang==='ru'?'–º–µ—Å':'mo'}</td><td>${o.method}</td><td>‚Ç¨${o.eur_final}</td><td>${o.status}</td><td>${new Date(o.created_at).toLocaleString()}</td><td>${o.memo}</td>`;
    tb.appendChild(tr);
  }
}
function renderRefs(){
  document.getElementById('ref-code').value = user().ref_code;
  const tb=document.querySelector('#ref-table tbody'); tb.innerHTML='';
  for(const r of (user().referrals||[]).slice().reverse()){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>@${db.users[r.uid]?.username||r.uid}</td><td>${new Date(r.at).toLocaleDateString()}</td><td>${r.paid?(lang==='ru'?'–î–∞':'Yes'):'‚Äî'}</td><td>${r.reward||0} ATM</td>`;
    tb.appendChild(tr);
  }
  const hasRef=!!user().referred_by; document.getElementById('ref-bind-input').disabled=hasRef; document.getElementById('ref-bind-btn').disabled=hasRef;
}
function renderBalance(){ document.getElementById('atm-balance').textContent = user().atm; }

/* =============================
   ADMIN
============================= */
function renderAdmin(){
  const users=Object.values(db.users); const o=db.orders;
  const totalEur=o.reduce((s,x)=>s+x.eur_final,0);
  document.getElementById('admin-stats').innerHTML =
    `<div class="row">
      <div class="chip">${t('users')}: <b>${users.length}</b></div>
      <div class="chip">${t('orders2')}: <b>${o.length}</b></div>
      <div class="chip">${t('revenue')}: <b>‚Ç¨${totalEur}</b></div>
    </div>`;

  const utb=document.querySelector('#admin-users tbody'); utb.innerHTML='';
  users.slice().sort((a,b)=>b.id-a.id).forEach(u=>{
    const refFrom=u.referred_by?'@'+(db.users[u.referred_by]?.username||u.referred_by):'‚Äî';
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.id}</td><td>@${u.username}</td><td>${u.atm}</td><td>${u.orders.length}</td><td>${u.ref_code}</td><td>${refFrom}</td><td>${new Date(u.created_at).toLocaleDateString()}</td>`;
    utb.appendChild(tr);
  });

  const otb=document.querySelector('#admin-orders tbody'); otb.innerHTML='';
  db.orders.slice().reverse().forEach(or=>{
    const userName='@'+(db.users[or.user]?.username||or.user);
    const items=or.items.map(i=>i.name+'√ó'+i.months).join(', ');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${or.id}</td><td>${userName}</td><td>${items}</td><td>${or.items.reduce((s,i)=>s+i.months,0)} ${lang==='ru'?'–º–µ—Å':'mo'}</td><td>${or.method}</td><td>${or.eur_final}</td><td>${or.status}</td><td>${new Date(or.created_at).toLocaleString()}</td><td>${ADMIN_IDS.includes(CURRENT_USER.id)?`<button class="btn" data-act="mark-paid" data-id="${or.id}">${lang==='ru'?'–û–ø–ª–∞—á–µ–Ω':'Paid'}</button> <button class="btn ghost" data-act="mark-cancel" data-id="${or.id}">${lang==='ru'?'–û—Ç–º–µ–Ω–∞':'Cancel'}</button>`:''}</td>`;
    otb.appendChild(tr);
  });
}

/* =============================
   PAYMENT (single address)
============================= */
function openPay(){
  if(state.cart.length===0){ toast(lang==='ru'?'–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞':'Cart is empty'); return; }
  const eur=state.cart.reduce((s,x)=>s+x.amount,0);
  state.pay.amount=eur;
  state.pay.memo='ORDER-'+(db.orders.length+1);
  document.getElementById('pay-addr').textContent=state.pay.addr;
  document.getElementById('pay-amount').textContent='‚Ç¨'+eur;
  document.getElementById('pay-memo').textContent=state.pay.memo;
  document.getElementById('modal-pay').style.display='flex';
}
function closePay(){ document.getElementById('modal-pay').style.display='none'; }
function createPaymentIntent(){ return new Promise(r=>setTimeout(()=>r('intent_'+Math.random().toString(36).slice(2,9)),300)); }

/* =============================
   COINS: sound + animation (no fiat peg)
============================= */
function playCoinSound(){
  try{
    const ac = new (window.AudioContext||window.webkitAudioContext)();
    const now = ac.currentTime;
    const seq = [880,1320,1760,2200];
    seq.forEach((f,i)=>{
      const o = ac.createOscillator(); const g=ac.createGain();
      o.type='square'; o.frequency.value=f;
      o.connect(g); g.connect(ac.destination);
      g.gain.setValueAtTime(0.0001, now+i*0.05);
      g.gain.exponentialRampToValueAtTime(0.2, now+i*0.05+0.03);
      g.gain.exponentialRampToValueAtTime(0.001, now+i*0.05+0.11);
      o.start(now+i*0.05); o.stop(now+i*0.05+0.12);
    });
  }catch(e){}
}
function spawnCoins(count=10){
  for(let i=0;i<count;i++){
    const c=document.createElement('div'); c.className='coin'; c.textContent='ü™ô';
    const dx = (Math.random()*60-30);
    c.style.left = `calc(50% + ${dx}vw)`;
    c.style.animationDelay = (Math.random()*0.25)+'s';
    document.body.appendChild(c);
    setTimeout(()=> c.remove(), 1200);
  }
}
function awardATM(){
  user().atm = (user().atm||0) + ATM_REWARD_PER_ORDER;
  saveDB();
  renderBalance();
  renderHeader();
  playCoinSound();
  spawnCoins(10);
}

/* =============================
   ORDER FLOW
============================= */
function createOrder(){
  if(state.cart.length===0) return toast(lang==='ru'?'–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞':'Cart is empty');
  const eur=state.cart.reduce((s,x)=>s+x.amount,0);

  const order = {
    id: db.orders.length+1,
    user: CURRENT_USER.id,
    items: state.cart.map(x=>({code:x.code,name:x.name,months:x.months,amount:x.amount})),
    method: 'pay',
    eur,
    eur_final: eur,
    status:'waiting',
    created_at:new Date().toISOString(),
    memo: state.pay.memo
  };
  db.orders.push(order); user().orders.push(order.id); saveDB();

  // ATM reward (fixed, not pegged)
  awardATM();

  state.cart=[]; renderCatalog(); renderOrders();
  closeCart();
  openPay();
  createPaymentIntent().then(id=>{ order.memo=id; saveDB(); renderOrders(); document.getElementById('pay-memo').textContent=id; });
}

/* =============================
   FAQ (Q/A)
============================= */
function renderFAQ(){
  const qa_ru = [
    ['–ß—Ç–æ —Ç–∞–∫–æ–µ CryptoATM.tech?','–ù–∞–±–æ—Ä –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–æ—Ç–æ–≤, –ø–æ–¥–ø–∏—Å–æ–∫, –∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥–∞ –∏ –æ–±—É—á–µ–Ω–∏—è.'],
    ['–¶–µ–Ω—ã –≤ –∫–∞–∫–æ–π –≤–∞–ª—é—Ç–µ?','–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ –µ–≤—Ä–æ (EUR).'],
    ['–ß—Ç–æ —Ç–∞–∫–æ–µ ATM-–º–æ–Ω–µ—Ç—ã?','–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –Ω–∞–≥—Ä–∞–¥–∞ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã. –ù–µ –∏–º–µ—é—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–∞ –≤ —Ñ–∏–∞—Ç–µ –∏ —Å–µ–π—á–∞—Å –Ω–µ —Ä–∞—Å—Ö–æ–¥—É—é—Ç—Å—è.'],
    ['–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å ATM?','–ó–∞ –ø–æ–∫—É–ø–∫–∏ –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ).'],
    ['–ú–æ–∂–Ω–æ –ª–∏ –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω–æ–≥–æ –±–æ—Ç–∞?','–î–∞, —á–µ—Ä–µ–∑ One Bot. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö –±–æ—Ç–æ–≤.'],
    ['–ï—Å—Ç—å –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥?','–î–∞: Trial –Ω–∞ 3 –¥–Ω—è –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –±–æ—Ç—É.'],
    ['Copy-trading —É—Å–ª–æ–≤–∏—è?','‚Ç¨50/–º–µ—Å + 10% –æ—Ç –ø—Ä–∏–±—ã–ª–∏. –ü—Ä–æ—Ü–µ–Ω—Ç—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.'],
    ['–ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥ –∏ –æ–±—É—á–µ–Ω–∏–µ?','–ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥ ‚Äî ‚Ç¨79/—á–∞—Å (—É–∫–∞–∂–∏—Ç–µ —á–∞—Å—ã). –ö—É—Ä—Å ¬´–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏¬ª ‚Äî ‚Ç¨890.'],
    ['–ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å?','–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –µ–¥–∏–Ω—ã–π –∞–¥—Ä–µ—Å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Memo –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã.'],
    ['–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞?','10% –≤ ATM –æ—Ç –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ.'],
    ['–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Ä–∏—Å–∫–∏?','–ú—ã –Ω–µ –¥–∞—ë–º –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤. –†—ã–Ω–æ–∫ –≤–æ–ª–∞—Ç–∏–ª–µ–Ω. –î–µ–ª–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.'],
  ];
  const qa_en = [
    ['What is CryptoATM.tech?','A suite of analytics bots, subscriptions, copy-trading and education.'],
    ['In which currency are prices?','Fixed in EUR.'],
    ['What are ATM coins?','Internal reward tokens. Not pegged to fiat and not spendable yet.'],
    ['How to earn ATM?','From purchases and referrals (on the first paid subscription of your invite).'],
    ['Can I buy access to a single bot?','Yes via ‚ÄúOne Bot‚Äù. You can add multiple different bots.'],
    ['Trial?','Yes: 3-day trial for a selected bot.'],
    ['Copy-trading terms?','‚Ç¨50/month + 10% of profit. Percentage handled separately.'],
    ['Consulting & training?','Consulting ‚Ç¨79/hour (choose hours). ‚ÄúFirst steps‚Äù course ‚Ç¨890.'],
    ['How to pay?','Transfer to a single address. Use Memo from the cart.'],
    ['Referral system?','10% in ATM from the invitee‚Äôs first paid subscription.'],
    ['Safety?','No investment advice. Markets are volatile ‚Äî DYOR.'],
  ];
  const data = (lang==='ru')? qa_ru : qa_en;
  const host=document.getElementById('faq-qa');
  host.innerHTML = data.map(([q,a])=>(
    `<details style="margin:6px 0; background:#0f1320;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px">
       <summary style="cursor:pointer;font-weight:800">${q}</summary>
       <div class="muted" style="margin-top:6px">${a}</div>
     </details>`
  )).join('');
}

/* =============================
   EVENTS
============================= */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button,.btn'); if(!btn) return;

  // bottom tabs
  if(btn.classList.contains('tbtn')){ H('light'); setHash(btn.dataset.tab); switchTab(btn.dataset.tab); return; }

  // bottom scrollers
  if(btn.id==='tnav-left'){ document.getElementById('tnav').scrollBy({left:-220,behavior:'smooth'}); return; }
  if(btn.id==='tnav-right'){ document.getElementById('tnav').scrollBy({left:220,behavior:'smooth'}); return; }

  const act = btn.dataset.act;
  if(act==='details'){ const code=btn.dataset.code; const it = CATALOG.find(x=>x.code===code); document.getElementById('item-title').textContent = it?.name||'–¢–æ–≤–∞—Ä'; document.getElementById('item-desc').innerHTML = `<p class="muted">${it?.desc||''}</p>`; document.getElementById('modal-item').style.display='flex'; return; }
  if(act==='add'){ addToCart(btn.dataset.code); return; }
  if(act==='remove'){ removeFromCart(btn.dataset.code); return; }
  if(act==='add-one'){ const sel = btn.closest('.p-card').querySelector('[data-select]'); const val = sel?.value; const label = BOT_LIST.find(b=>b.code===val)?.name || val; addToCart('ONE_BOT', label); return; }
  if(act==='add-trial'){ const sel = btn.closest('.p-card').querySelector('[data-select]'); const val = sel?.value; const label = BOT_LIST.find(b=>b.code===val)?.name || val; addToCart('TRIAL', label); return; }
  if(act==='add-consult'){ const hours = Math.max(1, parseInt(document.getElementById('hours-CONSULT')?.value||'1',10)); addToCart('CONSULT', `${hours}h`, {hours}); return; }

  // cart icon
  if(btn.id==='cart-open'){ openCart(); return; }
  if(btn.id==='cart-close'){ closeCart(); return; }
  if(btn.id==='cart-checkout'){ if(state.cart.length===0){toast(lang==='ru'?'–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞':'Cart is empty'); return;} state.pay.memo='ORDER-'+(db.orders.length+1); createOrder(); return; }
  if(act==='cart-remove'){ const idx=+btn.dataset.idx; state.cart.splice(idx,1); openCart(); renderCatalog(); return; }

  // payment
  if(btn.id==='pay-close'){ closePay(); return; }
  if(btn.id==='copy-addr'){ navigator.clipboard.writeText(document.getElementById('pay-addr').textContent||''); toast('Address copied'); return; }
  if(btn.id==='copy-amount'){ navigator.clipboard.writeText((document.getElementById('pay-amount').textContent||'').replace('‚Ç¨','')); toast('Amount copied'); return; }
  if(btn.id==='copy-memo'){ navigator.clipboard.writeText(document.getElementById('pay-memo').textContent||''); toast('Memo copied'); return; }
  if(btn.id==='paid-btn'){ toast(lang==='ru'?'–°–ø–∞—Å–∏–±–æ! –ú—ã –æ—Ç–º–µ—Ç–∏–º –∑–∞–∫–∞–∑ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.':'Thanks! We will mark your order after verification.'); closePay(); return; }

  // refs
  if(btn.id==='ref-copy'){ navigator.clipboard.writeText(user().ref_code).then(()=>toast(lang==='ru'?'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ':'Copied')); return; }
  if(btn.id==='ref-bind-btn'){ const code=document.getElementById('ref-bind-input').value.trim().toUpperCase(); if(!code) return toast(lang==='ru'?'–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥':'Enter code'); const owner = Object.values(db.users).find(u=>u.ref_code===code); if(!owner) return toast(lang==='ru'?'–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω':'Code not found'); if(owner.id===CURRENT_USER.id) return toast(lang==='ru'?'–ù–µ–ª—å–∑—è —Å–≤–æ–π –∫–æ–¥':'Cannot use own code'); if(user().referred_by) return toast(lang==='ru'?'–ö–æ–¥ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω':'Code already bound'); user().referred_by = owner.id; owner.referrals.push({uid:CURRENT_USER.id, at:new Date().toISOString(), paid:false, reward:0}); saveDB(); renderRefs(); toast(lang==='ru'?'–ö–æ–¥ –ø—Ä–∏–≤—è–∑–∞–Ω':'Code bound'); return; }

  // admin
  if(btn.id==='admin-refresh'){ renderAdmin(); return; }
  if(btn.id==='admin-export'){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cryptoatm_export.json'; a.click(); URL.revokeObjectURL(url); return; }
  if(btn.dataset.act==='mark-paid' && ADMIN_IDS.includes(CURRENT_USER.id)){
    const id=+btn.dataset.id; const o=db.orders.find(x=>x.id===id); if(o){ o.status='paid';
      const buyer=db.users[o.user]; if(buyer?.referred_by){ const refUser=db.users[buyer.referred_by]; const rec=(refUser.referrals||[]).find(r=>r.uid===buyer.id); if(rec && !rec.paid){ rec.paid=true; const bonus=Math.round((o.eur_final||0)*REF_BONUS_PERCENT*100); // –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ ATM, –±–µ–∑ –∫—É—Ä—Å–∞
        rec.reward=bonus; refUser.atm=(refUser.atm||0)+bonus; } }
      saveDB(); renderAdmin(); renderOrders(); toast('Marked paid');
    } return;
  }
  if(btn.dataset.act==='mark-cancel' && ADMIN_IDS.includes(CURRENT_USER.id)){
    const id=+btn.dataset.id; const o=db.orders.find(x=>x.id===id); if(o){ o.status='canceled'; saveDB(); renderAdmin(); renderOrders(); toast('Canceled'); } return;
  }

  // misc modals
  if(btn.id==='close-item'){ document.getElementById('modal-item').style.display='none'; return; }
  if(btn.id==='auth-close'){ document.getElementById('modal-auth').style.display='none'; return; }

  // dev login (for local)
  if(btn.id==='dev-login'){ CURRENT_USER={id:999001, username:'guest_local'}; if(!db.users[CURRENT_USER.id]){ db.users[CURRENT_USER.id]={ id:CURRENT_USER.id, username:CURRENT_USER.username, created_at:new Date().toISOString(), atm:START_BONUS_ATM, ref_code:'REF'+CURRENT_USER.id, referred_by:null, orders:[], referrals:[], start_bonus_given:true }; saveDB(); } renderHeader(); switchTab(currentTab()); toast('–¢–µ—Å—Ç-–≤—Ö–æ–¥'); return; }
});

document.addEventListener('change',(e)=>{
  const el=e.target;
  if(el.id==='period'){ renderCatalog(); }
});

document.addEventListener('touchstart',(e)=>{ const b=e.target.closest('button,.btn'); if(b) b.classList.add('touching');},{passive:true});
document.addEventListener('touchend',()=> document.querySelectorAll('.touching').forEach(b=>b.classList.remove('touching')));

/* =============================
   NAV / BOOT / DISCLOSURE
============================= */
function toast(t){ try{tg?.showPopup?.({title:'',message:String(t),buttons:[{type:'close'}]});}catch(_){} console.log('[toast]', t); }

function boot(){
  // —Å—Ä–∞–∑—É –º–∞–≥–∞–∑–∏–Ω –ø–æ—Å–ª–µ –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–∞
  if(!tg?.initDataUnsafe?.user) document.getElementById('dev-login').style.display='inline-flex';
  applyLang();
  renderHeader();
  switchTab('shop');
  renderCatalog();
  document.getElementById('pay-addr').textContent = PAY_ADDR; // –ø–ª–∞—Ç—ë–∂–Ω—ã–π –∞–¥—Ä–µ—Å
  setInterval(()=>{ document.getElementById('chip-atm').textContent=user().atm; document.getElementById('chip-orders').textContent=user().orders.length; }, 1000);
}

// Disclaimer button
document.getElementById('agree-btn').addEventListener('click', ()=>{
  db.disclaimerAccepted=true; saveDB();
  document.getElementById('splash').style.display='none';
  switchTab('shop');
});
if(db.disclaimerAccepted){ document.getElementById('splash').style.display='none'; }

// language toggle
document.getElementById('lang-toggle').addEventListener('click',()=>{
  lang=(lang==='ru'?'en':'ru');
  localStorage.setItem('CATM_LANG',lang);
  applyLang();
  renderCatalog();
});

// init
boot();
</script>
</body>
</html>
