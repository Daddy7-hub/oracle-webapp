<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>CryptoATM.tech ‚Äî Mini App</title>

  <!-- Telegram WebApp API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0a0b0e;--panel:#111319;--card:#141821;--muted:#a5adbb;--txt:#f1f5fb;
      --gold:#d4af37;--gold-2:#f5d77a;--gold-glow:rgba(212,175,55,.28);
      --accent:#00e5ff;--green:#22e39e;--danger:#ff6a88;
      --b1:1px solid rgba(255,255,255,.08);--r:14px;--r-xl:18px;
      --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
      --shadow:0 6px 28px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.04) inset
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.08), transparent 60%), var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Inter,Segoe UI,Roboto,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    :focus-visible{outline:2px solid var(--accent); outline-offset:2px; border-radius:8px}
    .wrap{max-width:1160px;margin:0 auto;padding: calc(10px + var(--safe-top)) 14px 120px}
    header{position:sticky; top:0; z-index:12; margin:0 -14px 14px; padding: calc(8px + var(--safe-top)) 14px 8px; background:linear-gradient(180deg, rgba(10,11,14,.95), rgba(10,11,14,.6)); backdrop-filter:saturate(120%) blur(6px); border-bottom: var(--b1)}
    .hbar{ display:flex; align-items:center; justify-content:space-between; gap:12px }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0 }
    .logo{ width:44px; height:44px; border-radius:12px; background: radial-gradient(140% 140% at 30% 20%, var(--gold-2), var(--gold) 60%, #6e570f); box-shadow: inset 0 2px 10px rgba(255,255,255,.25), 0 4px 18px var(--gold-glow) }
    .brand h1{margin:0;font-size:18px;letter-spacing:.6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px}
    .userchips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:var(--b1);border-radius:999px;padding:8px 12px;color:var(--txt)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}
    @media(max-width:1020px){.col-8,.col-6,.col-4{grid-column:span 12}}
    .card{background:var(--card);border:var(--b1);border-radius:var(--r-xl);padding:14px;box-shadow:var(--shadow);animation:fadein .3s ease}
    .card h3{margin:0 0 8px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:rgba(255,255,255,.06);border:var(--b1);border-radius:8px;padding:4px 8px;color:var(--muted);font-size:12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer;transition:transform .04s ease, box-shadow .2s ease;background:#1a2030;color:var(--txt);border:1px solid rgba(255,255,255,.1)}
    .btn.primary{background:linear-gradient(135deg, #715d1d, #f3d46b 40%, #c9a529);color:#0b0b0c;text-shadow:0 1px 0 rgba(255,255,255,.35);border:1px solid rgba(245,215,122,.65);box-shadow: 0 4px 18px rgba(212,175,55,.28), 0 1px 0 rgba(255,255,255,.25) inset}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.3)}
    .btn:active{transform:translateY(1px)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#11161f;color:var(--txt);outline:none}
    select{padding-right:32px}
    .label{color:var(--muted);font-weight:700}
    .line{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed rgba(255,255,255,.1);padding-top:10px;margin-top:10px}
    .price{font-weight:900}
    .kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}

    /* Bottom swipeable nav */
    .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:40;padding:8px 10px calc(8px + var(--safe-bot));background:linear-gradient(180deg, rgba(10,11,14,0), rgba(10,11,14,.96))}
    .tabbar-inner{max-width:1160px;margin:0 auto;display:flex;gap:8px;justify-content:space-between;background:#0e1117;border:var(--b1);border-radius:16px;padding:6px}
    .tnav{display:grid;grid-auto-flow:column;gap:6px;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
    .tnav::-webkit-scrollbar{display:none}
    .tbtn{appearance:none;background:transparent;border:1px solid rgba(255,255,255,.08);color:var(--txt);border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:8px;min-width:120px;justify-content:center;cursor:pointer;scroll-snap-align:center}
    .tbtn.active{background:linear-gradient(135deg, rgba(245,215,122,.18), rgba(212,175,55,.14));box-shadow:0 0 0 1px rgba(212,175,55,.5) inset}

    /* Cart icon */
    .carticon{appearance:none;background:linear-gradient(135deg, #272c3a, #171b26);border:1px solid rgba(255,255,255,.1);color:var(--txt);border-radius:12px;min-width:64px;padding:0 10px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;position:relative}
    .carticon b{background:#d4af37;color:#0a0b0e;border-radius:999px;padding:2px 8px;font-weight:900}

    /* Modal basics */
    .modal-back{position:fixed;inset:0;z-index:50;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);padding:20px 14px}
    .modal{max-width:720px;width:100%;background:#0e1117;border:var(--b1);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .modal h2{margin:0 0 10px}
    .modal .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Splash */
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(1200px 600px at 50% -200px, rgba(212,175,55,.12), transparent 60%), var(--bg);z-index:60}
    .s-title{font-weight:900;font-size:28px;letter-spacing:.6px}
    .s-sub{color:var(--muted);text-align:center;margin-top:4px}

    .page{display:none}.page.active{display:block}
    .touching{filter:brightness(1.03)}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

<!-- Splash (–¥–∏—Å–∫–ª–µ–π–º–µ—Ä EN –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π) -->
<div id="splash" class="splash">
  <div style="text-align:center;max-width:640px;padding:0 16px">
    <div class="s-title">CryptoATM.tech</div>
    <p class="s-sub" style="margin-top:10px">
      By accessing this Mini App, you confirm you understand CryptoATM.tech does not provide financial or investment advice. Information is educational/analytical only. Markets are volatile; do your own research. By continuing, you agree to our Terms.
    </p>
    <div style="margin-top:18px">
      <button class="btn primary" id="agree-btn" type="button">I Agree</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- HEADER -->
  <header>
    <div class="hbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>CryptoATM.tech</h1>
          <small id="brand-sub">–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ –ü–∞–∫–µ—Ç—ã ‚Ä¢ –ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã</small>
        </div>
      </div>
      <div class="userchips">
        <button class="chip" id="lang-toggle" type="button">üåê <b id="lang-code">RU</b></button>
        <div class="chip">üë§ <b id="chip-name">@guest</b></div>
        <div class="chip">ATM: <b id="chip-atm">0</b></div>
        <div class="chip">–ó–∞–∫–∞–∑—ã: <b id="chip-orders">0</b></div>
        <button class="chip" id="dev-login" type="button" style="display:none">‚öôÔ∏è –¢–µ—Å—Ç-–≤—Ö–æ–¥</button>
      </div>
    </div>
  </header>

  <!-- PAGES -->
  <main id="pages">
    <!-- SHOP -->
    <section id="page-shop" class="page active">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="sub-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
          <p class="muted" id="sub-help">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ 1/3/6/12 –º–µ—Å (—Å–∫–∏–¥–∫–∞ 0/10/20/30%). ATM –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ 25% (100 ATM = ‚Ç¨1).</p>
          <div class="row">
            <div class="kv" style="min-width:200px">
              <label class="label" for="period" id="lbl-term">–°—Ä–æ–∫</label>
              <select id="period"><option value="1">1</option><option value="3">3</option><option value="6">6</option><option value="12">12</option></select>
            </div>
            <div class="kv" style="min-width:240px">
              <label class="label" for="atm-discount" id="lbl-atm">–°–ø–∏—Å–∞—Ç—å ATM (–º–∞–∫—Å 25%)</label>
              <input id="atm-discount" type="number" min="0" step="50" value="0" inputmode="numeric" />
            </div>
          </div>
        </div>

        <div id="catalog" class="col-12 grid"></div>
      </div>
    </section>

    <!-- ORDERS -->
    <section id="page-orders" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="orders-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
          <table class="table" id="orders-table">
            <thead><tr>
              <th id="th-num">‚Ññ</th><th id="th-prod">–¢–æ–≤–∞—Ä</th><th id="th-term">–°—Ä–æ–∫</th><th id="th-meth">–ú–µ—Ç–æ–¥</th><th id="th-sum">–°—É–º–º–∞</th><th id="th-st">–°—Ç–∞—Ç—É—Å</th><th id="th-date">–î–∞—Ç–∞</th><th>Memo</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REFERRALS -->
    <section id="page-ref" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="ref-title">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
          <p class="muted" id="ref-help">–î–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM). –í–∞—à –∫–æ–¥:</p>
          <div class="row"><input id="ref-code" readonly><button class="btn primary" id="ref-copy" type="button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
          <div class="line">
            <div class="muted" id="bind-title">–ü—Ä–∏–≤—è–∑–∞—Ç—å —á—É–∂–æ–π –∫–æ–¥</div>
            <div class="row"><input id="ref-bind-input" placeholder="REF123456"><button class="btn" id="ref-bind-btn" type="button">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button></div>
          </div>
          <div style="margin-top:10px">
            <table class="table" id="ref-table"><thead><tr><th id="th-partner">–ü–∞—Ä—Ç–Ω—ë—Ä</th><th id="th-date2">–î–∞—Ç–∞</th><th id="th-paid">–û–ø–ª–∞—Ç–∞</th><th id="th-reward">–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <!-- TASKS -->
    <section id="page-tasks" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="tasks-title">–ó–∞–¥–∞–Ω–∏—è –∑–∞ ATM</h3>
          <div id="tasks" class="grid"></div>
        </div>
      </div>
    </section>

    <!-- BALANCE -->
    <section id="page-balance" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="bal-title">–ë–∞–ª–∞–Ω—Å ATM</h3>
          <p class="muted" id="bal-help">–ö–æ–∏–Ω—ã –≤—ã–¥–∞—é—Ç—Å—è –∑–∞ –∑–∞–¥–∞–Ω–∏—è –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –°–ø–∏—Å–∞–Ω–∏–µ –¥–æ 25% (100 ATM = ‚Ç¨1).</p>
          <div class="row"><div class="chip">Balance: <b id="atm-balance">0</b></div></div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="page-admin" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3 id="adm-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
          <p class="muted" id="adm-help">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∑–∞–∫–∞–∑—ã, –∑–∞–¥–∞–Ω–∏—è.</p>
          <div class="row"><button class="btn" id="admin-refresh">–û–±–Ω–æ–≤–∏—Ç—å</button><button class="btn ghost" id="admin-export">–≠–∫—Å–ø–æ—Ä—Ç JSON</button></div>
          <div class="grid" style="margin-top:12px">
            <div class="col-12 card" id="admin-stats"></div>
            <div class="col-12 card"><h3 id="adm-users-h">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3><table class="table" id="admin-users"><thead><tr><th>ID</th><th>Username</th><th>ATM</th><th>–ó–∞–∫–∞–∑—ã</th><th>–†–µ—Ñ-–∫–æ–¥</th><th>–û—Ç –∫–æ–≥–æ</th><th>–î–∞—Ç–∞</th></tr></thead><tbody></tbody></table></div>
            <div class="col-12 card"><h3 id="adm-orders-h">–ó–∞–∫–∞–∑—ã</h3><table class="table" id="admin-orders"><thead><tr><th>#</th><th>User</th><th>–¢–æ–≤–∞—Ä—ã</th><th>–°—Ä–æ–∫</th><th>–ú–µ—Ç–æ–¥</th><th>‚Ç¨</th><th>ATM</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
            <div class="col-12 card"><h3 id="adm-tasks-h">–ó–∞–¥–∞–Ω–∏—è</h3><table class="table" id="admin-tasks"><thead><tr><th>ID</th><th>User</th><th>–ó–∞–¥–∞–Ω–∏–µ</th><th>–ü—Ä—É—Ñ</th><th>–ù–∞–≥—Ä–∞–¥–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section id="page-faq" class="page">
      <div class="grid">
        <div class="col-12 card">
          <h3>FAQ</h3>
          <ul class="muted" id="faq-list">
            <li>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –≤ EUR. –û–ø–ª–∞—Ç–∞ ‚Äî –Ω–∞ –±–∏—Ä–∂—É –∞–¥–º–∏–Ω–∞ –∏–ª–∏ —Å—á—ë—Ç –∫–æ–º–ø–∞–Ω–∏–∏.</li>
            <li>ATM –ø–æ–∫—Ä—ã–≤–∞—é—Ç –¥–æ 25% –∑–∞–∫–∞–∑–∞ (100 ATM = ‚Ç¨1).</li>
            <li>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞: 10% –æ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM).</li>
          </ul>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Bottom swipeable nav -->
<div class="tabbar">
  <div class="tabbar-inner">
    <div class="tnav" id="tnav">
      <button class="tbtn active" data-tab="shop" type="button">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
      <button class="tbtn" data-tab="orders" type="button">üìÑ –ó–∞–∫–∞–∑—ã</button>
      <button class="tbtn" data-tab="ref" type="button">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
      <button class="tbtn" data-tab="tasks" type="button">üß© –ó–∞–¥–∞–Ω–∏—è</button>
      <button class="tbtn" data-tab="balance" type="button">üí∞ –ë–∞–ª–∞–Ω—Å</button>
      <button class="tbtn" data-tab="admin" id="tab-admin-btn" type="button" hidden>üõ† –ê–¥–º–∏–Ω</button>
      <button class="tbtn" data-tab="faq" type="button">‚ùì FAQ</button>
    </div>
    <button class="carticon" id="cart-open" type="button" aria-label="Cart">
      üß∫ <b id="cart-count">0</b>
    </button>
  </div>
</div>

<!-- ITEM DETAILS -->
<div class="modal-back" id="modal-item"><div class="modal"><h2 id="item-title">–¢–æ–≤–∞—Ä</h2><div id="item-desc" class="muted"></div><div class="foot"><button class="btn" id="close-item">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<!-- AUTH REQUIRED -->
<div class="modal-back" id="modal-auth"><div class="modal"><h2 id="auth-title">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2><p class="muted" id="auth-body">–û—Ç–∫—Ä–æ–π—Ç–µ Mini App –≤–Ω—É—Ç—Ä–∏ Telegram (—Å initData).</p><div class="foot"><button class="btn" id="auth-close">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

<!-- PAYMENT SHEET -->
<div class="modal-back" id="modal-pay">
  <div class="modal">
    <h2 id="pay-title">–û–ø–ª–∞—Ç–∞</h2>
    <div class="grid">
      <div class="col-12 card">
        <div class="row">
          <div class="kv" style="min-width:220px">
            <span class="label" id="lbl-chain">–°–µ—Ç—å</span>
            <select id="pay-chain"><option value="BEP20">BEP20</option><option value="TRC20">TRC20</option><option value="ERC20">ERC20</option></select>
          </div>
          <div class="kv" style="min-width:420px">
            <span class="label" id="lbl-addr">–ê–¥—Ä–µ—Å</span>
            <code id="pay-addr" style="word-break:break-all"></code>
            <button class="btn" id="copy-addr" type="button" style="margin-left:8px">Copy</button>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="kv"><span class="label" id="lbl-amt">–°—É–º–º–∞</span><b id="pay-amount">‚Ç¨0</b><button class="btn" id="copy-amount" type="button" style="margin-left:8px">Copy</button></div>
          <div class="kv"><span class="label" id="lbl-memo">Memo</span><b id="pay-memo">‚Äî</b><button class="btn" id="copy-memo" type="button" style="margin-left:8px">Copy</button></div>
        </div>
        <p class="muted" style="margin-top:10px">
          –û–ø–ª–∞—á–∏–≤–∞—è –ø–æ–¥–ø–∏—Å–∫—É, –≤—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ CryptoATM.tech.
          <a id="terms-link" href="#" target="_blank" rel="noopener">–°—Å—ã–ª–∫–∞ –Ω–∞ —É—Å–ª–æ–≤–∏—è (–ø–æ–∑–∂–µ)</a>
        </p>
      </div>
      <div class="col-12">
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="pay-close" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="btn primary" id="paid-btn" type="button">–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =============================
   CORE / CONFIG / CONSTANTS
============================= */
const tg = window.Telegram?.WebApp;
try{ tg?.expand(); tg?.setHeaderColor('#0a0b0e'); tg?.setBackgroundColor('#0a0b0e'); }catch(e){}
const H = (type) => { try{ tg?.HapticFeedback?.impactOccurred?.(type||'light'); }catch(e){} };

// –ê–¥–º–∏–Ω—ã (–ø–æ–∫–∞ –≤ –∫–æ–¥–µ; –ø–æ–∑–∂–µ —Å –±—ç–∫–∞). –ó–ê–ú–ï–ù–ò –Ω–∞ —Å–≤–æ–π ID
const ADMIN_IDS = [568646738];

const START_BONUS_ATM = 250;
const REF_BONUS_PERCENT = 0.10; // 10% –≤ ATM (100 ATM = ‚Ç¨1)
const PERIOD_DISCOUNT = {1:0, 3:0.10, 6:0.20, 12:0.30};

// –∞–¥—Ä–µ—Å–∞ –¥–ª—è —Å–µ—Ç–µ–π (–º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å)
const PAY_ADDR = {
  BEP20: "0x5af48f9d26edb82e7c30247e105fbf61d2dd1a5c",
  TRC20: "TYcRjK3fFvV2W1k2p7t1B5u8A9XyZqQrTs",
  ERC20: "0x1111222233334444555566667777888899990000",
};

// –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç
const BOT_LIST = [
  {code:'CRYPTO_ATM', name:'Crypto ATM Bot'},
  {code:'ALERTS', name:'Alerts Bot'},
  {code:'NEWS', name:'News Bot'}
];
const CATALOG = [
  // –ø–æ–¥–ø–∏—Å–æ—á–Ω—ã–µ (—É—á–∏—Ç—ã–≤–∞—é—Ç –ø–µ—Ä–∏–æ–¥ –∏ —Å–∫–∏–¥–∫–∏)
  {type:'onebot', code:'ONE_BOT', name:'One Bot', price:79, desc:'–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É. –ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–π.', chooseFrom: BOT_LIST},
  {type:'plan', code:'STANDARD', name:'Standard', price:150, desc:'–ë–∞–∑–æ–≤—ã–π –ø–∞–∫–µ—Ç –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.'},
  {type:'plan', code:'PREMIUM', name:'Premium', price:191, desc:'–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.', badge:'popular'},
  {type:'plan', code:'ENTERPRISE', name:'Enterprise', price:249, desc:'–¢–æ–ø–æ–≤—ã–π –ø–ª–∞–Ω —Å –º–∞–∫—Å–∏–º—É–º–æ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.', badge:'top'},
  {type:'plan', code:'COPY', name:'Copy-trading', price:50, desc:'‚Ç¨50/–º–µ—Å + 10% –æ—Ç –ø—Ä–∏–±—ã–ª–∏.'},

  // —Å–µ—Ä–≤–∏—Å—ã (–ù–ï —É–º–Ω–æ–∂–∞—é—Ç—Å—è –Ω–∞ –ø–µ—Ä–∏–æ–¥)
  {type:'consult', code:'CONSULT', name:'Consulting', price:79, desc:'–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º. ‚Ç¨79/—á–∞—Å. –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤.'},
  {type:'training', code:'TRAINING', name:'Training: First steps in crypto', price:890, desc:'–ü–æ–ª–Ω—ã–π –∫—É—Ä—Å ¬´–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ –≤ —Å—Ñ–µ—Ä–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç¬ª. –†–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂.'},
  {type:'trial', code:'TRIAL', name:'Trial 3 days', price:0, desc:'–ü—Ä–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –±–æ—Ç—É –Ω–∞ 3 –¥–Ω—è.', chooseFrom: BOT_LIST}
];

/* =============================
   I18N
============================= */
const i18n = {
  ru:{ brandSub:'–ü–æ–¥–ø–∏—Å–∫–∏ ‚Ä¢ –ü–∞–∫–µ—Ç—ã ‚Ä¢ –ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã',
       shop:'–ú–∞–≥–∞–∑–∏–Ω',orders:'–ó–∞–∫–∞–∑—ã',ref:'–†–µ—Ñ–µ—Ä–∞–ª—ã',tasks:'–ó–∞–¥–∞–Ω–∏—è',balance:'–ë–∞–ª–∞–Ω—Å',admin:'–ê–¥–º–∏–Ω',faq:'FAQ',
       subTitle:'–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏', subHelp:'–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ 1/3/6/12 –º–µ—Å (—Å–∫–∏–¥–∫–∞ 0/10/20/30%). ATM –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ 25% (100 ATM = ‚Ç¨1).',
       term:'–°—Ä–æ–∫', atmWrite:'–°–ø–∏—Å–∞—Ç—å ATM (–º–∞–∫—Å 25%)', more:'–ü–æ–¥—Ä–æ–±–Ω–µ–µ', add:'–í –∫–æ—Ä–∑–∏–Ω—É', remove:'–£–±—Ä–∞—Ç—å',
       popular:'–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π', top:'–¢–æ–ø', months:'–º–µ—Å',
       ordersTitle:'–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤', num:'‚Ññ', prod:'–¢–æ–≤–∞—Ä', termCol:'–°—Ä–æ–∫', meth:'–ú–µ—Ç–æ–¥', sum:'–°—É–º–º–∞', st:'–°—Ç–∞—Ç—É—Å', date:'–î–∞—Ç–∞',
       refTitle:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞', refHelp:'–î–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM). –í–∞—à –∫–æ–¥:', copy:'–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
       bindTitle:'–ü—Ä–∏–≤—è–∑–∞—Ç—å —á—É–∂–æ–π –∫–æ–¥', bind:'–ü—Ä–∏–≤—è–∑–∞—Ç—å', partner:'–ü–∞—Ä—Ç–Ω—ë—Ä', paid:'–û–ø–ª–∞—Ç–∞', reward:'–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ',
       tasksTitle:'–ó–∞–¥–∞–Ω–∏—è –∑–∞ ATM', proofHint:'URL-–ø—Ä—É—Ñ', submit:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
       balTitle:'–ë–∞–ª–∞–Ω—Å ATM', balHelp:'–ö–æ–∏–Ω—ã –≤—ã–¥–∞—é—Ç—Å—è –∑–∞ –∑–∞–¥–∞–Ω–∏—è –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –°–ø–∏—Å–∞–Ω–∏–µ –¥–æ 25% (100 ATM = ‚Ç¨1).',
       adminTitle:'–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å', adminHelp:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∑–∞–∫–∞–∑—ã, –∑–∞–¥–∞–Ω–∏—è.', refresh:'–û–±–Ω–æ–≤–∏—Ç—å', export:'–≠–∫—Å–ø–æ—Ä—Ç JSON',
       users:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', orders2:'–ó–∞–∫–∞–∑—ã', revenue:'–í—ã—Ä—É—á–∫–∞', atmHold:'ATM –Ω–∞ –±–∞–ª–∞–Ω—Å–∞—Ö',
       chain:'–°–µ—Ç—å', addr:'–ê–¥—Ä–µ—Å', amount:'–°—É–º–º–∞', memo:'Memo', iPaid:'–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)'
  },
  en:{ brandSub:'Subscriptions ‚Ä¢ Bundles ‚Ä¢ Copy-trading ‚Ä¢ Referrals',
       shop:'Shop',orders:'Orders',ref:'Referrals',tasks:'Tasks',balance:'Balance',admin:'Admin',faq:'FAQ',
       subTitle:'Subscription checkout', subHelp:'Choose 1/3/6/12 months (discount 0/10/20/30%). Redeem up to 25% with ATM (100 ATM = ‚Ç¨1).',
       term:'Term', atmWrite:'Redeem ATM (max 25%)', more:'Details', add:'Add', remove:'Remove',
       popular:'Most popular', top:'Top', months:'mo',
       ordersTitle:'Order history', num:'#', prod:'Product', termCol:'Term', meth:'Method', sum:'Amount', st:'Status', date:'Date',
       refTitle:'Referral program', refHelp:'Share your code and earn 10% (in ATM). Your code:', copy:'Copy',
       bindTitle:'Bind referral code', bind:'Bind', partner:'Partner', paid:'Paid', reward:'Reward',
       tasksTitle:'Tasks for ATM', proofHint:'Proof URL', submit:'Submit',
       balTitle:'ATM balance', balHelp:'Earn via tasks & referrals. Redeem up to 25% (100 ATM = ‚Ç¨1).',
       adminTitle:'Admin panel', adminHelp:'Stats, orders, tasks.', refresh:'Refresh', export:'Export JSON',
       users:'Users', orders2:'Orders', revenue:'Revenue', atmHold:'ATM on balances',
       chain:'Network', addr:'Address', amount:'Amount', memo:'Memo', iPaid:'I paid'
  }
};
let lang = localStorage.getItem('CATM_LANG') || ((navigator.language||'en').toLowerCase().startsWith('ru')?'ru':'en');
const t = (k)=> (i18n[lang] && i18n[lang][k]) || (i18n.en && i18n.en[k]) || k;

const TAB_EMOJI = { shop:'üõí', orders:'üìÑ', ref:'üë•', tasks:'üß©', balance:'üí∞', admin:'üõ†', faq:'‚ùì' };

function applyLang(){
  document.getElementById('brand-sub').textContent = t('brandSub');
  document.getElementById('lang-code').textContent = lang.toUpperCase();

  // bottom tabs (–ø–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª–Ω–æ—Å—Ç—å—é, —Å–æ—Ö—Ä–∞–Ω—è—è —ç–º–æ–¥–∑–∏)
  Object.keys(TAB_EMOJI).forEach(key=>{
    const btn = document.querySelector(`.tbtn[data-tab="${key}"]`);
    if (btn) btn.textContent = `${TAB_EMOJI[key]} ${t(key)}`;
  });

  // shop labels
  document.getElementById('sub-title').textContent = t('subTitle');
  document.getElementById('sub-help').textContent = t('subHelp');
  document.getElementById('lbl-term').textContent = t('term');
  document.getElementById('lbl-atm').textContent = t('atmWrite');
  // orders table headers
  document.getElementById('orders-title').textContent=t('ordersTitle');
  document.getElementById('th-num').textContent=t('num');
  document.getElementById('th-prod').textContent=t('prod');
  document.getElementById('th-term').textContent=t('termCol');
  document.getElementById('th-meth').textContent=t('meth');
  document.getElementById('th-sum').textContent=t('sum');
  document.getElementById('th-st').textContent=t('st');
  document.getElementById('th-date').textContent=t('date');
  // refs
  document.getElementById('ref-title').textContent=t('refTitle');
  document.getElementById('ref-help').textContent=t('refHelp');
  document.getElementById('bind-title').textContent=t('bindTitle');
  document.getElementById('ref-bind-btn').textContent=t('bind');
  document.getElementById('th-partner').textContent=t('partner');
  document.getElementById('th-date2').textContent=t('date');
  document.getElementById('th-paid').textContent=t('paid');
  document.getElementById('th-reward').textContent=t('reward');
  // tasks/balance/admin
  document.getElementById('tasks-title').textContent=t('tasksTitle');
  document.getElementById('bal-title').textContent=t('balTitle');
  document.getElementById('bal-help').textContent=t('balHelp');
  document.getElementById('adm-title').textContent=t('adminTitle');
  document.getElementById('adm-help').textContent=t('adminHelp');
  document.getElementById('admin-refresh').textContent=t('refresh');
  document.getElementById('admin-export').textContent=t('export');
  // payment labels
  document.getElementById('lbl-chain').textContent=t('chain');
  document.getElementById('lbl-addr').textContent=t('addr');
  document.getElementById('lbl-amt').textContent=t('amount');
  document.getElementById('lbl-memo').textContent=t('memo');
  document.getElementById('paid-btn').textContent=t('iPaid');
  // faq
  const faq=[ (lang==='ru'?'–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –≤ EUR. –û–ø–ª–∞—Ç–∞ ‚Äî –Ω–∞ –±–∏—Ä–∂—É –∞–¥–º–∏–Ω–∞ –∏–ª–∏ —Å—á—ë—Ç –∫–æ–º–ø–∞–Ω–∏–∏.':'Fixed EUR prices. Pay to admin exchange or company wallet.'),
              (lang==='ru'?'ATM –ø–æ–∫—Ä—ã–≤–∞—é—Ç –¥–æ 25% –∑–∞–∫–∞–∑–∞ (100 ATM = ‚Ç¨1).':'ATM can cover up to 25% (100 ATM = ‚Ç¨1).'),
              (lang==='ru'?'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞: 10% –æ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ ATM).':'Referral reward: 10% of paid subscription (in ATM).') ];
  document.getElementById('faq-list').innerHTML = faq.map(x=>`<li>${x}</li>`).join('');
}

/* =============================
   STORAGE / USER / STATE
============================= */
const DBKEY = 'CATM_DB_HTML_V2';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DBKEY)) || {users:{},orders:[],tasks:[],disclaimerAccepted:{}} }catch(e){ return {users:{},orders:[],tasks:[],disclaimerAccepted:{}} } }
const db = loadDB();
const saveDB = () => localStorage.setItem(DBKEY, JSON.stringify(db));

const rawUser = tg?.initDataUnsafe?.user;
let CURRENT_USER = rawUser ? { id:rawUser.id, username:rawUser.username||'user', name:(rawUser.first_name||'')+(rawUser.last_name?(' '+rawUser.last_name):'') } : { id:0, username:'guest', name:'Guest' };

if(!db.users[CURRENT_USER.id]){
  db.users[CURRENT_USER.id]={ id:CURRENT_USER.id, username:CURRENT_USER.username, created_at:new Date().toISOString(), atm:START_BONUS_ATM, ref_code:'REF'+(CURRENT_USER.id||Math.floor(Math.random()*1e6)), referred_by:null, orders:[], referrals:[], tasks:[], start_bonus_given:true };
  saveDB();
}
function user(){ return db.users[CURRENT_USER.id]; }

const state={ period:1, atmDiscount:0, cart:[], pay:{ chain:'BEP20', addr:PAY_ADDR.BEP20, amount:0, memo:'' } };

/* =============================
   LAYOUT / NAV / HELPERS
============================= */
function setHash(tab){ location.hash = '#/'+tab; }
function currentTab(){ return (location.hash.replace('#/','') || 'shop'); }
function switchTab(name){
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
  document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active', p.id==='page-'+name));
  if(name==='shop') renderCatalog();
  if(name==='orders') renderOrders();
  if(name==='ref') renderRefs();
  if(name==='tasks') renderTasks();
  if(name==='balance') renderBalance();
  if(name==='admin') renderAdmin();
}
window.addEventListener('hashchange', ()=> switchTab(currentTab()) );

function toast(t){ try{tg?.showPopup?.({title:'',message:String(t),buttons:[{type:'close'}]});}catch(_){} console.log('[toast]', t); }
function priceFor(item,months,opts={}){
  // –ø–æ–¥–ø–∏—Å–∫–∏ (plan/onebot/copy) ‚Äî —É–º–Ω–æ–∂–∞—é—Ç—Å—è –Ω–∞ –º–µ—Å—è—Ü—ã —Å —Å–∫–∏–¥–∫–æ–π
  if(item.type==='plan' || item.type==='onebot'){
    const disc = PERIOD_DISCOUNT[months]||0; const perMonth = Math.round(item.price*(1-disc)); return perMonth*months;
  }
  if(item.type==='copy'){ // copy-trading —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∫–∞–∫ –ø–æ–¥–ø–∏—Å–∫—É (—Ñ–∏–∫—Å ‚Ç¨50/–º–µ—Å)
    const disc = PERIOD_DISCOUNT[months]||0; const perMonth = Math.round(item.price*(1-disc)); return perMonth*months;
  }
  if(item.type==='consult'){ // –ø–æ—á–∞—Å–æ–≤–∞—è: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ –≤ opts.hours
    const hours = Math.max(1, parseInt(opts.hours||1,10)); return item.price * hours;
  }
  if(item.type==='training'){ // —Ä–∞–∑–æ–≤–æ
    return item.price;
  }
  if(item.type==='trial'){ // –±–µ—Å–ø–ª–∞—Ç–Ω–æ
    return 0;
  }
  // –¥–µ—Ñ–æ–ª—Ç
  const disc = PERIOD_DISCOUNT[months]||0; const perMonth = Math.round(item.price*(1-disc)); return perMonth*months;
}
function renderHeader(){
  document.getElementById('chip-name').textContent='@'+(CURRENT_USER.username||'guest');
  document.getElementById('chip-atm').textContent=user().atm;
  document.getElementById('chip-orders').textContent=user().orders.length;
  document.getElementById('ref-code').value=user().ref_code;
  if(ADMIN_IDS.includes(CURRENT_USER.id)) document.getElementById('tab-admin-btn').hidden=false;
}

/* =============================
   SHOP / CATALOG / CART
============================= */
function renderCatalog(){
  const grid = document.getElementById('catalog'); grid.innerHTML='';
  const months = state.period = parseInt(document.getElementById('period').value||'1',10);
  state.atmDiscount = Math.max(0, parseInt(document.getElementById('atm-discount').value||'0',10));
  const eur = state.cart.reduce((s,x)=>s+x.amount,0);
  const atmMax = Math.floor(eur*0.25)*100;
  if(state.atmDiscount>atmMax){ state.atmDiscount=atmMax; document.getElementById('atm-discount').value=atmMax; }

  CATALOG.forEach(it=>{
    // –≤—ã—á–∏—Å–ª–∏–º —Å—É–º–º—É –¥–ª—è –ø—Ä–µ–≤—å—é (–±–µ–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ consult/trial –≤—ã–±–æ—Ä–∞)
    const previewAmount = priceFor(it, months, {hours:1});
    const card = document.createElement('div'); card.className='col-4 card';

    // –±–µ–π–¥–∂–∏
    let badges = `<span class="badge">${(it.type==='plan'?'PLAN':it.type.toUpperCase())}</span>`;
    if(it.badge==='popular') badges += ` <span class="badge">${t('popular')}</span>`;
    if(it.badge==='top') badges += ` <span class="badge">${t('top')}</span>`;

    if(it.type==='onebot' || it.type==='trial'){
      const options = (it.chooseFrom||[]).map(b=>`<option value="${b.code}">${b.name}</option>`).join('');
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:start">
          <div>${badges}</div>
          <span class="price" style="color:var(--gold)">‚Ç¨${previewAmount} / ${it.type==='trial' ? '3d' : (months + t('months'))}</span>
        </div>
        <h3>${it.name}</h3>
        <p class="muted">${it.desc}</p>
        <div class="row">
          <select data-select="${it.code}" class="onebot-select">${options}</select>
          <button class="btn primary" data-act="${it.type==='trial'?'add-trial':'add-one'}" data-code="${it.code}">${t('add')}</button>
        </div>
        <div class="line"><button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button></div>
      `;
    } else if (it.type==='consult'){
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:start">
          <div>${badges}</div>
          <span class="price" style="color:var(--gold)">‚Ç¨${it.price}/h</span>
        </div>
        <h3>${it.name}</h3>
        <p class="muted">${it.desc}</p>
        <div class="row">
          <label class="label" for="hours-${it.code}" style="min-width:100px">Hours</label>
          <input id="hours-${it.code}" type="number" min="1" step="1" value="1" style="max-width:120px">
          <button class="btn primary" data-act="add-consult" data-code="${it.code}">${t('add')}</button>
        </div>
        <div class="line"><button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button></div>
      `;
    } else if (it.type==='training'){
      const inCart = state.cart.find(x=>x.code===it.code); // —Ä–∞–∑–æ–≤—ã–π ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ–º –¥—É–±–ª—å
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:start">
          <div>${badges}</div>
          <span class="price" style="color:var(--gold)">‚Ç¨${it.price}</span>
        </div>
        <h3>${it.name}</h3>
        <p class="muted">${it.desc}</p>
        <div class="line">
          <button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button>
          ${inCart?`<button class="btn" disabled>${t('add')}</button>`:`<button class="btn primary" data-act="add" data-code="${it.code}">${t('add')}</button>`}
        </div>
      `;
    } else {
      // –ø–ª–∞–Ω/–∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥
      const inCart = state.cart.find(x=>x.code===it.code && x.months===months);
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:start">
          <div>${badges}</div>
          <span class="price" style="color:var(--gold)">‚Ç¨${previewAmount} / ${months}${t('months')}</span>
        </div>
        <h3>${it.name}</h3>
        <p class="muted">${it.desc}</p>
        <div class="line">
          <button class="btn" data-act="details" data-code="${it.code}">${t('more')}</button>
          ${inCart?`<button class="btn" data-act="remove" data-code="${it.code}">${t('remove')}</button>`:`<button class="btn primary" data-act="add" data-code="${it.code}">${t('add')}</button>`}
        </div>
      `;
    }
    grid.appendChild(card);
  });

  updateCartIcon();
}

function updateCartIcon(){
  document.getElementById('cart-count').textContent = state.cart.length;
  document.getElementById('atm-balance').textContent = user().atm;
  renderHeader();
}

function addToCart(code, extraText, opts={}){
  const months = state.period;
  const it = CATALOG.find(x=>x.code===code);
  if(!it) return;

  // –∑–∞–ø—Ä–µ—Ç –¥—É–±–ª–µ–π –¥–ª—è —Ä–∞–∑–æ–≤—ã—Ö; –¥–ª—è –ø–ª–∞–Ω–æ–≤ ‚Äî –æ–¥–∏–Ω –Ω–∞ –ø–µ—Ä–∏–æ–¥; –¥–ª—è onebot –º–æ–∂–Ω–æ –º–Ω–æ–≥–æ (—Ä–∞–∑–Ω—ã–µ –±–æ—Ç—ã)
  if(it.type==='training'){
    if(state.cart.find(x=>x.code===it.code)) return;
  } else if (it.type==='plan' || it.type==='copy'){
    if(state.cart.find(x=>x.code===it.code && x.months===months)) return;
  }

  const amount = priceFor(it, months, opts);
  const nameBase = it.name + (extraText ? `: ${extraText}` : '');
  const monthsCol = (it.type==='plan' || it.type==='onebot' || it.type==='copy') ? months : 1;

  state.cart.push({ code: it.code, name: nameBase, months: monthsCol, amount });
  H('light');
  renderCatalog();
}

function removeFromCart(code){
  const months = state.period;
  state.cart = state.cart.filter(x=>!(x.code===code && (x.months===months || x.months===1)));
  H('light');
  renderCatalog();
}

/* =============================
   ORDERS / REFERRALS / TASKS
============================= */
function renderOrders(){
  const tb = document.querySelector('#orders-table tbody'); tb.innerHTML='';
  const rows = db.orders.filter(o=>o.user===CURRENT_USER.id).slice().reverse();
  for(const o of rows){
    const tr=document.createElement('tr');
    const names=o.items.map(i=>i.name+' √ó'+i.months+(i.months>1? (lang==='ru'?'–º':' mo') : '')).join(', ');
    tr.innerHTML=`<td>${o.id}</td><td>${names}</td><td>${o.items.reduce((s,i)=>s+i.months,0)} ${lang==='ru'?'–º–µ—Å':'mo'}</td><td>${o.method}</td><td>‚Ç¨${o.eur_final} ${o.atm_used?`(+${o.atm_used} ATM)`:''}</td><td>${o.status}</td><td>${new Date(o.created_at).toLocaleString()}</td><td>${o.memo}</td>`;
    tb.appendChild(tr);
  }
}
function renderRefs(){
  document.getElementById('ref-code').value = user().ref_code;
  const tb=document.querySelector('#ref-table tbody'); tb.innerHTML='';
  for(const r of (user().referrals||[]).slice().reverse()){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>@${db.users[r.uid]?.username||r.uid}</td><td>${new Date(r.at).toLocaleDateString()}</td><td>${r.paid?(lang==='ru'?'–î–∞':'Yes'):'‚Äî'}</td><td>${r.reward||0} ATM</td>`;
    tb.appendChild(tr);
  }
  const hasRef=!!user().referred_by; document.getElementById('ref-bind-input').disabled=hasRef; document.getElementById('ref-bind-btn').disabled=hasRef;
}
const TASK_DEF=[{id:1,title:'TikTok subscribe',reward:100},{id:2,title:'Repost to stories',reward:120},{id:3,title:'Project review',reward:150},{id:4,title:'Sticker on car',reward:500}];
function renderTasks(){
  const holder=document.getElementById('tasks'); holder.innerHTML='';
  TASK_DEF.forEach(tk=>{
    const col=document.createElement('div'); col.className='col-6 card';
    col.innerHTML=`<h3>#${tk.id} ${tk.title}</h3><p class="muted">+${tk.reward} ATM</p><input id="proof-${tk.id}" placeholder="${t('proofHint')}" inputmode="url"><div class="line"><span class="muted">Moderation</span><button class="btn primary" data-act="submit-task" data-id="${tk.id}">${t('submit')}</button></div>`;
    holder.appendChild(col);
  });
}
function renderBalance(){ document.getElementById('atm-balance').textContent = user().atm; }

/* =============================
   ADMIN
============================= */
function renderAdmin(){
  const users=Object.values(db.users); const o=db.orders;
  const totalEur=o.reduce((s,x)=>s+x.eur_final,0); const totalAtm=users.reduce((s,u)=>s+u.atm,0);
  document.getElementById('admin-stats').innerHTML = `<div class="row"><div class="chip">${t('users')}: <b>${users.length}</b></div><div class="chip">${t('orders2')}: <b>${o.length}</b></div><div class="chip">${t('revenue')}: <b>‚Ç¨${totalEur}</b></div><div class="chip">${t('atmHold')}: <b>${totalAtm}</b></div></div>`;

  const utb=document.querySelector('#admin-users tbody'); utb.innerHTML='';
  users.slice().sort((a,b)=>b.id-a.id).forEach(u=>{
    const refFrom=u.referred_by?'@'+(db.users[u.referred_by]?.username||u.referred_by):'‚Äî';
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.id}</td><td>@${u.username}</td><td>${u.atm}</td><td>${u.orders.length}</td><td>${u.ref_code}</td><td>${refFrom}</td><td>${new Date(u.created_at).toLocaleDateString()}</td>`;
    utb.appendChild(tr);
  });

  const otb=document.querySelector('#admin-orders tbody'); otb.innerHTML='';
  db.orders.slice().reverse().forEach(or=>{
    const userName='@'+(db.users[or.user]?.username||or.user);
    const items=or.items.map(i=>i.name+'√ó'+i.months).join(', ');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${or.id}</td><td>${userName}</td><td>${items}</td><td>${or.items.reduce((s,i)=>s+i.months,0)} ${lang==='ru'?'–º–µ—Å':'mo'}</td><td>${or.method}</td><td>${or.eur_final}</td><td>${or.atm_used}</td><td>${or.status}</td><td>${new Date(or.created_at).toLocaleString()}</td><td>${ADMIN_IDS.includes(CURRENT_USER.id)?`<button class="btn" data-act="mark-paid" data-id="${or.id}">${lang==='ru'?'–û–ø–ª–∞—á–µ–Ω':'Paid'}</button> <button class="btn ghost" data-act="mark-cancel" data-id="${or.id}">${lang==='ru'?'–û—Ç–º–µ–Ω–∞':'Cancel'}</button>`:''}</td>`;
    otb.appendChild(tr);
  });

  const ttb=document.querySelector('#admin-tasks tbody'); ttb.innerHTML='';
  users.forEach(u=>{
    (u.tasks||[]).forEach((tk,idx)=>{
      if(tk.status==='pending'){
        const def=TASK_DEF.find(d=>d.id===tk.id)||{reward:0,title:'#'+tk.id};
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${u.id}</td><td>@${u.username}</td><td>#${tk.id} ${def.title||''}</td><td>${tk.proof||''}</td><td>+${def.reward} ATM</td><td>${tk.status}</td><td>${ADMIN_IDS.includes(CURRENT_USER.id)?`<button class="btn" data-act="task-approve" data-uid="${u.id}" data-idx="${idx}">${lang==='ru'?'–û–¥–æ–±—Ä–∏—Ç—å':'Approve'}</button> <button class="btn ghost" data-act="task-reject" data-uid="${u.id}" data-idx="${idx}">${lang==='ru'?'–û—Ç–∫–ª–æ–Ω–∏—Ç—å':'Reject'}</button>`:''}</td>`;
        ttb.appendChild(tr);
      }
    });
  });
}

/* =============================
   PAYMENT (sheet from cart icon)
============================= */
function openPay(){
  if(state.cart.length===0){ toast(lang==='ru'?'–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞':'Cart is empty'); return; }
  const eur=state.cart.reduce((s,x)=>s+x.amount,0);
  const atmMax=Math.floor(eur*0.25)*100;
  const wantATM=Math.min(state.atmDiscount||0, atmMax, user().atm);
  const eurMinus=Math.floor(wantATM/100);
  const finalEur=Math.max(0, eur-eurMinus);
  state.pay.amount=finalEur;
  state.pay.memo='ORDER-'+(db.orders.length+1);
  document.getElementById('pay-chain').value=state.pay.chain;
  document.getElementById('pay-addr').textContent=state.pay.addr;
  document.getElementById('pay-amount').textContent='‚Ç¨'+finalEur;
  document.getElementById('pay-memo').textContent=state.pay.memo;
  document.getElementById('modal-pay').style.display='flex';
}
function closePay(){ document.getElementById('modal-pay').style.display='none'; }

function createPaymentIntent(){ return new Promise(r=>setTimeout(()=>r('intent_'+Math.random().toString(36).slice(2,9)),300)); }
function createOrder(){
  if(state.cart.length===0) return toast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
  const eur=state.cart.reduce((s,x)=>s+x.amount,0);
  const atmMax=Math.floor(eur*0.25)*100;
  const wantATM=Math.min(state.atmDiscount||0, atmMax, user().atm);
  const eurMinus=Math.floor(wantATM/100);
  const finalEur=Math.max(0, eur-eurMinus);
  if(wantATM>0) user().atm=Math.max(0, user().atm-wantATM);

  const order = {
    id: db.orders.length+1,
    user: CURRENT_USER.id,
    items: state.cart.map(x=>({code:x.code,name:x.name,months:x.months,amount:x.amount})),
    method: 'crypto',
    eur,
    atm_used: wantATM,
    eur_final: finalEur,
    status:'waiting',
    created_at:new Date().toISOString(),
    memo: state.pay.memo
  };
  db.orders.push(order); user().orders.push(order.id); saveDB();

  state.cart=[]; state.atmDiscount=0; document.getElementById('atm-discount').value=0;
  renderCatalog(); renderOrders();
  openPay();
  createPaymentIntent().then(id=>{ order.memo=id; saveDB(); renderOrders(); document.getElementById('pay-memo').textContent=id; });
}

/* =============================
   EVENTS
============================= */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button,.btn'); if(!btn) return;

  // bottom tabs
  if(btn.classList.contains('tbtn')){ H('light'); setHash(btn.dataset.tab); switchTab(btn.dataset.tab); return; }

  const act = btn.dataset.act;
  if(act==='details'){ const code=btn.dataset.code; const it = CATALOG.find(x=>x.code===code); document.getElementById('item-title').textContent = it?.name||'–¢–æ–≤–∞—Ä'; document.getElementById('item-desc').innerHTML = `<p class="muted">${it?.desc||''}</p>`; document.getElementById('modal-item').style.display='flex'; return; }
  if(act==='add'){ addToCart(btn.dataset.code); return; }
  if(act==='remove'){ removeFromCart(btn.dataset.code); return; }
  if(act==='add-one'){ const sel = btn.parentElement.querySelector('[data-select]'); const val = sel?.value; const label = BOT_LIST.find(b=>b.code===val)?.name || val; addToCart('ONE_BOT', label); return; }
  if(act==='add-trial'){ const sel = btn.parentElement.querySelector('[data-select]'); const val = sel?.value; const label = BOT_LIST.find(b=>b.code===val)?.name || val; addToCart('TRIAL', label); return; }
  if(act==='add-consult'){ const hours = Math.max(1, parseInt(document.getElementById('hours-CONSULT')?.value||'1',10)); addToCart('CONSULT', `${hours}h`, {hours}); return; }

  if(act==='submit-task'){ const id=+btn.dataset.id; const val=document.getElementById('proof-'+id)?.value.trim(); if(!/^https?:\/\//i.test(val||'')) return toast(lang==='ru'?'–î–æ–±–∞–≤—å—Ç–µ –≤–∞–ª–∏–¥–Ω—ã–π URL':'Add a valid URL'); user().tasks=user().tasks||[]; user().tasks.push({id,proof:val,at:new Date().toISOString(),status:'pending'}); saveDB(); toast(lang==='ru'?'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É':'Submitted for review'); document.getElementById('proof-'+id).value=''; return; }

  // cart icon
  if(btn.id==='cart-open'){ if(state.cart.length===0) {toast(lang==='ru'?'–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞':'Cart is empty'); return;} openPay(); return; }

  // payment
  if(btn.id==='pay-close'){ closePay(); return; }
  if(btn.id==='copy-addr'){ navigator.clipboard.writeText(document.getElementById('pay-addr').textContent||''); toast('Address copied'); return; }
  if(btn.id==='copy-amount'){ navigator.clipboard.writeText((document.getElementById('pay-amount').textContent||'').replace('‚Ç¨','')); toast('Amount copied'); return; }
  if(btn.id==='copy-memo'){ navigator.clipboard.writeText(document.getElementById('pay-memo').textContent||''); toast('Memo copied'); return; }
  if(btn.id==='paid-btn'){ toast(lang==='ru'?'–°–ø–∞—Å–∏–±–æ! –ú—ã –æ—Ç–º–µ—Ç–∏–º –∑–∞–∫–∞–∑ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.':'Thanks! We will mark your order after verification.'); closePay(); return; }

  // refs
  if(btn.id==='ref-copy'){ navigator.clipboard.writeText(user().ref_code).then(()=>toast(lang==='ru'?'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ':'Copied')); return; }
  if(btn.id==='ref-bind-btn'){ const code=document.getElementById('ref-bind-input').value.trim().toUpperCase(); if(!code) return toast(lang==='ru'?'–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥':'Enter code'); const owner = Object.values(db.users).find(u=>u.ref_code===code); if(!owner) return toast(lang==='ru'?'–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω':'Code not found'); if(owner.id===CURRENT_USER.id) return toast(lang==='ru'?'–ù–µ–ª—å–∑—è —Å–≤–æ–π –∫–æ–¥':'Cannot use own code'); if(user().referred_by) return toast(lang==='ru'?'–ö–æ–¥ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω':'Code already bound'); user().referred_by = owner.id; owner.referrals.push({uid:CURRENT_USER.id, at:new Date().toISOString(), paid:false, reward:0}); saveDB(); renderRefs(); toast(lang==='ru'?'–ö–æ–¥ –ø—Ä–∏–≤—è–∑–∞–Ω':'Code bound'); return; }

  // admin
  if(btn.id==='admin-refresh'){ renderAdmin(); return; }
  if(btn.id==='admin-export'){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cryptoatm_export.json'; a.click(); URL.revokeObjectURL(url); return; }
  if(btn.dataset.act==='mark-paid' && ADMIN_IDS.includes(CURRENT_USER.id)){
    const id=+btn.dataset.id; const o=db.orders.find(x=>x.id===id); if(o){ o.status='paid';
      const buyer=db.users[o.user]; if(buyer?.referred_by){ const refUser=db.users[buyer.referred_by]; const rec=(refUser.referrals||[]).find(r=>r.uid===buyer.id); if(rec && !rec.paid){ rec.paid=true; const atmReward=Math.max(0, Math.round((o.eur_final||0)*REF_BONUS_PERCENT*100)); rec.reward=atmReward; refUser.atm=(refUser.atm||0)+atmReward; } }
      saveDB(); renderAdmin(); renderOrders(); toast('Marked paid');
    } return;
  }
  if(btn.dataset.act==='mark-cancel' && ADMIN_IDS.includes(CURRENT_USER.id)){
    const id=+btn.dataset.id; const o=db.orders.find(x=>x.id===id); if(o){ o.status='canceled'; saveDB(); renderAdmin(); renderOrders(); toast('Canceled'); } return;
  }

  // misc modals
  if(btn.id==='close-item'){ document.getElementById('modal-item').style.display='none'; return; }
  if(btn.id==='auth-close'){ document.getElementById('modal-auth').style.display='none'; return; }

  // dev login (for local)
  if(btn.id==='dev-login'){ CURRENT_USER={id:999001, username:'guest_local'}; if(!db.users[CURRENT_USER.id]){ db.users[CURRENT_USER.id]={ id:CURRENT_USER.id, username:CURRENT_USER.username, created_at:new Date().toISOString(), atm:START_BONUS_ATM, ref_code:'REF'+CURRENT_USER.id, referred_by:null, orders:[], referrals:[], tasks:[], start_bonus_given:true }; saveDB(); } renderHeader(); switchTab(currentTab()); toast('–¢–µ—Å—Ç-–≤—Ö–æ–¥'); return; }
});

document.addEventListener('change',(e)=>{
  const el=e.target;
  if(el.id==='period' || el.id==='atm-discount'){ renderCatalog(); }
  if(el.id==='pay-chain'){ state.pay.chain = el.value; state.pay.addr = PAY_ADDR[state.pay.chain]; document.getElementById('pay-addr').textContent = state.pay.addr; }
});

document.addEventListener('touchstart',(e)=>{ const b=e.target.closest('button,.btn'); if(b) b.classList.add('touching');},{passive:true});
document.addEventListener('touchend',()=> document.querySelectorAll('.touching').forEach(b=>b.classList.remove('touching')));

/* =============================
   SPLASH & LANG
============================= */
document.getElementById('agree-btn').addEventListener('click', ()=>{
  localStorage.setItem('disclaimerAccepted','1');
  document.getElementById('splash').style.display='none';
});
if(localStorage.getItem('disclaimerAccepted')) document.getElementById('splash').style.display='none';

document.getElementById('lang-toggle').addEventListener('click',()=>{
  lang=(lang==='ru'?'en':'ru');
  localStorage.setItem('CATM_LANG',lang);
  applyLang();
  renderCatalog();
});

/* =============================
   BOOT
============================= */
function boot(){
  // Show dev-login outside Telegram
  if(!tg?.initDataUnsafe?.user) document.getElementById('dev-login').style.display='inline-flex';

  applyLang();
  renderHeader();
  switchTab(currentTab());
  renderCatalog();

  // update chip counters
  setInterval(()=>{ document.getElementById('chip-atm').textContent=user().atm; document.getElementById('chip-orders').textContent=user().orders.length; }, 1000);
}
boot();
</script>
</body>
</html>
